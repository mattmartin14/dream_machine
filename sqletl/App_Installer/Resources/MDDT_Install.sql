	
	
	/*
	*/
	
	
	USE SSISDB

	GO

	-- DISABLE MS TRIGGER ON SSISDB
	
	IF EXiSTS(select * from SSISDB.sys.triggers where name = 'ddl_cleanup_object_permissions')
		BEGIN
			IF EXISTS (SELECT is_disabled from SSISDB.sys.triggers where name = 'ddl_cleanup_object_permissions' and is_disabled = 0)
				BEGIN
					EXEC SSISDB..sp_executesql N'DISABLE TRIGGER ddl_cleanup_object_permissions ON DATABASE'
					--print 'trigger disabled'
				END
		END

	GO

	-- Change DB_OWNER to SA
	IF NOT exists (SELECT 1 from master.sys.databases WHERE name = 'SSISDB' and owner_sid = 0x01)
		BEGIN
			
			declare @sa nvarchar(255) = (select name from sys.server_principals where sid = 0x01)
			--print @sa
			
			exec SSISDB.sys.sp_changedbowner @sa;
				
		END

	GO


	IF NOT EXISTS(SELECT * FROM SSISDB.catalog.folders WHERE NAME = 'SQLETL.COM')
    BEGIN
        EXEC [SSISDB].[catalog].[create_folder] @folder_name= N'SQLETL.COM'
    END  

	GO

	DECLARE @FOLDER_DESC NVARCHAR(MAX) = concat(
'<SQLETL>
	<EDIS>
		<InstallTs>',format(sysdatetime(),'yyyy-MM-dd hh:mm:ss.ffffff'),'</InstallTs>
		<Instance>',@@servername,'</Instance>
		',(select @@version for xml path ('MSSQL_Edition_Snapshot')),'
		<SerialNumber>{EDIS_SERIAL_NO}</SerialNumber>
		<ActivationType>{EDIS_ACTIVATION_TYPE}</ActivationType>
		<BuildVersion>{EDIS_BUILD_VERSION}</BuildVersion>
		<UserVersion>{EDIS_USER_VERSION}</UserVersion>
		',(select SUSER_SNAME(owner_sid) from sys.databases where name = 'SSISDB' for xml path ('SSISDB_Owner_Snapshot')),'
	</EDIS>
</SQLETL>'
)

	EXEC [SSISDB].[catalog].[set_folder_description] @folder_name=N'SQLETL.COM', @folder_description = @FOLDER_DESC

	GO

	-- binaries
	declare @2012_bin varbinary(max) = 0x504B0304140000000800D26BEF4A1DE925BC7D350000F7AE00000D001C004C61756E636865722E6474737820A2180028A014000000000000000000000000000000000000000000ED7DF977E24892F0CFE3F7FC3F68D87DDBAE6973830D6EDBBB2921AE32B8C469989E574F4832A82C244AE230EED7FFFB179199BA30B87075CDEEEC7E4D7759288FC888C8C838F2E2FA3F9FE796B0365CCF74EC9B44369549FCE7EDE9C975A5D7BD929F0D6DB5542796717A220898E21A8F0DFD26F149D59ED4A99110A0AEED5D41CE4D62B3D9A4E6A6E63A9EF3B84C69CE3CDDFD6A750D1740A72B4B2FE1830881F6B60BE326D1ED36BA290E30950F8A49AEA12E1DB7ADCEA14CAB52E9FDDA5297CBDD6CC9992F564B23522C5E0268AAA84BC8CAE6D2B9723A97C95E08D9AB4CFE0A9E9F5A4159DE3C43A81826BBCED2D010C89DB136AC9B4426C81A3086892BD3027E1476D36BFD46E526F11B912FE462EEE2327921562E92859C74912C5FC8F9242956CA72F5E2E2229BCDFD1ED4BD53BD65CBD1CD47D3D0A1697DA52D0741BF40C7A472D94C2675112271E768AA65604BD94C3E64DDFDE40B60CD5872A7AE6C6D66B84126FCA3A855E552A122164BC9B204F8152EC56AB2542EC9C992582E936A41964B19F1F757CC644077BAEC164B5D73862D0C77B9C504569155E065AB8E3B577D9A12B717D7E968A5081856FC93EA426DE85DEF9601DC9BC9B23871EA52659D584A44D3A31C3174D3FB6C80107E5EA8CB59AC98CF1B929348B6902D254B442A270B15992445F9424A56E56A315FB92C648A85D2EFB19A71FE246EFDBC3D5CD9E50C2763A05A2B231116819175E52D540DCA2C5CC3C37194880388127BBB8795D07A7A1FC37E38332D673A35EDE9670B07C95E86568A954CA65429272B856A215928E70A49B154BC4CCAD5D265BE500579BBBCF893A194A12898A6BE978B553957950A1939599633D56441AE1493E50A29250B17C0DF6AA95A2817B37F7211D19F7BDE57EBB3697BCBBD8CCC88394992F2996455CA17411C4B65507B854A12F46151948AA52C2917FE6424A2EF79A6A74FA8BA5C21FD874493942F73D91270F42293016B92C9554163E6F268F26449122F2E8AC5CBFFE51CDD9FE585566BA0BA26BA359E900E13436F2766C4E29E958F5FDCBBFAB5ABB9E66229F454EF29C6BA5D0FAA15785D81C795028F2B8515BD148382DF235FCF857D95A2F9BEE7411D0FF8EF5C9056D672E51A37B6B15ABAAA752E7C5A4D2C53FB686C7BCE9361DF80FB5028EA9A5ECA94329A56CEC670EECDA0BFF5BA692F7D2FCACF099D9864F6A01C1E62852F7F9739508CF96A0E2C760E2D369192A56C594ACAF98254C994CA30C6E5B8FC550C8FC2A4DED521F07121FD57E5737CECEC8A6190C1F88963E0361C16D70C1718069819A60B02677CEF732E572C185AD1B850C1EFB92CEAEAA478A1AAF97C36FB68942FF27A225A6BD0ED9196FAC57103CF35FF3ADFB423F99958FE9D6A4F5720FC3709A93B53DD452CB30322746F5BDB80C49BC4BFF3C1727515F7EBCE7732623E4A3493D9DB484A683B2289FBF4E06D14B56BCEC1C6D29847D37D3E723D631ADEAF5D63B90454BC94C7BF24E215645B8320C09EDE24FABD2A2AAABFFE5DAA901EF9FB752C54FB0904E627C1F00BFF647A4EB2542A9693D99F6800E73753352D83C5693789956B5E05AD82A0B9AE6163DF3F42999BC459C5785441F83E708F9E67048A8BBF738AC2D2BEBE4BC72A0408D0ECEB74149FDB7FFCE39616F759F6BDBCEC189EB37235C34B81C67FFE3E46D29837646462B57C4C965810EC3ACE9211F3D7645260D083010DE2E83D085D88AEE62ACF637FB9680BB954269ADC9B19C2C235E7AABB15A68E6A7982F3282C67A6273CD2B848806F4B47502DCBD908AAE099F30530FBA175E7E73330CB192B3A77BCA5B51566ABB96A0BA85C7144A4682B53C3365CAAB804D5D685850AF8D853D69CC1C1AC610C392B4FD0411F084BB0239EA0BA86A03BB601A55C67359DD1D2686224C7066681B513344BF53C28CA60C077473321BED6858DB964E54378A928F1F2B38AE45C45D352A994A0EA4ECA3696692473064400EB84FF103CC65428C0450F7A97E50A361501789F9B6080A19DC4EDD2785EA683A987244AC2753AA8717B00C4DA0F43A19B8E28EED297C46D77EB8158A642C14329F0DF3AB4D0B9C00B0D4D5B77365E0AE35EEF1CC939A2A18D6B2EBFD9D090167A5F43B467581B388EC06E5CAFD185BAA5328812B5152C07E4C45BBA202ED769967BAD39F339A889A0982AF094EBB49F759DD643B3126D48722CC7CD26A840803161D8565C75030DA4686640034F4DDC8AD0EA4180A2B99CAB0B80E877FF4D425D2CC03C52714F3F27C3292810AB94436D5E6A62DA30EA5213D5332E0A51C5CD39F077964381324D00220D1EA4A95AE60B7C4DB5E59E5045976FE3B84F0283FA0F9F43BEEB7800E586E6D887588079AF38F04EDAB64B43755DF5DDE4D15E06CD419D651B7533742D42132838AA757C9D710C036883BE44F40E0BCB1E76453F81B2740DAA91547B2BD8ABF9040608209308C43A21B820F24C1D021797AA69FB3A938140EE330441039AEE8E3E52B519D35500C5AF8FE862AD73AA366955A650B10C286C275A906B63E826C171832E4B518509E5C0B47A0BC7D6994E670CA4DA9361ECAD160BC70D743A6A3086AA46752DB51F87D5B0EA6A3313A726C14F4C71181257CD143CA8F19FC246E8C8455E46441A29F4968E1BD5DD0C904F0A945EA6760D58900910571E54062989826592E1310E2E0DCBF222905FAB4A61069C0506E9C60289F696B434976CC117228D392A60ED6CC7671970CCB03D93DA3C507BC0E2A9B936EC104104C4583A5F01DC09A5475035E81AB4F3D636668BDA0EC87D5278AF2EA1361B1A7A6DA131F5B5C6065E5B966F9F41CE807C70485D5A9A5918410373CEE06002157F3E0859239E60019F80D513031C855807F9B45FBD9B0EDF27407609C215ED6A562EC2BDA093A9C0C447EE95AFC4BABC186D3BC5667C314E4E89AC3DF608D277A150B199413FFA6A8AB6C599EDFB68DF4FB4E7A88B1F4E726705DA736E1C26BD8BADE29F3F4CF6F7F4F38E7D781FDD10B03B71B3B08BFACA63968333035764C087B47125C3B05231BDF5473A3B99648EF8B3A75F71F7D0D4C12D030F3DE18737FE7A1494B949CC96CBC5553A8DCB529B7CCA71A7E95C2693454793B9EC7EE1B987660063239B03F6424626C1685D41B9242BE5DB568A85611968CF7CFF9022C28A5D353C0CB321E2B9492CDD951189D0B122C0042BF58CAC899A4E9A35734C0D3496FA7CAF81D6C390CD9E382B1B98B3136FBEC60064428D221907BCB7CD4801CFF8BA0296BFCEDDDB16151FDFA7A1D5A93781AE8BED639E494466200258E9371BA34DC10871CDC90A248E35867FF7B5B507FABEEA3448F8FEEA419C71040846DD215EB35CCEC86FF5261AF3F9C4DA7E5F6FEE1201A359F5FE00138EED821FC8807F3151E623FB1E9D07D5BA4964F7F16E6F03DCEF7D7F13B97FF6003A8AA6778DA95D88F91F32CC76A116FEA982174618FFCBA4EF478A06F8F6C889AF2B1322841FC56E5E8BDAB8D0241E00F51A08A78FDA6896F0E6B41007C3E738F6CD1185D1EBEE74C9E1D9A218543A75F40E286E4CAE38903F30A3E44FA2E78E5D3B985C5EAA45AD78912DE70B46A6547E17F6FECCD4F1D8BF3D4DF54FC41EDE70EAF60F4D33B395911684FB29EDE839FA7F738D29C6EE75C35A5C0942C35EB28D3C349E776818C7D69D84A5EA3D9D9EA4FF461DF0C802149B00F684ADB3C21A1017D38998B5E92E5790B56511E1C29FE065F31F103382DF8EC12D0C2313F8809E3BA0FC373AF580716F1828502FDBB4292E389F012303234C0001D81A530E1797AA60987AB488EB58C223469B028549FFC8CF0BEEBF0B0EFC710546B9276C66A6361366EADA1012C88684B0708D47F3D9A013DD10B8D399603AFBED2D0CCD7C343561A36EE94409A81D0A7C2F268F868AE2E1850440F41DE1664AF85BFAF4E4DF0C5B67A860B804EFBC47B053E9F2B0777AC262162695BFC45F53E8B907698796FC78C8B75B3726E0AF009BEAD476BCA5A9BDCAEA411FFCB28BBAED232C1CB108777AF21B93D0743A2D5C7BAB392E33DC8649A130FB5316A055DDADB07020C2E313537C9A81713425081587CEB76833D59EB2F9143E39E6DB10EF3C6C007A76A1E22C4DB0AA4181A62258A543B4FEF2F7E31753BB8D6EF82A23D69F1069E263F10F00B7A08A02315842E4CAE989D07C75B0275FB5872B949D1E4B604BA63492155514CDBFFC16EA819DA1DEA71DBA5770D7C1922C5F8EE17B07608CE2420F6D2A848B2A818E04C8F36B0A71713F171E4D176275C3F6604084134E41F199EA814280C85AD531AE869115D15F7F130C938E58AC829349FEB426D51A7CE66A67A515C630DB28811DBDBF5EAC051F08B500FBA03CBE1ABEE7E1E41C22BC99191449680FA510D4A11B6B01670C04DB30D80C2BB54DBE86F5D900320C9C0416C452CF050F75538C9D9AE5783C09577E55F09F00C5587B03D303FD2B74972BDD74D8FCE66A015E99718061582006E0303B4CC3F319EF1B0257B53D36DF879224EBE6D2C1C943542FA918D4405402B17A2D2B0E5D52A4631B8A08A072165E4A08F7B0B079768B2A617451920E50126F26F6C217F3B013B13876D8A3EBCC23F27A152B2FE01EDC9E499B86114ABFDD08677EEA07010762C095BFF34592ABABAE5F3AF18F14DDEDF3CB5138A12C70213A8C51BCC5BE67B85757F36D97BABF7E86DF2C209BB08D0D9B344B1C87C40E63166C2741D84B3BF8A0169EA84B6DD6D09135F0FA8A2BE16E045E703F578EC688793F7F0C2306E31B181D899087F3F94B736DFCB350AB19CBAEDF0645F3EC431C51741F22FA3D668D83D4B8D6AF9AEE41B56FACC11C7A01797BD4FC8E06A47E1C687623A80A839EEF5C11162B77014ACA3B6E5C3E32BC009EE1BAE87521C03D6340A60DA5800C43C68267D9D2B9803B2C80004FA05CF2129022AA7C410C5FE05FE6C3717D1CE261DAA13E3B029B4658FC2CBF17259E82E0D1DC51D502B12AC7EF1CC48B366F902998A80FEFC216FC51D7C66F47203A6445CFB285BD58B61DC637D4AC9A0192C796CC4C7BB15A1EE0258AE1BB84F00DD7032CB4CD8E300873D506EDF186D7D175402FB3AD20C08B7D35799C4117FEF63AE0D030B3874B6701FE588CACC4D0719F10513ACB2F85E05B3E78E01E10809DAE61A493A09CD20D7031AC23C59E2F46D802A9DCD3B8E735153BBDC9973E5C7513C1E88676729880364945835D11418F108D4E8B84D967D4914493ADD2F79DFE14C0E38C009F6F01B9B6DC8BB577162BF32186CE0EB474BAEF197EF4E643C0C56FEC3EEA15E1DAF9395B59710DCB505F157F2DD08768EDB0FA115A63A8C529FD46AF08742BDAEB1EF9BE0EF9E4A280A75ECCC5F77409DFFD80DBD53EA9208ED0032CE97F98F531AADEC5FC37D406C42D7FD91317D2610FC9D40C819D9D393A5D6D87B1876B7148C3EE0817D80EC8D05F8DCD0EC4C18A060C5F5CD686A0DD0EECFC326CEC9CAEC887EBF420297E44D631BC95B5440F0E5C5E9CB700D771A551D50A2AE1111402EE7CD821C3C16911A614CF71CE010A57B33B85A241A89FBE70CD356D61899A47603E203DD985E1C78A6E990501410F309617731F8E01F2196CF1E7B937F5FE183480F2264A11302C2C5E3BA62E601C7C163183BF450BE2C7B75D0B0E98BFC79DA4B01C75CED14A0B0BCF8C5709B25ED58D13A2BA47B0023F10F3C7137E8BBFE2878F68BEA1976B8CBDEEB37FC6863BABA99EC35A7FD56C146C6C77F19BD0E3E7CBDEDD486CA7F2371B8A9FBD7A4F63E13EE7B71A899CA4790FF03DFBA5DF6A65DFF6EABDCDBD6E106528451630F075B6BBE2ECBF1289C46F99DF130970AE7ECBF2670E9EE06A453677FB9272BE87EDFB9B02394FA109C39944A026DED17B7881E5893B5DCDA92F7FC3507D937B58839E3930DA0E9B4B846AB883E040D90EE0006EE512069CADABAEDE40AFF27D55A8D7FFBE2AF7ABE5379B61D877975B0B59C5F5422431553775DDB00FD4062BDB9D1996C54EBA208447D5F28CFDBD92926D14A88E6AA29BC13CF310B97D151801A8433BBE4FFEF30D469D88E46787E67E46D54BD79EBC7D48A628DF0E81A031571CC23E18A10ABD41B27F61B6FA60C90323C0A2477C3F6BAEEACD3ECFA08B2CD0A05141DF33BAC03EA61A7A441877874320D70786424A04EFC2668CC489AD3BD336F68B342B49D9152BB8AFE8503597308AE567F310B118FAE312C00D76011493C0E9DA5FF05138A3056F20BE7A9DBDC780E067C7FFE0930B6C528EA579A92E7344F6D0FAFBEB24C3F28CBDADEF6F3FD894BB443F614F133BA465F790F60679F8E1B0714E8B2E37310570D6A16E9A80FC04A889034DEFA1F03095C72342C57BB5D8874BEEC39570081BFC2033FECAD8966A78ED9565DDBB43DC1CDBC5A593B35DCF2B22F21F0EF0EE1B68C751F7BFFD2C247E757FB585047C7BA3CD370839C0DADF0F894A3AAD52AB8703175D42019B3A2C306FF088FB9347B0E6A8DEDCC792D74D1C16B04304EF9DAE4A66CF85845C697413E77EC3914995EF1FE45516627C7B90EFBC6A38DB289CC9CF9AB160535DCF3BBCDCC3C36F52663CA75AA072F0BA85A8CA7E3D79F44328C47DE71BEA9507649CEDC560B7E91D5E3CE25E15EBDB9EFB2225E1F2CB01F35131BDC5BEDCD8C088BDF8C1130D7BF65AC7572EF079D471FD1C98C2A85FEEDBF668FA4EB9476A3063215614E320C072B3EF0FB1B2C786581C174A308F55285EE0C62D2C1CEE89AE7227F7EE3EA36CA580049C858C244958B1CE1845B35F0FA4EF8CE2DEE1AAE333FFDA658FF7CEAB6EE139AF114EA7B9F08ACE73AA3B733667099CA8D9431A303AEAE3075CFCE575B1E35D7B2C7DD8A5DD2DF92A00D85BD0CDEEB88FD943255EA1B3871B944E810F8F602A3D5AF1F7D7E38B4F4ED06176D0793EE3F3791EF43A6E058ABACC54E711141FA8F6D902CFF0F0E0F9B69DA700E8F68D5DF3B547E7701BCDC5913AA531103B5A6EBF7F79A8067CBD7336380270728F1E183A4BD098E02AB1CFB41E74075F791247A2BB0BE7B5CDDA519DC775EE6E58F32FDAB7BEB3F11DCC3A6C54FC25979811157443B354B6E6B233CFF8C654AB61AFE6C8D3B5A91BEC849C0DCC3271EF8C3773DC250EC3E8262D4F7316467C5B0D3F76B564EBDC3323DE8ACBCC7E7C3F4FBCC81EB4E8FCF546F582E349BAA0AE964EB01C73C44C2AA52CC6A1837DCEA328505DDFD86395AAF4BAA83419403FFA3A8F43E3CECCBBA1F17A913E8F08447C12FD2F200EBFFFD173EB98FDD656C2ECC59D7CF44175289FCC5E2470A8DABA6A3936B4B1353C76745DBBE2CDF1632E5A7022861F72D9B9AC0D7B9FAFBBCF2DBC282D93CE94D273D05DE14199C93760E83877863B5AD250169D003C72934F082EE37D782504D2C1400CA2B4E1C6B06BA81ADCCA52739DD5025359320684C8CADB2336C45DA763350218E84E5AEAF67D60A2950248FE5515B7738F7A3CAC68901A94F3A542BFFDED32572954E4522199CB56CAC942362B26CBF97C3E59C817CAC58A94CB5D94E4DF199CB0163225BD972B143C4ADB0E9FFC9E6FD89AB5D28FBBC523A579D8FD897408862ED7053022B72E107E36057D0FDC1B7B4C9D9D9B1ADE57A56278E61494D2B18D05576C7C77C5E0968C83B5E2DB83D36137453BE43A1D8CC31F76E7C55EE2DED029D1EDC9E974F2877E4E4FD012A099480656E39626E2E79059996CC1EA2D1DC74A61D1A0B844379A7A6C171F5E8B81FC9EAB5B08AA718B9B69D353D51A1E519CA96B130FFD52436959B8290142C82578120134B63AA9D393CAA0C5FDC6530CE5F41E9C7F346B4E4FFEEE9FE2BA12A6963351ADABABD79B8153A8A40884CA5B886EC0BE2DE8D22577D1835DAE6791EB873EB13DE1B84B11833789644BD9EC15415FAD6FB3E5DB4FCC8D43D050A48B1E049E10C463F4F0DE8378050F271EA31742C94B059207953FF3EB5FCE3E5C7D079484F03393D8041D641FFEF1EE0DCF1188BE6B11FD6BDA4BC3059E8293A4E26AF6CECE60FF6A9A57FD02FEFAA3395D31970E3D487FD7BC5F05F701477D99F0DBDF7740F91E079E88054976FD3D394142CD97BEB09391113EBCDD35601F679D31BEE1EF53E5A137CF8E457B11606C25781716EFC45DE70CFA779F63CD96F27711383C09C4BFFE61C7E91DE6EB483D78F40D40BE29ED81B6F20267A580E539EFD858F26E12D40908CE227F8FA3145CBB1433F3510EE1F9A8DACAD4BDDBDFF2994A267B512D27F397F942B220831B414A17D96451BEAC94CA65395BAAE67FFFE5B72A91330559CA24F3992CB88BD94A3E29560B623293913285EA6559AE8AD2EF41D784F079BBB1F1809BB674935D9926FCF4EF67B1CC0F3FE182C44F3F0989DB8A31594DAFD3B1EC80104B5DD2032D3BB0FCF40818626FA54F7DC08D67457811B91BF7B694CAA4F299CB4C9E5211CDE1E5BB514F939DD98A27C5798CF4DFFE562E97ABC5523697AC66A5CB64815C9264B99225C9BC2C5E908BBC24573399906FB40E07C316C5E849B63B73E24284749D8EA4F152A05A7CFB5D7570BAEC365468D7E9D7B9BC5AC77196C14996E31CD87815BF796E988EF7836335381426FBC1BD303E3FD705E4F1814C5E159D29620185F4785F319BBB4EC793E85848BF1E0CF1F1718C4852714481E24DD3F7EE763E81217D8BCBC4D7E95852B418EDB2C79565F132D12EBC5F807E375F201F27E8A093FDF79820E0F6B2DBD4AF13D3FE9542F8D597069AC18BB225ECBECD76C4E9B4206E47F0411FCC0F707D346DDC28862A79E9DD5664B15FFBA5D721928C88C733FD36D9922CDE10730BBA73BE58423B91345E8CEF6FA53760DF16AED3B1F71FD7497CAFDBA16EE27CD8D74F01DB59577EB317784BFF2DFDF03FD803D13084A90EE3D170F164702486A19E4A78BCF770193A717654C1D819B8A36A3CCCADB7CBED9BD369F11EE8757FC81D9AEF6EFF07DFE119DCA118EFB6D7BD18B10C7B23D80825DCCF3C2A840F8F63775713AAE430740043C9DF38C83487194830041478C2CC0FD58F09FDC3A6B803ECB8B7786818D53F361AA45EA7C302411DBC241F92D9D0BDDD3B45709D8E17F271DF45F6183EED9F8308D1211046424BB73DAA7BFCB720BB62E0143498B3FE024C5F9C11A816A2B90758DCC61B198F9BABD8C759BF5417EFBC3290C7EFE1EFBEB98643EC45448F61E9DEF98BEFE4E82B1E1CC9D457F8C56773BE6734BC1ABA786528874F2723A8A32FB82B8B1F845605E9DFFCA34E29FF7AA3C69CDED8C6DDCA9BC4BF9FB5BA34B0104D1B0DD5875F4365C46EC84D2D590012A8105E576617A481CDF1D1652718D901C690C2AAA5AE1D37124DF3DFAE382ABE885D36C81B8E80AA3B1EBFC0194FD5FA6F099ACE377F424B629E5C948A84242F65524D1644FC958C7221932C5E968BE52A29122973F97B428804E3ECDEEB9507E156786130F49BD033E60B88160C0F79851742510B8D4A4E7E361826187BD96BBAB21DE642478249A76B453789F41ACC34A248B3FBAE79F51F5F57CEF2174CD631295B324AB98B493109FCC0EBF74B936459BBB84CEA7809FA45C9307265357D992D5F9432994C725234A050BE584E96F2869154CBB9C7C78BA27E91CBE518DCF8F51AD7D872EC0A027A2D75BC0C67B56499AF2E34C1EA0D947FFC1D1118FFDD46F773B797CD8247BE93158197DE0F107CF21DE90844FF95300530628217A4FEB0E9CF5DCB7564C41F3B6F0F36DE0A0E78C4730E4CDAD035603E57C9B4A625448EA809EAC4592DF1E0913FE3474F52B0C31138FF14BDCB919DC7C54629383C0481F72F04A7EA537C26140BE3D1DEE0CA167E906CE90873FC99982D8516395747C1ED5ECA1BC1894FB74666257D66F6CCA5853B438EB8ED1BA7A8F64088DCA77E96385428E6F8BF556CBE50EDEDE1023CCEFF43084BCE62EB9AD3194009BE0AFF2508F81B4187EAF45C500073D57D7A0377E6F9F1025C62FC1BA1A36720A90988C80B080B5E80E985B73DFA52F2084E03EFFBABD884B9406F5AF7A14792F182F5A0D1309D1A12A14D2F530D533BC6DAF4EBD3D491B3A227FDD8ED1C5BBC90243CA5430FE06C79093E13C84FC0333074523EDA92C730986CF939302CFCD3DF7E12F0CCE6CCD9D8EC22CBAB9DF9729F9F9C8A339CA34BFD0D98FAE3AF0EFF731DE5CF7594FFD6759450F47021C57FE3C760714165CF9D4ACE2A5C33090BEF6AA1FF7BDCF1F569C0951A25D1BF65956737EC903B8FCEFF6DAE7811AEBCCD13E044C0950F570340F19FB0D276E0C2214120B815D5C19B969378A85CC76D496C92802EC29DF3DB0D1C7A267CB580AF1ABF74966D058312C6523B7081104BE39A91AEE9A16A8C2B23D48FF44E158E06460D41F0CF37A906901890B5A972952A58E613BDC119BC3D3479B1EB5F522102EC7E1907AFBF9A3B6BBC8885F534DD9ECAAEAD11E89D684C0DF393C1EECAE6B00348C12DDC69205F70A82775CE00B3C891821A74839091D5DC5D758C0A379B9E345C88CCF182132AEBAF961A839552C68140CEF62F72EE2C4AEE2E79C63556A8A782BE87F7FDEB936FC23D28DF015C9EB617F65B2CFA678FFFE8826EC0E9804D671FA25CFE7D1FF26F6C2644D70D1764D97D5E9AAAE1B56FBB8C0FAE33A29736D011B17337D7A1E1B58F753BB73BB37B8944BC881FE7C543861D55BC8B1B4953445F237EFA5E4EBD57CC76DF8F5BD7C6FDA7671109C505097B65591F3E1C3AF172344290EB9FA73EB6CE5151CD5ED30002899AD6793C0B923EA47C47FAD0899B18DD14DFE34EB6F1CD00FB07F64E9DF74BF6FDDA705DBA3F96CA36FB01008CA20D55FFC9F37FBAA8DFE0E33EBC588C865596B50B2FB03D6870560B2F8845F07E036E1F847D66EA7FED2039AC337D9EBD6BD3C76145BB473EBC43A0623040DCD6BBB745ED959B6F6F2061BF2AF047F68FE89695B8ED0DBE2A84B4087C64FC934E9708B99B12FFA390E33FA727F897D52D3CAEA605B22476BB31998ABD566636A8CD16DA56DC68F3B2ADCDABCB46AD3D9BCC8B6B5D12CD7157DCEAC3C254857F1DB9DC6BD4B2EBD39371ADBFAA28998FCDA00551E900423D225748C5EAA8D653D8F83DFC33E53BA27850CCC194869F55F9F2C4709B4629927D54E1AF18C291C3AF12F1F3D9A74594469F16066862583CA81201C32B1420F12E843B95C99E0FE31BA9E19FCDBE02EFFA30688D10FFE02361823CDD492C66C60FB30C7EAD8A949FB4406DCAA070DC623528AE2BCD6E6F47145D4615E3EB08FF68AFB112E9BFD3933BBB694D6AE52F840B1DA39AA1DA98BEAE8750953DE9D0AB9BD3937BFF85510550FA4495A08FAAD31E89F6C71D01D2A4C23E38FE670FA531020AD247EC4EE27C955FA02529E393D579A40C50968D7A03DEC54D86F3ADE154803FD2BC84447CD49EB194F31184136BC9BCD6D79A5DA0FDF2715690A6B4DF685A85A699C517718AB841AD8A5FEAA3A8503C88E86DC4A998A33D06FFE487D6105B92ECD6037DE65BD81D1F2B80494DA198A8F87E7AA2D9C0FCBAB8AE31FCB0BF3E4E9E9122A74DCCE998BDE3285A6C2D28A3D54A1396861DBE58D711DAAC256359CAB7A0F4563958BABA0B996CE457654F4F78E9DA6EE93BE575695EB62ED59B0BA2881B5919356565B0AE03372473543F3D9195CEBA8E544EB506A370B1A66363AA3D4CB6B447EAD55CC944A8E2B3BE6E6CFC3CC5CFB358DE18706B22DCE9087291654EADFAA95093507FD82D87E2B57D0AD337D17487A68BB9924BA1CD4B1EE35B73DAE88833B90E294B7C97375E57DA4E57B4FF3AB2FC1105978C6A936D894298BC10FE94F913A9717AA727922837EE3A324807C5613879C101E6149E503A20AFFAD26A6A4E462475D293BADE46F35AECFB43A18A92C5FB1F0400E54D32332359B1A08F1A44ABEF94605C6F3E4E51BC3AAC17CC29667EBCEB4C3BD243A342A6E2C6CFE77D6A4EB38CC2278EE362DD467ECE065B095B11E5A636EB4B8013E04EF93BF765007A01E9FE987F7A424AA7813CE768EE43E30EDB9395C51A3502A4EB74C47D031A96673A24A8F142F1BAC84F33C0598773182C0A71B58F80ABD20BEC6117FF20DE44CCC0F8159B4C8734513095465062306DA032C511DE0E75496B232A629A7EDFEC19B79B42559B691248485DDCB69137B552898EE43A1FD1D03313CAB3AF6DAA223B2D59569421B900691235D999C9728D0C4D481B57A65D1347C1E9C927858D0AA9567AA452B8B158DFCD4B535FC699846B433E3662124BE5D504AE80FE03DCAAA38020922BFD8CB98018D65A76EB05661879BA3FF23E6D280695C94B211CBFF332D3BD1FB5454942ADA4503C37C3C7691F99B953BA9466787CEDEEB65AB50B684D6480B6BFDDAF8F36E3DF9431ED058B4B0EA1D2AD3D231340A9E278961C839833EC35D0961FA74CD9BF78EE7A4DB5B6D4C1F749B55DD4F21D6BD22D76C70FEDB5FED0FC327E68ADFAF3C1CB243FD88E7283EE78587D1A3F343CF0685E46B9F2F6F46452B3CC3B491C8E1F9A2FEAB0BCFAD453562DA9B0B9FB42BC86DCCE4EEA9DAC36EF9727F34156AF3767136933EDD70726D4FBD2CD0D8A835AD91D0F0BE5D1172D7F7A32EA0DBEB47BA3E77B70B1C63D52B8EFB67BC6433B331E66A278BCDC59CDECC4EE2C26C34188EBA06DE9A19BE45BC0AA2876E83F46B562B53F2A4835177D3443A43ECA00BEABD60B7969F5981706128D124254B0C1446AFF8CD02A7D34552F689CA4760FA8594CE63AD560E4237A6CA02321AB911DF4A00F90A7B48D46461F74FBF8559CCAF0F8190409A0496D093C0733143AC4BCFA50571BA2A4A0AEAB5C347B2D30FD1C8E447D822A1DA7146E86B54B2955A63E04F2C91F87FC9D12C85C0739F8C330F3DD3727E08638AD8880DB9D03CD5574D29A92CA9494494711C1328FC9048CFD545C934101DE01A191074F3227334792A6E08FCD4B12E437C9B654816786E41A15B0F553E90EBFC1D361CF4A9D3FA7FC59644FD2176BF4B9664FB1C19E9228D664199E3380C6BEA5C51AB655D1C43BC4A932634FE8ED61A302983D8B1DAF2A4DC58FF804488FE250962B080968015CBF88C39284BA5772F11BE49430071CAF81B8EE57E1B9C4A7842D005500D105DD012D4A2DF192B7084FA0409244E40E71011AE59B589744AF4A4894C35CDEA01B80A525F4EBE09D3A9132115D70FEB04F2B3C5D21A01A4E4F1E37A8631574032B58DBD9F0F21B9035783E6EE41E3E5DD0B8F82C4FE5223EDBA459C7E727FEEC29CD3A4AEFA8B6DD3427A4AA92CCA669E033479F3C2268B4466B308A88EB90BBDA4F9B2F12E900BA8AD461E34AEA49ED1148481369694E59CD66AB5198CA0BACE9F09AD6745A235F4042A7D20BAF59ABDD6D44F0D024D08CBC9E3C32A6439DFA9664CD6BCEA6E280CC60E881FC34A8144B22A93A527743BDEA275E1384AED947D77C6432D17D52A42DB1906F9222D9CD789B77A4A13D45DB24C463C3E2BE25B1E7133E25F24991D89891A97F8A9111FD5625E2538596144B155A521ABD7AEF2A52890C37A4CF9F43FE1CF1E7E989CABF69FC69F0E7943F4DFE7CE2CF393E1F80AFF8EC78E42B7F028D25C00DBE794AE545AC8FE049EEC5870CF98825460DB2A5CF02C9F11A327F16F8F3823F4BFC099E03FF56532AF7A22A939F15F2287E0503A3C839F12B4AA89C16DD163CC5A6E86AE45E11BBA28B106074CD37F8F4F8F302C6292004B0DBFC69B36745E4CFB5E83DE1338DEF170AE9891056D4945A8940DF5CC04014CB237C4EF0797A02DF9EC5720653D2E2CF2DC4BE2AFEAC918652A5B8C07B577CA654CDF9B3C89E155AEE67A5D215F33270A7EE006E3F7BF8ED127D16A072287DD2484B9167D2A70C502567A53BA4AE467B005A14613C1345A976F0F951A98E25D11129F52681B1A028E28CD510BF4A1545841214023CCB52C5116B7E9F6154536BE0F389D4305FEA91A682D313139050119E5F50F7E237F10B8171062977A452C2670F24189F2FFCE9F21A97E40ECB89155E6F425A1951D9804E81164E4FBABC0D90C009A64C3712CD81415323DDA90818893474C591568396F0795F10A973273624B02B12B5231BEA23414991EA2D059F343E056D24871311FD71B9EA87CBCC23DC9D44005DF2CC6C1689CD4EB02A6879D8C7DBC9724899DB286967520174F410FA343AB583DF1B236A5023733EA5DEB0FCA40F9FAD4F53B137A896B6AD2F7DF02C5AD9716F3C6B55FA99F6CBE069346C644F4FDAF3EAACF5D27A6E0DC7D67D6FF432968A4F135024511F8454DBFD8797C6B6DDEB58A39781D59ECB9B764FC9B7879DD9E84B3F371ACA2FAD17F9F9F4643CEF17DB5FDA4F7796B89DE4454B03CF053C2BD2CF0D327ACD5A8DF3F8BDBD551FC44C6F585D4CDEC00F7C24C0F0157E44EC8DF2CD8556EFA03F845ED70BE13E1A7A68C4F7ED14F1D368BEB0467985F4F3D6CBE9895E1B2CEF9EDAEBC97CBC1823650FE055E50A44791037E8A3B1F7626FFCD0C9A8C3A2AD659A332DD727BDA1F5459B975F26B971E6CE6A3F83F76861243EB634B3E8E3D21F3DB4C13C6517F0BED672E5B92E157BDAF019A03573E047AE3A80E79DD501884B78B601A2B5D1ABF88E1A0978DA5706CD7EC09B5CF3EB78D8CE603F8E87CF1240B7883C58E9C30CA586D262352D68097CCEB6A56DC4C03B845EE867679379D586768916F6637B342C84B59F746F92032FB5665D049CC80F3CBD3ED88EFBD053F312AD0B7E2FAB5D0179CA007C8B48C52F7AADBC2535DDD2ABE5D02B8DB43A86FE7EC8043E31D1F83B40E329415B8A08148E6708BD3B2C026ED5D508B8CE2074ACF1BC0A5014D2A90DE6A307A803FDEFFBC9C0B7DAA08029DC4395F4A1E58D6B03C0AD9CD5E5CE4CAFC904F0CF746AD5CC685006796C3E4E1EDA36F00BBFCB40F90C7A6DA60267D0C387B6E66DE7017A01380ECF1950D4F190A2906F9DC568A8AF26F9364849FB85D056AA102FB42DF5616C8DE5416E3C2C66405B3E34B11D9C3785E8A2FDF2007DA5D7C52CF00CA9040AB21678F62F182B4E72D087F9F623480B8C9BE62348F00C5B434800238763E1393B1E941F41BEB3235ABA453A7318418C87399AAF884B8002125A5E4CEC7686D4DB2FEA03429D59A36C790163C71AD7702C3CE4C336D5A1422225E61AE0A612F105DAC60888F2EF21F70CFCED47658F47257DEC85F960ABE52C185920371B11C64213A4A053C3D9E2F183BED6E64B51AF77B6EAB099D56B3128D0BFCF3046FD91D806DC802FE6A46EF5D507E07CBF9AC1BE1DD9830C502702BED664D8F48C7E07649F8D158CC51418B330A24CFDA103E3A4FA02F2B61CCD9F8BD00BB932C8B2658384024701C7A7431041333C88B3896DC570459C38460A8CFA39EAD576E6507BD0DAC678682EC6B9D9C13203880D414697D0A70F4DF720A4602C1EC07700FAC76EA3C6A2F882C7F59ABB411F015E4BAD0663E3A1493512482EEA8CCA2497DDA8C367C6190B6778AB05D406301672C597186ED5200EA5B5B0D4686E79D04BC5380D6023EC810DE377DB9B97578307AA2D41EF02CD31CE0EEAD60628EAEA20E32A8C05FADEE7234E11EB20417DE341B43A76733D09D3C10F0978A08828678F611F3D45C629ED4F9049D09A72165B07D770F004F8AEB5271C65FACB0860A0B68C71B80A232403635082BECE6BB92AC4EF831E1DAF4AC02F4B7BD22D808C3604467C581FA02904F4571B2080CEC8B69BF02FA2EB9755E0E1D680C80B2C4C5C42AAFE88040B596FAED1EE02A5D97606A40435E37CB2092C1FB76C9DF62407968E302EA08579CB029D9E80C55D81EE028C3BFDFE466C8314001FA0676C65D5CF573DB0D25B1DA8021D97D1B6C5A06748753C033C6720972835B4351CF555E84BCA9F9768096E179AD80BFCFB906BA7FE04E8D1989610B5BA083CECD480D7742C28DC4A8C1700F17E84EDD6DB585BD4E67A16E46EA5D75BBE25D98E87D023FDE27A900368B5729E97053D8CD20B96EB8B5E05DE810E03FE3D01FF36BADF42B6895A708BF6B50F7A167000DC3B55B0076B6D0A7A0FA803EF0724A5893CEEA1E7508536AADBB1CC3538F884BE56F7DB0748C5498D5BBAAC0EDAB2B3D6815A03A485E336803C80A682244EE44101DAA7E380513458A1348E07CD19686CB465557DCE2866B60B70C90D1690F6D4012B0352D440DAD066A1B5AB3E8DABE54F20474065875A35A0E0CB7868812D029F78D8798216B680F376171AC70D251C74882E33CB8F7CD16C855B61EB8940BA5E696D890CBC038A7B6013B4FA2003ADCCC632B30DCA7C608354333E822E419BD569410AC88F0E54D19EAE1A30BAB854D0EFA0999E403228D707B5EA8B0ABDA3E5999D67565D23DD87F63DE0367CF67AF9E6830AB5C683F66634449F08FDB9F60C4A737EB5FDB1F100D667A351EEB0D6027ECEF1A2C7719FF10374420178B1A11A70CA64BB371C801E064F06477CADFCE28F7CD089C079F445AC178DA583F7237A4869DB977BEE53D0B6573E6F06B5720B348E05F205908A2097D60A46D25EDF177C72EE9DEFF1CD51EE3630A2615CD2B9C1D003DC16B791B94C1607D4AB3D9CEF55C8C3866C49A541DA0A01EEF7C96843B2F86C4FC519CE01D0F48A064F112236998CA6905F19413485F92DD2DA906752C1D9BCF154B448E5096A428456C3980EE2913A7809E0E920440D67C36A4F04FB1417EEFA581EB80EF9592C37DAB07722B59E1037826D7C21350F9F3642B89F920B7C1AE0AD905A0B701717D812B4FFF45679C08D40C93AAD016D4C11872FA40A7E2C012AC0875431E4EB2A18CBCD10B2BAC1A706E50042C5C1F24F883BF40CE837025110606D6309551157F804C81EB6A523557411EEE90D9C320809FC3BE41B68E947840D32F682B8908A77B826EAB90DA30568329106C0ADC07A4ECCE2FA828238AD49AD10F2476A99A4EE61E45A2652036359F6AEECBC4FD93BA90CFAD8D7A02D318A8618B7A3885BDE975B7CFF48C42EA596B0BE9B4C218A96695F3E613AC078060E00A4720F31021AB60C375D1137DF09718B10EFA774AEAE7E7A5251A0129D31B3AA4456485711D90AB1086D5665D283918F12DE43FECA7DD2C1159D6A0BE592CB004877166CAA22B60037283120620B398A93A004440A2C61854A264A6C6D4ABA543A0AC8798F49345905F248C8BA31152F71CC9C9E3C2AC0519C35A0293289BF3776DE5BEC1DD01947B95261F300889B519B6E9D4C59EE546739F5E3501DBC548A0D22DDE9170FD5D1B87D2F35A5C65C7ED07264DADA76C866D4AD2AAD9A3C7BAAE06A165D9C9EF571A6A17B7A5253708655EED614A541C4C6002740B0A4386BB468C9E94606D4BA158210320DF056C4CAB4700FFF6A80B158171B33321D35A095CEE94995CF2D887C66BD416428AD4CA185863825A26C815952E05D6CCE44A4592974478A52271D6819184A3AD585C4776EF0D50ABADE466B94A104911D49C459267856EB38772C6E90AA7B09AA017EF77508A4440920298D1AB62E8FA426D4C3B99ACE66843549E723F9A2F411A7AEA1B4707D0221D0A57D42A96A2175F7BCB53140AE92E914D31AF2466BC9761FF866741A3AE743A332FB486C655A85B183EFD0638D6E5D29E875E2D5C54E332BDB4FF7801BBC43ABB41E72A471DFD9C8A46616C1667506D128C8F38248E94B36D7960A1B023E5165168B9464B0FF1BF0C38B3D4CEB9055EF69D06FC8E32D5A99ACA5E7CA5B754B321F819B60218E9A97F16765E82C11EBC821F00D0C59345E69C8640A1CDBB47AB8D43615830D346241C409AC01690C07F9E64C938B104545ACA6D571686494D736281D1527D8DD413F959FE9FBEEA6969D4FA9126E1641BB50AE80B7204F6ACF6DB495FE0CCF18629971ED994F9955D24D85CDEBBDF5F9C6FE90777EFEBF82A63069C1D5D6BD5B79D8CA0EDD1074209F7EBA0C5A7546E89C666C5613DE5FE882D110B536D8B221EA68F01A7AA89B7B1BF11E753568FD7B228FE0DDC76DADF4D6697FC510A4B35CD5AA35BAE9A892196CFAE34F612B6CEE751F8232AD2CB23571B45ED886AA30BDDFA5367F045A9A156E7248603FB66837A925AFE19A07F378409BAF38DFF073077A8B7246460B93417DEF7B119D295AEC0DDAF426B534B8D2089F4BBA8E29B359EA0A9BAD06686002C11FA35868745D488E4290A98DDA8017C15AD8447D03FA01BE0ED03A567077538B7A760AF38D2A7DB48F39A406DAA2E96DEA19525B6E623EF510311FFA096D1C781373EAA7403DC40D3D14C6E3CA06CD43C8BF01B5C00DE6C9D44A68EBE9A70511325277378596A145DAB25460B86DB1CD16E2443FE845E0F60DC6279D3088138AD386F4E833436D7C944AA491F1ED47508934A26F895E80422684AD9677E9FFD4FFB0B04F474835F364A0079ED00F5E50CF91886C357E033D5227C4603E127AC81BD1C1BE6AE020626B0F5BDAEB9C7A832E57CB3806B6BCFC02B9C05A0AF90CBEE51B7C782F1710B7C37CD8E582CAE5B14FC744097DA62C7AD6D053F7CCB79C28D46BC2BEECFDD14884C99B1F8BEC462274C918979C95202281E8967ACC191CDFCCEB6A0563838ED36794BC1652056DB4E9B8EBA364FA383E633AD315532EE132F3EA01E709F2AD866B9B64CA74C86E1BEF6A21F2F917B70B7F42FB131AFBA055629BD02BE19EEE7F11DCFE84F627B4373ED7E9F02846EC82117695897F194878C148A5D7BDBAA73F2380378C05D78B6032FBA90C3C04C32F188927B2BB48AE31919DE0C75F8A8FDC54F2D6659FF46ECFBF2693F4FC282D2578FCE75C35FE8B0DF4E091A56EF15E8FE8BD0DFC7A06FE83EE29A18757EC073F054BAFFBF16215BC9536C3CB0ECE9ECFB71F00BCE3EAC0A2A5E19D0B1B535FCECEE9F1FB99811750B07B8010B3C623BD6561AEDA2BBC7C9F9D2665C7957863586BAE3ED123A7A6B7846FE7918B192C636908E6322504107B21D6ECB0BFB7E447FE919B785B80E5A8BA6023E2D8E264C52E7658B8C6DA7456DE3E66C42E0D4084B082EEDF4F467363BF2120B84652755DFF761301D0643FA1E2D891AAC032F751D50CCE0D261EF4A704821B58BDAF56369B082E5A9255E0B18DB714D0CB2458CBBC27FDB361263D4CA62E05DD81A280EEE323FDA16176E34B701942701513BFA0884924432C89259336BB4A826507D715DE51EEE001ABC8355CAEBA98B18C702C482AF482B9DCDE240AC16DB19AE5268343D957FBEE9B8BFCBA777091707071053B3906E96670E2EB17FFF8FBCDB1D028B2B10B9DDA0076177B41E89A2F407E369F392FE462F76534F4802BBFB2E12ED0AB8BA2657ACEE2CE785C42FD42F93C5B2A44EF35BA4E47F81568821DBE5EA77913F472212E1AEC72A1839A004BEE2894FF07504B0304140000000800D26BEF4AC09FDC0953000000580000000E001C0050726F6A6563742E706172616D7320A2180028A014000000000000000000000000000000000000000000B3B1AFC8CD51284B2D2ACECCCFB35532D43350B2B7E3E5B2090EF60CB60A482C4ACC4D2D014A2A0055E5155B81446D95CACBCBF57233938BF28BF3D34AF492F373F5830B7382538B80A6E883542829E8DB0100504B0304140000000800D26BEF4AB8DFF246710300000B18000011001C004050726F6A6563742E6D616E696665737420A2180028A014000000000000000000000000000000000000000000ED985B6FE23814C7DF57DAEF80F2EED6098EB1518B94C4F60A6958554B679E46AA4C7099CCE64213A717ADF6BBAF43C80229D0025D6D1F7889143BE7EFCB39BF73625F8DC7C371FF26CF7EAA50779A176D5EA22CFDA21E557C6DB12CD563F9A8C62A2D221D3D2AABF39CC469D1AF3EBFB69E9E9E2E9228CCB322BBD71761965C8E1FE2B1CA1F557E597D610D7EFDA5D3B96AB4E72AD7912A168DADE6977A02BFCB445D5B43660DFE82760FC9FBE904A8104D009ABA0E98486803EA5004898330B6E1DF57971B226F2A574F6BC0D9707CA8E5379517665F46F267965B0378AC79949E62EE97513C3DDE3CC89244A5BAB01A830365825CC92A3898D466171D6863603BC0A1B776B70FBB7DDBBD30CEC1AEDB03D0EDC38367B990CFF2DA4723C66EBF8FA4D647AA98B5CE4BADD6D40E1562AA08F3685E2DF8D80D13599E48BDDC7D6B606FB3DF6C6BF0586ACAF04F396B135337AE8FF3459669F843E517535D3C5B750F4F75FE729345A9BEB66CAB73B931D8BA6EAD1A64695AA33F92A9E9CB8BC664D1CDD43CCE5EAAE819A6F7597BE155065909DCC8DCCC4AAF245A335F5368F58C949626B8E4EEB5FD6BB733AD6CE97C9D5C042788F92E0134C03D807ABE0084120E884FA92710E704FA3B92CB5BFA75C035B33E4E6333D96C0D9BF78BEC4D39EF1459261E7492483BFD2CCD4E91FCEDEBC29D1EC7DC758C27B1CF30404E8001C5BC0B3C97512EB02915B673A43B9791D922191F27B625A59CB209AD72BDD7C9DBD3CC26830DB6DB866F3AD7C757D3A8B853CF2ABC9B4BFD6373456FF0B97F61B5539DC0B3914D00F1020A10E31EF0390E80E0C2EDB21E822E227B9DBA7F8CA698D5BCBEB23B5A77A78F4F931DA6615C4E4DEE646A52CE5899CCDF607ABFDC1FEAA18C72B5FB67E23D22ABBFC25354BEC9B8FC580F980A72FB32379A36D9AFB20F8AB562B90CFD83B088B3D92C4A6777714DE6C7A2C15C0621611430241040D441C027E6B78B0BD2EB22612A580F9FD138A3F1F9D0A88A4534FD681E04774480200794430110672EA0CC230061438A200251D73EF370E6E1D3F19014C5437C17A585FE6824A0EF0441D08540045DD7940842CDE10631604E3DAE1FB8C4F6283A237146E2D321511451319D2C8E15651506FF41B9F068CFB189610343684EFFD011E664E174AB83230F021F5757586736CE6CFC1F6CB4BB56869B7777CD5559EB66B275C3B66C7E757BB79A5E757537F807504B0304140000000800D26BEF4A9DDD9D0CA50000001C01000013001C005B436F6E74656E745F54797065735D2E786D6C20A2180028A014000000000000000000000000000000000000000000958F4D0E82301085AFD2CC1E8A2E8C311416EA0DBC4053A640A43F690753CFE6C22379058B6C8D89CB37EF7DEF655E8F67DD2633B11B86383A2B605356C0D02AD78DB61730932EF6D036F5E5EE31B21CB551C040E40F9C4735A091B1741E6D76B40B465296A1E75EAAABEC916FAB6AC795B384960A5A3AA0A94FA8E53C113BA77C5E673B8A09D8710D2E5B020813F15C0B8C7F45BC0CD2C43F2123EDA831D22F8C7F7E6DDE504B01022D00140000000800D26BEF4A1DE925BC7D350000F7AE00000D00000000000000000000000000000000004C61756E636865722E64747378504B01022D00140000000800D26BEF4AC09FDC0953000000580000000E00000000000000000000000000C435000050726F6A6563742E706172616D73504B01022D00140000000800D26BEF4AB8DFF246710300000B18000011000000000000000000000000005F3600004050726F6A6563742E6D616E6966657374504B01022D00140000000800D26BEF4A9DDD9D0CA50000001C01000013000000000000000000000000001B3A00005B436F6E74656E745F54797065735D2E786D6C504B05060000000004000400F70000000D3B00000000
	declare @2014_bin varbinary(max) = 0x504B0304140000000800956BEF4AE55661A34335000050AE00000D001C004C61756E636865722E6474737820A2180028A014000000000000000000000000000000000000000000ED7DF977E24892F0CFE3F7FC3F68987D5F574D1737D8E0B6BD9B12E22A834B9C86E979F5842483CA42A2240EE37EFDBF7F1199A98BC385AB6B76677786EEB2501E11919171E5C9F57F3ECF2D616DB89EE9D837896C2A93F8CFDBF3B3EB4AAF7B253F1BDA6AA94E2C438042B67705893789CD66939A9B9AEB78CEE332A539F374F7ABD5355C8091AE2CBDC4F99920606DD7786CE837894FAAF6A44E8D2059720D7509B82AEAD2007CE9423A97C95E0A85AB5CE6AA58103EB5F64AB6D539946C05280F42745CC9992F564BC3E5C52B95DE6E8930E7D796BA5C06D9F0AF51B949FC56AAE6B2D50B494A5E142FC464A1285693A228C9C9FC45AE245E667217B25CF83DA81572A7B75DBC4AE09DEA2D5B8E6E3E9A86FEC975F495B61C040CCFA532A95CF1A20C8C0FCA3B9A6A1948523693CF07C9F7932F86B6648DB85357B63633DC2093E364A414C364D7594225407567AC0DEB261162E124882BD3826E2AECA6D7FA942705312B962E4B7292E473F964A15CA926CBB98294CC56C965B12215492E9BFB3D718B95AF39C285E12EB798C0E03182397D55C79DAB7EEB13B7A5EB74B452040C2BFE4975A13674AA77CB001ECC645987842611CD028953197F4AF174DEFD65B15084561692F9EA653159B8C86492A54BB1929472C5422953B92864F2E5DF6335A33D62E8A6F7D90099F8BC5097B3C4AD5FEE00575E2328CE33DEC0816AAD8C4811D0C62B6FA16A5066E11A1EEA5EE2F6002B017BFA10C3FE1B9899BB902E4BE4524E968AC56CB29005B6925219E4265FB920B90A91E58CF80D665ACE746ADAD3CF164AEEBF3C430B854A31972FE48097A08305512A274160CB494904712D91D265F532FB0A4351304DFD5F9E8B17652957BA2024992DA38E97AB60D87297E5E4855C2685CBCA454E2AE58E7371EE795FADCFA6ED2DFFE519592DE54A152927258BD9A2942C540B7212382A25CB172291F2954CBE92BF3CCE48CF333D7D42CDE50A09F8DF219A87B3BCD06B0D54D7C480C013D261621827C49C58981C65523C68FAB5ABB9E66229F454EF2971BCE3C2C88395DF2B5E313C9A41238E6330FD9EBD2C168AD5922C268B993CA848AE2226C552E63259AC962B44CC4B17557947458E474247E809039C64F6A88C1CA3B33783C6EB75D35E623413979ADD0E08321860149FDB5028AE190A1000CC0CD3058153D0FB5CD43293CB4C21ABE533B9C2E363BE9C2F3F96F58B42A970A1652F8BC544B4D6A0DB232DF58BE306D15D7E3FDFB423F99958FE9D6A4F57D0ED3709A93B53DD452CB3038DBEB7AD6DD0C49BC47F7031B9BA8A071F1F7632628E349AC99C422425347091C4579595F29173B0B134E6D1749F8F5CC34CC3FBB56B2C97408A97F2F89744BC826C6B1028DBD39B44BF572D818AFEF96F5285F4C8DFAE63E3949F609CF29360F8857F323D27592A15CBC9EC4F74F4E2A3A99AFED8E526B172CDAB00AB20AD5CD7B0B1EF1FA1CC4DE25DC5785457D6F23D8F657946A0B2FC9DB7282CED6B7A3A56212080665FA7A3F4DCFEFDEFB7B4B8CFB2EFE565C7F09C95AB195E0A2CDAF3F731920EF842462656CBC764898D005DC759B2C6FC39991418F440B3411CBD07A10B4390B9CAF3D85F2EDA020C6BA2C9BD99212C5C73AEBA5B61EAA89627388FC272667AC2231D1108F06DE908AA65391B41153C73BE00663FB4EEFC7C0666396345E78EB7B4B6C26C35576D01CD016A448A62991AB6E152E328A8B62E2C54A0C79E32740607B3061D72569EA0833D109660B33C41750D41776C034AB9CE6A3AA3A5D19C498E0DCC023B2F6896EA795094C180EF8E66C220561736E692950FE1A5A28D979F556CCE55342D954A09AAEEA46C6399C666CEA011C03AE1FF091E632A14E0A207BDCB72059B8A00BCCF4D703D802771BB349E97E960389E4449B84E07356E8F8058FB0330E8A6138ABBF42571DBDD7A2096A950F0500AFCB70E2DF441E08586A6AD3B1B2F85233EEF0336E704441BD75C7E13D190167A1B22DA330C07EA511614628D21C22D954194A8AD60392027DED20571B94EB3DC6BCD99CFC14C04C55481A75CA7FDACEBB41EBA952822C9B11C379BA00201CE84515B71D50D2048D1CCA00D3C35712B02D6A300457339571700D1EFFE9B84BA5858A646C53DFD9C0CA76540AC520EF579A9896983D6A526AA675C14A2869B73E06F2C8702659600441A222453B5CC17F89A6ACB3DA18AC1CEC6719F0406F5EF3E87FCA0E908C90DCDB18FB100F3F638F0C6B66D9786EABAEA9B9B477B192C070D066DB4CDD0B5084DA0E0A8D5F16DC6290CA0087D89E81D179603EC8A7E0263E91AD422A9F656B057F3092808109308C43A21B820F2CC1C021797AA69FB36938140EE3302C1029AEE8E3D52B519B35500C5AF8FE462AD0FD46CD2AACCA0621930D84EB420B7C6D04D82E3065D96A20613CA816BF5168EAD339BCE1848AD27A3D85B2D168E1BD874B4608C548DDA5AEA3F8E9B61D5D566264E6AAD5CC0C86048DC3453F060C67F0A9150CD455E46441A5BE82D1D376ABB1920BF29507A99DA75604126405C795019A4240A964986C738B8342CCB8B40DE3795C20C380B0CD28D0536DA5BD2D25CB2055F883416A880B7B31D9F65C031C3F64CEAF3C0EC018BA7E6DAB04302111063E97C057027B43D82AA41D7A09FB7B6315FD47640EE93C25B6D09F5D98068DF4363EABEC5065E5B96EF9F41CEA0F91090BAB434F3308206EE9CC1C1042AFE5C0919124FB0804FC0EA89018142AC83FCB65FBDB91D7E4C80EC12842BDAD5AC5C847B41275381896BEE956FC4BABC18C59D62739D38424C890C1F7B04E9BB50A8D8CCA01F7D3345717166FB31DAF737DA73D4C50F6F726705D6736E1C6F7A17B1E29F3FDCECEFE9E71DFFF0B676C310D389BB855DD2571EF31C9C19B8040131A48DB3FD86958AD9AD3FD2D9C9240BC49F3DFD8A8787A60E611944E8097F78C3BF5C41999BC46CB95C5CA5D3B854B3C9A71C779ACE6532590C3459C8EE179E7BE806706C6473C05EC8C82438AD2B289764A57CDF4AA9302C03FD991F1F524258B1AB8687C36C18F1DC2496EECA888CD0B122C0042FF58CAC89BA4E9A35734C0D2C96FA7CAF81D5C3219B3D715636306767BCB94F01C8841A25320EF820CE4801CFF8BA0296EFE71EC445C5C78F6968751A4D60E862FB9467129119880056FA5564141568886B4E5620710C19FE3D84EB00F443D5E920E1FBAB07E38C1340B0D61DE335CBE58CFC566FA2339F4FACEDF7F5E66E23409B55EF0F30E1D42EF8810CF8271365AED9F7183CA8D64D227B88770711F0B8F7ED2872FF68053AA94D6FD2A95D88F91FA266BB500BFF50C10B4718FFCBA4EF478A06C4F6C889AF2B1346083F8ADDBC16F571A14B3C026A1F086F1FF5D12CE1D569210E86CF711C9A230A47AFBBD325C7678B6250E9D4D11BA0B831B9E240FEC08C923F898E1B28E0BF0F82B4B2704C78631BABA5AB5A1F844FAB0904881F8D6DCF7932EC9BC9E5A55AD48A17D972BE60644AE53751EFCF4C9D4EFDEBD354FF40EAE10DA76EFFD034F3094B1F29CD5B00901F3EEFCC29137A8E6379C14A4901CBF359F79EEA4E8D251807BA7725888079D0CBE3D89D3D4A3AAE7DE0D4797AEE4DB01A46C4F970B29F2E01D65C67B588CCF8231DA895B595A97BB7BFE533954CF6A25A4EE62FF3856441CEE793A474914D16E5CB4AA95C96B3A56AFEF75F7EAB12395390A54C329FC95693D96C259F14AB053199C9489942F5B22C5745E9F7A06B42F81C2F8C181ECDE98ACF61C39B6EB2853BE1A7FF7817CB7CFF93707323FCF49390B8AD1893D5F43A1DCB0E1A62A94B3A9FB503CB4F8F8021F656FAD407DA78568417915D4BB72510D97CE63293A7AD88E6F0F26C94E127524B114F8AF318DB7FFB5B8694CA25E04DB25C2C89C942299B4D8AA5D26592907CA9487252FEF2520CF946EB7030F7ABE5624539797B674E5C18635FA72369BC14592C2A86674E6DC3AD3A16EA4AB898729DDECFE5D53AA04CA81474F9F8F604C5B84EC7ABF8E879508B19A78189D5E05098EC07B3913E3FD705E4F1914C5E15179F88052DA44EA598CD5DA7E3497E83C180596BC3C7DE311E0D179D6A636A3BAEB18383F83E95236B991E8CF2B5D92D8EFD80133F0416B371FB5A1A57DC537485EA094A3A6F2B7DEF6EE713B0359CE45852B41895A5C79565F13251D9BA5F2CCDB9F902F9AAE50190E03D26A19FD4E5EC36F5EBC4B47FA5107EF5C59466F0A2B28D8B597D7BAEDAEAD4D069415CBEF5411FCD0F687D346D9C77F096AABDF46E2BB2D8AFFDD2EB104946C2E3993E4ED775DC8E8113A6B760D4E78B25E089A4F16243D5B50113DD4A785BB84EC7DE7F5C277520F0513DE35837713E1CEAA780EDAC2BBFD90B1CD37F4B3FFC0FF6007AF9986F0BF45068D89AB5D283C59930DA3D5E2685F33B27158CC53C27D578985BAF978BEC2DF1771DA75ABC077ADD30AECA9E1C5881D32914754D2F654A194D2B67DF8E3FDCE5F223F15FA7E3DDB6DF8B1197151218D920106909CE4CE2F68543C57CE3DCB01F1D08EA221376DDD5841A39C9D141E0FD377F88C26106123C9F18BA6EE87EFC7B10D7CE9E8510558D2D0B38EE2DC6D0E8971069907A9D0E0B0475705F352433D5BD0D41FB4C81C65CA7E3857CDA77893D854F0711449A40564B0730DDF6A8EDF1DF82EC8AB1306C1DFC6C7F013E39CE08340BD1DC232C6EE3068543A4ED6FAB39C459BF541797800CE4F15BF81BE03881BD48E8292C3D04F37B39BAC7831399BA471F53E7966ADADFAB0D7BAA8B3B68387CBA9A45472082BBC29D6A8F74014FFA8BB060816DCA9FED6FCCE902268F776F12FFF1AED5A5231ED1B4D151BDFF3534466CC3586AC946468109E17565B65E083EC72777607A2BD5EA2E57BAE9842DAC5AEADA71C3FE11F8218093063EB1B5778E3802AAEE787C631F6E83F3DF12349D6F35034C629E5C40B04F929732A1BB9C2F92E57221932C5E968BE52A29122973F97B4220E1D20FDB72B8F2601C18EE9F837E137AC67C01C318C3435EE1FA08F5D068E4E4678351F297FA4779F4F9EE5E22779F5B44AA37DAF2AFDDFB6A6F483A72C8DC5FA3CCFA350B46FDD7067A6FCBAA98EE5F7EC591A5BD4E19CF467CAAE81A5BE60FA7C37D90F1329C4F9265EE4DCE61F5060A2F9E1B01E5ED36BA9FBBBD6C0EE2FC9DACE824D3618010E9EF746D20B77B9210C088494D90FA07E71562BA75E2D4C15F5C638A63E1BA612DAE0450A4251B74D27D020E5528B6BF55580287CFCFD27FA50B7B910DA46C6399276C9D15D6001ED001F1DA7497D0786BCB569A17FEC631B6AF42B5713D1017CD41904C6F46570481E4BFD22D0DB89E1E4A215DBD336D4A0BEE93309E97B8720D20805A63CAE162BC6082CDA7455CC7121E71155BA030E91FF979C1D7050507FEB8026BB9276C66A6361366EADA1012C88604580B08249FB9FD30D80E33BAABCE5B181AC885266CD42DDD80B1F20C0AFC20258F868AD1891736C0F4A2DC4C097F4D9F9FFD05CC2823059761E19DF74830C8F5CECFD85A288BE37E89BFD28831483B144255969EBF94BC5B371644EE01365518497A4B53DBCBEA411FFCB24BBAED132C9C30023F3FFB8D49683A9D16AEBDD51CB72FDE8649A130FB5B2140E7DCADB0704C7BC937BCF0ED0B8CA32941A838741F8736035BC57C01DF74E38F7DBD0F2102E8D9858ABB3F82DD9214682A42553A24EB4F7F3BC65954012F12A6A6D09884AF3252FD09890E46E07F07700B1AA722054B53B5787B226DBE3ADA937BF8D0E4777A2C816DC5A62BE4A28AA2F9A7DF423BB0A3EA7DDAA10705771D6CF5E6DB3CF96E7CD051DC404A518570D124504D803CBFA61017F70FC2A3E982C5069B070A116E64098ACF540F0C8201E0317244CD8AD8AFBF0A86493516ABE026157FBB14B51A7C47CCCE0E6EF4F874A8861D7DB85E0C830F84CE2C1F82F2B8A7BE1FC24D3F48F066665022011F4A219843378601772208B661B09D5B74CEDBB7B03E1B40868193C08258EA07C143DB1463A766391E4F32E96817B4CE798CE163CE4760DE87ED9B5A2D7475691C611816880138CE0E8C3938E37D47E0AAB6C7F611A124C9BA09D12ED83D342FA918D4405402B1DA9715876E55A6BA0D450430390B2F2584A742D8FE3D8B1A615CFA483AD092389AD80BDF248C9D88C5B1C31E5D671E91D7AB5879010FD0F64C8A1A34947EBB11DEF9A9EF0554C4802B7FE303ECABABAE5F3AF1F7143D25F3CB4934A12C70213A4E511C63DF33DCABABF9B64B97D5FC0C1F2D109BB08D0DDB8C93388D881DC62C58D818F6D20E3D6885273881D8D09135F0BAC795F094032F78982B2753C4D72EFE10450CC637283A91200F23B8A5B936FE51A4D58C65D7C741C97CF73E4E28860F11FB1EF3C6416ADCEA574DF7A8D9C7607BE905CD3B60E6772C208DE3C0B21B4155507A7E224658ACDC051829EF34BD7C6474013C0367E618C0033A20534429688641A7F0DE654B1F041CF642033C8172C94B408AA8F28DB6F802FF32EF4FEBE3900ED30EEDD909D434C2E2EFF20749E229081EDD1D352D86EED3F701C48BA237C8145CD4FB37510BF1289DAB3C85503EADF92E5B384865DB617C43CBAA1920796C2BAE692F56CB23BC44317C9310BE127A8087B6D9A17A814DFEBE1275741DB0CBEC8809F0E2504D3ECEA01B8A0F06E08098F9C3A5B380782CD6ACC4D0719F9050BA7B500AC1B77CF0C03D680076BA86239D04E5946E4088619D28F67C93A32D90CA3D1DF7ECB762A737F9964A57DD4428BAA19D1C26A04F52D1615744B02344A3DB2DC2EC7734904497ADD2F79DFE1420E28C009F6F81B8B6DC8BE17B172BF33E46CE0EB474BAEF19FEE8CD87809BEAB1FB6854847BF23FB01D9B2E5B35D829BE2FD0C7DACA571D226D8D91166FE9377A45A047DCF67BE4FB3AE4938B029E7A3117DFD325FC54051E83C33917EC0196F43FCCFA58ABDEC4FC57CC4644CBF747877E327546E06D678E4EF7F28306E24E5F6CC9AE9E0BEC7C6518B5C6E608E2604503941837CDC3D0DD0EBCFD3244F681EEF70F4F0180BCF8E3B28EE1ADAC25C67110F8E2EC0504902B8D1A58300C8F6016F05CC54E331C9C1C61A6F103CE3C40E16A76A7507428EAA72F5C734D312CD1FE082C12A47398380859D103B920261807C6F26241C429403E8347FE3CF7A6DE1F8306505E252902860D8ED78EA90B381A7E177186BF450BE2C7F7600B0E98BFC743A5B01C0DD1D1570B0BCF8C5709B2F6EAC61BA2BA27B0023F30F28F27FC167FC50FD76B7E5C98DB8D8341B47FCD040F59533D8761DF431B051B3BBBFC2AF4F8152B6F46123B07FD4D44F1EB47DE822C3C45FD1A92C865126F017EE034F66B580E1DDE3E886E1F21CA508A2C7009859DDD78F75F8944E2B7CCEF89048458BF65F933074F08B82247C77D49F97080ED8751819CA7D091E17C22B426DED1077881E5893B5DCD69447FC3487D957B5883DE9A60B41D36A308D57097C091B21DA00182CB25289CADABAEDEC0D8F26D5568ECFFB62A6C19EDF53A8CFAEE726B21ABB85D8824A6EAA6AE1BF691DAE06BBB33C3B2D89D0D08816E6738DC2B29B6C7A1A39A186CB0F83C24EE5005D600B4A11D3F32FFF906C79E48E46787E67E46D34B77B67A87884C51BE1D0341475E710887608426F4069BFD0BF3D8474B1ED1008BDEB2F55973556FF679065D6481058D0AFA01ED02FF986AE81161DC558740AE8FA8424A8418832FA8E2F4D69D691B87459A95E4BB4422050F151DAAE612B4587E368F351627007021E006BB008AE132E7E1828FC23B5AF0064659FBD9071C087E76E20F3EC5C0A6E6589A97EAB240E4405B7FDF4F322CCF3888FD30FEE0C8EF12E3840328769A963DD0B4579A871F0E1B67B6E8A2133300EF3A344C13909F00357104F581161E6FE5E98450F15E2D0ED1927B7F251CA3063FC88C3F33B6A51A5E7B6559F7EE108FDE767101E5DD6EE41511F9F74778F70DB2E3A4FBDF7E1612BFBABFDA4202BEBD82F395861C61EDEFC744259D56A9D743C5C590504054C705E6151EF178F204D69CD49B8758B28FE2B8801D6BF0C149AB64F68390902B8D6EE2838F3832B5F2FD4A5E65438C6F2BF9CEAB86738EC23BF95933166CC2EB7987970778F8CD9619CFA916981C889562267B7F0AE987B4104FB56F68541E34E3DD410A7651EFF0E2114FC258DF8EDC17290917618EB88F8AE92D0EE5C61423F6E20F9EE8B0E7A077DC0B813F4403D7CF812B8CC6E5BE6F8FA6EF947BA40E3336C48A521C0CB0DCECDB8758D95387589C16DA603E56A1744118B7B050DD135DE54EEEDD7D46D9A21B42409022491256AC3346D1EC7D45FACE51DC1B42757CE6F743F678EFEC750BCFD927389DE6C22B3ACFA9EECCD9BC4BE074CD81A601A3A3317EC0C55FF68B9D1EDA63E9E321ED6EC9BD01C0C1826E76277CCC1E2BB147CE016ED0760A5C3D8209F568C5DFF7F58B4F4E50353B1A3CBFE3B37A1EEE71733F08D19099DA3C82E203D53E5B10191E579E6FFB790A806EE2D8755F076C0EF7D15C1C69501A03B163E50EC797C76AC0D73B67831A80537CF43A9277093A26B84A1C72AD47C3C1BD48E2447277E1ECFBAC1DD3795AE7EE0E6BFE49FBD60F36BE8359C79D8ABFF01273A2826E6896CA565E4E9F6A35ECD51C79BA367583DDBF6303B3702B9CE0CD1C77896A18DDAAE569CEC2886FAEE197BA2CD96AF7CC88637199DB8FEFEA89173940169DC5DEA85E70F9892EA8ABA5132CCA9C30934A5B16E3D0D13EE7A328305DDFD86995AAF4BA683419407FF4F5210E8D07336F86C6EB45FA3C2210F1A9F43F8138FCFE476FC5C3ECD73614662FEEE4938F2342F964F62281AA6AEBAAE5D880636B78EC80A276E51F5164976868DF387A88BDCF57DFE716DE769E49674AE939D8AEF01A8EC9F71D5F145CC6FBF0C2496C87173D6AC7DA86DBC3AEA16A70DBA9BF39F94F2CD9DF3A7B3BF7688C719D8EA506E570E078FA01B6588D0006869D96FA867370BB950248BE54E8B7BF5D542AA4582A17931797A4902C5C882449F297D964B9286673D95C3157B82CFDCE4085B59029E9835CA1E0A39BB8E318239BC54F3F289B0EC154BFB9213ED8C87F4AADDD131CA7D4D93989F1B62AD1EDFA6F6AD64915E39B84D36137453BE43A1DE8E10FBB51F32099AFD894E826E5743AF9433FE767E809D04D2403AF714B13F173CCAD4CB6E0F5968E63A5B068505CA2DB4D3DB6970F2FDD447ECFD52D0CAA71A39B69D33BDB34BC0069A6AE4D3C91401DA565E1D6040B37B29B8F0134B63AA9D37BD0C08AFBC8538CE4F4019A7F346BCECFFEE6DF1173254C2D67A25A5757FB5B8253687C080C95B730BA01FFB6A04B973C440FF6BABE8BFE7403DB198E7B1571F026916C299BBD2218ABF56DB67CFB898571081A8A743182C0FB87F0923E7867475A4FB30BA1E4A502C983CA9FF931F777EFAFBE034A42F899496C829A8FF77F7FF3B6E708443FB488FE35EDA5E1024F21485271357B677FB07FF1ED5EBFC44E7AA6222738FC2AB81B381ACB84DFFEB603CA8F38F8991BD7DF991324D47CE90B3B1919E1C3DB5D03F669D619E31BFE6E553EF4E6D9B1D15E04185B09DE85C53B71373883FE3D1458B3A5FC5D028E4F02F1AF3F22703AE6444EB47BB13DF71DE3D10A3679C4738E74191D01724BC57ACD1222DBD4047502030CDC7CE4EB3BDD47C1B646A0F445EF89647B72112905875B20F00C46B0B33EC5ED2016C6EDBDC175307C331958C739FE4CCB96428BECADA3E0762FFC8DD0C48D6DC426F9CCEC994B0BE7854EB8491C05F40084C8DDEDEF12C70AC574EBB562F3856A6F8F17E0B739FC21822567B175CDE90CA0045F85FF1204FC999F63757AAEAA43C8EA3EBD423B3B46CB0B7089F16F9B8EEE83A4E7E922F202C282976B7AE14D92BE943C4234C3FBFE2AE62E057A8BBB0F3D928C97B70748C3741A320B6D7A516B98DA31D6A65F9FA68E9C15DDEDC74EE86CF15052B847876EBFD9F212DC0EF05DF00C0C75C9514C1EA3005C3ED3342CFCD35F7F1270DFE6CCD9D8EC92CCAB1D6FE9F393B7E21D0E0F527F05A6FEF86BC9FF1D45FD3B8AFA6F8DA242D1C330CA7FE35B61319C3A705F93B30A23A6B0F0AE15FABFC71DDF9E065CA9D126FA37B8F2EC861D72E7D1F9BFCD152FC295D779029C08B8F2FE6A0024FE03E2EC23870E0581E0429483B738277163B98E9392ECC6051A827FE0271C1CBA2F7CB580AF1ABFD0964D04430963A91D3944C8D2B865A4113D9AC6B83142FB48CF557132F008767093025FA20A2031206B53E52655B0CC277A3B34447BE8F26247C0522101EC8C99834760E7CE1A0F63B19EA68B53ECE89A40EF5B636698EF0E765736871D400A6EF84E43F3058746521F1860760C9F821A7483F3F7ACE6EE98232ADCECAE17C36D3B361E72A2B2BE37D008C6498C03819C1D1EE2EC0C4976073C718B15DAA9A0EFE1FDF0E8E455B847E53B80CBD30EC27E8D45FF68FD8F0EE7024E076C7AF73ECAE5DF0F11FFCA5202866E381C63677A3555C3A3DFBB8C0F8E34D2831B542376CEE71E53AF43ACDBB9399A9D4D14F1927FDC801732ECA4E25D5C464A117D8DF4E90739F55631DB7D3F6D548BAB4FEF22128AFBAAEC9565BD7F7F6CBFCBC90441AEBF9BFAD43A278D6A0EBA061048B4B4CEE3BB20E97DCA0FA48FEDB789B59BD27BDABE363E157058B177EABC5DB2EFD786EBD2D5312ADBECC70570146DA8FA4F9EFFB348FD06D7FBF070311D5659D62EBCC0F7A0C3592DBC602C82A71BB87F100EB9A9FFB54A72DC66FA3C7BD394CF71437B403EBC63A0623040DCD6BB27460FCACDB7A78FD82F16FC915B4275CB4ADCF6065F15425A043E32FE49A74B84DC4D89FF51C8E99FF333FCCBEA161E57D3025912BBDD984CC55E2B331BD4660B6D2B6EB479D9D6E6D565A3D69E4DE6C5B52E89E6B82B6EF56161AAC2BF8E5CEE356AD9F5F9D9B8D65F5594CCC7668041543A40508FC815D21A2BAAF51422BF877FA67C47140F8A3998D2F0B32A5F9E186DD3688B649F54F82B8670E4F0AB44FC7CF66911A5D1A785019A18160FAA44C0F00A0548BC0BE14E6572E0C3F8466AF86773A8C09B3E0C5A23A43FF84898204F77128B99F1C32C835FAB22E5272D509B32289CB6580D4AEB4AB3DBDB112597B58AF175847FB47DAA44FAEFFCECCE6E5A935AF90BE142C75ACD486D4CF7EB2154E5403AF4EAE6FCECDE7F61AD02287DA24AD047D5698F44FBE38E40D3A4C22138FEE7404B630D28481FB13B89F3557E014C52C66F56E79132405936EA0D78173719CEB7865301FE48F31236E2A3F68CA59C8F209C584BE6B5BED6EC02ED978FB38234A5FD46D32A34CD2CBE8853A40D6A55FC521F4585D241446F234EC51CED31F8273FB4868849B25B0FF4996F61777CAC0025358552A2E2FBF9996603F3EBE2BAC6E8C3FEFA3879C616396D624EC7EC1DB568B1B5A08C562B4D581A76F8625D4768B3968C6529DF82D25BE568E9EA2E64B291F7CA9E9FF1D2B5DDD277CA7E695EB62ED59B0BA2881B5919356565B0AE03372473543F3F9395CEBA8EAD9C6A0DD6C2C59AEAC6547B986C698FD4ABB9928950C5677DDDD8F8798A9F67B1BC31D0D644B8D311E422CB9C5AF553A126A1FDB05B0EA56BFB14A66FA2E90E4D17732597429B973CC6B7E6B4D11167721D5296F82E6FBCAEB49DAE68FF7564F9230A2E19D526DB1285307921FC29F327B6C6E99D9F49A2DCB8EBC8201D9486E1E40515CC293CA174405EF5A5D5D49C8C48EAA42775BD8DE6B5D8F7874215258BF73F0800CA9B646646B262411F358856DF29C1B8DE7C9CA27875582F9853CCFC78D79976A48746854CC58D9FCFFBD49C66590B9F388D8B751BF9391B6C25C422CA4D6DD6978026A09DF277EECB00F402B6FB63FEE9095B3A0DE43947731F1A77884F56166BB40890AE538DFB06342CCF6C4850E385D275919F6680B30EE7307814E26A1F8156A517F8C32EFE41BA899801FD159BCC8634513095465062306DA031450D6F87B6A4B51115314DBF6F0EE8EDA650D5669A04125217B76DE44DAD54A29A5CE71A0D3D33A13CFBDAA626B2D392654519920B902651939D992CD7C8D084B47165DA35510BCECF3E294C2BA45AE9914AE1C6627D372F4D7D196712AE0DB96EC42496CAAB095C01FB07B45547418348AEF433E60261586BD9AD179863E4E9BEE67DDA500A2A939742A8BFF332B3BD1FB5454942ABA4503A37C3C7691F99B953BA9466747CEDEE62ADDA05F42632403B8CF7EBA3CDF837654C7BC1E29243A8746BCFC80430AAA8CF9263107386BD06D6F2E39419FB17CF5DAFA9D5963AF83EA9B68B5ABE634DBAC5EEF8A1BDD61F9A5FC60FAD557F3E7899E407DB516ED01D0FAB4FE387860711CDCB2857DE9E9F4D6A96792789C3F143F3451D96579F7ACAAA251536775F88D790DBD949BD93D5E6FDF2643EC8EAF5E66C226DA6FDFAC0847A5FBAB94171502BBBE361A13CFAA2E5CFCF46BDC197766FF47C0F21D6B8470AF7DD76CF786867C6C34C948E973BAB999DD89DC5643808691DB42D3D0C937C0F5815C50EFDC75AAD58ED8F0AB69A8B3EBA21521F6580DE55EB85BCB47A2C0A03894609212AF86022B57F4668953EBAAA17744E52BB07AD594CE63AB560E423466C602321AB911DF4A00F90A7144723A30FBA7DFC2A4E6578FC0C8204D0A4B6049183190A1D525E7DA8AB0D5152D0D6552E9ABD16B87E0E47A2314195EA29859B6178694B95A90F817CF2F590BFD306B2D0410EFE30CAFCF0CD09B8214E2B22D076E700BA8A4E5A5352999232E9282278E6319980B39F8A6B3228C03B1034F2E049E664E648D214E2B1794982FC26D9962AF0CC905CA302BE7E2ADDE137783AEC59A9F3E7943F8BEC49FA628D3ED7EC2936D85312C59A2CC37306D0D8B7B458435C154DBC439A2A33F684DE1E362A40D9B3D8F1AAD254FC884F80F4280E65B98290A02D40EB17715892D0F64A2E7E839C12E640E03510D7FD2A3C97F8941003B40A20BA603B00A3D4122F394678420B244944EE1017A051BE897549F4AA844439CCE50DBA01585AC2B80EDE69102913D185E00FFBB4C2D31502A6E1FCEC71833656C130B082B59D0D2FBF015983E7E346EEE1D3058B8BCFF2542EE2B34D9A757C7EE2CF9ED2ACA3F48E6ADB4D7342AA2AC96C9A063E73F4C947048DD6680D4E11691DF250FB69F345221D2057913A4CAFA49ED41E818434B12DCD29ABD96C350A537981351D5ED39A4E6BE40B48E8547AE1356BB5BB8D08119A049691D79347C674A8D3D892AC79CDD9541C9019A81EC84F834AB12492AA23753734AA7EE23541E89A7D0CCD472613DD2745DA120BF9262992DD8CE3BC230DED298A93108FA9C57D4B62CF277C4AE49322319D91697C8A2323FAAD4AC4A70A2D29962AB4A434DA7BEF2A52890C37A4CF9F43FE1CF1E7F999CABF69FC69F0E7943F4DFE7CE2CF393E1F80AFF8EC78E42B7F421B4B401B7CF394CA8B581FC193DC8B0F19F2114B8C1A644B9F0592E33564FE2CF0E7057F96F8132207FEADA654EE4555263F2BE451FC0A0E469173E2579450392DBA2D788A4DD1D5C8BD22764517218076CD37F8F4F8F302F4140802D86DFEB4D9B322F2E75AF49EF099C6F70B85F4441856D4945A8940DF5C80228AE5113E27F83C3F836FCF6239832969F1E716525F157FD64843A9525AE0BD2B3ED356CDF9B3C89E155AEE67A5D215F33270A7EE006D3F7BF8ED12631668E550FAA4919622CFA44F1968959C95EEB07535DA038051047D268A52EDE0F3A3521D4BA223D2D69B04744151C419AB217E952A8A082528047896A58A23D6FC3EC3514DAD81CF2752C37CA9479A0A4E4F4C404245787E41DB8BDFC42F04F40C52EE48A584CF1E48303E5FF8D3E5352EC91D96132BBCDE84B432A2B2019B0218CECFBA1C0748E00453A61B89E680D2D448772A0245221DBAA2A6D500133EEF0B220DEEC486047E45A27E64436324282952BBA5E0938E4FC11AC9E144447FBCCAFAC3651611EE4E22802D79663E8BC466275815F43CECB33B73E09072D463473E60A387D0A7D1A91DFCDE1851871A99F329F586E5277DF86C7D9A8ABD41B5941DBD8866FB85645AC3D64BABD2C88CE7A317883C8AE767E32FD653FB8B526857C65F5A3D2DDBEE169F266048A23108A9B6FB0F2F832FAD5A23DFAA28CFA397D6A6F5A533871AC5D68B35BF1F2AB976659A393F6BCF5BCFED977EF6CE12B793BC686910B9406445FAB94146AF59AB711EBFB7B7EA8398E90DAB8BC92BF4819E02857BF429626F946F2EB47A07E3218CBA5E088FD13042237E6CA7889F46F38535CA2BA49FB7009A5E1B2CEF9EDAEBC97CBC1863CB1E20AACA1588F2206E304663EFC5DEF8A1935187455BCB34675AAE4F7A43EB8B362FBF4C72E3CC9DD57E86E8D1C291F8D8D2CCA24F4B7FF4D006F7945DC0FB5ACB95E7BA54EC69C36780D6CC411CB9EA009D775607202EE1D90688D646AFE23B5AA481D5EE2B83663FE04DAEF9753C6C67B01FC7C36709A05B441EACF46186B686B6C56A5A800962CEB6A56DC4203A843EED67679379D506BC440BFBB13D1A16C2DA4FBA37C941945AB32E024EE4079E5E1F6CC77DE8A97989D685B897D5AE803C6500BE45A4E217BD56DE929A6EE9D572189546B08EA1BF1F32414C4C34FE0ED0784A804B11A185E31942EF0E8B405B753502AE33081D6B3CAF021485746A83F9E801EA10318893816FB541015378842AE943CB1BD706405B39ABCB9D995E9309D09FE9D4AA99D1A00CF2D87C9C3CB46DE0177E97A1E533E8B5990A9CC1081F70CDDBCE03F402701C9E336851C7C316857CEB2C46437D35C9B7414A406629962A8C17DA96FA30B6C6F220371E164117948726E2C17953185DB45F1EA0AFF4BA98059E612BA105590B22FB171C2B4E72D087F9F623480BE84DF311247886D81012C0C8C17861F89C1D0FCA8F20DFD9112DDD229D396810E3618EE62BE212A08084961713BB9D21F5F68BFA805067D6285B5E8C89688D6BA80B0FF910A73A5448A4C45C03DA5422BE006E1C0151FE3DE49E81BFFDA8ECF151491F7B613ED86A390B340BE46623822E34410A3A359C2D1E3FE86B6DBE14F57A67AB0E9B59BD168302FDFB0C3AEA6B621B6803BE9893BAD5571F80F3FD6A06FB76640F32D03A11E8B526C3A667F43B20FB4C57702CA680CE824699FA4307F4A4FA02F2B61CCD9FC1BE29B932C8B2658384024781C6A76310C1323C88B3896DC568459A38450A68FD1CED6A3B730C1F60DB180FCDC538373B5A6600634390D125F4E943D33D0A29D0C523F40EC0FED86DB458945E88B8F6B91BF411D0B5D46AA01B0F4D6A914072D1665426B9EC461D3E33CE5838C35B2DA035005DC8155F62B455837128AD85A54673CB835E2AC6DBD0B180561BF477DB9B975783076A2DC1EE429B639C1DD4AD0DB4A8AB838CABA00BF4BDCF354E11EB20417DE341B43A76733D09D3210E0978A08828678F611F3D45F494F627C824584D398BD821341C3C01BD6BED09B54C7F19010CB496310E57414332A08312F4755ECB5561FC3EE8517D55027E59DA936E0164F421A0F1617D80A610B05F6D80003623DB6EC2BF88AD5F5681875B03465EE061E21252F535123C64BDB946BF0B2DCDB63320256819E7934DE0F9B867EBB42739F0748471013DCC6B1EE8FC0C3CEE0A6C1750DCE9F737621BA400F8003D632BAB7EBEEA8197DEEAD02AB071196D5B0C7A8654C733A0730672895243B1A1D657A12F297F5EA225B85F68622FF0EF436E9DFA13688FC6AC84A8D545E061A706BCA6BAA0702F315E00C4FB11E2ADB7B1B6A8CDF52CC8DD4AAFB77C4FB21D0FA147FAC5F52007D06AE53C2F0B7618A5173CD717BD0ABC031B06FC7B02FE6D741F43B68956708BFEB50F76166800DA3B55F0076B6D0A760F5A07D10F484A1379DCC3C8A10A38AADBB1CC2D38C484BE55F7F103A4E2A4C63D5D56076BD959EBD05A03A485D336803C80A682244EE44101F0533D602D1AAC501AC783E60C2C36FAB2AA3E672D66BE0B68C90D1690F6D4012F0352D4C0B6A1CF426F577D1A57CB9F408EA0951DEAD5A0055FC6430B7C11C4C4C3CE1360D802CDDB5D689C369470B021BACC3C3FF245B315EE85AD2702E97AA5B52532F00E5ADC039FA0D50719C0321BCBCC3728F3810D52CDF808B6047D56A70529203F3AB48AF674D500EDE25241BF83657A02C9A05C1FD4AA2F2AF48E96677E9E79758D741FDAF740DBF0D9EBE59B0F2AD41A0FDA9BD11063228CE7DA3328CDF9D5F675E301BCCF46A3DC61D8027ECEF19A87719FF1036C420178B1A11670CA64BB371C801D86480635BE567EF1351F6C22701E6311EB4563E910FD881EB6B4EDCB3D8F2928EE95CF9B41ADDC028B63817C01A422C8A5B5024D3A18FB026D3C3A3F109BA3DC6D40A3412FE9DC6018016E8BDBC85C261B07D4AB3D9CEF55C8C3866449AD85A31A9354341C0765484526A30D8CB32A74AE067A6544C638EEAA3C91D68614F11D467A4FA432C2E99902A9E09C431B476C50B38D102B7D18D3C178A40E5102443A04A51967C36A4F04FB1417EEFA5311E4BF85F9592C37DAB07722B59E90360223368058F3F0692384FB29B9C0A701D10AD2FCB0111704970D2AF2D36BE5816F044AD6690DC031451ABE902AC4B1449CE14C938A43BEAE8263B919425637F8D4A01C40A83858FE0969879E01FB4660140454DB584255C4153E01B287B8746C155D847B7A85A60C4282F80E6741C14A3F226C90B117A48554BCE335D1CE6D585BC6D863D006A0AD80F9C0BF2CAE2F2848D39AD40A217FA49649EA1EF67199480D1CCBB27765E77DCADE4965D02735A44DC351348C713B8AB8E57DB9C5F78F44ECD2D612D67793298CA265DA974F980E309E810300A9DC438AA00D5B469BAE889BEF84B84588F7533A57573F3F03A1FBC85699AD2A9115D285F11F9B8D029C5599F440F351C27BC85FB94F3AB8A2536DA15C721920A49D059FAA882DA00D4A0C88D8428EE224280191024F58A19289125B9B922E958E0272DE63124D56813C12B26E4CC54BD499F3B34705388AB306344526F1F7C6CE7B8BBD0339E328572A6C1E00686B5DE89F5A03C9B2DB15ABF0D0AEF6BED62F2F1B44BAD32F1EAAA371FB5E6A4A8DB9FCA0E5C8B4B5ED90CDA85B555A3579F654C1D52CBA383DEBE34C43F7FCACA6E00CABDCAD294A83888D014E80604971D668D192D38D0CA4752B0421641A10AD889569E11EFED58062B12E3666643A6A0096CEF95995CF2D887C66BD416428AD4C0143439C1251B6C02D29F02E366722B6592974478A52271DC00C0C259DEA42E23B37F86A055D6FA335CA5082C88E24E22C133CAB75B447E2065B752F4135A0EFBE0E03295102484AA386D8E591D4847A3857D3D98CB026E97C245F943ED2D4359416AE4F2004BAB44F68AB5AD8BA7B8E6D0C90AB643AC5B486BCD15AB2DD07BE199D86CEF9D0A8CC3E125B99564177F01D7AACD1AD2B05BD4EBCBAD8696665FBE91E688377C04AEB21471AF79D8D4C6A66117C5667101D05795E3052FA92CDB5A5C286404C5499C5464A32F8FF0DC4E1C51EA675C8AAF734E837E4F116BD4CD6D273E5ADBA25998FC0CD46F6B479197F5686CE12B18E1C02DFC09145C72B0D994C81631BF0340427A5830D346241C409AC01690C07F9E64C938B308A8A784DABE3D091515EDBA074549C6077079BC5FA99BEEF6E6AD9F9942AE16611F40BE50A440BF2A4F6DC465FE9CFF08C612C33AE3D7B1C72BAA9B079BDD73EDFD81FF2C6CFBF143485490BAEB61EDCCAC35676E886A023F9F4D365D0AA3342570E63139EF0FE42178C8668B5C1970DD14643D4D043DBDCDB88F768ABC1EADF137904EF3E6D6BA5B74EFB2B86209DABAC56ADD14D47D2E560D31F7F0AB1B0B9D74304CAB4B2C8D6C4D17B210E556176BF4B7DFE08AC342BDCE490C07F6CD16F524F5EC3350F16F180355F71BEE1E70EEC16E58C8C1E2683F6DE8F223A53F4D81BF4E94DEA6970A5113E97741D5366B3D415365B0DD0C0058EA68C6B1A5D1792A31064EAA3361045300C9B686C403FC0D7017AC70AC64823E43F58D0363E01720BE38F0A4686E079E11D6899E3FBBDC2224188088B185DB43142041D85483047234985E491B63EC15D25C899CA06DD43C8BF01F5C00D16C9D44AE8EBE9076AAEB0757753808414108824259C7F039B4D690088455616A308DCBEC1F8A4130611383FC3D6F7E833437D7CB495D8468CDF7E4C2B19DFDA4835949810B65ADEA5FFD3F8C3C23E1D61AB5924033DF08471F082468E4464ABF11BE8913A21068B913042DE880EF655039588AD3D6C69AF234EF81874B95A461DD8F2F20BE402C314F21962CB57F8F0562E206DC7F9B0CB0595CB639FEA440963263ACE809EBA67B1E544A15113F665EF8F8E4450DEC2B1C8EE48842E19E392B3128C4860744B23E60CEA378BBA5A816E503D7D46C9031A561CF2868D69903F0D7CCF220DCC564CB984CB2CAA07CE43DB4C944303BC10B321BB38DE8421F2F927F70BFF86F66F68EC835E896D428F48F13F096DFF86F66F68AF7CAED3E1518CD80FBEB2CB92FC9B90FC9CEB74A5D7BD623FB58817F3053FF78AC9ECA24C3C04C37FF0359EC87E1BF61A13D9097EFCB5B8C82FC7BE76871ABD20EDCFC9243D3F4A4B091EFF4917FEBB86ECE091A56EF15E8FE8BD0DFC7A06FEA36E29FA13AE7E5D935D0DE5C52A782B6D86971DBC7BFEB07D0FE0E9CF1CE20FFE7E1036A6BE9CB1DF139C19780105FB5165A4ACF1486F5998AB36FBE5577A9A941D57E2C8B0D65C7DA2474E4D6F09DF3E442E66B08CA52198CB941040EC8554B3C3FEDE921FF9A73F1BB97404CB5175C146C211E364C52E7658B8C6DA7456DE2166C42E0DF07F1256F77FEC9DE6C66E10145C23A9BA6EF0A3A24026BB40D5B123558165EEA3AA199C1B4C3CE84582C16571DE572B9B4B04BF5A2DABC0631B6F29A0974930CCBC27A3BFB4487F2D5367BF6DAA3E3ED21F1B6237BE04972104BF6BCD7F9B824924232C89259336BB4A8265FB3F277D7D47B98307AC22BF69EEAA8B19CB08754152A117CCE5F62651E017EBDD2434CB4D0687B2AF0EDD6018F985AFE01AA1E0E20A76720CD2CDE0C4D72FFEF1F79B53A1516263BF8EDD06B0BBD40B42D77C81E667F3D90F855CECBE8C861E70E5D7C88F1AC7CAF49CC59DF1B8BC49E432990FB9FC65F477A6AFD3117E05966087AFD7698E82DEADC64583DDAC76D41260C91D83F2FF01504B0304140000000800956BEF4AC09FDC0953000000580000000E001C0050726F6A6563742E706172616D7320A2180028A014000000000000000000000000000000000000000000B3B1AFC8CD51284B2D2ACECCCFB35532D43350B2B7E3E5B2090EF60CB60A482C4ACC4D2D014A2A0055E5155B81446D95CACBCBF57233938BF28BF3D34AF492F373F5830B7382538B80A6E883542829E8DB0100504B0304140000000800956BEF4A36162FCD730300000A18000011001C004050726F6A6563742E6D616E696665737420A2180028A014000000000000000000000000000000000000000000ED985B6FE23A10C7DF8F74BE03CABBDBD8711207B548899D1C212DAB6AE9EED34A951B0C4D4F2E34717AD1D1F9EEEB10B2400A6981AE761F7841C2C3FC7D99F9CD185F8CC7C371FF2ACFEE45287BCD17A9BE4459FA493C8AF85263592AC7FC518C455A44327A145AEF3989D3A25FFDFC527B7A7A3A4BA230CF8A6C2ACFC22C391F3FC463913F8AFCBCFA8536F8FBAF5EEFA2D19E8B5C46A2580CB6865FEA057CE689B8D4864C1BFC878D29719031055CB72C806F21013C2421800887D35B01B10DF5FF2FCE3744DE54AE3EB581CF86E37D3DBF89BC50E732E2F759AE0DF443DDA3F41877AF8CE2C9E1EE344B1291CA426B1CF694A1B9E05572302ED529221DDA408740C7D7D0EA23BD6FE233DD4608A921B3AFEFBDC8857A96D7211A3176FD7DC4A53C50456D755E4AB1A6B6AF1013459847F36ABF879E5790E50997CBC3D706709BFFE65843C7529387FFF2591B987A707D9E4FBC4CC33B919F4D64F1ACD5163F95F9CB5516A5F252835AEF7C63B275DD5A9566695A933FE2A9B2E545E3B23033318FB3972A7986E9346B6FBC2A202B812B9EAB55C995446BE56B0A2DCB4848AE728BEFDEDB4FBF9D55658BF1756D210182814529B04CCB03D8F402E079D40786858867EBC8F27DBCA3B6BCA55F275CB3EAC334366BCDD6B479BF4867C579A7C8B2EEE0A344DAD567E9768CE43F5FEB56E1418FD8C407AE810C801D160007610A60E0DA26A3A68B203A309CCBCC6C914C0E13DB52528E398456B7EE0CF2F632B3C96083EDB6E91BE3FAFC62121537E2598437732EEF3677F4069FDD1B5B04D5F1B0A9E2898111D826C096AE03627B0C506462A2330BEB86D319D4EE399A5E56F3FACAEF60DD9D313E4E769886713951B59389DB72C6CA64FE06D3DD725FC44319E562F75DE23D22AB4BE1312ADF785C7E6C045407B97E992B4DD8C96937146BCD7299FA7B611167B35994CE6EE29ACC8F450359D426AEED03629A10607523062E7154BD3398E522E6FABEEE9DD038A1F1E7A151358B68F2D13C60CC4C6460A45050AD1F7BD401AA7B38807AAA771097D8810D4F3C9C78F8E378488AE221BE89D2427E3412964311B15C1740A7BA3D3981BA1C23DB0196EFB8D86616A2A4FB4ADC3DC709891312BF0689A2888AC9EDE26F4559A5C12F6817014184514481094D0A70807DA020A1C0B13C971A4C3798619FD838B1F13BD8689B568E9B6F77CD5359EB65B2F5C2B61C7EF57AB75A5EF57437F801504B0304140000000800956BEF4A9DDD9D0CA50000001C01000013001C005B436F6E74656E745F54797065735D2E786D6C20A2180028A014000000000000000000000000000000000000000000958F4D0E82301085AFD2CC1E8A2E8C311416EA0DBC4053A640A43F690753CFE6C22379058B6C8D89CB37EF7DEF655E8F67DD2633B11B86383A2B605356C0D02AD78DB61730932EF6D036F5E5EE31B21CB551C040E40F9C4735A091B1741E6D76B40B465296A1E75EAAABEC916FAB6AC795B384960A5A3AA0A94FA8E53C113BA77C5E673B8A09D8710D2E5B020813F15C0B8C7F45BC0CD2C43F2123EDA831D22F8C7F7E6DDE504B01022D00140000000800956BEF4AE55661A34335000050AE00000D00000000000000000000000000000000004C61756E636865722E64747378504B01022D00140000000800956BEF4AC09FDC0953000000580000000E000000000000000000000000008A35000050726F6A6563742E706172616D73504B01022D00140000000800956BEF4A36162FCD730300000A1800001100000000000000000000000000253600004050726F6A6563742E6D616E6966657374504B01022D00140000000800956BEF4A9DDD9D0CA50000001C0100001300000000000000000000000000E33900005B436F6E74656E745F54797065735D2E786D6C504B05060000000004000400F7000000D53A00000000

	declare @2016_bin varbinary(max) = 0x504B0304140000000800176BEF4AA5CF1B4AC635000016AE00000D001C004C61756E636865722E6474737820A2180028A014000000000000000000000000000000000000000000ED7DF973E2C892F0CFAF23FA7FD06337BEE97E63405C36786CEF9684B86CB0396D9879D1212459C8088991388C27E67FFF32AB4A42C2E0C63D3D6F67371E336DA13AF2AAACCCAC938BFF7A9ED9C2CAF07CCB752E13999498F8AFAB8F1F2ECABDEEB9F26C68CB853AB60D010A39FE39245E26D6EB756A66699EEBBB8F8B94E6CED2DD5FEDAEE1018C7479E1273E7E1004ACED198F75FD3271A76A53D534C264D933D405E02AAB0B03F065D3D9623A2B664E858C789E3B3DCF9D09A4F9AA704B9D41E16688752F50D793DDD97CB9303C5EBC5CEEED96D8E6FCD254178B301BFED5CB9789DFC402292B452597CCC9E552327F9627494992B3C972895414A2C8F2995CFE3DACB515506F337F93C01BD55F345DDD7AB40CFDCE73F5A5B6188432CFA5C4545E1451F6617957536D0349CA88B95C987C3B7E32B40563E2465D3ADAC4F0C24C8E939152D8267BEE022A01AA1B6365D897892D164E82B4B46C68A95C6637A3DAA74239AB944B854CA6983C3BAB149379B15248925CA9902C578AB9BC92CB8B25B9F07BE20A2B5F708C73C35B6C3081C1631473022BAE375303F61357C58B74B452040C2B7EA77A501B5AD5BF6200F766B2AC7D5A93886681D6A94C40C5783A6FFF4C5E944BF94A39A9905C2E999772E564E934574C56483E27154E65397376FA7BAC66B4490CDDF2BF18A0145FE6EA6292B80ACAED91CA5B04C565C6191CA8F6D2485CC9E7BF00201312858A651BFE2FA1CE09DDF68DC0FAE12F999CF80BC0F845B21CE717D07644626813A55CEFA680BE3D120722D3FBE4FA2F90B9782A568AA42C274F959C94CC83A625259074B2902914C5AC7C5ACC97C4AFC8DC764DD372CC2F366AF89F227790EAD8F5FF62922367A45024249F3C2B14415B7339922C162BA524C9E4B265395F56CE2AF21B924345B5F43F455C8BD93C93CDCD667F2D799D9DE532A7199924C5522E9FCC971431490A6229592A48F259563C3B13F36787E535F3FD5FED2F96E32FFE149151A754560699D3BF96D09492725A90F34A522914CF92F94CA6922432A81B78C362E9ACA88895CA1BDDD3F72D5F1F53A3B84402FE2485DB168148E5DC9FAB1A94997B868FF63071F55E89EECFF2B7BE69A07A16FA7D5F486F13B7E140CC556D93A3428A8747BF7435CF9A2F849EEA4F13871B6E1B60B0F2AF8A970D9F66D0C0E210CCD0F092BC5C3ACDE7C06888603E4E3362B2244AC564F12C573E2B96B2E0DC2BF1963D1CF01CA0671BC724330775E4109DBD0930AFD72C6781414B5C6B761B20CC6080517DAEB64A71C150800260E6365D103805BD2FBAA8E60D236FE4F362315F304E8B85D3BCF638CE6B63432C66CEC444B4D6A0DB234DF5C9F5B6415CFE7501CB89148803B8511D7309ED7E9990BB13D59BC7323BC0F5AD636F421E2F13FFC9F5E4FC3C1E639CEC64C41C613493D9FA48CAD69A4512DFECAD54905C84F585318BA60782E45DCC82C0A46B2C16408A9FF2F99744BC82E26810103BE665A2DFAB14A18FFEFD67B94C7AE4E78BD890E407088B7F108CA0F00F96EF82BE164AC9CC0F74A012A0C168880D532E134BCF3A0FB10AF2D2F30C071BFF11CA5C263E958D4775692F3EF3909567847D96BF738EB6A583AE9E8E550809A0D917E9283D57FFFCE7152D1E88EC5B65D9317C77E969869F0293F6FC6D82A463BBAD2013CBC563B2C8067B9EEB2E18337F4F2605067D1B5702F207A10B438D99CAF3D85FAEDA42362546937B1343987BD64CF53682E9AAB62FB88FC26262F9C2230DFC05F8B67005D5B6DDB5A00ABE359B83B01F9A37413E03B398B0A233D75FD81B61B29CA98E80F6007B448A62310DC7F0A87514544717E62AD0E3980C9DC1C1ACA00FB94B5FD0C120080B305ABEA07A86A0BB8E01A53C77694E6869B467B2EB80B0C0D00B9AADFA3E146530E0BBAB59305ED585B5B560E5B7F05251E6956715D9398FA6A5522941D5DD94632CD2C8E6049800D109FF4FF09950A100573D685D962B385405E07D6681EF013C105319CF8B7438F24EA2265CA4C31A570740AC82711634D311C53DFA92B8EA6E7C50CBD456F1500B82B70E2D7422F042F796A3BB6B3F85033BFF04D93902D1DAB3165F45744F0BBD0F116D198603FB51063AC40A63842BAA83A8511BC176414FFC8507EA729166B9179A3B9B8199088BA9024FB948075917697DEB57A28864D776BD4C822A047813466DD953D780204533431E786AE24A02AC07014AD662A6CE0162D0FC9709753EB72D8DAA7BFA39B99D8101B54AB9D4E9A5C69603BD2E35567DE3341F35DC5C023FB31C0A945902506908912CD5B65EE06BAAA5F4840A463B6BD79B0A0CEA3F03090551D30192EB9AEB1C1201E6BD92C03B79DB2C0CD5F3D477B3475B192C078D061DB4CDD0B4084DA0E0A8D5096CC63102A008038DE81D56963DE28A7E4263E919D422A9CE467096B3317410202611AA7542F040E5993904292E54CB096C260381D267048205B4BC1D7BA46A1366AB004A501FC9C55A27D46CD2AACCA0621930D86EB420B7C6D04C82EB854D96A20613CA816BF5E7AEA3339BCE0448AD27A3D85FCEE7AE17DA74B4608C548DDA5AEA3F0E9B61D5D326164E5E2D3DC0C860C8DC3453F060C67FD822A13D1765195169E4D05FB85ED4763340012B507A91DA75606126405CFA5019B4240A966986CF24B8306CDB8F407E6D2A8509481604A41B7364DA5FD0D25CB38540893416A880B773DC40642031C3F12DEAF3C0EC81884D6B65385B02111013E96C0970C7941F41D5A069D0CFDB9B982F6AB9A0F749E1BDB684FA6C40F4DA4363EA6B8B0DB2B6EDC03F839E01FB10907AB434F3308206EE9CC1C104AAFEBC133224BE60839C40D463030285580305BC9FBF9B8F2026407109C2396D6A562E22BDB091A9C2C47BEE7960C4BABC18C59D62539A38444C490C1F7B84E9BB50A8DA4CA01D0333457171610731DAB733EDBBEAFCBBB3DC5982F59C198759EF2256FCF387D9FE9676DEF10FEFE31BC6986EDC2DEC92BEF499E7E0C2C0A50688211D9CD537EC54CC6EFD91C64E265920FEECEBE73C3CB47408CB20424F04C31BFEE51CCA5C26268BC5FC3C9DC65599752EE57A663A2B8A190C3459C81E149EF9E806706CE470C0FE569049705AE7502EC94A05BE955261D806FAB3203EA484B062E7751FC7D930E2B94C2C3C9CC30A47E258116082977A46D1445D27CD9AB89606164B7DBED5C0EAE190CD19BB4B0784B333DE7C4D01E8841A25320E782FCE4801DFF87509227F9DBB1717559F20A6A1D5693481A18B13502E2622531021ACF49BC8282AE8219E355E82C63164F8771FAE3DD0F755A783846FAF1E8E338E00C1B83B246B96CB05F9B5D644673E1BDB9B6F6BCD5D26A037ABFE1F10C2B14DF01D05F0175365DEB36F317850EDCB44669FECF622E071EFFB5164FFEC0E74144FEFEA53BB1073DFA59BED42CDFFA98AB71D61FC2FD3BEEFA91A10DBA3247E5D5A3042F85EE2E6B5A88FDBBAC403A05E03E1FC511FCD12DE9C16E260F81CC7BE39A2EDE87577BAE4F06C510C2A9D3A7A07142FA6571CC81F98510A26D1810EFCEF449097368E092F1D63B9F054FB44B85B8E2140BC36363D776A3897E3B333B5A0154E33A55CDE108BA577511FCC4C1D4FFDDBD3547F22F5F08653B77F689AF988B58F94E6CF01C8779F77E694093DD7B5FD70A5248FE5F9AC7B4FF54C6301C681EE510923601EF4F23876673B928E6B1F38759E9EF963AC8611716E3BD94FD700AB9EBB9C4766FC910EEC95D5A5A5FB57BFE5C4B29839AD9492B9335C295672B924299E669205E5AC5C2C95944CB192FBFDA7DF2A4411F38A2C267362A692CC64CAB9A454C94B495194C57CE5ACA45424F9F7B069B6F0395E18313C5AE692CF61C39B6EB1953BE187FFFC14CBFCFC83707929FCF08390B82A1BE3A579918E65878CD8EA82CE67EDC00AD2236088B391EFFA401BCF8AC822B23BE9AA082A9B13CFC41CE5229AC3CBB3514690482D453C292E63E4FFEA37F9B42C9D2AB871A1745A4AE62B9952523A2D149320735239CD8A99AC52DACA8DD6E1606E978BF9924AF2EAC61A7B30C6BE4847D27829329F970DDF321DC3ABB836F695ED62CA45FA752EAFD681CE849D82AE1F5F1DD1312ED2F12A017A1ED462C6716062353814A6FBE16C6420CF553E55B8481FC8E45571F189D8C021752A854CF6221D4F0A18060366AF8C007BC778343C74AA75D3713D630707097C2A47D6B47C18E56B932B1CFB8124BE0B2C66E35EF7D278C73DA6AFD07E829ACE79A5EFDDCD6C0CB686931C4B8A16A3BAF4B8B46D5E26AA5BB7F38535B35E205FB5714350F81ED3D03B7531B94AFD32B69C5F28845F0235A519BCA8E2E06256DF99A98E6A1A3A2D88CBB701E883F921AD8F9683F30EFE427516FE555991FAD59F7A1D222B48783C33C0E979AED73170C2F40A8CFA6CBE003C91345EEC5EF51CC044B70C5EE52FD2B1F7EFD7481D087C54DF38D44C5C0EFBDA29143B6BCAAFB602C7F42F6987FFC116402F1FF36D613F14EA8E662FF57071661BED1E2E93C2F99DA30AC6629EA36A3CCCECB7CB453697041B8C534DDE02BDEE36AEA2FB678F0AAC8A2530BFBAA617C5A2A869A5CCFBF16FB7B97C4FFC17E978B3BD6EC588CBDA1218D92010E104672671FBC2BE628171AE3B8F2E04759109BBEE724C8D9CECEAA0F0C15B3044E130430D9E8D0D5D37F420FEDD8B6B67CFC21655952D0BB8DE15C6D0E8971069987A91DE1608EBE0FE6948665DF76A0B3A100A3073918E170A68DF25F61839ED451061812C172E60BAEA51DB13BC85D965636E383AF8D9FE1C7C725C106816A2B90744DCC20D0AFB487BBDAD669F6483525D5C023250C6EF916F88E308F122A1C788741FCC6F95E82B191C29D457F4B1EEDC542DE75B7BC3ABAE8B3B68387CBA9A45472082B7C4AD6A8F74014FFE0F61CE02DB5430DB5F9FD1054C1EEF5E26FEF353B34B473C92E5A0A3FABCDDE69D621BC6520B36320A4D08AFABB0F542F03901B903CB5FAA7677B1D42D77CB61C55657AEB76D1F81EFF53F6AE0135B7BE78823A06AAECF77F6E136B8E02D41D3F95633C024E50804C28424CF145249E625F934592AE5C564E1AC5428554881C8E2D9EF09816C977ED89EC3A50FE3C0EDFE396837A167CCE6308C317C9415AE8F44E7712E106D30D6DDEE528C97E14CC8B6F56AE60CABD751B3F0F006F4AC6EBDFBA5DBCBE4206ADFC98ACE00ED070861F88EDC43A57AD54C218C589386A97F70D01F53FC23C7F5FFE119260E546B863D3F1740CB176C444817F15DAAED6CF7A9B000097FFC90FE075D758B6CEF64BBBE7C61E32EB106C8808E565796B700E6ED0D5B069E07BBBAD8A607D5C1C53A5CD18656B6FC095DAE0392FF41F71BE062F75645E8D29AE5505A701383F1BCC065650001D41A26878BCEDC02834C8B78AE2D3CE212B34061D23FCAF39C2FDA092EFCF104C6B92FAC2796361126EACA1012288604746588F29E79E736D8F62FBAE5CD9F1B1AE88526ACD50DDD1DB1F40D0A7C2F258F868AA183BF65C0F2A3D24C09FF487FFCF01F60E31829B8460AEFBC45C211A8FFF1035BA86441D64FF1571ACE8569FBE29BF2C20FD67977EBC622BC57802D158679FEC2D25E65F5A00DF6D1815859F7F86997312760473862F0FCF1C36F4C7FD3E9B470E12F67B8F3F06A9BB455F5601703A0F436C2DCB59C05DFABC2771E3079A704A1ECD22D18DA04CC0C33E37CBF4C306CF54FB608A0DDE72A6EDC08373A52A0A90855E92D597FFBF990DCB183F891083385A666FBAA20D57748743878FE27809BD31013295858AACDF989F07C7EB09D5FE1436BDDE9B104B68D9A2E6E4B2A2AEEDF7EDB5A891D43D0A74DBB57AD57E1366DBE4393EFA4871E8C7B3F29AA2D5C3418B49F405E505388778613E1D1F2C09E834584EEB2DD8312169FA83E980B03C063D087FD2E62DDFE211816EDCF5805F797043B9DA84DE19B5976365FA3B3A6A32C6CE8FDF5621802207452781F94C7579DFB64BB5F07095E4F0C4A24E0432D0463E9C530E02602C1310CB6E98A4E5707F6371003E830481244104B3D117CB45C31716AB6EBF3248B0E54A1D7B98F317CCC3509CC37B12D4FCBB9AE2E8C0302C302310087C581E102177CE0263CD5F1D91620D42445B7205005AB88C62715831AAA4AA856AF75C5A5BB8C69DF862202189FB99F12B6273AD8D63B9B9A685CB548BAC0491C4DEC85EFEFC546C4E2D8608F30848FE8EB79ACBC80C75C7B16450D3D947EBB143E05A99F05EC88A1547EE663E3F3F36E503AF1CF143DE1F2D35134A12E70253A4C511C63DF37BCF3F3D9A64B57C4828C002D109B708C35DB4793388E881DC1CC59C4B76DA51D7AD00A8F71EEAFAEA368E0F59554B6071478C1FD52399A22BEECF087286230BE42D19104F918DF2DAC95F16791563516DD000725F3D3E738A1185C44EC7BCC1B87A971AB5FB1BC8366DF58813BF443F6F698F91D0B48A33CB0EC4658153A3D3FCC22CC97DE1C8C947F5CBF7C6474013C0327D518C03D7D40A18852C0864167DF3E658A27028E5881015FA052F2139022A97C8F2CBEC03FF1F3716DBCA5C372B6F6EC086AEADBE29F727B49E229081EDD1D352D861ED07702EA45D11BC40417F5F95DD442B44AA7198F2194CF487ECAE4F752D97299DCD0B26A06681EDB456B39F3E5E2802C510DDFA5846F841EE0A11D76EE5D60F3B66F441D5D17EC323B1D02B2D857938F42E85EE0BDE1392066FE70E1CE211E8BB195B877BD29124A37FEC95BF0CD003C3FD30D2C68380E4A5049E9068418F6916ACFF7273A0229DFD251D16B2E765A93EF86F4D47584A24BDAC8DB04F4492A3AECB20476846874A7C436FB130D24D165ABF47DA73D058CF123746C80B896D28BE1FB142BF33946CE0EB474BAEF1BC1D82E8080FBE1B1F9685484DBE94FD8664B8F4DF8EF147FADD08778E50B06115E63A4C539FD4AABD0B3FA7B5AE4DB1AE4CE43054FBD58F36F69127E20024FB0E17409B6004BFA1F167D8CAB7709FF0DB311E9E5AF478741327546E06D27AE4EB7E1430FC44DBAC8C96E3F17D8D1C86DD41A9B418883950CE8C4B8DF1D06F64EE8ED175B642774ABFE76033FE84B302EEB18FED25E601C07812FCE6D4000B9D4A88105C3F00866018F44ECB0E1E2D409338D27382F01852B999D42D1A168343D2AAAB967AD28C605DA23814586743A1207254B7AB816D406E3C2585E2CA83806C817F0D05F66BEE9FF316800E54D922260D86079E55ABA80A3E34FE01CFF8623DBF80C58E0CBE61C247F8F074DDB72345847AF2DCC7D2B5E25CC7A5537CE82EA1D2104FC2CBC4D3CE1B7F82B7E780FE7677EB905D91B4E075740F0E035D57319F65768A360630790DF841EBF0EE5DD48628799BF8A287E07C87B906D8F42BF852472FDC37B80EF3952FD16967D27B0F7A27B8D10752845E6B80EC20E607CFAEF4422F19BF87B2201C1D66F19FECCC21342AFC8F9EF40534EF6887D3F2AD0F314BA349C77046EE20DBD4716589E78E6724663FB4B46EA9BD2C31AF4EE03A3E5B29947A8864BFD07CA768006083317D0E11C5DF5F43A4699EFAB424701EFABC2D6C2DEAEC3A8EF2E36368A8ADB854862AA66E9BAE11CA80D5EB73B316C9BDDBC8010E89E84FDAD92621B153AAA8561078BD4B7C4EDABC01840EBD90962F41F2F71148A447E7169EE1734BA747BAABF8FC81495DB2110740C1687B00FC6D6845E22DB7B4BBD51F3408FB0E915595F344FF5275F26D0643658D4A8E2EFE96DE03953753DA29CBBDD23D4F3035D232541F4C1574971E2EBC6728CFD2ACE4AF2AD1F9182FB8ADEABD6027AB5F26C1D6216A7067001E1129B048AE1DAE5FE828FC2275AF012C65FAFB3F73814FCEC44267CF2814DDAB1343FD56521CA1E5E7F7F9D64D8BEB117FB7EFCE139DE05460C7B50ECB096D9C3DA1BECE187C3C6392FBA58C50CC2A70E0DE0049427404D1C40BD87C3C35C524284A328A1FABD9CEF2326FBF95C38440E7E501A7F67724BD5FDD6D2B66FBD7B3C50DBC5B5954FBB415844E73F1F101EA5FB70569CF4E0DB8F42E217EF174748C0B73770BEC1C801D9FE7E4857D26995BA41ECB9181D0A88EAB0C6BC21231E5A1E219AA3F46A9F485EA3789F86E1E79020F6CE732533274202AF824B9C0404456663BEBDF757D8A8E4EBBD7FE755C3694AE193F2AC19733647F6BC23E33DB2FD2A67C673AA09B60882AA982D7F3DEBF45D38C433EC6B1ABE876C7CDA4BC12EEA1D593CE2B917FBEB21FE3C25E3BACD01BF52B6FCF9BEDC28321CF8FCBE6FD44707477B3DE7AB70F9241AE47E09DD6434860FE28068FA4EB947EA4CB784ECB01B0EC6BCCCFB8763996387639C16CA301FD750BA20E49BDB680912DDF68DD2BBF912DCA18833989124192BD698A068F6EBBEF48D23BE7784F5F8CCBD0EEFE3ADF3AA5978CE6B82D369AEBF92FB9CEA4EDCF5A7044EF2EC610D041D1D0F8452FCE975B1E3870158FA70F8BB5BF2D560616F412FB3136A660E957845CE1E69503E05DE3DC269F868C5DF5FF72F3E8541BBD9C140FB139F0BF471539B772244C36B6AF608AA0F54FB6243D478B8F37C3D04A000E8868C5DCFB6C7EC70F7CDD59106AC31103B866E5FEC79B0027CBD71D7D801705E905E3FF22941870FE789CF9F0F0786AF428A2389DB85F3DA49C59AF18D09B25853EE0E78FEA22D19441DDF20ACD792095E82C59998D7147443B355B63A73FC74ACE12C6728D395A51BEC7A1D078485BB85047FE27A0BEC74D1CD5EBEE6CE8DF8061C7E67CB82AD884F8C38168FF9F9F8CE9FDD39D15764D199EEB5EA87779BE882BA5CB8E1C2CD11B3AD94B398840EB6391F4F81A1FACA5EAD54B9D74513C90006E3B09338341EBDBC1B1AAF1769F38842C4A7DB31A2F8FD8F5E7A87D96F6D49CC9CDE28479F3684F2C9CC6902BBAAA3ABB6EB008E8DE1B3F387DA79700291DD91A17DE56421B63E5FA19FD9786BB998168BE91998AAED2D1BE36F3B9D28784CF6E129C81CF2E1474FD231DE700BD905540D6F330DF61EFF8D25E3C8F0F87367B11A218C6077EDD5CCA751092B17A686E530CEB4D5771C73DBAD14420AB442BFFA4DCC142A4A25934F8A528624F3997C3949701B724E162BA76759252F65F16C60BC160A25BD572A147C748F761C63642FF8F1E760D35B3095638F5A1C53E7F5DEFE636AED1CB4785F95E86EFC77917854C5F836E3F4B699A20D72910EFBE177BB30732F996FD894E836E7743AF95D3F1F3FA0274037910CBDC6154DC4CF21B732DE80D75BB8AE9DC2A26171996E49F5D97E3FBC5313E53D5337308AC6CD709643AF64D3F07EA389BAB2F0C0017594B68DDB176CDC0A6F3D86D0D80AA64EAF39032B1E204F3192D37B68FEDEA2F9F8E1E7E00A9873C1B4DDB16A9F9FBFDE549C422345606CBC81B10CF8B7395DDEE40179B81FF653F41718D8DE72DCCF88433599648A99CC39C158ADEFB025DE3B16C6216828D2C50802AF17C23BF8E09D9D583DCE2E6C352F156A1E54FEC24FB17FFA7CFE0D5012C28F4C6313D4147CFEE7BBB746472006A145F4AFE52C0C0F640A41928A2BDE3B7B88837B6D5FB54BEC20672A724023A8823B86A3B1CCF6DBCF3BA08288831FA9F182DD3B614235D0BE6D23A3200278BBEBC201CD3A137C3DD8D1CA07DA3C3B36B68B0063ABC3BBB07823EE0667D0BEFB026BB6DCBF4BC0E18918FEF57B044E875CCF91762FB643BF633CDAE1469078CE8126A3E33D6EA958ABD942642B9BA08E6180811B9482FE4EF75AB0ED13A87DD16B20D9BE5D444AC1E136093CC511EEBE4F713B8885710B7078DB0BDF7006D67186BFB6B2A1D022FBEF28B8DDFB7C233471631BB14981307BD6C2C659A0236E0A4705DD03217237FBA7C4A142B1BEF556B1D95C7536870BF0CB1AFE10C1B23BDF7896390128E157E1BF05017FAEE7509D9EA7EA10B27AD3376867A7647901AE31C165D2D1BD92F4B85C445F4059F0EE4C7F7B5164A0258F10CDF0B63F8FB94B81DED21E408F24E3DDEC21D26D3A0D778516BD87759BDA315656509FA60EDD25DD11C8CEF86CF058D3761F0FDDA2B3E125B81DE03BE51918EA92A3987C4601B87CD6D3B0F00FFFF841C0BD9D1377EDB03B30CF77BC65204FCEC5271C1EA4FE0142FDFEB78EFF3B8AFA7714F52F8DA2B6AA876154F0C6B7CB6238B5E73A2677B98D98B68577ADD0FF3DE904F634944A95B2185CD0CAB3EBCE563A8FEEFF6DA9F811A9BC2D1390442895CFE70320F14F88B30F1C4C140482CB4E2E5ED29CC4CDE73A4E4AB20B1568087EC24F41B874EFF8720E5F357E5F2D9B088612C6423B70D090A571CB48237A348D716384F6919EBDE264E009EBF0A204BE20154262405696CA4DAA605B537AF933447BE8F262C7C4525B02D83934170FD1CEDC151ED8622D4D97A2D8F136815EA7C6CC30DF41EC2D1D0E3B84145EE09D06F605974652270C303B654F410DBAE1F17A567377CC11556E76958BE1B55C070F42515D7F35D008C7494C02A19EED1FE2EC0C4976073C718BB5B55361DBC3FBFED1C99B700FEA770897A7ED85FD9688FEECFE1F1DCE85920EC5F4E97354CABFEF23FE8DA5040CDD7038C6CEFD6AAA8687C777051F1E7BA4873B688FD839C37BA87BED13DDCEC5D0ECFCA28477F8E3D6BCADC08E2ADEC565A414D157489FBE5752EF55B3DDF7E346B5B8FAF429A2A1B8C3CA59DAF6E7CF8736BE1C4D10E406FBAC8FAD73D4A866AF6B0085444BEB3E7E0A933EA78240FAD0C69B18DF94DEE376B8F1A980FD1D7BA7CEFB35FB7665781E5D1DA3BACD7E3B0047D186AAFFE007BF7AD4AFF37EBF3D804C8755B6BD0B2FF43DE87096733F1C8BE00908EE1F847D6EEA7F6D27396C330399BD6BCAE7B0A1DDA31FFE21503118A06EABDD53A57BF5E6EBD347EC0709FEC825A0BA6D27AE7A835FDB8434097C14FC934E1709B93149F06993E33F1F3FE05F5637FFB834F364419C567D6C4ABDA638195427736D23ADB559C9D1669545BDDA9A8C6785952E4BD6A82B6DF4FBBCA9C2BF8E52EAD5AB99D5C70FA36A7F596E8BD78D1083D4EE00413DA294496B71A7DAD32DF25B42EA16B9814C28E6624A3DC8B29F4C469B19E548094885BFD2164E75FB5526413EFB34C9B0DEA785019A14426182A3E4ED084469E721F12E2C583315B2E7C3E4C630AFF71578D78741AB6FE90F3F322628E64E62411C3D4C44FCEA48348FFEA99A0C0AA72D5683D2BAD49CD66688E472AE985C87F8477B4D9544FF7DFC70E334EC71B5F444B8D271795352EBE6EB7A08B5BD271DA0E53F7EB80D5E185700A54F6632D4B96B7749B43DEAEB1C64E7F7C1093E7B388DA1F3D7922989543A804079682269D7B2D3ECD067AE8918AFCBA4EE2A6B8426CF8A7D4CD1503C35695581F290768F69E3671491DB2296D963EF086CBE69C043AB16072C0D65395F5518B44953D92D3D58EF2F0D652BBB65A711C81F3FEC94AEEE965E1E865C936B37204B69ADB4870DA53D807E8A4D285BC39AD2EEACAAC8A5A9D51987F315EA11BC3F8C9F7DE4B856C91631E35A7AD657B57690970FF21E692B40EE684535D81C3E8C37A85E6EB57297AF62F7909CA645E9DA34C374AA5D617A9BA64BD9A2CDA1CD8A337C36CC7A479A28357877F05D594FBB72D77469FB7514E59AF69A6175BC995208E38DCB9F94F62AC86D830AEFF66449A9DF7414F95AA234DC8F37D881DCFC14B503F22A2FCD8636F12552233DD9F2D79AADB0EF4E9EF641940ED2E6BA686A654B1C2A6D6C238568B56D099ACFA47EFD6822A60E6B05CB5C22CD371DB3233BD71DD296D61F3FEC9458310E5D4EE37C857FE5C96033432C9272ADFDDA449AEEC72F54BEB34007A015164C6E397BD893D74C9F4173D734F7E17A84F894F662D53469FA03D5F2AF427B55E385D2750AAD21F256CA50ACF25C6A85BD8E1AF11BEC75B5367C57A6AC9FB2DE6D0625A43E7E1F99F85D0CBBACF202D6A5468D11CAB4A33DE357F75A7BA634DE94CDC1E6E3873995FA4D05B91ABFA0AEBB4DEDB94EFBA7FC7053C2F4AA2B52BFD2E80CCBAED57F90AEEB7695DC5B8DCEF456BA6EAC5A6BD603A09F568B23CACDDA662D312BAA718DD6EE795FA01A1AD34FCB459A6552A15634B048D922768FEB6B6ABEDC45B79647755782F4A0A7DDB6290DE5F18BB9EDAFB3E22995B525CA000DACD02DA5747DFF4865D5DE2D5D6074FCDADDC55A71F2E52856B42131BCBFD6CCBA7B472DC1FC4726BF5FA9A5946ACC329AB477755ED054CB2EA1D0AE2779F9BA2CB2BEF0ABE7E4A93BBDE91436B7EB3AD15AB41494C8534C7748A3437503A0612FEFFC487BBEECAA8F261ADB3650710DD0A476903AE4A975B74DE97497DA1A155925E8ECA00CADDF17E732000CFC05F54CFA537BD994F32F1F3F34CBCDE75BE6DE2AA48AB5A52962A8E780AE16A481734005AB675AA236B397A31C736D77248FBA8B594F8341939C452387A74E66D0E8D0626B80052C2244B1E18FB361E0C27CF140D35D5369D0D0E0CE959A6B724FB86FFBF8E19A1643DE090D93CA944ECA95144260DFE4F03D12EF31B74DFF485CDF7880E481E2732AAA44A997AFC1329296C29EF5BC5C690FEF48635DA5F937BE7C6DF6AB44EE97E9930CCB401B7EBB31594AB5CE9E359F3D5B7556E356949575FB9A3486E57B7CDE1525784239A572D7366F893CAD01A65BA0AD4A2AF0AD4ACAEB4AAE0D256E8A3578DE923BA54AD36FDB0A4DAF29327DAFBB952ED2AA0CA15EFF96288A6C9B50FEBA0E7D817EA3CD06345486327005E6BFAD00EE2E69E5ABE3B5D205DB22C1136A1625A481345C4681DC2714935C448CD01748D3AC40CD5BE0A60690ABA4E94AB484E4B32750734D3514543708F1A8BE29F05F3923C1DF5BFE4E5BA10D38ABBFAE472D5A0C6B80AA9C12D59366226AEE0DB421B64E01F3066DB0BCA06B4A5BF2C9AD064FE8E93FE2539A02349A529E4BB73E3E57C428D27772D70448A31EB9D3C8C0251329EDC2B37C471E5DD2E7A1E3C42C83D20E293DF535B348B2446E9A95B409D4D6CD275AACA14019AD46DA43726A31DD9FB6A51AC4FA1200BA63F1BB5CAD12B30AB45F13499B32ED859AC3B209926DBBA4B5618A673E9B7509FAAD6C9234AFD993EBC38A628283AEFA2CE46F34EB99B5F280F5348BD5FBF861BA7E7A229DB5249BD229AF792FB7EAB5BAA9DC90BAC26AD6874319B582F8C4EAB29AD38E792B9979495EB36E916E33EF5C277E9BF596151F392C4CD6DB5A669B967C5C639BD6C9BAADEC7D2FB7DB408809910354EE10C6FF089FC0DD1C9F50EE993F0BEC89FD963E1BFCD9E1CF117F4E9036FA6DCE20CACFEC59A6252BEDF284A74BFCD9604FA9C09FCFA4ACD4A063CE490BA39AE6BAFC4C5A6D50F43294682A77A63C22B2A8B4B1C64DBDD64108D5BAA41078D6DC1A7D2AD37A6F4D21B3E76DBB824FA04DAEB39472511A60C9DB6219DE2568B35A6F0D56AA6D56EFE9BB4B866D78D6DBEC59A95754D4AE3BAD3646DA6BE8173413E4D6455A20E5BA2E51AEEA45F66C0E6BF47937251AE5260F3A08F2D587444739AB7ECD58437ADDAC992641B93DE62B1691414E43092072C90284725396B0457A5399B6909627B335E3DE6DCB1352F10993C650FA956258573E7E6863C98E59F3D6126F0179C4DBF819689616D8B683757DD596A9E4D7EB72905F476B9C6BE3B34DF28019BD73933C98CA1235B3854F88DBEED6F8F459BADC24237C977D3225F02C37F993BF2B3C5FF109DA37F856E125807AAF5D29936A1370815E514C9527E84DF05E0649E3938CB11F839791A80BC0BE0016B4B1A616E94E936ED061B486B5665B91A91B59230F531893630D179F32D20E1649D90EB4FBA3DE201C76719FB53B4CDEACA520686BC573CA7DB0F64A602E639FA68F3698C748E59DCC4C340C0C2A57A6E8AB2AC1C4403FD3791C95A549AB3AB05BD5BED82A131851B6CAF0F664665A4F9DA7D1AC2E0EB30DBB59369F5B2F1074DE17C4E64B1D1C4E6635AA0DFC512F4F7AF7F693362BBD8CB323F1C66E3D8F2B2D5B7346B666155A1F3F0CEF0B93517630ED543A3D521B4DC6B581FD90291248131FC4CE4407ED1B3D34369D6A451CB6A595FED051860F9D09A9665E86D9D2665CB52D52D56DBD52829E3582BE3FAA761E3B50639C6BD092FDD9E069746F6747F7D08BEE3BD307B194D16B524657107AA53BBA6FD9EAC3C886BA2F5AD67E79C80EF29006E32C156A8CEE3B732D53C23999A7D1430B72ED29A9346CADFA3C1966FBA4FBD0BAD5EF9FFD5EAEF1A0566D713468AD870091543BF66856C98C6B9DC6D8698994D3A7515B72460F48DF64AE2BADD5A8DAE79C666C2DD70249F4C96056D9A8F7156B0C797D67B0D4ABF66234E814B4EAA00E30A698FEF143076A0D6AF67AD41F6DC6D94C98A321B48C3E1FCF3A2B1DA22DE3FED9261509CAB410C3838AE5727A4FAFD93E50F382D400B419BCF50B93F17DFFADF652F45A7319D2D496E4D13D609A0E36507E03729E8C9467E8A7E3599FB467030770DD417BADE11F48B932ED5521F26B4B9256936CA0AF09F92027688D4AC9A7DF2BC8659F74669539E8C106A5056D0A14B673035F67292F3BEF1B6815D08AC6D3A8DF42696734C00E1ADA6F0F1AFD7EB6B5511F24B1976DFC0A6D0AADD0BB2F4D47F7CFF2F001DA48A9ACA11DE7C36C4554EF4BCB3EC84E471A732D9EDFF2C7397C820EE4A49506ADD3017DD0ABA54DDB69C0B85E87361BCE9EED7E0E7509B8CE96165A1564F9D0A88D80236D5611418324BDD681366D64B04CA73AB0F47B1DF4A0713BCE1606D0621BA80771C8A85F11F55A633E74062270A68CA0C628AB530CED870E46CE16C812E8194CD587CE4A9BA296EB2FC3FB86BF53172255686D7B0C39C60029DE8550015D1F2C007261506B409F81EF0F0D2F56A6D2996833E859CA6883DA9BB175E86FAA18C71362E9B756E3D9683ECA0D36D0EBE6C0598CEB36F49DD17DC61AD76C05DBB4053A66AF41DAABF13406B10CDABC56EF9F2734CFC6B9B04A9E437CD9C703D0065CF46B0DB4384FBA72983EAD66033DBABB53A6D717ED5EA0291F3F0CAA951755041DAF350AFD6A693E763A8738A1B442CF2BC4E5D6C8409DF9F87E00113E2D01D40FA187419BC54BD65A68B750037A6A75E08F156A7928166A1532CC1E0676112C79A555D0721D7BDC2D7475B0B52AB4CA8D0D7DD369A17CA0D743A45A2DF5903BFC3E722490A3B9B74F8386B05EDD1BE61A73ADD6E983CE7B44C9CCE11D74BD34D3E5424FBB7FEE81A666470FF565A7D679B9B1412BB20B78F216442DC9A23FDDED6BACA7AD493F67BFE8A05F3753D0900709B404648BFE0138067EFA0FD9F67AD8036B09FF5AE5F6FAB6DCCE8086F486F9566F08DE6564B5AA2D0BA2F07CB3A7AD6F661D7F4C9815ED820CC7D07EC6430B7A99087DB39019C72C42668253EBA0218CC3D6F0DE5E466408ED5798814664B09FA20588E4D5C6D59235BC7F9E1B3B79D0A620FDD1FDC8472E690EB4DB303B60DA6C4A65F00722E0B7C11BCEC66B66B1D042680EF882D96815B1C7401BF8A08DAE80D599154156A86705A7ED0CE663F0209A09B5C16283F4B94680E7C99680DE96DDBBAF2C87F73A9609FD1CC88D7ABA4E45A7529E4CC0CEFA581B7A51663C6BB90FD04AD0CEF0DCE675C0FB81C6BE042D37C8352668A331B694FA63F179A5838DE2DADAA51E1170E99596885E07ECC694F95B8034B337A33EF307442E3CA1A5C4E730D7595168415B2D3B551BBC5D610512057D6B6EB5C40E7A4F7F19B1A6540755F0ABDA9AC1404EC525F0FC32468B931DBC1CD2A5839A64432BE424E83B9D395AA4660C1ACEC20792069C812D865EA5B7C6D90EA56350294D9B5505F8E98BA35E5B8428486CDDF7B31F3FDC96A137545BB321C448C3591FE850724DB9D006B9AC8113D01AA097452DF720BF39B5E00F2085D00335098D78060D6805A0670EED39E5ED2481557EA17E9345308F181F3D64332F580B6406DE19FCA783321D3C212F406B3B885F709680E2455F4E823E8B9CA3D642C948A4C3DAF12107ED8C3DED1E6D621346B18D15859A29A10764FEFD51A31E70B0006D4528CC4B3F341C1D2C14EA16C7CAF412A1D0A867B0A49C0F1A13F5A14523073D2C819CA067665E7AB01C29A39536CB4C7422DD0D67737B08838341B6027114A44F0779F5A11D448D34F20268B5368F87A8CDEA0257194C637A555A22AD04B5185A04E3492D57F121BE5B6AB9A05EC31E5541A369E4803D187A0CF8448CE8207E24BC67CFD01B37809E4E0F24BF1C417F1E293CC6245B8D1F5407F9A00E8C8C725003A4DA9B95784CA671EAB79E9947E64F0D1C39401C3C5C4B1E3E476BC9266597DC9AF0ACE1CA1D78B127522912B52DE118FEF9CD1AD536967BC1F2502F4FC0DB40B9479C2181085B440D81D149793AC591C01021C328089E0E96BC35C9293E4738B6C651D21A065FD5226280FC2901FBE72064B0D140DB90D18693B9F337685A20240DC788D535429C936A1EDF71847216AD87B4C56ABE604DCA0D703534810BA0CD40DC3092D3811B4AD35A5A46A4F35437A5339C37FDF8E1B14D2C1C93B11485C4DFEBEC1D064B031857504C6B18D62910659BD206B986B1B789D3307D13AD2501DD029C1BA4BE4EA432950BD202109B6D9CCD20E93E72053C68B85256EBE342E05E88A06FB475DF8088A37190029DDD5F8B580907958D0E448EB80AD05FD351DD2360EC006DCA9A404E1F9F20E10A4E8175C177E2925FA005A4ACF74845213D02F995363E1F91B60ECEB4C048B9BD464A70B40B6DE3E21816B462899267AD5D27375C2347309ABCD9D489B18631704DC4754BE08ABE3FEFBC6F506EB19417FE4ECAF731B99C029FCFC04D9F6A2E8EAE8196166DEB3E7B9671B4DBC29CB28903E50CCD31491E87C9F014512B46A6646149D0270BF39B3831086DDF425A411A7DC23112D6A675A2A3AEE3D86A4D408FEA28AF172CC15AA6C9DED9E7B62B3F8BAB59F1C7767D315473BDD32CB91BD2F5D9B65207681B6C933EBE7594364DBD95BA30EAEF546CC5D49ACA54E9763AF552D9CCDFC2BFBA4CF2DD2E96931A199C28549C29E057BA8F9D35C496755C47068865D33425096A4DD638C5885065E00DA0568989D84C45AB42EF80F4AE59EF23044999F641BF418F36F887CE12B4EBB79249CA0C37D492AEC9B40D90DBF53AA6C9645A93A406D6BC559E448052471A413EF5EE5D3BAFD7A017104A7BDB64D0645CE973E591329475E092C0F709480CD0E5BBE6B5525FE4E6DA603215F3F569DD1A7660202393978612CC66B04990F5B0FBF1C35D1BFCAC2D96A5496382290AA9576502691D208EF4252EAF2AF45CA926353A746E069733A4864E9782660AD832E07AA6286C754C010259AE89B938610369A6146E6690F274AE7940EAF7341E520A305289C47976C705EF98C3BEA0D4493BDC4AE0C2F7A77D33276FCD9B10E081CDFC10692841F72B43645280F8DA516B6DB32D13B3F9449E4183A1CF2AA46A156E3B834E15F7888C1E74F08ABE3F9881B7CE025D4F996C4BCE67407CFD8F1FCA9368A985025E760D9160A187699DFAB2371DF4EB30BE0B47771B22DE3CF5C982CE1F9D5D9F9DD19534826BE3687B9F436F168B95EC6DAC446701AA83CD8D2C2DB42C8CB96630BEB6D6E6963E113090E5C70F4D39BF865261B47C07E36588248096B55FAF489921D61417368C5F576A76B0BCBBAFE75A5925337CE9679BBDE90BC815E2AAE913468E1845D3D8711BB36DB623A408AD1047B677367D48ED76BF43FF51AEABEBFCCE3E87FA904ECFD5C95B1F297FBB9B542995710E0AE290EA331B79F0392B8817214AA04B9CF029A71B6D62BEDA1973E0F3953D18EFFCFC1BDA5F045A9B4DDEE2F4EBDEAD3C7CE5B579389F7EBA0C5A65822FEA8E4AA9129D0496EED197430C708FBE1DA28C1E460BBDB5748B7E1562825BA20CE13DA06DD5EEADD2668003A28341BE52A59B8EA4D683D91FDD6D376431CBBD8F40255C3FAD0C316AD8200E152343F0AB5D1A450C214E63851B1CD280B078638C711E4486C3683C47C256B8218A41777628844657E091540A51231D133DF71A3D74036328F0FD2B0A99976FD25881CA750DD0302A30D906B3AAC9D61A21E65991AA48C66D8C33F2180BBC845C41BC425B4669224D0B1E412F490DF760F44C8819A1E6283AF35EA3DC4951EE3B34766A623CB241EE20EE887109C57B28B736B6D914A91DB63192E9236491C53EF02CD30D7E22463A909EA511107DD2486746AA758C919EF08931398B91202ACDD11D0484FC484811DBB44A71234DD05238BFCA23EC15724F3F102BDD982C56C2980AE54610D71223E616AEE800CE26E75AA34BED0A6B638866473C9A1D22F70A7D2E68EC095C228F1F3F7C2F2E9147A46DCB2544A753D48631D54813FF97301E1ED1B18D825C9779E457E05AE4A022E8B47C136883365963EB6A54AF34DC2321A2E76FA3D6B3987C4D6349EC03B873A2FD0A431F210FD9BA3370057A35A1B8D611BD828FC1E5D6E35A31E2A32226B7ADF68CB996D13625D8B30718B543076DE298A54C256EB327CAADCDE3DD36C80DD38728CF0C3E99DC86D803E818B089E3299B4B1CDA54C39A41B44F7D978A8B5BD8EB78C40C23930C1D7711B021C82D62E0FD94B5EEF7685BA48DB56E5C83313EA61ADC46798E11538D8E6CC5039AFC8C1A0C71087245F947887DD4ED0DD76011DB92D9AF2129E3BA1F04A738BBC15BCE426D32D07B730C6C8D7217C75118F67CFEE23EEBDFD0FE95D0D02BD18D23B3F2D6C1FE4568FB37B47F437BE37391DE1EC588FD642CBB2C29B80929C8B948977BDD73F6738C78315FF883B198CCAEC5C44330FC2763E389ECD7652F30919DE0C75F948BFCF6EC5B77A8D10BD2FE9E4CD2F3A3B494E0F39F7DE1BF7DC80E1ED9EA06EFF588DEDBC0AF67E03FFC96A23F021BD4B5D8D5507EAC82BFD42678D9C1A7E793CD67004F7F0A117FCFF744585BFA62C27E737062E00514EC379391B2FA23BD6561A63AECB763E96952765C8923C35A33754A8F9C5AFE02BE9D442E66B08D8521588B941042EC6DA96687FDFD053FF24F7F5A72E10AB6ABEA82838423C6F1925DEC30F78C95E52EFD7DC2885D1A10FCA8AC1EFC963BCD8DDD2028784652F5BCF08747814C765DAAEB44AA82C8BC475533B834987AD08B04C3CBE28A89F007A91515E4EBE00D05F422098695B762F49718E9AF69EAECB74FD5C747FA6344ECB697F02284F027ABF92F56306D644425B164D261D748B0ECE097A22F6EA864F07055E4E7CA3D753E6119DB7E20ABD002D6627399C8F34BF52E139AED25C303D9E7FB6E2F8CFC02587885507869053B3506E95678DAEBA7E0E8FBE5B1D028B1B11FBE6E01D85DEA05A16BBD00FB995CE6249F8DDD9551D743A9FC12F949E458999E3BBF311E1797895C2173922D88D15FA9BE4847E4155A811DB95EA4390A7AAF1A570B76ABDA412B8025778CC9FF07504B0304140000000800176BEF4AC09FDC0953000000580000000E001C0050726F6A6563742E706172616D7320A2180028A014000000000000000000000000000000000000000000B3B1AFC8CD51284B2D2ACECCCFB35532D43350B2B7E3E5B2090EF60CB60A482C4ACC4D2D014A2A0055E5155B81446D95CACBCBF57233938BF28BF3D34AF492F373F5830B7382538B80A6E883542829E8DB0100504B0304140000000800176BEF4A2AD8C9E6B60300002A18000011001C004050726F6A6563742E6D616E696665737420A2180028A014000000000000000000000000000000000000000000ED985D6FF23614C7EF27ED3BA0DC9BDAB11327A8450A76322195A95BBA5E21556962689EE58526A62F9AF6DDE7103220055AA0CF45AB4A082976CEDF2FE7FCCE717CEEFB43BF7755E43F44283BCD83540F719E5D8A47915C683CCFA41F3C0A5F64652CE347A1759ED3242B7BD5EB17DAD3D353378DC3222FF389EC86797AE63F24BE281E457156BDA1F57FFDA5D3396FB467A290B128178DADE6977A02BF07A9B8D0865CEBFF43224A914E3080511801823101D6C498003DA093704289A11BD1BFE7671B226F2A57FF5ADFE543FF50CB1B51946A5F46C18FBCD0FAF058F3383BC57C308F93E8787396A7A9C864A9350607CAB042045570F040AA5DD4213201D2816E5D23D8C3A6FA7521A698600B40A3070F9EE5423E2F6A1F8D38BF1E8F02298F54516B9DCDA558533B54888B322CE259B5E06337CCCB8B3490CBDDD7FA689BFD665B83C7523308FF0EA66D62EAC6F5712E837916DE8BA21BC9F259AB7BDC4C162F57799CC90B0D699DB38DC1D6756B559667598DFE28C8545F5136268B6E2E6649FE5245CF309BE4ED85571964257015146A567225D19AF99A42AB672464A0822BD8BDB6FFED76A6952D9DAF930B341CEE5A2E0698711B104A1C3018301D70DBF15CC7658C32BE23B9BCA55F075C33EBE3343693CDD6B079BFC8DE94F34E9165E2C1A74DA59D7F9666A748FEF6D7C29FD4E3B681900528F52C40A0670007DB06E09E85898B09B49971A43F97A1D942D93A4E6C4B4E3965135AF57AAF97B7E7994D081B6EB70DDF74AE8F2FA2B8BC15CF22BC9D05F27E73456F00BA7F610BA72202994D3C0E5C076340069803DB54C5C573081E182663889A7B9DBA7F8CA69AD5C0BEB23B5A77A78F4F931D6661328F54F2E4E26E3EE5F374F606D4FBE5FE140FF3B810BB4F13EF11591D0B4F51B90992B95260BDB1EA9DAA30EB787122CAF1A8395976FC3F2E3BF5B1728C301CF36B7F3C88B36CACCABAAA16D722BCAF8E745D158927B8AD527A99A989A0BD70EF2769ADC42E793988A5249F4EE36C7A9BD4387F2C4FD0849EE570064C170F0051F9120C1445C040860575665AC486DF3C7D199E142D7779F99989A80A4B1C7D34060E750CCB7108A08685AB0F4B075896670307619D33C25DEAB16F0CBE0C06329D211DA7E9E7E5202DCB87E436CE4AF9D128508A91899803A08D0920B60B8163401BD8C680511D520A09FD46E1CBA0B0B853E1EE0D323F2F0C651997D1DDE2A3635E05C04F2810AEED9A06232E700D8B028290071CA64A85E332CBA6960B3DEFFB9CF475A8F8400FFC7C36DA5D2BC3CDABBDE626AD7571D9BA805B36BFBADC5B4DAFBAD9EBFF07504B0304140000000800176BEF4A9DDD9D0CA50000001C01000013001C005B436F6E74656E745F54797065735D2E786D6C20A2180028A014000000000000000000000000000000000000000000958F4D0E82301085AFD2CC1E8A2E8C311416EA0DBC4053A640A43F690753CFE6C22379058B6C8D89CB37EF7DEF655E8F67DD2633B11B86383A2B605356C0D02AD78DB61730932EF6D036F5E5EE31B21CB551C040E40F9C4735A091B1741E6D76B40B465296A1E75EAAABEC916FAB6AC795B384960A5A3AA0A94FA8E53C113BA77C5E673B8A09D8710D2E5B020813F15C0B8C7F45BC0CD2C43F2123EDA831D22F8C7F7E6DDE504B01022D00140000000800176BEF4AA5CF1B4AC635000016AE00000D00000000000000000000000000000000004C61756E636865722E64747378504B01022D00140000000800176BEF4AC09FDC0953000000580000000E000000000000000000000000000D36000050726F6A6563742E706172616D73504B01022D00140000000800176BEF4A2AD8C9E6B60300002A1800001100000000000000000000000000A83600004050726F6A6563742E6D616E6966657374504B01022D00140000000800176BEF4A9DDD9D0CA50000001C0100001300000000000000000000000000A93A00005B436F6E74656E745F54797065735D2E786D6C504B05060000000004000400F70000009B3B00000000
	
	declare @2017_bin varbinary(max) = 0x504B030414000000080029AF464B690789887435000003AE00000D001C004C61756E636865722E6474737820A2180028A014000000000000000000000000000000000000000000ED7DF977E24892F0CF53EFD5FFA061F77D5D356D6EB0C16D7B3725C46583CD69C3F4BC7A4292858C9028498071BFFADFBF88CC949030B87077CDECCCEED05D16CA23323222328EBCB8F8AFE7B925AC74D7331DFB32914D6512FF75F5F1C345A5DF3B979F7575E92B134B17A090ED9D43E26562BD5EA7E6A6EA3A9EF3E8A754679EEE7DB57ABA0B30D215DF4B7CFC200858DBD51F1BDA65E24E51678AA187C992AB2B3EB455517C1DDACBA44FD3B94CF64C289F174AE7B98270D77A55B4ADCCA1682B6C732F48C7959CF962E9EB2E2F5EA9F4774B6C737E6D29BE1F66C3BF46E532F15BB6789AAB64CEA4E45999E49385EC19498AB9B29CAC16F339299B29940AB9ECB7B0D6963CFDCDE24D046F14CF6F399AF968EADA9DEB684BD51F86142FA432A96C26037F4ECBDB1A8EAA583A2295CDE4F361F2EDE449577DD68D1B6569AB53DD0D3379AB0C99E236D9757CA8048DDDE82BDDBA4C64C22C8E84B8342DE0546E37BD36A05429C97251CE6533C972552A250B62AE922C9F4A62329BAD9E167367525126A56F892BAC7CC11B5CE8AEBFC104068F21CCF1AB3AEE5C09FA9FB82A5DA4A395226058F13BC585DAC056EF8A01DC9BC9B2F6894D229A0542A730FA94E2E95C004A67A785FC59AE983CCD65B3C9C269B69C2C65CBA7D0DF4A55CC95F2E562B5FC2D5633CA115D33BD2F3A48C59785E24F135741B93D54790BA138CD7807878AB5D4234560409E7B0B4585320B57F770F825AEF690125A4FEF23D83F809865A90A23BB5A4E56CB444C1648164653A62A25B352AE729AC910299721DF21A6E51886691B5F2C94DCFFF304954FAB55B95820C97C55969305499492249F21C94CAE2895A46CA95A2E66DF20280AA6A9FD9FA722C967CBC562E12C49CE0A40C5AA04C33B9FAF248948A4B25CCDE54E8B6F8CF1B9E77DB5BE98B6E7FF9F27A424564A996C9E24CBF017C431574D9649EE2C99CD174B854C41CE9172F130213DCFF4B40955974B44E05F4334F767795BAB35545C135D024F486F13B79E42CC886D93A3448AFB4DBFF654D75CF8425FF16689C38CDBFA1EACFCABE215DDA319D4E73804331C228562312F9342523E1381B3B9BC0C7E1029A35B74765A2D94CAD5EC8EA239EC0B1DC067EBE024B30765E4109EFD29745EAB9BB68FDE4C5C6A7619106630C0283E575BA1B8604D800060E6365D103806FD2F4A51CDE71E957CA950520A79E87CEE2CA366CB4A3E9B29954F335A225A6BD8EB9396F2E4B85BFFAEF8BA8069470A6462F9378A6D2C81EF9709A93755DC452CB30BBDBEB5AD4DD8C7CBC47F7239393F8F7B1F273B19314B1ACD64562192B2D57091C437472B25242761C3D7E7D1F480907C8899BAF76B4FF77D40C54B79FC4B225E41B655F0956DE33231E8574B3046FFFC57A942FAE4AF17B158E52788557E12F4A0F04FA6E7244BA5623999FD89463041335533885F2E134BD73C0F5B15A4A5EBEA3632FF11CA5C263E55F4476569F99FB933CB33C231CBDF798FB6A583A19E8E550811A0D917E9283E577FFBDB152D1E90EC5DB43C422853AAB70020BF8FB2340ADC5236B1F41F9325161672CC84BEE3585E28C2052CCFC9D1575C43F781D634AA4804949FFAFEE23C9DF62062992BDE4E00A9A150A27CA4E7DE04AB414898C96FB9409573CD75968B082B100F5436B5A5A97957BFE533954CF614BCCDFC59BE902CC8F97C92944EB3C9A27C562995CB32B847F96FBFFC56253298262993CC836B0A214C259F14AB053199C9489942F50C1C0051FA16B2660B9FB72B39F6A3692C5DAA7A0578D34CA652859FFEF3532CF3F34FC2E5A5F0D34F42E2AAA24F96C6453A961D76C452FC478888766105E91130C4DE487703C08D674568118928AF4A104FE63367993CED45348797EF511E0489B9540664339614A731F6FFEAB722C9917C512C26F3D95309BDA652B2543DCB815DA8E6CBF96A4E04A76A4B375A8783B95DFA10962325AF6ECC89ABB89B8B74248D97228B059828D3B075B7EA581A98DBADC6B848BFCEE5D5BA8E436D0535EC57470C8C8B74BC4AD0BCE7E9F389B5C18CE3C0C46A70284CF6ABE815AC1D7716D0735548152FD207327955D40AC4821ECE41235D15B3B98B743C29E8B0EE39D64A0F5AEFEA8F3AE830556F186053F49D3688EFBBE664E9EBBCB196E941E8AD4EAF7C77A903257E08AC50F5ED8CD2F8C03D66ACD07182921EF848F8DEDBCC27A06B38CAB1A468312A4B8F4BCBE265A2B2750B6ECFDC7C817CC5F20048F81E93D03BB09A57A95F27A6FD2B85F06B20A6348317956DB4BB037BAED86017355A10ED6A00FA607E88EBA369EBD079CF576CDFBBAAC8E2A0F64BBF4B2419118F67066DBAAEE376F585E3FA57A0D4E70B1FDA89A4F162F78A6B434B7492E7AA70918EBDFF382675754B573CFD109B381DF6F129243B63E577B9C05BFA87F0E17F900368E563B62D1C8742C356ADA586167FE341A944E8D21E2E934207F7A882F7A6AD396B2F85F371DE51351EE6D6DBE5225E7F30259C6A710EF47B2742E030D0394FF8EF045C30CB5FBAFAA5AD2F7D57B14E84BBE5C432D56B7DD37766BA7D592A970A454DD54A99524655CBD9F7B7BF8D3F7E64FB17E938DB5E733162B2B60846BCE0484F70E21AFDCA7DC502E5DCB01F1D70EA22C14E6F39A14A4E723410F8E02D886039CC5082E7135DD3740D55FED255F7B715647A29888F9F234DD574E8054EA05F419107B44BD868987A91DE1608EBE09C3724B3A17BB5051D10053A73918E170A70DF45F6183AED6D20D205B2F41D68E9AA4F754FF0B60D10F5856E6B6067070BB0C97142A05A88E61E2071DBB1F7A3F63ADED947D9A0540FFE583AD2F83DF40DDB3882BC88E83124DD07F3F752F4150D8E24EA2BFCD8706E29A6FD7B47C3ABA1FBE76432802FF8535DA01188E02E710E01FC6C4111A4FF1016CCB14D25937CBCCF51F30BDCDF8538FC53AB47231ED1B4D1507DFE75AB8C58249FF2596414AA105E577EF6751BD552686E86A6B754AC9EBFD44C67DBC3AAA5AC1C77CB1F812FCF1C15F84483F5A0E108A8BAE3F129179C9F08DE12349DCF01404B629E9C968A8424CF64524D16449C392D1732C9E259B958AE9222913267DF1202683E50A1D4676093414B0FE2C0EDC406F04DE8EBF3058431BA87B4BA4C242293358020362B44A780E80C50BC0CEF8464995BEF3852BD8192850B6E30B27A8DDE975E3F9B874067272B022FBD1F20B8E13B740F85EA159B4218319686A97F2CE83FACA77F748CEF4280B41D190C7A28CC025A0081C58B3C8FFDE5B6558078329ADC8701B570CD39847D82E1807326388F30CA4C3AB4208010E09BEF088A65396B18699E0972A10B0FAD9B209F81F1A7ACE81CF8676D84E9121C3B012701D1CD4BD1560CA6231107C5D6848502F8D8066B4EE760568A6B3A4B4FD0C049127C104E4F505C5DD05075FB535009C6949646B9052F1088E583F9562D05ACB0C761C0774735417635616DFAACFC165E2ADA79F959C1EE9C47D352A994A0684ECAD6FD3476730A9D00D209FF4F60732358804B187097E50A361501789F9B731DDB495CF9FAB39F0EA75192CC508535AE0E805805CBAE34ECFF6E7197BE24AEB803B8153C9482E0AD4B0B9D08FBFCCA13ECCE110DAD5DD3FF6E43F7B4D0FB1AA29C616DE038CAC28058E1C2C015954194A88D603920271E84B7B6719166B917AA33A76177504C1178CA453AC8BA486BDBC9E468439263392EB88A3ED57E815FEE2A6B68204533C33EF0D4C49568A1153D005034FDB9B2008801FB2F13CA56C9A69F93DBE93410AB944367BA531043C1A84B4D20863A2DC40C00EBE35F590E05CA340188B4A7BBA6624158A609A9B6DC17C2F85F6050FF165028D08207506EA88E7D880498F78A02EFECDBC6D715D755DEDD3DCA65D01C7409C8465704588BD0040A8E6A9D40671C4300DA602011FDC3C2B2875CD14FA82C5D9D6A24C5DE08F612FC6017914984629D105C1079A60E818A3EF84181CE642090FA0C41D080A6BBA38F1475CA74154009EA23BA58EB84AA4D5A9529542C030ADB8916E4DA18D824806714B02C45152694730151F0E634A6D31901A9F664187BCB05F59A3814D4600C5595EA5A6A3F0EAB61C555A7266E6581802DC561485C3553F0A0C67FDA3642472ED23222D2D8430FDCE8A8EE668082AE40693FB56BC0C24C80B8F4A032BA8511B04C323C46415FB72C2F02F9B5AA14A640592090061E3074DAF369692ED94220442A5B9D006B673B01C974E658509B57A5AEA961AE747B8B200262249D2F01EE84F6475054600DDA796B13B3456D07E43E29BC5797509B0D0DBDB6D098FA5A6303AD2D2BB0CF2067D07D1D784A4B330B23A860CE191C4CA0E2CF07216BC4132CA013907AA283A3106350D0F7F377F723F009905C82704E59CDCA45A81732990A4C7CE49E074AACC78BD1B6536C8713AE0BA744D61E7B84E9BB50A8D84C818F819AA26D7162073EDAEFEFB4E7288B1FDEE5EE12B4E75C3FDCF51EB68A7FFE70B77F0F9F77ECC3FBFA6DDA547D45CCC22EEA4B8F590E4E0C8C2FC187B471979F6EA5627AEB8F303B88369F3DED9CBB87A6066E1978E8E1CA1AFF720E65C26536DCA3B9CEA71CD7C095B42C3A9ACC650F0ACF3D3403B8206A73C0DE969049305AE7502EC94A8513BD88856EE968CF02FF9022C28A9D373C9C7B8448FF328133BC91E01C2B024CB052CF91B07C9B35754C153496F27CAB82D6C3755A7BE22C6D20CECE22F36B0C402694289271C07BDB8C14F0F4AF4B9C42DC6391F7B445C527F0696875EA4DA0EB62079867E2612A87957EB331DA9412ACAFF0C66C1A80BF6E6B0FF47DD56990F0FBAB8771C6112058EF0ED19AE572427E8F9B0A9FEDFC7DDCDCED048C66C5FB03443896053F9000FF64A2CC47F62D3A0F8A7599C8EEA3DDDE06B8DFFBFE26727FEF0174549FDE35A67621E67FC830DB855AF8BB0ADE36C2F81793BE1F291AE0DB2325BE2E4D88107E14B9792D6AE322D38AFB41BD06C2FB476D344B78735A8883E1731CFBE688B6D1EBEE74C9E1D9A218543A75F40E286E4CAE38903F30A314ACE2E58E5DC49B9C9D2945B5789A2DE70B7AA6547E17F6C1CCD4F1D8BF3D4DF577C41EDE70EAF68FED2D8BADAF1C39B5FC1FAE6E60EC5ED7ADC5B920346C9F6D3CA2F1BC43C338B6FB54F0156FF6F143FA2FD4018F6CEF6413C09EB071965803E2623A11B3325D7F09591B16112E82095E36FF013123F8ED18DCC23032810EE8B903CA7FA1530F18F76E0305EA659B36C505E733606460840920005BDDE07071CD1886A9478BB88E253C62B4295098F48FFCBCE0FEBBE0C01F57603DF784F5D454A7C25459E94202C9901016AEFE683EF335249DCD04D3D96F6FA1ABE6A3A90A6B6543274A40ED50E07B3179D415140F6FDB0188BE23D44C097F497FFCF01FBAAD3154305C8277CE9170A393F7F1038B599854FE127FA5BB06C2B47DCBE815DF0B42BEDDBA31017F05D8540CDBF17C537D95D5071EFCB28BBA1D202C1CB10BEBE387DF9884A6D369E1C25BCE7199E16A9BB415E660CA02B4AABB11160E44787C628A4F33308AA604A1E2D0F91675AAD8069B4FE19363810DF14EB60D0067170ACED284AB1A14682A82557A8BD69FFE7A88B23804BCC8568514AE596D5F65C4FA0E910E7761FD0DC02DA8A2400C7C885C797F227D3E3FC8C957EDE1B25FB7CF12D846691AC98A0A8AE69F7EDBEA819DA13EA00CDD2BB8AB7023365F8EE17BE5618CE2420F6D6A0B1755021D099017D414E2E27E223C9A2EC4EABAEDC180D84E3885C5A78A070A01226B05770FE0C88AE8AFBF08BA49472C56C1C9A4605A936A0D3E73B5B3BD1A577DE9761D64F4FE7AB1160220D402EC83F2F86AF89E6C27E710E1F554A748427B2885A00EDD580B386320D8BACE6658A96D0A346C40069061A0249020967A2278A89B62E4542DC7E34926DDF104A3CE798CB5C7D63805B6C8C9E637970BF0CAF40304C302310087C981EBCE9CF081217015DB63F37D2849B266FA0E4E1EA27A49C5A086A2128AD56B5971E892221DDB50440095B3F052C2F6CC069B67B7A812461725E9404FE2CDC45EF8621E32118B23C31E5D671E91D7F35879014FB8F64DDA348C50FAED52F814A47E1670208654F92B5F24393FEF05A5137F4BD1332CBF1C8513CA0217A2C318C55B1C78BA7B7E3EDFF4A8FB1B6404CD02B2095B5FB349B3C47148EC1066C1B60E6CB9B4830F6AE1096E226D68481A787D4595ED11045E703F558EC688EF5FFF43183118DFC1E848843C9CCFF7CD95FEF742ADA6FBBDA00D8AE6A7CF7144D17D88E8F798350E53E35ABF6ABA07D5BEBE0273E885DDDBA3E6773420F5E340B3EB615518F4FCB88AB058BA0B5052DE71E3F291E105F074DC9DC900EE1903326D2805DDD0E936CE4FD9D289803B2CA0039E40A9E425204554F88218BEC0BFCCE7E378BCC5C3B4B7FAEC086C1ADBE29FF27B51E229081ECD1D552D10AB72FC4E40BC68F33A31C0447D7E17B6E08FD2FDAAC720CAB7B67ECA16F662D97618DD50B3AA3A481E5B3233EDC5D23F404B14C37709E11BAE0758689B1D7917D806E037BC8E9E037A996D05015AECABC9E30CBAF0B7D7018786993DF49D05F863B16E25EE1D778688D2597E690BBE158007EA410790E92A463A094A294D0717C33A52ECF962842D90CA2D8D7B5EF762879B7CE9C355D6118C2E2993B70968931434D81511F40851E9B4C836FB137524D1642BF47D879F02789C11E0F30D20D796FBB1F63EC5CA7C8EA1B3032D9D1E787A10BD051070F11BD947BD225C3B3F612B2B2EDB39BE53FCB5401FEA2BDF791EE96B0CB5784FBFC315819E3F7BCD91DFC7903B17053CF5622E7E0F4BF8EE073CA386FBEE90032CE97F98F4B15EBD8BF86FA88DC8287F1D1D06C9D41881B59D3A1A5D738711882B72D893DD712EB0C38F5BAF35364710072BEA308871711B42773BB4F6FEB6B113BA2EBF5DAD077909E2B2AEEE2D2D1FFD38707C71F6021CC8A54A152C288647500BB8FF61A71B0E4E8E30D57882330F50B89ADD29140D45A3E971622D5C7345DBF4512309CC37A43B5B312C59D203B42038E819C6F2626EC53140BE808DFE32F70CEF8F410328C7A1C482E595636A0246C79F22C6F1B72801F01358B40507CBDFE3AED3B61C75D9D1760B0BCF8C5709B35ED58D7743718F20047E7C77134FF82DFE8A1F3ECEF9D95EAE47F63AD5C1A510DC854DF51DD6FAAB66A36063078DDF841EBF10E5DD8DC40E2D7FB7A1F86521EF696C7BE4F9AD4622573FBC07F89EA3D36FB5B2EFA4F5DEE65E37883294220BDC56CFF65C7CFAEF4422F15BE65B22012ED76F59FECCC1131CB0C839EF40524EF6907D7F5320E729346C38BF08BD89337A0F2DB03C718DE59C7AF8970CD537A98735E81D077ADB61338C500DF7151C28DB051CC0D9F461C0D99AE26A0DF435DF5785C602EFABC28E56BC5D8761DFF33716928AEB854862AA6E6A9A6E1FA80DB6B737D52D8BDDB08010E811B7FD5C49B1736F5DC544E783F9EB5BE4F655601D400DDA0D3CF59F2F31164524BF3834F70B2A5EBA22E5ED433245E97608048DC4E210F6C1D8AAD04BECF62FCC281D2C79600458F44EAC2FAAAB78D32F536091051A342AE87B4617D8CB54438B08E3EE7008E5FAC0504889E073F0433638DD7563DAFA7E916625F9C9C148C17D45EF15D387512C3F9B873A8B1302B83070892C806278F4657FC147E1132D780951D7EBEC3D06043F3BFE089F726053752CCD4BF59863B2A7AFDF5E27E996A7EF6D7D7FFBE1565D1FBD843D4DEC742DBBA76B6F740F3F1C36CE74D14528A6003E75A9DB26203D016AE240D37B7A78B897C72342C57BB9D8874BEEF3B970081BFC2031FECCC8966A78EDA565DDBAF7B865B6870B2A9F76FDAE88C87F3E40BBEFA01D473DF8F6B390F8D5FDD51612F0ED8D36DFE8C801D27E3B242AE9B442AD1E0E5C7408056CEAB0C0BC4123EE4D1E419AA3B8B98F24AF9B382C60873ABC77122B993D111272A5D14B9C040D47A65A7EFF20AFB290E3FB837CE755C53948E193FCACEA0B3601F6BC43CB3D34FC6ECFF4E7540B540EF84A3195FD7A4AE987F41077A3AFA9571E76E3D35E0C769BDEA1C523EE60B1BEEFB92F52122ECA1C301F15D35BECCB8D0D8C6FFBA2391AF6ECB58EAF5CE093A8E3FA25348551BF3CB0EDD1F49D728FD460C642AC28C66180E566DF1F62658F0DB1382EB4C33C56A178811BB7B070B8E35DA0789F98AE4E51BC52D00B9C9E8CA74A58BDCEC8454BBC1E4EBF33967B87C38ECFFC6BC73DCEA357CCE139AF114EA7B9088BCE73AA3775D69F123889B3A76B40EEA8A71FD2F297D7C58E77F0B1F461C776B7E4AB30606F4137BBE344660F957885CE1E6AD07E0A7C9084D3ECD18ADF5E8F323E414107DB4117FA139FEBF3F0F4B37B22441D67AAF9088A0F54FB62817F7878087DDFDA5300746BC7AE11DBA379B8A5E6E2485DD318881D5DB7DFCB3C5403BEDE386B1C0138F1470F137D4AD0C8E03CB1CFC01E740A5FF91347A2BB0BE7B5E5DA51A0C7317737B8F927E56DE072FC0E621D362DC1724CCC940A9AAE5A0A5B8F397E0256B79773A4E9CAD474767ACE0662E1396CC19B3AAE8FC330BA81CB539D851EDF72C38F64F96C0D7CAAC75B7199F18FEFF5D99D057D85169DDB5E2B5E7874491394A5EF844B3547CCAFD29EC5287490E73C9602D5F59DFD57A94ABF874A93010C62B0933834EED2BC1B1AAF17E1794420E213EC7F0271F8F647CFB463F65BDB0CB3A737F2D187D8A17C327B9AC0A16A6B8AE5D8D0C646F7D8B176F53CB8BC8E1D8151BF73291D729FAFC9CF2DBCA33C93CE94D273D05DDB433493DF77B19DE032DA8717E8E5B11F5EF41236D637DC34760155C31B4A836B2BFEC492834B15AEE61EF5312ED2B1D4B01C868FC75F6D16AB11C240E7D352DE7143DA6EA510522015DAD56F722E9F39AD96AAC9B352564E16F0B668B15A9593D952512E8B95B258CC95BF3150DB5A4894F45EAA50F0D1EB3DE22D46AE1139FE0AC5F4164CF5BB57A58457BC1C536BF76E9F63EAECDCFDF0BE2AD18B5CDED5ADA32AC6B70EA7B76C8A32E4221D8EC31F761FC65E34DFD029D1ADCBE974F2877E3E7E404B806622195A8D2B9A889F436665B201ABE73B8E95C2A26171896E42F5D80E3FBC3203E93D5736105AE3F637D3A627AE553CBE385556261E08A686D2B270C38285B7A8988F2134B666A9D153CCA0C583C6530CE5F41E9C7F34693E7EF86B70C2EB5C302C67A258E7E7AF370AA750F91008983710DD807D5BD0054DEEA2873B603F457F7081ED17C71D8C18BF49245BCA66CF09FA6A039B2DEADE31370E4143911E7A10787A108FD8C33BBBECF038BDB095BC54287950F90BBF00F5D3E7F3DF012521FCCC243641D5C7E7BFBD7B33740462E05A44FF9AB6AFBB40537092145CE3DED9351CDC55FB8A2FB13B005391BB7D822AB84738EACB6CBFFD750754E071F0DB98DC60BF4E98500BA46FCB642444006F771D38C05963846F047B5879E8CDB363D15E04185B0FDE85C599B8EB9C017FF739D66C817F1781C35341FCEB8F709C0E199123F55E6C277E577FB4C2AD1FF19C032CA31120D7548C6B9610D9BC2628130830704B5230DEE9EE0AB66102A52F7ACB03DBA98B8D5270B831024F6684FBED535C0F6261DCF41B1EE6E25BCC403BCEF1C75536145A64C71D05B77B5D4F0427AE6C233A292066DFF42D5030C7DCFE8D02BA0742E4BEF54F8943856263EBAD62F385626F0E17E0F7FCFE21842567B1714D630A50C2AFC27F0B02FE38CFA13A7D57D1C06575676FE0CE4E37F1025C6282BBA2A2BB23E94D6B11790161C1AB31BCED3D1081943C8237C3797F1E339702BD793D801E49C6FBD6C346B7E9D46516DAF49A956D6A575F99417D9A3A7296740F203BB7B3C1A34ADB9D3B7453CE8697E07A80EF8D6760A8498EB6E4310CC0E4B39186857FFACB4F02EEE69C3A6B9B5D7171BE632D037AF25E7CC2F020F51720EA8FBF54ECDF5ED4BFBDA87FA817B5153D74A38237BE4116DDA93DA72D9DE5D663DA16DED542FFFBA813E8D3902A35DAC5E0FE159EDDB0B7D47974FE7753C58B50E56D9A002542AA7C3E1F028A7F073FFBC051444120B81CE5E01D4C49DC6EAEE1A424BB8B97BAE027FCDC8343778B2F17F055E5D7D1B0896028A1FBEA81A3852C8D6B46EAD1A36A8C2B23D48FF4B41547038F9D8777ECF225AA101203B23215AE5205CB9CD1BB9DC0DB4393173B1896DA22C04E9E39783076EEACF08816E3345D9C6207DA047A5A9AA961BE67D85DDA1C760829BC9F2B0DDD171CEA499D30C0EC82560A6AD80B6F66653577638EA870B35BC075B7EDD878F489CAFAAB40238C9318054239DB1FE2EC8424BB014F5C636DF554C87B78DF1F9DBC09F7A07C877079DA5ED86F91E8EF3DFEA3E15C48E9904C9F3E47A9FC6D1FF26F2C25A0EB86E1183BE9AB2A2A1E08DF257C78D0911EE7A02362E7D4EEA1E1B58F743BF73EB1138B225ED187DBF0B6043BAA780F979152445B217EDA5E4ABD57CC76DF8F8B6A71F5E9534442717795BDB4ACCF9F0FED7A391A21C80DF6541F5BE7A8A866AF690081444DEB3C7E0A933EA70247FAD0AE9B58BF29BEC7ED6EE35301FB07F64E9DF74BF6ED4A775DBA3A46659B5D0D8851B4AE683F79C12F190D1A7CDC6F8F1CD3B0CAB276E185B6070DCE72E185B1089E79E0F641D867A6FE6507C9619D19D0EC5D533E8715ED1EF9F00E818AC100715BED9E23DD2B37DF9F3E62F70DFE91DF8FD22C2B71D51F7EED10D222F091F14F3A5D22E4C620C1A7438EFF7CFC807F59DDC2E3D228109FD8EDC6C410FBADCC74589B2ED48DB856E7655B9D57FD46AD3D9DCC8B2B4D12CD714FDC68F70543817F5DB9DC6FD4B2AB8F1FC6B5C1B2D2C95C37C316C44E1710EA13B9426AB34CAE3ADB367E4B48C324379009C51C4C690459CE93C17033A23D920354E1AFB88553DB7E954890CF3E2D326A0C68618026865018E1287A3B04A9920224DE8505EB864CF67C18DD58CBEB7D05DEF561D01A5BFCC38F8409B2B19358CC8C1FA619FCFA55A479F44FCD6050386EB11A14D7A56AB737234497F78AD175847FD4D75889F4DFC70F3776D39AD4CA4F840B1DA73745B561BCAE87503B7BD2A18AFCF1C36DF0C27A055006642E514CFA24CA8FA69187ECC23E38C1674F4F631DF0D6A221662875A001F9A185CD5C4B76AB4B9FF9560F9F15D270E4354293E6A501A6A8489EBAB8AA427948BBC7B4C93392C86913D3E8B37704B6D834E1A1D64A439686B45CACAA0CDAB425EF961EAEF79786B2D5DDB2B308E48F1F764AD7764B2F0F43AE4BF51BA0A5B8963BA3A6DC19C23845164AE6A82E77BAAB1AF6D2501BAC878B15CA11BC3F4C9E3DEC71BD9A2B61C6B5F8ACADEA9D20AF10E43D522E40EE784525D8183D4C36285E4EAD7A57A8E1F010ED9649F1DAB4C2742A5D617A87A68BB992C5A1CD4B737C368D46579CCA7578B7F15D5ECF7A52CF7028FFBAB27C4D47CDA836D9CC2884C9C6E14F8A7B0DE8B6418177FA9228376EBAB2742D521CEE271B1C404E6186D20179D59756539D7A22A993BE647A6BD592D977BB40C720520771731C54B5929919C91DE4914CD4FAB604CD6754BF7E34B0A52EE382692C11E79BAED195ECEB2EE988EB8F1F764AAC580F1D8EE362857FA5E97033C75644F95AFDDA429CEE272F94BEF34006800B3EA35BDE1AF5A535936790DC35CD7DB81E637B72C75FB50C9AFE40A5FCBBD05ED578A1789D0237329C4B59DAAAB410DBE1A8A34AFC06475DBD03DFE5191BA738D6443A1669097180DFC7067ECF8443567E01ED52A7CA0869DA559FF1AB73AD3E531C6F2AC670F3F1C38252FDE6067B35794159775AEA73838E4FE9A1D12486B8AE3919AA4F9ADD51C531070FE275C3AA917BB3D99DDD8AD7CD557BCD46008CD35A694C7BB3B61827E625252ED1EA3D1F0B544263F2693A88B344AA548B061A2957C2E1717D4DD597E3F7EA05147739480F46DA6D87E25099BC18DBF13A2F9D525A3FCD2480065AE89662BABE7FA4B4EAEC962E323CBEF6765BADDA854AB455D421B176BFD68D86734735C1E26746BFAF54538A75A6190D3ABABA2FA8AA25875068D7D382745DC9B0B1F0D5B50BD49CDE748B9BEEBA41D4362D05250AB4A53BC4D1A6B201D07094777FA6235F72944703956D07B0B806686227481DF1D486D3A1783A4B758D82AC1034765086D61F641612000CEC05B54CDA5367D9920A2F1F3FB42AADE75B66DEAAA486B5C519B6D0C8035E6D4803E38002D6C8B633EADC5A8EF3CCB4DDA1F9BF5963D6D370D8223F473D87A76E76D8ECD2AF063CA08B0831D3F426B9D07161B678A86A8E2137A96B70E788AD35B927DCB67DFC704D8B61DF0975932A144FDA2B3184C0BE49E17BC4DF63669BFE11B9BC7107C98501C1B1A811B951B906CD48DA327B360A52B533BA23CD758DE6DF78D2B531A8116950A14F32AA006EF8EDC66029B5067BD63DF66C37588DDB8C24AF3BD7A439AADCE3F3AE24C213CAC9D5BB8E714BA4591D5ABA05DC6AA40ADF6AA4B2AEE63B50E2A65487E72DB9936B34FDB623D3F4BA2CD1F78653ED21AEF208EA0D6E892C4B9601E5AF1B3016E837CA36C0A13A92A057A0FE3B32B4DD23ED426DB2967BA05B447842CD92883890A6C33000D2D196A412B6086381B48C2AD4BC85DED401728DB41C9196103DF6046CAEA984A2E5E454A5F226C37F95AC089EEC2D7FA75CE8409BB5AFEB719B16C31A2023A74471C5790625F7067888DC2962DEB0039A17644DEE8032BC55E10923FD677CA2C7C5522A0BF1D6C3E78AE825FA4EEE5A0069B422772A193A642AA61D7856EEC8A34306DC759C1A9533117D3AC0A7B1661A4912C94DAB9A3600DB86F1448B356528A3D64967444E4D26FBB38E58075F5F044077CC7F976A3562D400F76B22AA3326BD5073543180B21D87B4374CF08C67A3017881A624695EB32F354655D900035DF398CBDF6C35B26BF901EBA926ABF7F1C36CFDF444BA6B5132C4535EF35E6A37EA0D43BE210D99D56C8C46124A05F188D96335675DE356340AA2B466C322DD61D6B941BC0E1B2D2B1E39F8061B6D6DA3434B3EAE91A70DB2EEC87BDF2B9D0E206280E70095BB84F57F8C4FE8DD029F50EE993F8BEC89E3963E9BFCD9E5CF317F4E1137FA6DC1204ACFEC59A125AB9DCA94A78BFCD9644FB1C89FCFA422D761602E481BBD9AD6BAF24CDA1D10F40A9468C9778634265246EE608D9B46BD8B106A0D5126F0AC3B75FA94678DFE9A4266CFDB4E159F809BD46029959238C492B7A50ABC8BC0B37A7F0D5AAA63D4EEE9BB43461D78363AEC596D541594AE3BB53E41DCEB68175403E8D6435C20E5BA21D25E354AECD91AD5E9F36E4654DA9B02C820D0571B110DE9AC78757D0DE90DA36E1804E9F658A89A44023A8D4480C8290B102A2D49448EF46712E5905A20F335EBBDD391A6A4A212468D91F895B6B0AE7EFCD0C1925DA3EEAE45CE0169CC79FC0C388B3EF276B86EAC3A12A5FC7A5D09F21BA88DF31D7C7648015A46EBDC220F86BC44C96CE313FCB6BB353E3D962EB5C818DF258FCC083C2B2DFEE4EF32CF973D82FA0DBE557989AA47DC4E1562E616B40572455BAA3EC16882F70A501A9F6482E318AC8C484D008E05D0A0CD35D54877AA788306A33DAAB73AB244CDC81AFB3083981C6B38F8941077D048721868578DF1B0E9708587128CE374374CDEACC52028BF8DE75406A0EDE5405DC63E2D0F7530F7912A3B116276B738C56586B6AA1A4C0CF4EE8B99D64B03CC477635AE0FBD71BF00D0FAF7D6933A2FBF4C72E3CC8DD57E9E54DB966A8F2DD52CB647F7C5E938379C75ABDD3EA98FA793FAD07AC89608A4651E32DDA906B2347E686EBAB56A66D4112132D21EBAF2E8A13B25B5ECCB2857DE4C6A9649AAEDC1434ECE8E5E5A9BF15C7EB9AD740AA37EE7A55D318AAD27753D7A918BA37EEBB905EFED2771466A9AA555CB30B2C630F6C7B5EE6317DA98E49B14F2603E7C1ADF5BB9F13D8CA2FBEEEC2153CE6A7531ABC9884FB537BE6F5BCAC3D882BA2F6ACE7A79C80D0B900671960235C6F7DD859A2DE39CCCD3F8A10DB9D68C549B965A7B9E8E7203D27B68DF6AF7CF5E3FDF7C506A56663C6CAF470091D4BAD6785ECD4EEADDE6C46E673E7E00DA3C8D3BA23D7E40FCA60B4D6EAFC6B501A74DD652F36DA0DD800CE7D58D725F35279037B0874BAD66F9E361B7A8D6860D8031C3F48F1FBA506B58B7D6E3C17833C965C31C15A165B5C564DE5D69E06DE9F7CF16A98A50A68D2D3C28582EAFF5B5BAE501362F880D409BC3DBA0389DDC0FC81BFC95B57A6B19E2D411A5F13DB4341B6EA0FC06E83C1DCBCF304E27F301E9CC8736B47507FC5DC33FA07275D6AF81E7D71145B52E5A805F0BF2814EC08D6AD9A3DFABD8CB01E9CEAB0B909C0D520B780A1876F2434F63292F3BEF1BE0CA4A7B683E8D076DA4765685D687567BD0193607835C7BA33C88997EAEF915789A41E92DCFC6F7CFD2E801782457D7C0C7C52857CD28F7E5E50068A7218EF936CF6F7B933C3E4106F2E24A05EE74411EB45A79D3B19B28BDC0B3D1FCD91AE45196A0D7B9B2AFD680960FCDFA187AA4CEAB19902051AB7781A7CD2C96E9D686A676AF811C346F27B9E21038B6817A33E8E9A09AD1EACDC5C81E66A067F2186A8C731A6DA1F3D045CFD9045A023EC399F2D05DA9339472ED6574DFF476EA82A70ADCB62690A30F11E35D085590F5A10F908BC37A13C60C7C7F68BAB132D5EE549DC3C892C71B94DEACA5C1F85432F176C25606EDD5643E5E8CF3C30D8CBA05F42CD6EB0E8C9DF17DD69CD42D1979DA0619B3D640EDD56416835801695E2BF7CF539A67E15C58B5C021BEECEB03E006BD18D49BA8A39E34F9307E6ADD027C3467A74C7F90B1FA81A47CFC30AC555F940CC878BD591CD4CA8B89DD3DD4138A2B8CBC629C6ECD2CD4594CEE87E0E1D31280FD084618F02C5EB2DE46BD8512D0576A436F2253CD435BA15A21CB3468A049419357DB4535DFB526BD624F03EDAC00576E2C189B761BE903A31E3CD55AB98FBDC3EF635B043A1A7BC73448081BD5FD51BEB950EBDD01C8BC4BE4EC02DE41D6CB734D2AF6D5FBE73E486A6EFCD05876EBDD971B0BA422E7C3937310A52487F67477ACB191B62683BCF5A2817CDDCC40421E449012A02D5A14E8F1214DFFF1C3215D7F33EF7A13C2B4680F683801FEE90F6D186519189BC5EC24A611B2539C5A0709613D04FB642D233404FE15E72011591CA7A8012279F549AD6C8EEE9F17FA4E1EF014A83FBE1F7BD84B9A037C1BE5864C9A0DB102F62003ED5B603FE79335D358A821541B6CC17CBC8AE863C00D6CD0469341EBCC4B402B94B3A2DDB1878B095810D580DAA0B181FA5C22C0F2E4CA806FDBEADF5797A37B0DCB84760E4616B574DDAA46A93C9D829EF5B0368CA2EC64DE761E804BC067786EF3BA60FD40625F02CE0DF3CD29EA68F42DC5C124F3BCD240477169ED518B086D69D57606AD0EE88D19B3B700696E6DC603660F88547C424D89CF51BEBBA2D0025E2DBB350BAC5D71051405796B6DA5C40A46CF6019D1A6540615B0ABEA9AC1C09E6696D0E797096A9CDCF0E5BD5EC38D055CC88B3076BA0BD448AD18349C850F280D6D06BA184695D69EE4BA148F61B53C6DDFB75E5AF3F1B4F562646E6B32F84B9DC2C70FB7FD46BE556B3DDFDECB2FAD3E29DCF647EBB154EC005DD6D013901AC097792DF740BF05D5E00F4085D002B508F591864DE002E0B3007ECE389F44D0CA2FD46E320FE6113DAA875CF6056B01CDC03A83FDB491A6C327EC0BE0DA09FC179C25A0EDA22D27C198C59EA3D442C988A7C3F8F890073EE348BB479DD88228B6B9A250B365E6BFA17D7F54A9051CFA20AD088559E987A6AD818642D9E2AD32B94428D4EB192E69CF87CDA9F2D0A69E831696C09EA06566567AB81CCBE3953ACF4E3522DE8DE60B6B04C1C13057053F0AD267C382F2D009FC4CEA7901B47A87FB435467F5A057594C6372555E22AE04A5183882FEA79AAF7AE0DF2DD57C50AF698D6B20D1D473C0110C23066C227A74E03F123EB2E7688D9B804FB70F945F8E613C8F65EE6392ADC40F6BC342500722A33CD400AAF6E765EE93A91CFBAD65E69EF953132307F09C476BD1C5E7782D5AA4E2905B039E755CB9032BF644AA25A274448CE19FDFAC51EB60B9172C0FF50A04AC0D947BC41912F0C9332821102C5466338C04460819A22078DA58F2D620A7F81C636C8D51D21A82AF5A095B80FC1901FD672364D0D180DB88E18693B98B3770F211928A31626D8D1017A456C0779CA83E8BD643DC62355FB026ED0DF46A64402F00371DDB86484E83DE509CD6E232429DA786219EE1BCE9C70F8F1D62624CC65264127F6FB0770896861057D096D610D6C9E0651BE2067B0DB1B781D3300303B52501D9823637887D8388154A17C40520B63A389B41D203EC15F441C595B2FA001702F7420479A3DC7D032246E340053ABBBFCE60258CF19A5DF01C711560B0A6519DD58777C04DEE50EE62DB434E1F8588554CEF810DC5A5BF401A4825DBC6F42EED35AD37E052E220AE102FE0DC0BC4CE9D35E22623AF1C8C69A1E41239C1B8DF20375C42C7105DDE6C1A445F434C5CCFE03A26F492BE3F23DD62299B9DF717FE4E2AF7313A9D42BF9F819E03E4EDA803212DF409E76A00426D84292F18F6B671E20F7084E70B4EFEDEE23C12F0B68DB8400DE04C11F3A1DE334A05CB1F911611673857532003C2DBE4BDD250F631D65A1390AB06D2ED05F319A75AEC9D7D668D974A3B53BB1B749CB102D0FCE678D0F7AA74C5B623370053F83AC0EF5DB943D36EC51E1149B76AC986DA926772AFDB6D942B46E116FE352452E8F5B09CD804FD865387B23D030CE4DE63770D7D02143718EB1B862842ADE91AA71C11AA249A08B5460C6CCD90D51A8C1648EF198D01D68778419E0D1082841070AA9F741AB7A2412AAC6DA8255E93590720771A0D4C93C8AC2E8A4D11EADDCA4F1980D2401C813E8DDEC70F779D825687714128F68843036A105176A4B13C9234E82581EF53A0183456E819D772C3CF2FD4E174962934660D73D485C046222F4D590ED69DF96CFB7AD4BBEBB46AB295A988D3E614DF65D2A84904D2BA801C19889C5E3518C9625D6C76E95C0D2E6F884D8DCDAEC87319B8208BF0C4D91380D069602E2E99619A44D30C31DCDC2016E8DCF39034EEA97F241721721916A875669E9FD575C05EE6D535F0B5136E2D70E0FBD320DB7D1CF5874FAD97E61C7C9042BB329DB62BADCC6D65B669BF884FADBE051E84BC06CFA132CBB57089187AC1DA1D89304C2BE0A914C1DFB6957AC7E848C4683D91675C53EB756452338BB7DD61B7867B46C60F1A5849CF1BCE71E54ECD015E4FD95C5B2A64817C83CA345ACA97C1EAAEC1332CF631ADDB58F667C34103E2BD30DADB90CCCDD380F874568AB4CEAECFCEE8DA1AC1D572527B0EAD5BCC77B2B6BE139D15A80D373792E8AB3988C1E6106F9B6B03E22CC090E197813608AE24ADA154E83DDF41FC0C9E05E0B2F61A55313BC29A19DF827876A5E486CBBBFB46BE4DFDBD410E467D7FF6D2AE0DD640BFA7882FB9F5E136DB8829822BF8959D9D4D206207ACF3A0DBC17FD86FD05FF15D11CD067D6F90B73E921C4CD445764D54CB159C959AD49E5924C2E7BCC6E0EB8E6B74C9133E9574B3438C573B655E43FB019F7F43FB2781D661B3B138FDBA772B0F5F796D1DCEA79F1E83569DE28BB223428A48973EC57BB4DCE065DDA32D072FA38FDE427F2DDEA21D055FE096C823780F705B75FAABB411B4011A10C215AAA0409FCC2D637CB7DD90C5E6A1F7212887EBA755B4CCA0F5A10D053D43B0A33DEA358CC04F63859B1CD29030EF62827E1E7886A3A83F47422EDC1059A73B3B6442BD2BB0400A85A892AE81967A8D16B9893ED4D8105714322FDFC239FA0AA52BE85EF40EC02A522C6A065B6B040F67456A1932E9A0CF5440DBFF12F60AFC13CA19B98538F9DC835E923AEEC1E81BE03D41CD71749EBD4E7B27467BDFA55E450BBDAB0DF60EBC8C582FA1781FE9D6419E4D71C27F843E11D8EA31B65069A1C792414F073C9E0CBE538FA732430F318FBD1B51CF66C63D225CAD68F1126DEC2D6526F9999012F2B446DB469C805338BFCA3DEC15F69E7E00C20DD603CF08EA63BC006D030E74BDE516FDB0CA769942A54BED32E331F89263EECD8EB0F7327DFAD4E7845E621F3F7EF851BDC43E226EDB5E82373A436998508934F07FE004950E9BCA19F7B08103452E45360A8246CBA36F093C592377552A572A7AD019B4F41D947AE693AFB16DB4CCB885834947AC850142865EA36F09FD06B99AD2B6D611B9828FCEE9D6E75231E65111A3DB567A265CCA30CE826A30B261D43C527F172337A053CB10E7DCBF2D30FF17E9D9C1774A4FE0D80657EFC0DF7D42DC6F3B74FDB4423DE3352F91430A8F91C7CCBBA7B64AC1C52D1C75DC3F86C884FAE030466E696F71CCF071CAB8FB23788BB831EEC62518BD612AC11DA427706A86F1D50835C27E497E4609A6636189FE3E6BD340D97EA19079EF99FE1A910AAEFBC934D679E19C33519A74B4D6BC05B646B9DBC6512DECF9FC93DBAC7F43FB4742438D42378E2C2212F34F82DBBFA1FD1BDA1B9F8BF4F62846EC3781D96549C14D4841CE45BAD2EF9DB31F60C48BF9C25F05C6647651261E82E1BFFD1A4FF4582A26B213FCF81B72DB63516FDEA1462F48FB733249CF8FD25282C77FE885FFDA213B7864291BBCD7237A6F03BF9E81FFD45B8AFEB06B50D764574379B10ADE529DE265079F9E4F369F013CFDF143057F5753589B9A3F65BF3238D5F1028A5432C9316B3CD25B16E68ACD7E0F969E2665C7957863586BAECCE89153D3F3E1DB49E462064BF775C1F4534208B1BFC59A1DF6F77C7EE49FFE98A4EF0896A368828D88638B9325BBD861E1EA2BD3597AFB8811BB3420F8A1588DDFA7C0726337080AAE9E545C37FCA951FEC3CF9EE0D891AA4032F75151754E0D261EF422C1F0B2B812FB8162EC97AC007D6DBCA1805E24C15AE55C8CFEF622FDFD4C8DFDDAA9F2F8487F7E88DDF6125E84C01AC46B24189D983432A4925832C97E239967873F927C43298387ABB6925D7395C594656CC781A400074C7F437FDD9C5EAA7799502D37191EC83EDF777B61E437BFC22B84C24B2BD8A9314837C3D35EBF0447DF2F8F8546918DFE12FA451BC0EE622F083DF305BA9FCD674F0AB9D85D190D2DA4CAAF919F398E95E93B8B1BFDD1BF4CE4CFCA27B9D3B3E80F8E5FA423F40AB5C00E5D2FD2BC097AAF1A170B76ABDA412D80257794C9FF07504B030414000000080029AF464BC09FDC0953000000580000000E001C0050726F6A6563742E706172616D7320A2180028A014000000000000000000000000000000000000000000B3B1AFC8CD51284B2D2ACECCCFB35532D43350B2B7E3E5B2090EF60CB60A482C4ACC4D2D014A2A0055E5155B81446D95CACBCBF57233938BF28BF3D34AF492F373F5830B7382538B80A6E883542829E8DB0100504B030414000000080029AF464B3BD0B365740300000B18000011001C004050726F6A6563742E6D616E696665737420A2180028A014000000000000000000000000000000000000000000ED985B6FA33814C7DF57DAEF10F1EED636E6E2A88D0406569126A36AD299A7912A87B81966B9A4607AD16ABFFB981026094D6893B49A3EE405099BF3F7E59CDF39C617E3F170DCBFCAB39F2294BDE645AA97284B3F897B115F6A5E96CA31BF17639116918CEE85D67B4CE2B4E8579F5F6A0F0F0F674914E65991DDCAB3304BCEC777F158E4F7223FAFBED0067FFFD5EB5D34DA7391CB48148BC656F3533D81CF3C1197DAD0D306FFE9210E6F090F8140260244582698709D00134D883DA1B685B1F5FFC5F986C88BCAD5531BF8DE70BCAFE53791176A5F46FC67966B0378A879941E63EE96513C3DDC9C6549225259688DC19E322C17BC0A0E8F4BB58B18220B2008A0798D519FD87D8CCF20B174C3A000923EDC7B960BF92CAF7D34F2BCEBEF232EE5812A6AADF3528A35B57D853C51847934AF167CE88605599E70B9DC7D6D80B6D96FB635782C3579F82F9FB589A91BD7C7F9C4CB34FC21F2B3A92C1EB5BAC74F65FE749545A9BCD490D63BDF186C5DB75665599AD6E88F78AAFAF2A23159747B621E674F55F40CD3DBACBDF02A83AC04AE78AE66255712AD99AF29B47A464272155C7CF7DA7EDBED4C2B5B3A9F27176498D88316031675744090E50017531F04868E1982C42618ED482E2FE9D701D7CCFA308DCD64B3356C5E2FD299725E29B24C3CF8289176FA599A1D23F9CFD7853B6DDF377CAC72110D980D888B3D404DE6028402D3C016337CC73ED09DCBC86C916C1F26B625A51CB309AD72DDE9E4ED696693C106DB6DC3379DEBE38B6954DC884711DECCB9FCB1B9A217F8EC5E58ED54CB24BA850D6062A40E0026A2C046D4549EF50217DB3A3502DAE9D4EE319A6256F3FACCEE60DD9D3E3E4E769886713955B9D3139372E695C9FC05A6BBE5BE88BB32CAC5EEC3C46B4456A7C26354BEF1B87C5B0FA80A72FD34579AA893D36E28D68AE532F4F7C222CE66B3289DDDC435996F8B0665813A7D051404D4710171902A5F30600031EC99103A0C43E784C6098D8F8746552CA2E95BF3E09B41E01BC4017AE0FB8030970147870E80D860364376408DEEE35CF718271E4E3CBC0F0F4951DCC537515AC8B746C2D111350C6201C7220A8980A98393AE7BC0711D46FD0063D3389D9E4E487C3C248A222AA693C56F455985C13B940BE67A3644BA03A87AAA728103401D6C01A41B3681C4C70E354E6C9CD8F8136CB4BB56869B7777CD5559EB66B275C3B66C7E767BB79A5E757537F805504B030414000000080029AF464B9DDD9D0CA50000001C01000013001C005B436F6E74656E745F54797065735D2E786D6C20A2180028A014000000000000000000000000000000000000000000958F4D0E82301085AFD2CC1E8A2E8C311416EA0DBC4053A640A43F690753CFE6C22379058B6C8D89CB37EF7DEF655E8F67DD2633B11B86383A2B605356C0D02AD78DB61730932EF6D036F5E5EE31B21CB551C040E40F9C4735A091B1741E6D76B40B465296A1E75EAAABEC916FAB6AC795B384960A5A3AA0A94FA8E53C113BA77C5E673B8A09D8710D2E5B020813F15C0B8C7F45BC0CD2C43F2123EDA831D22F8C7F7E6DDE504B01022D0014000000080029AF464B690789887435000003AE00000D00000000000000000000000000000000004C61756E636865722E64747378504B01022D0014000000080029AF464BC09FDC0953000000580000000E00000000000000000000000000BB35000050726F6A6563742E706172616D73504B01022D0014000000080029AF464B3BD0B365740300000B1800001100000000000000000000000000563600004050726F6A6563742E6D616E6966657374504B01022D0014000000080029AF464B9DDD9D0CA50000001C0100001300000000000000000000000000153A00005B436F6E74656E745F54797065735D2E786D6C504B05060000000004000400F7000000073B00000000

	declare @sql_vsn int = 
	(
		select convert(int,left(cast(value_data as varchar(256)),2))
		from sys.dm_server_registry
		where value_name = 'CurrentVersion'
	)
	declare @deploy_bin varbinary(max)


	if @sql_vsn = 11
		begin
			set @deploy_bin = @2012_bin
			print 'deploy 2012'
		end
	else if @sql_vsn = 12
		begin
			set @deploy_bin = @2014_bin
			print 'deploy 2014'
		end
	else if @sql_vsn = 13
		begin
			set @deploy_bin = @2016_bin
			print 'deploy 2016'
		end

	else if @sql_vsn = 14
		begin
			set @deploy_bin = @2017_bin
			print 'deploy 2017'
		end

	--{INSTALL_STEP}Package Deploy{/INSTALL_STEP}

	declare @op_id bigint
	EXEC SSISDB.catalog.deploy_project @folder_name = N'SQLETL.COM'
		,@project_name = 'EDIS'
		,@project_stream = @deploy_bin
		,@operation_id = @op_id out
	;


	GO

	--{INSTALL_STEP}Schema Create{/INSTALL_STEP}

	-- ----------------------------------------------------------------------------------------------------------
	-- SCHEMA

	IF NOT EXISTS(SELECT 1 FROM SYS.SCHEMAS WHERE NAME = 'EDIS')
    BEGIN 
        EXEC SSISDB..sp_executesql N'CREATE SCHEMA [EDIS] AUTHORIZATION [dbo]'
    END    

	GO


	-- ----------------------------------------------------------------------------------------------------------
	-- Base Tables


	--{INSTALL_STEP}Create Table lkup_service_id{/INSTALL_STEP}

	IF NOT EXISTS(SELECT 1 FROM SYS.TABLES WHERE NAME = 'lkup_service_id' and schema_Name(schema_id) = 'EDIS')
		BEGIN
			CREATE TABLE EDIS.lkup_service_id 
			(
				service_id NVARCHAR(250) PRIMARY KEY
				,last_upd_ts DATETIME2 NOT NULL
				,service_type NVARCHAR(250) NOT NULL
				,service_config VARBINARY(MAX) NOT NULL

			)
		END


	--{INSTALL_STEP}Create Table task_logger{/INSTALL_STEP}

	IF NOT EXISTS(SELECT 1 FROM SYS.TABLES WHERE NAME = 'task_logger' and schema_Name(schema_id) = 'EDIS')
		BEGIN
			CREATE TABLE EDIS.task_logger
            (
                 log_id int identity(1,1) primary key
				,exec_id varchar(50) not null
				,crt_ts datetime2 not null
				,log_type varchar(10) not null
				,msg_hdr varchar(250) not null
				,msg_dtl varchar(max)
            )
		END

	GO

	--{INSTALL_STEP}Create Table util_task_params{/INSTALL_STEP}

	IF NOT EXISTS(SELECT 1 FROM SYS.TABLES WHERE NAME = 'util_task_params' and schema_Name(schema_id) = 'EDIS')
		BEGIN
			CREATE TABLE EDIS.util_task_params
            (
				 exec_id varchar(50) not null
				,itemID varchar(1000)
				,itemVal varchar(max)
            )
		END

	GO

	--{INSTALL_STEP}Table Create etl_audit{/INSTALL_STEP}

	IF NOT EXISTS(SELECT 1 FROM SYS.TABLES WHERE NAME = 'etl_audit' and schema_Name(schema_id) = 'EDIS')
		BEGIN
			CREATE TABLE EDIS.etl_audit (
				 exec_id varchar(250) not null primary key clustered
				,task_action nvarchar(250)
				,task_start_ts datetime2
				,task_end_ts datetime2
				,task_duration int
				,task_run_outcome nvarchar(20)
				,usr_login_id nvarchar(250)
				,usr_machine_nm nvarchar(250)
				,ip_adrs nvarchar(250)
				,src_sys nvarchar(1000)
				,dest_sys nvarchar(1000)
				,src_qry nvarchar(max)
				,dest_tbl nvarchar(250)
				,rows_tsfr bigint
				,err_msg nvarchar(max)
				,file_path nvarchar(1000)
				,ftp_id nvarchar(250)
				,ftp_srvr nvarchar(250)
				,ftp_dir nvarchar(1000)
				,ftp_folder_nm nvarchar(250)
				,local_dir nvarchar(1000)
				,file_crit nvarchar(250)
				,file_list nvarchar(4000)
				,svc_id nvarchar(250)
				,[url] nvarchar(4000)
				,process_nm nvarchar(1000)
				,process_args nvarchar(max)
				,soap_envelope nvarchar(max)
				,sys_hb_ts datetime2
				,info_msgs xml
			)
		END
	ELSE
		-- V 1.8 and higher...add service ID column, url, and other stuff
		BEGIN
			IF NOT EXISTS(SELECT 1 FROM SYS.TABLES AS T INNER JOIN SYS.COLUMNS AS C ON T.OBJECT_ID = C.OBJECT_ID WHERE T.NAME = 'etl_audit'
				and schema_name(t.schema_id) = 'EDIS' and c.Name = 'svc_id')
					ALTER TABLE EDIS.etl_audit ADD svc_id nvarchar(250)
			;
			IF NOT EXISTS(SELECT 1 FROM SYS.TABLES AS T INNER JOIN SYS.COLUMNS AS C ON T.OBJECT_ID = C.OBJECT_ID WHERE T.NAME = 'etl_audit'
				and schema_name(t.schema_id) = 'EDIS' and c.Name = 'url')
					ALTER TABLE EDIS.etl_audit ADD [url] nvarchar(4000)
			;
			IF NOT EXISTS(SELECT 1 FROM SYS.TABLES AS T INNER JOIN SYS.COLUMNS AS C ON T.OBJECT_ID = C.OBJECT_ID WHERE T.NAME = 'etl_audit'
				and schema_name(t.schema_id) = 'EDIS' and c.Name = 'process_nm')
					ALTER TABLE EDIS.etl_audit ADD process_nm nvarchar(1000)
			;
			IF NOT EXISTS(SELECT 1 FROM SYS.TABLES AS T INNER JOIN SYS.COLUMNS AS C ON T.OBJECT_ID = C.OBJECT_ID WHERE T.NAME = 'etl_audit'
				and schema_name(t.schema_id) = 'EDIS' and c.Name = 'process_args')
					ALTER TABLE EDIS.etl_audit ADD process_args nvarchar(max)
			;
			IF NOT EXISTS(SELECT 1 FROM SYS.TABLES AS T INNER JOIN SYS.COLUMNS AS C ON T.OBJECT_ID = C.OBJECT_ID WHERE T.NAME = 'etl_audit'
				and schema_name(t.schema_id) = 'EDIS' and c.Name = 'soap_envelope')
					ALTER TABLE EDIS.etl_audit ADD soap_envelope nvarchar(max)
			;

		END

		-- heartbeat timestamp for proxy exec
		IF NOT EXISTS(SELECT 1 FROM SYS.TABLES AS T INNER JOIN SYS.COLUMNS AS C ON T.OBJECT_ID = C.OBJECT_ID WHERE T.NAME = 'etl_audit'
				and schema_name(t.schema_id) = 'EDIS' and c.Name = 'sys_hb_ts')
					ALTER TABLE EDIS.etl_audit ADD sys_hb_ts datetime2
		;

		-- heartbeat timestamp for proxy exec
		IF NOT EXISTS(SELECT 1 FROM SYS.TABLES AS T INNER JOIN SYS.COLUMNS AS C ON T.OBJECT_ID = C.OBJECT_ID WHERE T.NAME = 'etl_audit'
				and schema_name(t.schema_id) = 'EDIS' and c.Name = 'info_msgs')
					ALTER TABLE EDIS.etl_audit ADD info_msgs xml
		;

		-- rename pkg to task in ETL Audit table
		IF EXISTS(SELECT 1 FROM SYS.TABLES AS T INNER JOIN SYS.COLUMNS AS C ON T.OBJECT_ID = C.OBJECT_ID WHERE T.NAME = 'etl_audit'
				and schema_name(t.schema_id) = 'EDIS' and c.Name = 'pkg_action')

				BEGIN

					EXEC SP_RENAME 'EDIS.etl_audit.pkg_action', 'task_action'
					EXEC SP_RENAME 'EDIS.etl_audit.pkg_start_ts', 'task_start_ts'
					EXEC SP_RENAME 'EDIS.etl_audit.pkg_end_ts', 'task_end_ts'
					EXEC SP_RENAME 'EDIS.etl_audit.pkg_duration', 'task_duration'
					EXEC SP_RENAME 'EDIS.etl_audit.pkg_run_outcome', 'task_run_outcome'

				END
			;


	GO



	--{INSTALL_STEP}Update ETL Audit for exec_id as guid{/INSTALL_STEP}

	-- Version 3.1 -- to prepare for exec guids in pk spot
	IF EXISTS(
				SELECT *
				from INFORMATION_SCHEMA.columns
				where TABLE_NAME = 'etl_audit'
					AND TABLE_SCHEMA = 'EDIS'
					and column_name = 'exec_id'
					AND DATA_TYPE = 'bigint')
					-- before 3.1, the datatype was a bigint
			BEGIN
				-- drop the pk
				DECLARE @drop_pk nvarchar(max)
				SELECT @drop_pk = 'ALTER TABLE [EDIS].[etl_audit] DROP CONSTRAINT ['+CONSTRAINT_NAME+']'
				FROM INFORMATION_SCHEMA.TABLE_CONSTRAINTS
				WHERE TABLE_NAME = 'etl_audit'
					and TABLE_SCHEMA = 'EDIS'
					and CONSTRAINT_TYPE = 'PRIMARY KEY'
				Exec SSISDB..sp_executesql @drop_pk;

				-- alter the column
				EXEC SSISDB..sp_executesql N'ALTER TABLE [EDIS].[etl_audit] ALTER COLUMN exec_id varchar(250) NOT NULL'
				-- Add PK
				EXEC SSISDB..sp_executesql N'ALTER TABLE [EDIS].[etl_audit] ADD PRIMARY KEY (exec_id)'


			END

	GO

	-- Update max width columns for src/dest/tbl

	--{INSTALL_STEP}widen columns for src dest sys and dest tbl in etl audit table{/INSTALL_STEP}
	IF EXISTS(
		SELECT * FROM INFORMATION_SCHEMA.COLUMNS
		WHERE TABLE_NAME = 'etl_audit' and TABLE_SCHEMA = 'EDIS'
			and COLUMN_NAME = 'src_sys'
			and CHARACTER_MAXIMUM_LENGTH < 1000
	)
		BEGIN
			EXEC SSISDB..sp_executesql N'ALTER TABLE EDIS.etl_audit ALTER COLUMN src_sys nvarchar(4000)';
			EXEC SSISDB..sp_executesql N'ALTER TABLE EDIS.etl_audit ALTER COLUMN dest_sys nvarchar(4000)';
			EXEC SSISDB..sp_executesql N'ALTER TABLE EDIS.etl_audit ALTER COLUMN dest_tbl nvarchar(4000)';
		END

	GO

	--{INSTALL_STEP}widen error message{/INSTALL_STEP}
	IF EXISTS(
		SELECT * FROM INFORMATION_SCHEMA.COLUMNS
		WHERE TABLE_NAME = 'etl_audit' and TABLE_SCHEMA = 'EDIS'
			and COLUMN_NAME = 'err_msg'
			and CHARACTER_MAXIMUM_LENGTH <> -1 -- max
	)
		BEGIN
			EXEC SSISDB..sp_executesql N'ALTER TABLE EDIS.etl_audit ALTER COLUMN err_msg nvarchar(MAX)';
	
		END

	GO

	--{INSTALL_STEP}rename pkg sync to task sync{/INSTALL_STEP}

	IF EXISTS(SELECT 1 FROM SYS.TABLES WHERE NAME = 'util_pkg_sync' and schema_Name(schema_id) = 'EDIS')
		EXEC SP_RENAME 'EDIS.util_pkg_sync', 'util_task_sync'

	GO

	--{INSTALL_STEP}Create Table util_task_sync{/INSTALL_STEP}

	IF NOT EXISTS(SELECT 1 FROM SYS.TABLES WHERE NAME = 'util_task_sync' and schema_Name(schema_id) = 'EDIS')
		BEGIN
			CREATE TABLE EDIS.util_task_sync (
				queue_id bigint identity(-9223372036854775808, 1), entry_id bit
			)

		END

	
	
	--{INSTALL_STEP}Create Table lkup_server_id_perm{/INSTALL_STEP}

	IF NOT EXISTS(SELECT 1 FROM SYS.TABLES WHERE NAME = 'lkup_server_id_perm' and schema_Name(schema_id) = 'EDIS')
		BEGIN
			CREATE TABLE EDIS.lkup_server_id_perm (server_id nvarchar(250) not null, usr_id nvarchar(128) not null
				,last_upd_ts datetime2 not null
				,primary key (server_id, usr_id)
			)

		END

	GO

	-- ====================================================================================================================================
	-- ENCRYPTION (DONT DROP IF THEY ALREADY EXIST!!!)

	GO

	--{INSTALL_STEP:}Add SQLETL_EDIS_CERT{/INSTALL_STEP}

	IF NOT EXISTS(SELECT 1 FROM SYS.CERTIFICATES WHERE NAME = 'SQLETL_EDIS_CERT')
        BEGIN
			CREATE CERTIFICATE [SQLETL_EDIS_CERT]
				WITH SUBJECT = 'Certificate for SQLETL EDIS data encryption', EXPIRY_DATE = '2200-01-01'  
        END

	GO

	--{INSTALL_STEP}Add SQLETL_EDIS_SKEY{/INSTALL_STEP}

    IF NOT EXISTS(SELECT 1 FROM SYS.SYMMETRIC_KEYS WHERE NAME = 'SQLETL_EDIS_SKEY')
        BEGIN
			CREATE SYMMETRIC KEY [SQLETL_EDIS_SKEY]
				WITH ALGORITHM = AES_256 ENCRYPTION BY CERTIFICATE [SQLETL_EDIS_CERT] 
        END

	GO
	
	-- ====================================================================================================================================
	-- Procedures

	
	--{INSTALL_STEP}Drop existing Procedures{/INSTALL_STEP}

	-- Drop existing procs and functions
	declare @cmd nvarchar(max)
	select @cmd = isnull(@cmd,'')+
		concat('if object_id(''',object_schema_name(object_id),'.',name,''') is not null drop '
			,case type 
				when 'P'  then 'proc '
				WHEN 'PC' then 'proc '
				when 'FN' then 'function '
				when 'FS' then 'function '
				when 'FT' then 'function '
				WHEN 'V'  then 'View '
				WHEN 'AF' then 'AGGREGATE '
			end
			,object_schema_name(object_id),'.',name
		) +'; '
	from sys.objects
	where OBJECT_SCHEMA_NAME(object_id) = 'EDIS'
		and type in( 'P','FN','V', 'PC', 'FS','FT','AF')
	;

	exec SSISDB..sp_executesql @cmd

	GO

	--{INSTALL_STEP}Drop Types{/INSTALL_STEP}

	-- DROP TYPES
	declare @cmd_types nvarchar(max);

	select @cmd_types = isnull(@cmd_types,'')+'DROP TYPE ['+SCHEMA_NAME(schema_id)+'].['+name+']; '
	from sys.types
	WHERE schema_id = schema_id('EDIS')
	;

	exec SSISDB..sp_executesql @cmd_types

	GO

	-- ====================================================================================================================================
	-- Assembly objects to drop

	--{INSTALL_STEP}Drop Existing Assembly{/INSTALL_STEP}

	IF EXISTS(SELECT * FROM sys.assemblies WHERE NAME = 'SQLETL_EDIS')
		BEGIN
			DROP ASSEMBLY SQLETL_EDIS
		END

	GO

	--{INSTALL_STEP}Drop Existing Assembly Signer{/INSTALL_STEP}

	IF EXISTS(SELECT * FROM SYS.DATABASE_PRINCIPALS WHERE NAME = 'SQLETL_EDIS_AssemblySigner')
		BEGIN
			DROP USER [SQLETL_EDIS_AssemblySigner]
		END

	GO

	--{INSTALL_STEP}Drop existing login for assembly{/INSTALL_STEP}

	-- Assembly Login (New)
	--{CHANGE DATABASE:MASTER}
	IF EXISTS(SELECT * FROM SYS.SERVER_PRINCIPALS WHERE NAME = 'SQLETL_EDIS_AssemblySigner')
		BEGIN
			DROP LOGIN [SQLETL_EDIS_AssemblySigner]
		END

	GO

	--{CHANGE DATABASE:MASTER}
	IF EXISTS(SELECT * FROM sys.asymmetric_keys WHERE NAME = 'SQLETL_EDIS_AssemblyLoadingKey')
		BEGIN
			DROP ASYMMETRIC KEY SQLETL_EDIS_AssemblyLoadingKey
		END

	GO

	-- ====================================================================================================================================
	-- Proxy Encyrption Stuff...wipe/reload

	--{INSTALL_STEP}Drop MSDB usp_MDDataTech_EDIS_run_pkg{/INSTALL_STEP}

	--{CHANGE DATABASE:MSDB}
	IF exists(select * from sys.procedures where OBJECT_SCHEMA_NAME(object_id) = 'dbo' and name = 'isp_SQLETL_EDIS_run_task')
		DROP PROCEDURE dbo.isp_SQLETL_EDIS_run_task
	GO

	--{INSTALL_STEP}Drop MSDB usp_MDDataTech_EDIS_get_sys_info{/INSTALL_STEP}

	--{CHANGE DATABASE:MSDB}
	IF exists(select * from sys.procedures where OBJECT_SCHEMA_NAME(object_id) = 'dbo' and name = 'usp_SQLETL_EDIS_get_sys_info')
		DROP PROCEDURE dbo.usp_SQLETL_EDIS_get_sys_info
	GO

	--{INSTALL_STEP}Drop MSDB isp_SQLETL_EDIS_exec_monitor{/INSTALL_STEP}

	--{CHANGE DATABASE:MSDB}
	IF exists(select * from sys.procedures where OBJECT_SCHEMA_NAME(object_id) = 'dbo' and name = 'isp_SQLETL_EDIS_exec_monitor')
		DROP PROCEDURE dbo.isp_SQLETL_EDIS_exec_monitor
	GO

	--{INSTALL_STEP}Drop MSDB isp_SQLETL_EDIS_setup_proxy_id{/INSTALL_STEP}

	--{CHANGE DATABASE:MSDB}
	IF exists(select * from sys.procedures where OBJECT_SCHEMA_NAME(object_id) = 'dbo' and name = 'isp_SQLETL_EDIS_setup_proxy_id')
		DROP PROCEDURE dbo.isp_SQLETL_EDIS_setup_proxy_id
	GO

	--{INSTALL_STEP}Drop SSISDB EDIS Operator User{/INSTALL_STEP}

	--{CHANGE DATABASE:SSISDB}
	IF EXISTS(SELECT * FROM sys.database_principals where name = 'SQLETL_EDIS_Operator')
		DROP USER SQLETL_EDIS_Operator

	GO

	--{INSTALL_STEP}Drop SSISDB Proxy Certificate{/INSTALL_STEP}

	IF EXISTS(SELECT * FROM sys.certificates WHERE name = 'SQLETL_EDIS_ProxyCert')
		DROP CERTIFICATE SQLETL_EDIS_ProxyCert

	GO

	--{INSTALL_STEP}Drop MSDB EDIS Operator{/INSTALL_STEP}

	--{CHANGE DATABASE:MSDB}
	IF EXISTS(SELECT * FROM sys.database_principals where name = 'SQLETL_EDIS_Operator')
		DROP USER SQLETL_EDIS_Operator

	GO

	--{INSTALL_STEP}Drop Master EDIS Operator User{/INSTALL_STEP}

	--{CHANGE DATABASE:MASTER}
	IF EXISTS(SELECT * FROM sys.database_principals where name = 'SQLETL_EDIS_Operator')
		DROP USER SQLETL_EDIS_Operator

	GO

	

	--{INSTALL_STEP}Drop Master EDIS Operator Login{/INSTALL_STEP}

	--{CHANGE DATABASE:MASTER}
	IF EXISTS(SELECT * FROM sys.server_principals where name = 'SQLETL_EDIS_Operator')
		DROP LOGIN SQLETL_EDIS_Operator

	GO

	--{INSTALL_STEP}Drop Master EDIS master certificate{/INSTALL_STEP}

	--{CHANGE DATABASE:MASTER}
	IF EXISTS(SELECT * FROM sys.certificates WHERE name = 'SQLETL_EDIS_ProxyCert')
		DROP CERTIFICATE SQLETL_EDIS_ProxyCert

	GO

	--{INSTALL_STEP}Create EDIS Proxy Certificate{/INSTALL_STEP}

	-- Proxy Certificate in SSISDB
	CREATE CERTIFICATE SQLETL_EDIS_ProxyCert 
	ENCRYPTION BY PASSWORD = '{PROXY_CERTIFICATE_PASSWORD}'
	WITH SUBJECT = 'SQLETL.COM EDIS Proxy Certificate', EXPIRY_DATE = '20601231'

	GO

	--{INSTALL_STEP}Backup Certificate{/INSTALL_STEP}

	--{ACTION:CLEAR_PROXY_CER_TEMP_PATH}
	BACKUP CERTIFICATE SQLETL_EDIS_ProxyCert 
	TO FILE = '{PROXY_CERTIFICATE_TEMP_PATH}'

	GO

	--{INSTALL_STEP}Create Certificate in Master{/INSTALL_STEP}

	-- load in master
	--{CHANGE DATABASE:MASTER}
	CREATE CERTIFICATE SQLETL_EDIS_ProxyCert 
	FROM FILE =  '{PROXY_CERTIFICATE_TEMP_PATH}'

	GO

	--{INSTALL_STEP}Create operator login{/INSTALL_STEP}

	-- remove the file again once we've loaded it
	--{ACTION:CLEAR_PROXY_CER_TEMP_PATH}
	--{CHANGE DATABASE:MASTER}
	CREATE LOGIN SQLETL_EDIS_Operator
	FROM CERTIFICATE SQLETL_EDIS_ProxyCert

	GO

	--{INSTALL_STEP}Update operator authentication{/INSTALL_STEP}

	--{CHANGE DATABASE:MASTER}
	GRANT AUTHENTICATE SERVER TO SQLETL_EDIS_Operator

	GO

	--{INSTALL_STEP}add operator user{/INSTALL_STEP}

	--{CHANGE DATABASE:MASTER}
	CREATE USER SQLETL_EDIS_Operator FROM LOGIN SQLETL_EDIS_Operator 
	GO

	--{INSTALL_STEP}Add MSDB Operator user{/INSTALL_STEP}

	--{CHANGE DATABASE:MSDB}
	CREATE USER SQLETL_EDIS_Operator FROM LOGIN SQLETL_EDIS_Operator 
	GO

	--{CHANGE DATABASE:SSISDB}
	CREATE USER SQLETL_EDIS_Operator FROM LOGIN SQLETL_EDIS_Operator 
	
	GO

	GRANT SELECT, INSERT, UPDATE, DELETE on EDIS.etl_audit to SQLETL_EDIS_Operator

	GO

	--{INSTALL_STEP}create run package in msdb{/INSTALL_STEP}

	--{CHANGE DATABASE:MSDB}
	CREATE PROC dbo.isp_SQLETL_EDIS_run_task
         @exec_id varchar(50)
		,@logging_level varchar(50)
		,@edis_exec_path varchar(1000)
		,@err_msg nvarchar(max) out
		with execute as OWNER, encryption
	as
		set nocount on;
		-- Copyright Notice
		
		-- Validate that the execute package proc was calling it
		declare @caller_info varchar(max) = isnull(cast(context_info() as varchar(max)),'')
		set context_info 0x01
		if charindex('$-___139ns~#@Fvnc9N@DEDIS_PROXY_CALLER$*%NQNCZGSG(DS)',@caller_info) = 0
			BEGIN
				Raiserror('This procedure is not allowed to be executed directly. It is an internal procedure only to be used directly by EDIS. Please contact your system administrator for help.',16,16) with nowait
				return 16
			END

		--declare @exec_guid varchar(255) = replace(@gtt,'[##_______EDIS_','')
		--set @exec_guid = replace(@exec_guid,']','')

		-- grab the proxy id
		--print 'Getting Proxy'
		declare @proxy_id nvarchar(255)
		--declare @sql nvarchar(max) = 'SET @proxy_id = (SELECT ItemVal FROM [##'+@exec_id+'] WHERE ItemID = ''proxy_id'')'
		declare @sql nvarchar(max) = 'SET @proxy_id = (SELECT ItemVal FROM SSISDB.EDIS.util_task_params WHERE exec_id = @exec_id AND ItemID = ''proxy_id'')'
		exec sp_executesql @sql, N'@proxy_id nvarchar(255) out, @exec_id varchar(250)', @proxy_id = @proxy_id out, @exec_id = @exec_id;
		
		DECLARE @cmdExe nvarchar(max) = @edis_exec_path +' "'+@@servername+'" "'+@exec_id+'" "'+@logging_level+'"';

		--print @cmdExe

		declare @job_nm nvarchar(255) = 'SQLETL_EDIS_'+@exec_id
		--print @job_nm

		declare @sa nvarchar(255) = (select name from sys.server_principals where sid = 0x01);
		declare @job_id uniqueidentifier

		EXEC sp_add_job 
			 @job_name=@job_nm 
			,@job_id = @job_id out
			,@enabled=1
			,@description = N'SQLETL.COM, EDIS Proxy Execution'
			,@owner_login_name=@sa
		;

		EXEC sp_add_jobserver @job_name= @job_nm, @server_name = @@SERVERNAME

		exec sp_add_jobstep 
			 @job_name=@job_nm
			,@step_name=N'step1'
			,@step_id=1 
			,@cmdexec_success_code=0 
			,@on_success_action=1 
			,@on_fail_action=2
			,@subsystem=N'CmdExec'
			,@command= @cmdExe
			,@database_name=N'master' 
			,@proxy_name= @proxy_id
			,@flags=0
		;

		-- ==================================================================================================
		-- Create Monitor Job

		declare @mon_job_nm nvarchar(255) = concat(@job_nm,'_mn')
		declare @mon_job_id uniqueidentifier

		EXEC sp_add_job 
			 @job_name=@mon_job_nm 
			,@job_id = @mon_job_id out
			,@enabled=1
			,@description = N'SQLETL.COM, EDIS Proxy Execution Monitor'
			,@owner_login_name=@sa
			,@delete_level=3 -- delete when done
		;

		EXEC sp_add_jobserver @job_name= @mon_job_nm, @server_name = @@SERVERNAME

		declare @job_mon_sql nvarchar(max) = 'EXEC dbo.isp_SQLETL_EDIS_exec_monitor '''+@exec_id+''';'

		exec sp_add_jobstep 
			 @job_name=@mon_job_nm
			,@step_name=N'step1'
			,@step_id=1 
			,@cmdexec_success_code=0 
			,@on_success_action=1 
			,@on_fail_action=1
			,@subsystem=N'TSQL'
			,@command= @job_mon_sql
			,@database_name= N'msdb'
			,@flags=0
		;

		-- update the heartbeat timestamp for the execution
		EXEC SSISDB.EDIS.isp_log_info @exec_id, 'heartbeat', '';

		-- start monitor job first
		DECLARE @ret_cd int;

		exec @ret_cd = sp_start_job @job_name = @mon_job_nm, @output_flag = 0

		if @ret_cd <> 0
			BEGIN
				set @err_msg = 'Error starting proxy execution monitor job'
				RETURN
			END

		WAITFOR DELAY '00:00:02'
		exec @ret_cd = sp_start_job @job_name = @job_nm, @output_flag = 0
		if @ret_cd <> 0
			BEGIN
				set @err_msg = 'Error starting proxy execution job'
				return;
			END
		WAITFOR DELAY '00:00:02'
		declare @ticks int = 0

		WHILE EXISTS(
			SELECT 1
			FROM msdb.dbo.sysjobs job with (Nolock)
				INNER JOIN msdb.dbo.sysjobactivity activity with (Nolock)
					ON job.job_id = activity.job_id
				INNER JOIN msdb.dbo.syssessions sess with (Nolock)
					ON sess.session_id = activity.session_id
				INNER JOIN
				(
					SELECT
						MAX( agent_start_date ) AS max_agent_start_date
					FROM
						msdb.dbo.syssessions with (Nolock)
				) sess_max
					ON
						sess.agent_start_date = sess_max.max_agent_start_date
				WHERE activity.run_requested_date IS NOT NULL AND activity.stop_execution_date IS NULL
					AND activity.job_id = @job_id
		) 
			BEGIN
				WAITFOR DELAY '00:00:01'
				set @ticks +=1;
				if @ticks >= 2
					BEGIN
						EXEC SSISDB.EDIS.isp_log_info @exec_id, 'heartbeat', '';
					END
			END

		set @err_msg  =
		(
			SELECT message
			FROM dbo.sysjobhistory 
			WHERE job_id = @job_id
				and run_status = 0
				AND step_name <> '(Job Outcome)'
		)

		-- drop the job
		exec sp_delete_job @job_name = @job_nm, @delete_history = 1

		-- ----------------------------------------------------------------------------------------------------------------------
		-- Clear abandoned Jobs

		BEGIN TRY

			if object_id('tempdb..#jobs') is not null drop table #jobs;
			SELECT Distinct j.name
			into #jobs
			FROM msdb.dbo.sysjobactivity AS a 
				INNER JOIN msdb.dbo.sysjobs AS j 
					ON j.job_id = a.job_id
			WHERE j.name LIKE 'SQLETL_EDIS_%'
				AND 
				(
					a.stop_execution_date <= DATEADD(MINUTE,-5,GETDATE())
					OR 
					( DATEDIFF(MINUTE, j.date_created,GETDATE()) >=5 AND a.start_execution_date IS NULL) -- for jobs that never started
				)
			;

			if exists(select * from #jobs)
				BEGIN
					DECLARE @nm NVARCHAR(255)
					DECLARE cs CURSOR LOCAL FAST_FORWARD FOR SELECT name from #jobs
					OPEN cs
					FETCH NEXT FROM cs INTO @nm
					WHILE @@FETCH_STATUS = 0
						BEGIN
							EXEC msdb.dbo.sp_delete_job @job_name = @nm, @delete_history = 1, @delete_unused_schedule = 1
							FETCH NEXT FROM cs INTO @nm
						END
					CLOSE CS
					DEALLOCATE CS

				END

		END TRY
		BEGIN CATCH
		END CATCH


	GO
	--{INSTALL_STEP}create proc usp_SELETL_EDIS_exec_monitor{/INSTALL_STEP}

	--{CHANGE DATABASE:MSDB}
	CREATE proc dbo.isp_SQLETL_EDIS_exec_monitor
		 @exec_id varchar(50)
		WITH ENCRYPTION
	AS
		
		SET NOCOUNT ON;
		-- Copyright Notice

		--declare @sql nvarchar(max) = 'SELECT @curr_ts = sys_hb_ts FROM SSISDB.EDIS.etl_audit WHERE exec_id = @exec_id';
		
		declare @job_nm nvarchar(250) = 'SQLETL_EDIS_'+@exec_id

		WHILE EXISTS(SELECT 1 FROM dbo.sysjobs WITH (NOLOCK) WHERE name = @job_nm)
			BEGIN
				
				declare @curr_ts datetime2 = (SELECT sys_hb_ts from SSISDB.EDIS.etl_audit where exec_id = @exec_id)
				
				--exec sp_executesql @sql, N'@curr_ts datetime2 out, exec_id varchar(250)', @curr_ts = @curr_ts out, @exec_id = @exec_id;
				
				DECLARE @now DATETIME2 = GETDATE()

				-- if longer than 20 seconds, it has been cancelled
				
				if DATEDIFF(second, @curr_ts, @now) >=20
					BEGIN
						-- the sp_stop_job issues a kill command to the cmdexec that launched edis per MSN BOL
						exec sp_stop_job @job_name = @job_nm;
						exec sp_delete_job @job_name = @job_nm, @delete_history = 1;

						UPDATE SSISDB.EDIS.etl_audit
							set task_end_ts = sysdatetime()
								,task_run_outcome = 'ABORTED'
						WHERE exec_id = @exec_id
						OPTION (MAXDOP 1)

						RETURN
					END
				ELSE
					-- delay 5 seconds
					WAITFOR DELAY '00:00:05'
					
			END


GO


	--{INSTALL_STEP}set permission for msdb edis run pkg proc{/INSTALL_STEP}

	--{CHANGE DATABASE:MSDB}
	GRANT EXECUTE ON dbo.isp_SQLETL_EDIS_run_task TO SQLETL_EDIS_Operator
	
	GO

	--{INSTALL_STEP}add permission in master for lookup items{/INSTALL_STEP}
	
	--{CHANGE DATABASE:MASTER}
	GRANT EXECUTE ON sys.xp_regread TO SQLETL_EDIS_Operator


	GO

	--{INSTALL_STEP}add permission in master to read sysprocesses{/INSTALL_STEP}
	
	--{CHANGE DATABASE:MASTER}
	GRANT SELECT ON dbo.sysprocesses TO SQLETL_EDIS_Operator


	GO

	--{INSTALL_STEP}Create proc dbo.isp_SQLETL_EDIS_setup_proxy_id{/INSTALL_STEP}

	--{CHANGE DATABASE:MSDB}

	CREATE PROC dbo.isp_SQLETL_EDIS_setup_proxy_id
		 @login_nm NVARCHAR(128)
		,@login_pwd NVARCHAR(1000)
		,@proxy_id NVARCHAR(128) 
		WITH EXEC AS OWNER, ENCRYPTION
	AS
		SET NOCOUNT ON;
		SET XACT_ABORT ON;

		DECLARE @step NVARCHAR(128)

		BEGIN TRY
			BEGIN TRAN

				IF CHARINDEX('\',@login_nm) = 0
				BEGIN
					RAISERROR('Please provide a domain login account that includes a "\" for the @login_nm parameter',16,16) WITH NOWAIT
					ROLLBACK TRAN;
					RETURN 16
				END

				DECLARE @sql NVARCHAR(MAX)

				SET @step = 'Login Check'

				-- Check Login
				IF NOT EXISTS(SELECT * FROM sys.server_principals WHERE name = @login_nm)
					BEGIN
						SET @sql = N'CREATE LOGIN ['+@login_nm+'] FROM WINDOWS'
						EXEC master..sp_executesql @sql
					END


				-- Create credential set
				DECLARE @cred_nm NVARCHAR(128) 

				SET @step = 'Credential Check'

				-- Check Credential
				IF NOT EXISTS(SELECT * FROM sys.credentials WHERE credential_identity = @login_nm)
					BEGIN
						set @cred_nm = CONCAT('SQLETL_EDIS_CRED_',REPLACE(@login_nm,'\','_'),'_',LEFT(NEWID(),8))
						SET @sql = N'CREATE CREDENTIAL ['+@cred_nm+'] WITH IDENTITY = N'''+@login_nm+''', SECRET = N'''+@login_pwd+''''
						EXEC master..sp_executesql @sql
					END
				ELSE
					BEGIN
						SET @cred_nm = (SELECT name FROM sys.credentials WHERE credential_identity = @login_nm)
						SET @sql = N'ALTER CREDENTIAL ['+@cred_nm+'] WITH IDENTITY = N'''+@login_nm+''', SECRET = N'''+@login_pwd+''''
						EXEC master..sp_executesql @sql
					END

				SET @step = 'Proxy Check'

				-- Create proxy if not exists
				DECLARE @proxy_exists BIT = 0

				IF EXISTS (
					SELECT p.name
					FROM msdb.dbo.sysproxies AS p
						--INNER JOIN master.sys.credentials AS c
						--	ON p.credential_id = c.credential_id
					WHERE p.[name] = @proxy_id
						--AND c.[name] = @cred_nm
                )
					SET @proxy_exists = 1
				;

				IF @proxy_exists = 1
					BEGIN
						SET @sql = N'sp_update_proxy @proxy_name=N'''+@proxy_id+''',@credential_name=N'''+@cred_nm+''', @enabled=1'
						EXEC msdb..sp_executesql @sql;
						
					END
				ELSE
					BEGIN
						SET @sql = N'sp_add_proxy @proxy_name=N'''+@proxy_id+''',@credential_name=N'''+@cred_nm+''', @enabled=1'
						EXEC msdb..sp_executesql @sql;
					END

				SET @step = 'Proxy Subsystem Update'

				-- add to command exec subsystem
				IF NOT EXISTS(
					SELECT *
					FROM msdb.dbo.sysproxysubsystem as ss
						INNER JOIN msdb.dbo.sysproxies as p
							on ss.proxy_id = p.proxy_id
					WHERE ss.subsystem_id = 3
						and p.name = @proxy_id
				)
					BEGIN
						SET @sql = N'sp_grant_proxy_to_subsystem @proxy_name=N'''+@proxy_id+''', @subsystem_id=3'
						EXEC msdb..sp_executesql @sql;
					END

				SET @step = 'SSISDB User Check'

				-- Map to SSISDB
				IF NOT EXISTS(SELECT * FROM SSISDB.sys.database_principals WHERE name = @login_nm)
					BEGIN
						SET @sql = N'CREATE USER ['+@login_nm+'] FOR LOGIN ['+@login_nm+']'
						EXEC SSISDB..sp_executesql @sql
					END

				SET @step = 'SSISDB role add'

				-- map to mddt role
				SET @sql = N'ALTER ROLE [EDIS_Role] ADD MEMBER ['+@login_nm+']'
				EXEC SSISDB..sp_executesql @sql

				declare @success_msg nvarchar(1000) = concat(
					'Proxy ID ['+@proxy_id+'] has been added successfully!',char(13)+char(10)
					,'Ensure the target server you are reading/writing data against for this proxy ID has login [',@login_nm,'] '
					,'mapped to the database with necessary permissions it needs access to.'
				)
				--print @success_msg

			COMMIT TRAN;
			
		END TRY
		BEGIN CATCH
			ROLLBACK TRAN;

			DECLARE @err_msg NVARCHAR(max) = CONCAT('Error setting up proxy ID',CHAR(13)+CHAR(10)
				,'Step: ',@step,CHAR(13)+CHAR(10)
				,'Message: ',ERROR_MESSAGE()
			)
			RAISERROR(@err_msg,16,16) WITH NOWAIT;
			RETURN 16;
		END CATCH

	GO

	--{CHANGE DATABASE:MSDB}
	GRANT EXECUTE ON dbo.isp_SQLETL_EDIS_setup_proxy_id TO SQLETL_EDIS_Operator

	GO

	--{INSTALL_STEP}Create proc usp_MDDataTech_EDIS_get_sys_info{/INSTALL_STEP}

	--{CHANGE DATABASE:MSDB}
	CREATE PROC dbo.usp_SQLETL_EDIS_get_sys_info
		 @info_ind		VARCHAR(250)
		,@info_arg_1	VARCHAR(1000) = NULL
        ,@info_arg_2	VARCHAR(1000) = NULL	
		,@res_msg		VARCHAR(MAX) OUT
        ,@res			BIT OUT

		WITH EXECUTE AS OWNER, ENCRYPTION
    AS
		SET NOCOUNT ON;

		

		IF @info_ind = 'INSTALL_ID'
			BEGIN

				DECLARE @install_id NVARCHAR(1000)
				declare @install_key_path nvarchar(1000) = N'Software\SQLETL.COM\'+replace(@@servername,'\','_')
				EXEC sys.xp_regread
						@rootkey      = N'HKEY_LOCAL_MACHINE'
						,@key          = @install_key_path
						,@value_name   = N'EDIS Install ID'
						,@value        =  @install_id output
						,@no_output	= 'no_output'
				;

				if @install_id is not null
					BEGIN
						set @res_msg = ltrim(rtrim(@install_id))
						set @res = 1
					END
				ELSE
					BEGIN
						set @res_msg = 'EDIS has encountered an internal error while attempting to validate the license. Please contact support@sqletl.com'
						set @res = 0
					END

			END

		

		IF @info_ind = 'CHECK_PROXY'
			BEGIN

				-- Is SQL Agent Running?
				IF NOT EXISTS(SELECT 1
					FROM MASTER.dbo.sysprocesses
					WHERE program_name = N'SQLAgent - Generic Refresher'
				)
					BEGIN
						SET @res_msg = 'In order to run this task, the SQL job agent must be running. Please start SQL Agent before re-running this task.'
						SET @res = 0
						RETURN
					END

				DECLARE @proxy_nm VARCHAR(255) = @info_arg_1

				-- does the proxy exist?
				IF NOT EXISTS(SELECT * FROM DBO.sysproxies WHERE name = @proxy_nm)
					BEGIN
						SET @res_msg = 'Proxy ['+@proxy_nm+'] does not exist. Contact your system administrator for help'
						SET @res = 0
						RETURN
					END	

				-- does it have access to CmdExec?
				IF NOT EXISTS(
					SELECT *
					FROM dbo.sysproxies AS p
						INNER JOIN	dbo.sysproxysubsystem AS sub
							ON sub.proxy_id = p.proxy_id
					WHERE p.name = @proxy_nm
						AND sub.subsystem_id = 3 -- CmdExec
						-- Powershell has security signing issues
						--AND sub.subsystem_id = 12 -- powershell
				)
					BEGIN
						SET @res_msg = 'Proxy ['+@proxy_nm+'] does not have access to subsystem CmdExec.'+CHAR(13)+CHAR(10)
						SET @res_msg += 'In order to use this feature of EDIS, please have your system adminstrator run this code below:'+CHAR(13)+CHAR(10)
						SET @res_msg += CHAR(13)+CHAR(10)
						SET @res_msg += '	-> EXEC msdb.dbo.sp_grant_proxy_to_subsystem @proxy_name=N'''+@proxy_nm+''', @subsystem_id=3'
						SET @res = 0
						RETURN
					END	

				SET @res = 1
				SET @res_msg = 'PROXY_VALID'
	
				-- ------------------------------------------------------------------------------------
				-- Check the credential mapping to MSSQL

				DECLARE @cred_id NVARCHAR(255) = (

				SELECT C.credential_identity
				FROM sys.credentials AS c
					INNER JOIN dbo.sysproxies AS px
						ON c.credential_id = px.credential_id
				WHERE px.name = @proxy_nm
				)

				DECLARE @issue_id INT = 1

				-- is the ID mapped to the server
				IF NOT EXISTS(SELECT * FROM sys.server_principals WHERE name = @cred_id)
					BEGIN
						SET @res = 0
						SET @res_msg += '('+CAST(@issue_id AS VARCHAR(2))+') '+CHAR(13)+CHAR(10)
						SET @res_msg += '		The Credential ID associated with the proxy ['+@cred_id+'] needs to be mapped as a login to the SQL Server'+CHAR(13)+CHAR(10)
						SET @res_msg += '		Please run this SQL to correct: '+CHAR(13)+CHAR(10)+CHAR(13)+CHAR(10)
						SET @res_msg += '			USE MASTER'+CHAR(13)+CHAR(10)
						SET @res_msg += '			GO'+CHAR(13)+CHAR(10)
						SET @res_msg += '			CREATE LOGIN ['+@cred_id+'] FROM WINDOWS'+CHAR(13)+CHAR(10)

						SET @issue_id += 1

					END

				DECLARE @sid VARBINARY(128) = (SELECT sid FROM sys.server_principals WHERE name = @cred_id)

				-- are they mapped to SSISDB?
				DECLARE @is_mapped_to_ssisdb BIT = 0
				DECLARE @user_name NVARCHAR(255)
				DECLARE @db_prince_id INT
				IF NOT EXISTS(
					SELECT *
					FROM SSISDB.sys.database_principals
					WHERE sid = (SELECT sid FROM sys.server_principals WHERE name = @cred_id)
				)
					BEGIN
						SET @res = 0
						SET @res_msg += CHAR(13)+CHAR(10)
						SET @res_msg += '('+CAST(@issue_id AS VARCHAR(2))+') '+CHAR(13)+CHAR(10)
						SET @res_msg += '		The Credential ID associated with the proxy ['+@cred_id+'] is not mapped to the SSISDB.'+CHAR(13)+CHAR(10)
						SET @res_msg += '		Please run this SQL to correct: '+CHAR(13)+CHAR(10)+CHAR(13)+CHAR(10)
						SET @res_msg += '			USE SSISDB'+CHAR(13)+CHAR(10)
						SET @res_msg += '			GO'+CHAR(13)+CHAR(10)
						SET @res_msg += '			CREATE USER ['+@cred_id+'] FOR LOGIN ['+@cred_id+']'+CHAR(13)+CHAR(10)
						SET @res_msg += '			GO'+CHAR(13)+CHAR(10)
						SET @res_msg += '			ALTER ROLE [EDIS_Role] ADD MEMBER ['+@cred_id+']'+CHAR(13)+CHAR(10)

						SET @issue_id += 1
					END
				ELSE
					BEGIN
						SET @is_mapped_to_ssisdb = 1
						SET @user_name = (SELECT name FROM SSISDB.sys.database_principals WHERE sid = (SELECT sid FROM sys.server_principals WHERE name = @cred_id))
						SET @db_prince_id = (SELECT principal_id FROM SSISDB.sys.database_principals WHERE sid = (SELECT sid FROM sys.server_principals WHERE name = @cred_id))
					END

				DECLARE @edis_role_id INT = (SELECT principal_id FROM SSISDB.sys.database_principals WHERE name = 'EDIS_Role')

				-- are they mapped to the edis role
				IF @is_mapped_to_ssisdb = 1
					BEGIN
						IF NOT EXISTS(SELECT *
							FROM SSISDB.sys.database_role_members
							WHERE role_principal_id = @edis_role_id
								AND member_principal_id = @db_prince_id
						)
						BEGIN
							SET @res = 0
							SET @res_msg += CHAR(13)+CHAR(10)
							SET @res_msg += '('+CAST(@issue_id AS VARCHAR(2))+') '+CHAR(13)+CHAR(10)
							SET @res_msg += '		The Credential ID associated with the proxy ['+@cred_id+'] is not a member of the EDIS_Role. Please run the SQL below to correct:'+CHAR(13)+CHAR(10)
							SET @res_msg += '			USE SSISDB'+CHAR(13)+CHAR(10)
							SET @res_msg += '			GO'+CHAR(13)+CHAR(10)
							SET @res_msg += '			ALTER ROLE [EDIS_Role] ADD MEMBER ['+ISNULL(@user_name,'')+']'

							SET @issue_id += 1
						END
					END
    
				

				IF @res = 1 
					BEGIN
						SET @res_msg = 'PROXY_VALID'
					END
				RETURN

			END

	GO

	--{INSTALL_STEP}set permission: proc usp_MDDataTech_EDIS_get_sys_info{/INSTALL_STEP}

	--{CHANGE DATABASE:MSDB}
	GRANT EXECUTE ON dbo.usp_SQLETL_EDIS_get_sys_info TO SQLETL_EDIS_Operator

	GO

	-- ========================================================================================================================================
	-- Define Types

	--{INSTALL_STEP}Create header type web_request_headers{/INSTALL_STEP}

	CREATE TYPE EDIS.web_request_headers AS TABLE(header_name VARCHAR(250), header_val VARCHAR(MAX))
	
	GO


	-- ========================================================================================================================================
	-- EDIS Assembly

	--{INSTALL_STEP}Load Assembly{/INSTALL_STEP}

	-- Write the DLL to the temp path and load it as an assemtric key
	--{ACTION:ASM_KEY_DELETE_FILE_IF_EXISTS}
	--{ACTION:ASM_KEY_WRITE_FILE}
	--{CHANGE DATABASE:MASTER}
	CREATE ASYMMETRIC KEY SQLETL_EDIS_AssemblyLoadingKey
	FROM EXECUTABLE FILE = '{MDDT_CLR_ASM_PATH}'

	GO

	--{INSTALL_STEP}Create assembly signer login{/INSTALL_STEP}

	--{CHANGE DATABASE:MASTER}
	CREATE LOGIN SQLETL_EDIS_AssemblySigner FROM ASYMMETRIC KEY SQLETL_EDIS_AssemblyLoadingKey

	GO

	--{INSTALL_STEP}set assembly signer permissions{/INSTALL_STEP}

	--{CHANGE DATABASE:MASTER}
	GRANT UNSAFE ASSEMBLY TO SQLETL_EDIS_AssemblySigner

	GO

	--{INSTALL_STEP}Create assembly signer user{/INSTALL_STEP}

	CREATE USER SQLETL_EDIS_AssemblySigner FOR LOGIN SQLETL_EDIS_AssemblySigner

	GO


	--{INSTALL_STEP}Load Assembly{/INSTALL_STEP}

	CREATE ASSEMBLY [SQLETL_EDIS]
	AUTHORIZATION [dbo]
	FROM '{MDDT_CLR_ASM_PATH}'
	WITH PERMISSION_SET = UNSAFE

	GO

	--{ACTION:ASM_KEY_DELETE_FILE_IF_EXISTS}

	GO

	--{INSTALL_STEP}create assembly proc{/INSTALL_STEP}

	CREATE PROCEDURE EDIS.isp_run_asm_proc_internal
		@exec_id nvarchar(255)
		WITH EXECUTE AS CALLER
	AS
		EXTERNAL NAME [SQLETL_EDIS].[EDIS.cEntry].[main]
	GO

	----{INSTALL_STEP}check proxy account{/INSTALL_STEP}

	--CREATE PROCEDURE EDIS.isp_check_proxy_id
	--	 @proxy_id nvarchar(255), @service_id nvarchar(1000)
	--	,@res_msg nvarchar(max) out
	--AS
	--	EXTERNAL NAME [SQLETL_EDIS].[EDIS.cSysTasks].[check_proxy_account]
	--GO

	--{INSTALL_STEP}validate db conn{/INSTALL_STEP}

	CREATE PROCEDURE EDIS.isp_validate_db_conn
		 @cn_str nvarchar(max), @cn_type nvarchar(10), @err_msg nvarchar(max) out
	AS
		EXTERNAL NAME [SQLETL_EDIS].[EDIS.cSysTasks].[validate_db_conn]
	GO

	--{INSTALL_STEP}ufn_concat_list{/INSTALL_STEP}

	CREATE AGGREGATE EDIS.ufn_concat_list
			(@txt [NVARCHAR](MAX), @delim [NVARCHAR](250))
			RETURNS[NVARCHAR](MAX)
	EXTERNAL NAME [SQLETL_EDIS].[EDIS.CONCAT_LIST]

	GO

	--{INSTALL_STEP}check proxy account{/INSTALL_STEP}

	CREATE PROCEDURE EDIS.isp_get_cn_props
		 @service_id nvarchar(1000)
	AS
		EXTERNAL NAME [SQLETL_EDIS].[EDIS.cSysTasks].[get_cn_props]
	GO

	--{INSTALL_STEP}Create function ufn_does_file_exist{/INSTALL_STEP}

	CREATE FUNCTION EDIS.ufn_does_file_exist (@file_path nvarchar(1000))
	returns BIT
		WITH EXECUTE AS CALLER
	AS
		EXTERNAL NAME [SQLETL_EDIS].[EDIS.cSysTasks].[does_file_exist]

	GO

	--{INSTALL_STEP}Create function ufn_does_file_exist{/INSTALL_STEP}

	CREATE FUNCTION EDIS.ufn_read_file_line (@file_path nvarchar(1000), @line_nbr as integer)
	returns nvarchar(max)
		WITH EXECUTE AS CALLER
	AS
		EXTERNAL NAME [SQLETL_EDIS].[EDIS.cFileTasks].[read_line_from_txt_file]

	GO

	--{INSTALL_STEP}Create function ifn_read_file_to_str{/INSTALL_STEP}

	CREATE FUNCTION EDIS.ifn_read_file_to_str (@file_path nvarchar(1000))
	returns nvarchar(max)
		WITH EXECUTE AS CALLER
	AS
		EXTERNAL NAME [SQLETL_EDIS].[EDIS.cSysTasks].[read_file_as_str]

	GO

	--{INSTALL_STEP}Create function ifn_get_ms_ace_version{/INSTALL_STEP}

	CREATE FUNCTION EDIS.ifn_get_ms_ace_version ()
	returns nvarchar(10)
		WITH EXECUTE AS OWNER
	AS
		EXTERNAL NAME [SQLETL_EDIS].[EDIS.cSysTasks].[get_ms_ace_provider]

	GO

	--{INSTALL_STEP}Create function ifn_get_dts_bin_path{/INSTALL_STEP}

	CREATE FUNCTION EDIS.ifn_get_dts_bin_path (@use_32_bit_runtime bit)
	returns nvarchar(1000)
		WITH EXECUTE AS CALLER
	AS
		EXTERNAL NAME [SQLETL_EDIS].[EDIS.cSysTasks].[get_dts_bin_path]

	GO

	--{INSTALL_STEP}Create function ifn_format_qry_as_text{/INSTALL_STEP}

	CREATE FUNCTION EDIS.ifn_format_qry_as_text (@src_qry nvarchar(max))
	returns nvarchar(max)
		WITH EXECUTE AS CALLER
	AS
		EXTERNAL NAME [SQLETL_EDIS].[EDIS.cSysTasks].[format_qry_as_text]

	GO

	--{INSTALL_STEP}Create function ufn_convert_file_to_varbinary{/INSTALL_STEP}

	CREATE FUNCTION EDIS.ufn_convert_file_to_varbinary (@file_path nvarchar(4000))
	returns varbinary(max)
		WITH EXECUTE AS CALLER
	AS
		EXTERNAL NAME [SQLETL_EDIS].[EDIS.cSysTasks].[convert_file_to_varbinary]

	GO

	--{INSTALL_STEP}Create function ufn_convert_file_to_varbinary{/INSTALL_STEP}

	CREATE PROCEDURE EDIS.usp_convert_varbinary_to_file 
		 @bin_data  varbinary(max)
		,@output_file_path  nvarchar(4000)
		WITH EXECUTE AS CALLER
	AS
		EXTERNAL NAME [SQLETL_EDIS].[EDIS.cSysTasks].[convert_varbinary_to_file]

	GO



	--{INSTALL_STEP}Create function ufn_split_string{/INSTALL_STEP}

	CREATE FUNCTION EDIS.ufn_split_string (	
		@str_list nvarchar(max), @delim nvarchar(255)
	)
	RETURNS TABLE (value nvarchar(max))
		WITH EXECUTE AS CALLER
	AS
	EXTERNAL name [SQLETL_EDIS].[EDIS.cSysTasks].[split_string]

	GO

	--{INSTALL_STEP}Create function ufn_get_files{/INSTALL_STEP}

	CREATE FUNCTION EDIS.ufn_get_files (	
		@src_dir nvarchar(1000), @filter nvarchar(500)
	)
	RETURNS TABLE 
		(
			  file_path nvarchar(1000)
			, dir_path nvarchar(1000)
			, file_nm nvarchar(1000)
			, ext nvarchar(250)
			, file_nm_wo_ext nvarchar(1000)
			, root_path nvarchar(250)
			, crt_ts datetime
			, crt_ts_utc datetime
			, last_write_ts datetime
			, last_write_ts_utc datetime
			, is_read_only bit
			, file_size bigint
		)
		WITH EXECUTE AS CALLER
	AS
	EXTERNAL name [SQLETL_EDIS].[EDIS.cFileTasks].[get_files]

	GO

	-- ========================================================================================================================================
	-- Define Functions
	
	--{INSTALL_STEP}Create function fn_check_perm{/INSTALL_STEP}

	CREATE FUNCTION EDIS.fn_check_perm
	(
		@server_id NVARCHAR(50)
	)
	
	RETURNS BIT
	WITH ENCRYPTION
    AS
    BEGIN

		-- 1 means has permissions, 0 means does not

		-- sysadmins get green light
		IF IS_SRVROLEMEMBER('sysadmin') = 1 RETURN 1

		-- db owner gets green light
		IF IS_MEMBER('db_owner') = 1 RETURN 1

		-- if this server is not in the permissions table, no contraint was put on it, so we are good to go
		IF NOT EXISTS(SELECT * FROM EDIS.lkup_server_id_perm WITH (NOLOCK) WHERE server_id = @server_id) RETURN 1;

		-- Does the individual user ID exist in the table?
		IF EXISTS(SELECT * FROM EDIS.lkup_server_id_perm WITH (NOLOCK) WHERE server_id = @server_id AND usr_id = SUSER_NAME()) RETURN 1

		-- Check for active directory group membership
		IF EXISTS(
			SELECT *
			FROM EDIS.lkup_server_id_perm WITH (NOLOCK)
			WHERE server_id = @server_id
				AND ISNULL(IS_MEMBER(usr_id),0) = 1
		) RETURN 1

		-- default
		RETURN 0

	END

	GO

	--{INSTALL_STEP}Create Function ifn_validate_qry{/INSTALL_STEP}


	create function EDIS.ifn_validate_qry
		(@src_qry nvarchar(max))
		Returns varchar(max)
		WITH ENCRYPTION
	as
		begin
			declare @sys_err_msg varchar(max) = (select top 1 error_message	
			from  sys.dm_exec_describe_first_result_set(@src_qry, NULL, 0)
			where error_message is not null
			)

			declare @fmt_err_msg varchar(max)

			if @sys_err_msg is not null
				begin
					declare @crlf char(2) = char(13)+char(10);

					set @fmt_err_msg = CONCAT(
						'The source query provided by parameter @src_qry for host server ['+@@servername+'] has a syntax issue. Below is the error statement',@crlf
						,'Error Message',@crlf
						,'-------------',@crlf,@crlf
						,@sys_err_msg
					)
						
						
					if @sys_err_msg like '%invalid object name%' 
						BEGIN
							set @fmt_err_msg += @crlf
							set @fmt_err_msg += 'When receiving an invalid object name error, please ensure tables and views referenced in the source query are fully qualified ie. [Database].[schema].[table].'
						END

					
				end

				return @fmt_err_msg


		end

	GO

	--{INSTALL_STEP}Create Function ifn_get_svc_config{/INSTALL_STEP}


	create function EDIS.ifn_get_svc_config
		 (@svc_id nvarchar(250))
		
		returns xml

		with execute as owner, encryption
	as
		BEGIN

			--declare @has_perm bit = 0

			---- sysadmins and db_owner get green light
			--IF (IS_SRVROLEMEMBER('sysadmin') = 1 OR IS_MEMBER('db_owner') = 1)
			--	set @has_perm = 1

			---- Does the individual user ID exist for permission on that service id?
			--IF EXISTS(SELECT * FROM EDIS.lkup_server_id_perm WITH (NOLOCK) WHERE server_id = @svc_id AND usr_id = SUSER_NAME()) set @has_perm = 1

			---- Check for active directory group membership
			--IF EXISTS(
			--	SELECT *
			--	FROM EDIS.lkup_server_id_perm WITH (NOLOCK)
			--	WHERE server_id = @svc_id
			--		AND ISNULL(IS_MEMBER(usr_id),0) = 1
			--) set @has_perm = 1

			

			declare @svc_config xml;

			--if @has_perm = 0
			--	BEGIN

			--		declare @not_authorized_msg varchar(max)
			--		declare @crlf char(2) = char(13)+char(10)

			--		set @not_authorized_msg = concat('**AUTHORIZATION ERROR**',@crlf
			--			,'Your User ID is not authorized to view the connection details',@crlf
			--			,'In order to view the connection properties, you need one of the following permissions:',@crlf
			--			,'[1] Be a sysadmin',@crlf
			--			,'[2] DB_owner on SSISDB',@crlf
			--			,'[3] Have explicit permission to the service id. See procedure EDIS.usp_config_svc_id_perm for details'
			--		)

			--		set @svc_config = (select cast(@not_authorized_msg as xml))
				
			--	END
			
			set @svc_config = (
	
				select convert(xml,DECRYPTBYKEYAUTOCERT(cert_id('SQLETL_EDIS_CERT'), null, service_config))
					from edis.lkup_service_id
					where service_id = @svc_id
				)
			;

			return @svc_config;

		END

	GO

	--{INSTALL_STEP}Create Proc usp_config_svc_id_perm{/INSTALL_STEP}

	CREATE PROC EDIS.usp_config_svc_id_perm
		 @svc_id nvarchar(255)
		,@usr_id nvarchar(255)
		,@action nvarchar(10)

		WITH ENCRYPTION
	AS
	BEGIN
		SET NOCOUNT ON;
		-- Copyright Notice

		declare @msg varchar(max)

		if @action not in ('INSERT','DELETE') 
			BEGIN
				raiserror('Parameter @action only accepts values ''INSERT'' and ''DELETE''', 16,16) with nowait
				return 16
			END

		if @action = 'INSERT'
			BEGIN
				IF NOT EXISTS(SELECT 1 FROM EDIS.lkup_server_id_perm WHERE server_id = @svc_id and usr_id = @usr_id)
					BEGIN
						INSERT EDIS.lkup_server_id_perm VALUES (@svc_id, @usr_id, getdate())
						set @msg = concat('User [',@usr_id,'] has been added successfully to Service ID [',@svc_id,']')
						print @msg
					END
				ELSE	
					BEGIN
						set @msg = concat('Service ID [',@svc_id,'] for User [',@usr_id,'] already exists in base table SSISDB.EDIS.lkup_server_id_perm. No action taken')
						print @msg
					END
			END
		ELSE
			BEGIN
				IF  EXISTS(SELECT 1 FROM EDIS.lkup_server_id_perm WHERE server_id = @svc_id and usr_id = @usr_id)
					BEGIN
						DELETE EDIS.lkup_server_id_perm WHERE server_id = @svc_id and usr_id = @usr_id
						set @msg = concat('User [',@usr_id,'] has been removed successfully from Service ID [',@svc_id,']')
						print @msg
					END
				ELSE	
					BEGIN
						set @msg = concat('Service ID [',@svc_id,'] for User [',@usr_id,'] does not exist in base table SSISDB.EDIS.lkup_server_id_perm. No action taken')
						print @msg
					END

			END


	END

	GO

	--{INSTALL_STEP}Create Proc isp_run_task_via_proxy{/INSTALL_STEP}

	CREATE PROC EDIS.isp_run_task_via_proxy 
		 @exec_id varchar(50)
		,@logging_level varchar(50)
		,@edis_exec_path varchar(1000)
		,@err_msg nvarchar(max) out
		WITH EXECUTE AS OWNER, ENCRYPTION
	AS
		SET NOCOUNT ON;

		declare @bin varbinary(128) = cast('$-___139ns~#@Fvnc9N@DEDIS_PROXY_CALLER$*%NQNCZGSG(DS)' as varbinary(128))
		set context_info @bin

		EXEC MSDB.dbo.isp_SQLETL_EDIS_run_task
			  @exec_id = @exec_id
			 ,@logging_level = @logging_level
			 ,@edis_exec_path = @edis_exec_path
			 ,@err_msg	= @err_msg out
		;


	;
	GO

	--{INSTALL_STEP}Sign Proc isp_run_task_via_proxy{/INSTALL_STEP}

	-- SIGN THIS
	ADD SIGNATURE TO EDIS.isp_run_task_via_proxy BY CERTIFICATE SQLETL_EDIS_ProxyCert
	WITH PASSWORD = '{PROXY_CERTIFICATE_PASSWORD}'

	GO

	--{INSTALL_STEP}Create Proc isp_get_sys_info{/INSTALL_STEP}

	CREATE PROC EDIS.isp_get_sys_info
		  @info_ind VARCHAR(250)
		, @info_arg_1 VARCHAR(1000) = NULL
        , @info_arg_2 VARCHAR(1000) = NULL
		, @res_msg		VARCHAR(MAX) OUT
        , @res BIT OUT
		WITH EXECUTE AS OWNER, ENCRYPTION
	AS
		SET NOCOUNT ON;
		EXEC MSDB.dbo.usp_SQLETL_EDIS_get_sys_info
			@info_ind = @info_ind, @info_arg_1 = @info_arg_1, @info_arg_2 = @info_arg_2
			,@res_msg = @res_msg OUT
            ,@res = @res OUT
        ;

	GO

	--{INSTALL_STEP}Sign Proc isp_get_sys_info{/INSTALL_STEP}

	ADD SIGNATURE TO EDIS.isp_get_sys_info BY CERTIFICATE SQLETL_EDIS_ProxyCert
	WITH PASSWORD = '{PROXY_CERTIFICATE_PASSWORD}'

	GO

	--{INSTALL_STEP}Create Proc isp_run_task{/INSTALL_STEP}

	CREATE PROCEDURE EDIS.[isp_run_task]
		   @args xml
		  ,@exec_id nvarchar(255) = null out
		 WITH ENCRYPTION
	AS
	BEGIN

		SET NOCOUNT ON;
		SET XACT_ABORT ON;
		
		-- Copyright Notice

		declare @crlf char(2) = char(13)+char(10);

		-- Can they run the task?
		if NOT (IS_SRVROLEMEMBER('sysadmin') = 1 or IS_MEMBER('EDIS_Role') = 1)
		begin
			DECLARE @pkg_access_msg varchar(max) = concat(
				 'Please Note: Your user id [',suser_name(),'] does not have access to execute EDIS stored procedures.',@crlf
				,'In order to execute EDIS stored procedures, you need to be added to the SSISDB Database Role "EDIS_Role"',@crlf
				,'using the SQL command below or be a member of the sysadmin role.',@crlf
				,'To add your user ID to SSISDB Database role "EDIS_Role", execute this SQL: ',@crlf,@crlf
				,'	USE SSISDB',@crlf
				,'	GO',@crlf
				,'	ALTER ROLE EDIS_Role ADD MEMBER [',suser_name(),']'
			)

			raiserror(@pkg_access_msg,16,16) with nowait;
			return 16

		end

		-- SQL Login Check
		IF EXISTS(select * from sys.server_principals where name = suser_name() and type_desc = 'SQL_LOGIN')
			begin
				declare @ms_sql_login_err_msg varchar(8000) = concat(
					 'Note: SQL Login [',suser_name(),'] cannot run this program. Only Windows Logins are allowed to run the program.',char(13)+char(10)
					,'This is a Microsoft SSISDB security restriction.'
				)

				raiserror(@ms_sql_login_err_msg,16,16) with nowait
				return 16 
			end
    
		-- Check that caller is one of our stored procs
		declare @caller_auth nvarchar(250) = isnull((select   x.value('caller_auth[1]','nvarchar(250)')  from @args.nodes('/root') as t(x)),'')

		if @caller_auth <> 'MDDT_AUTH_CALLER_#x$^71'
			begin
				declare @caller_msg varchar(max) = 'isp_run_task is not able to be executed directly. Please use an approved procedure.'
				;
				raiserror(@caller_msg,16,16) with nowait
				return 16 
			end
              
		-- Get The EDIS Install ID
		Declare @install_id nvarchar(1000), @install_err_check bit

		-- edit 2/26/2018: removed license check. company closed :(

		set @install_id = 'PRO SITE LICENSE'; goto skip_license_check

		EXEC EDIS.isp_get_sys_info @info_ind = 'INSTALL_ID'
			,@res_msg = @install_id OUT
			,@res = @install_err_check OUT
		;

		IF @install_err_check = 0
			BEGIN
				RAISERROR(@install_id,16,16) WITH NOWAIT
				RETURN 16
			END

		skip_license_check:

		declare @use_32_bit_runtime bit = isnull((select x.value('use_32_bit_runtime[1]','bit') from @args.nodes('/root') as t(x)),0)

		DECLARE @edis_exec_path nvarchar(1000) = EDIS.ifn_get_dts_bin_path(@use_32_bit_runtime)
		--set @edis_exec_path += 'MDDataTechEDIS.exe'
		set @edis_exec_path += 'SQLETL_EDIS.exe'

		--print @edis_exec_path

		-- =========================================================================================================================================
		-- Grab Task and Sub task and route

		-- Set Exec ID
		--declare @exec_id nvarchar(255) = cast(newid() as nvarchar(255))

		set @exec_id = cast(newid() as nvarchar(255))

		declare @prim_task nvarchar(250)= upper((select x.value('primary_task[1]','nvarchar(250)') from @args.nodes('/root') as t(x)))
		declare @sub_task nvarchar(250)= upper((select x.value('sub_task[1]','nvarchar(250)') from @args.nodes('/root') as t(x)))

		declare @use_clr bit = 0
		if @prim_task in ('file_task') -- and @sub_task in ('delete_files','create_dir','delete_dir','get_file_list')
			SET @use_clr = 1
		else if @prim_task = 'web_task' and @sub_task = 'web_req'
			begin
				-- if no tls version was declared, we can use clr
				declare @tls nvarchar(250) = isnull((select x.value('tls_version[1]','nvarchar(250)') from @args.nodes('/root') as t(x)),'')
				if isnull(@tls,'') = '' 
					set @use_clr = 1
			end
		else if @prim_task = 'admin_task'
			set @use_clr = 1
		;

		-- ------------------------------------------------------------------------------------------------------------------------------------------
		-- Load Vars to temp table

		if object_id('tempdb..#edis') is not null drop table #edis;

		create table #edis (itemID varchar(250), itemVal varchar(max));

		insert #edis (itemID, itemVal)
		SELECT
			ItemID = C.value('local-name(.)', 'varchar(250)'),
			ItemVal = C.value('(.)[1]', 'varchar(max)') 
		FROM @args.nodes('/root/*') AS T(C)
		;

		-- remove unecessary params
		delete #edis
		where itemId = 'caller_auth'
		;

		-- Encrypt Sensitive
		update #edis
			set itemVal = ENCRYPTBYPASSPHRASE(cast(@exec_id as varchar(50)),itemVal)
		WHERE itemId in ('src_cn_str','dest_cn_str','cn_str','ftp_uid','ftp_pwd','svc_uid','svc_pwd', 'client_secrets', 'proxy_svc_uid', 'proxy_svc_pwd')
		;


		-- Load additional Vars
		insert #edis values ('install_id', @install_id);


		-- load sql server version
		insert #edis
		SELECT 'SQL_SERVER_VERSION'
			,CASE 
				 WHEN CONVERT(VARCHAR(128), SERVERPROPERTY ('productversion')) like '8%' THEN 80
				 WHEN CONVERT(VARCHAR(128), SERVERPROPERTY ('productversion')) like '9%' THEN 90
				 WHEN CONVERT(VARCHAR(128), SERVERPROPERTY ('productversion')) like '10.0%' THEN 100
				 WHEN CONVERT(VARCHAR(128), SERVERPROPERTY ('productversion')) like '10.5%' THEN 100
				 WHEN CONVERT(VARCHAR(128), SERVERPROPERTY ('productversion')) like '11%' THEN 110
				 WHEN CONVERT(VARCHAR(128), SERVERPROPERTY ('productversion')) like '12%' THEN 120
				 WHEN CONVERT(VARCHAR(128), SERVERPROPERTY ('productversion')) like '13%' THEN 130
				 WHEN CONVERT(VARCHAR(128), SERVERPROPERTY ('productversion')) like '14%' THEN 140
				 ELSE 0
			  END
		;
		
		-- ====================================================================================================================
		-- Check for Debugging and Logging flags

		-- default
		declare @logging_level nvarchar(30) = 'none'

		-- debugging
		if charindex('edis_debug_mode_on',cast(context_info() as varchar(128))) > 0 
			begin
				select @args as EDIS_params_xml
				return
			end

		else if charindex('edis_logging_verbose',cast(context_info() as varchar(128))) > 0 
			BEGIN
				set @logging_level = 'verbose';
			END

		INSERT #edis VALUES ('LOGGING_LEVEL', @logging_level)

		-- ----------------------------------------------------------------------------------------------------------------------------
		-- Load the Audit Table

		declare @task_start_ts datetime2 = sysdatetime()

		declare @task_action nvarchar(250);

		set @task_action = upper(@prim_task)
		if @sub_task is not null set @task_action += concat(' - ', upper(@sub_task))
		;

		declare @src_sys nvarchar(250), @dest_sys nvarchar(250), @src_qry nvarchar(max), @dest_tbl nvarchar(250)
			,@file_path nvarchar(1000), @ftp_id nvarchar(250), @ftp_srvr nvarchar(250), @ftp_dir nvarchar(1000)
			,@ftp_folder_nm nvarchar(250), @local_dir nvarchar(1000), @file_crit nvarchar(250), @file_list nvarchar(4000)
			,@svc_id nvarchar(250), @url nvarchar(4000), @process_nm nvarchar(4000), @process_args nvarchar(max), @soap_envelope nvarchar(max)
		;

		select 
			 @src_sys			= x.value('src_sys_nm[1]','nvarchar(250)') 
			,@dest_sys			= x.value('dest_sys_nm[1]','nvarchar(250)')
			,@src_qry			= x.value('src_qry[1]','nvarchar(max)')
			,@dest_tbl			= x.value('dest_tbl[1]','nvarchar(250)')
			,@file_path			= nullif(x.value('file_path[1]','nvarchar(1000)'),'')
			,@ftp_id			= x.value('ftp_id[1]','nvarchar(250)') 
			,@ftp_srvr			= x.value('ftp_srvr[1]','nvarchar(1000)')
			,@ftp_dir			= x.value('ftp_dir[1]','nvarchar(4000)')
			,@ftp_folder_nm		= x.value('folder_nm[1]','nvarchar(250)')
			,@local_dir			= x.value('local_dir[1]', 'nvarchar(1000)')
			,@file_crit			= x.value('file_crit[1]', 'nvarchar(1000)')
			,@file_list			= x.value('file_list_usr[1]', 'nvarchar(4000)')
			,@svc_id			= x.value('svc_id[1]','nvarchar(250)')
			,@url				= x.value('url[1]','nvarchar(4000)')
			,@process_nm		= x.value('process_nm[1]','nvarchar(4000)')
			,@process_args		= x.value('args[1]','nvarchar(max)')
			,@soap_envelope		= x.value('soap_envelope[1]','nvarchar(max)')
		from @args.nodes('/root') as t(x)

		-- get scalar uses different var
		if @src_qry is null
			begin
				set @src_qry = (select x.value('sql_qry[1]','nvarchar(max)') from @args.nodes('/root') as t(x))
			end
		-- sql cmd uses different var
		if @src_qry is null
			begin
				set @src_qry = (select x.value('sql_cmd[1]','nvarchar(max)') from @args.nodes('/root') as t(x))
			end

		set @src_qry = nullif(ltrim(rtrim(@src_qry)),'')

		if @local_dir is null 
			begin
				set @local_dir = (select x.value('folder_path[1]','nvarchar(1000)') from @args.nodes('/root') as t(x))
			end

		set @file_list = nullif(ltrim(rtrim(@file_list)),'')

		if @sub_task = 'RENAME_FILE'
			begin
				declare @curr_path nvarchar(1000) = (select x.value('curr_file_path[1]','nvarchar(1000)') from @args.nodes('/root') as t(x))
				declare @new_path nvarchar(1000) = (select x.value('new_file_path[1]','nvarchar(1000)') from @args.nodes('/root') as t(x))
				set @file_list = concat(@curr_path,' > ', @new_path)
			end

		declare @ip_adrs nvarchar(250) = cast(CONNECTIONPROPERTY('client_net_address') as nvarchar(250))

		if @sub_task = 'RUN_SQL_CMD' set @task_action = 'RUN_SQL_CMD';
		if @sub_task = 'GET_SCALAR' set @task_action = 'GET_SCALAR';


		-- Load Audit Table
		insert EDIS.etl_audit (exec_id, task_action, task_start_ts, usr_login_id, usr_machine_nm, ip_adrs
		,src_sys, dest_sys, src_qry, dest_tbl, file_path, ftp_id, ftp_srvr, ftp_dir, ftp_folder_nm, local_dir, file_crit, file_list
		,svc_id, [url], process_nm, process_args, soap_envelope
		)
		values (@exec_id, @task_action, @task_start_ts, SUSER_NAME(), HOST_NAME(), @ip_adrs
			,@src_sys, @dest_sys, @src_qry, @dest_tbl, @file_path
			,@ftp_id, @ftp_srvr, @ftp_dir, @ftp_folder_nm, @local_dir, @file_crit, @file_list
			,@svc_id, @url, @process_nm, @process_args, @soap_envelope
		)
		option (maxdop 1)
		;         

		-- ----------------------------------------------------------------------------------------------------------------------------
		-- Run the Task

		-- check if this is going proxy execution
		declare @using_proxy bit = 0
		if exists(select 1 from #edis where itemId = 'proxy_id' and isnull(ltrim(rtrim(itemVal)),'') <> '') 
			set @using_proxy = 1
		;

		-- Localize data to global temp if we are going via proxy or ssis
		if @using_proxy = 1 OR @use_clr = 0
			BEGIN
				INSERT SSISDB.EDIS.util_task_params (exec_id, itemID, itemVal)
				SELECT @exec_id, itemID, itemVal
				from #edis
				;
				--exec('SELECT * INTO [##'+@exec_id+'] FROM #edis')
			END

		-- SSIS execution prep
		IF (@use_clr = 0 and @using_proxy = 0)
			BEGIN
				
				--DECLARE @x int;

				--goto skipSSISDB;

				declare @ssis_execution_id bigint

				declare @queue_id bigint
				insert EDIS.util_task_sync (entry_id) values (1);
				set @queue_id = SCOPE_IDENTITY();

				declare @counter int = 1
				while exists(select 1 from EDIS.util_task_sync with (nolock) where queue_id < @queue_id)
					begin
						waitfor delay '00:00:01';
						set @counter +=1;
						-- delay no more than 2 min
						if @counter >= (60 * 2) break
					end

				exec SSISDB.catalog.create_execution 
					 @folder_name		= 'SQLETL.COM'
					,@project_name		= 'EDIS'
					,@package_name		= 'Launcher.dtsx'
					,@execution_id		= @ssis_execution_id out
					,@use32bitruntime	= @use_32_bit_runtime
					
				;   

				-- remove from queue (flush any that were never removed as well)
				delete EDIS.util_task_sync where queue_id <= @queue_id

				-- set ssis package params
				declare @instance nvarchar(255) = cast(@@servername as nvarchar(255))
				declare @ssisdb_execution_id_str nvarchar(50) = cast(@ssis_execution_id as nvarchar(50))
				exec catalog.set_execution_parameter_value @ssis_execution_id, @object_type = 30, @parameter_name = N'mssql_inst', @parameter_value = @instance;
				exec catalog.set_execution_parameter_value @ssis_execution_id, @object_type = 30, @parameter_name = N'exec_id', @parameter_value = @exec_id;
				exec catalog.set_execution_parameter_value @ssis_execution_id, @object_type = 30, @parameter_name = N'edis_logging_level', @parameter_value = @logging_level;
				exec catalog.set_execution_parameter_value @ssis_execution_id, @object_type = 30, @parameter_name = N'edis_exec_path', @parameter_value = @edis_exec_path;
				exec catalog.set_execution_parameter_value @ssis_execution_id, @object_type = 30, @parameter_name = N'ssisdb_execution_id', @parameter_value = @ssisdb_execution_id_str;

				exec catalog.set_execution_parameter_value @ssis_execution_id, @object_type = 50, @parameter_name = N'LOGGING_LEVEL', @parameter_value = 1;
				exec catalog.set_execution_parameter_value @ssis_execution_id, @object_type = 50, @parameter_name = N'SYNCHRONIZED', @parameter_value = 1;  

			END

		
		--skipSSISDB:

		-- Run the task
		DECLARE @err_msg nvarchar(max)



		IF @using_proxy = 1
			BEGIN
				drop table #edis; 
				EXEC EDIS.isp_run_task_via_proxy 
					  @exec_id = @exec_id
					, @logging_level = @logging_level
					, @edis_exec_path = @edis_exec_path
					, @err_msg = @err_msg out
			END
		else if @use_clr = 0
			BEGIN
				drop table #edis; 

				--EXEC EDIS.isp_run_edis_exe 
				--	 @edis_path = @edis_exec_path
				--	,@mssql_inst = @@servername
				--	,@exec_id = @exec_id
				--	,@logging_level = @logging_level
				--;
				

				EXEC catalog.start_execution @ssis_execution_id; 

			END
		ELSE
			BEGIN -- CLR RUN
				EXEC EDIS.isp_run_asm_proc_internal @exec_id
			END
		               
		-- =======================================================================================================================================================================
		-- Get Results

		DECLARE @result bit = 1
		if @use_clr = 1
			BEGIN
				IF exists(select * from EDIS.etl_audit WITH (NOLOCK) where exec_id = @exec_id and err_msg is not null)
					BEGIN
						SET @err_msg = (select err_msg from EDIS.etl_audit WITH (NOLOCK) where exec_id = @exec_id)
						set @result = 0
					END
			END
		ELSE if @using_proxy = 1
			BEGIN
				-- did we log it?
				IF exists(select * from EDIS.etl_audit WITH (NOLOCK) where exec_id = @exec_id and err_msg is not null)
					BEGIN
						set @err_msg = (select err_msg from EDIS.etl_audit WITH (NOLOCK) where exec_id = @exec_id)
						set @result = 0
					END
				-- error message was passed back from job agent
				else if @err_msg is not null
					BEGIN
						set @err_msg = @err_msg
						set @result = 0
					END
			
			END
		ELSE
			BEGIN
				IF (select status from catalog.executions where execution_id = @ssis_execution_id) = 4 
					BEGIN
						set @result = 0
						set @err_msg = (select err_msg from EDIS.etl_audit WITH (NOLOCK) where exec_id = @exec_id)

						if @err_msg is null
							begin
								select @err_msg = coalesce(@err_msg+'','')+ cast(message_time as varchar(50))+' ->	'+replace(message, 'Script Task:Error:','') + char(13)+char(10)
								from catalog.event_messages
								where operation_id = @ssis_execution_id  and event_name = 'OnError'
									and message is not null
									and message not in ('Script Task:Error: The script returned a failure result.')
								order by message_time
							end
					END
			END

		-- -----------------------------------------------------------------------------------------------
		-- Log Finish

		declare @task_end_ts datetime2 = sysdatetime()
		update EDIS.etl_audit
			set 
				  task_end_ts = @task_end_ts
				, task_duration = DATEDIFF(second, @task_start_ts, @task_end_ts)
				, task_run_outcome = CASE WHEN @result = 0 then 'FAILURE' else 'SUCCESS' END
				, err_msg = case when @result = 1 then null else @err_msg END
		WHERE exec_id = @exec_id
		OPTION (MAXDOP 1)
		;

		-- ---------------------------------------------------------------------------------------------------------------------
		-- Raise the error if needed

		declare @err_msg_to_report nvarchar(max)
		if @err_msg is not null
			BEGIN
				set @err_msg_to_report = concat(@task_action, ' failed with the following information:',char(13)+char(10),@err_msg)
				set @err_msg_to_report += concat(char(13)+char(10),'For more information about this error event, run this query: SELECT * FROM SSISDB.EDIS.etl_audit where exec_id = ''',@exec_id,'''')
				RAISERROR(@err_msg_to_report,16,16) with nowait;
			END
		           
				   
		-- Clean up Params
		DELETE p
		from SSISDB.EDIS.util_task_params as p
			inner join SSISDB.EDIS.etl_audit as a
				on p.exec_id = a.exec_id
		WHERE (
			    a.task_end_ts is not NULL
				-- remove old param recs greater than 2 days
				OR DATEDIFF(day,a.task_start_ts, GETDATE()) >=2
			)
		option (maxDOP 1)
		;

		-- return error code
		IF @err_msg IS NOT NULL
			RETURN 16
		ELSE
			RETURN 0 -- isp_run_task
		;
				      
	END

	GO
	--{INSTALL_STEP}Create Proc isp_log_task{/INSTALL_STEP}

	CREATE PROC EDIS.isp_log_task
		  @exec_id varchar(50)
		 ,@log_type varchar(10)
		 ,@msg_hdr varchar(250)
		 ,@msg_dtl varchar(max)
		WITH ENCRYPTION
		AS
			SET NOCOUNT ON;

			INSERT EDIS.task_logger
				(exec_id, crt_ts, log_type, msg_hdr, msg_dtl)
			VALUES (@exec_id, sysdatetime(), @log_type, @msg_hdr, @msg_dtl)

	GO

	--{INSTALL_STEP}Create Proc isp_log_info{/INSTALL_STEP}


	CREATE PROC EDIS.isp_log_info
		 @exec_id varchar(250)
		,@action varchar(50)
		,@val nvarchar(max)
		WITH ENCRYPTION
	as
		set nocount on;

		if @action = 'rows_tsfr'
			BEGIN
				UPDATE EDIS.etl_audit
					set rows_tsfr = cast(@val as bigint)
				where exec_id = @exec_id
				option(maxdop 1)
			END
		else if @action = 'err_msg'
			BEGIN
				UPDATE EDIS.etl_audit
					set err_msg = @val
				where exec_id = @exec_id
				option(maxdop 1)
			END
		else if @action = 'aborted'
			BEGIN
				UPDATE EDIS.etl_audit
					set task_end_ts = sysdatetime(), task_run_outcome = 'ABORTED'
				where exec_id = @exec_id
				option(maxdop 1)
			END
		else if @action = 'heartbeat'
			BEGIN
				UPDATE EDIS.etl_audit
					set sys_hb_ts = sysdatetime()
				where exec_id = @exec_id
				option(maxdop 1)
			END
		else if @action = 'info_msgs'
			BEGIN
				UPDATE EDIS.etl_audit
					set info_msgs = TRY_CONVERT(XML, @val)
				where exec_id = @exec_id
				option(maxdop 1)
			END

	GO

	--{INSTALL_STEP}Create Proc usp_replace_file_content{/INSTALL_STEP}

	CREATE PROC EDIS.usp_replace_file_content
		 @file_path nvarchar(1000)
		,@orig_string nvarchar(1000) 
		,@replace_string  nvarchar(128) 
		,@backup_file_nm nvarchar(255) = null

		WITH ENCRYPTION
	AS
	BEGIN
		SET NOCOUNT ON;
		--	-- Copyright Notice

		if EDIS.ufn_does_file_exist(@file_path) = 0
			BEGIN
				raiserror('File [%s] does not exist.', 16, 16, @file_path) with nowait;
				return 16
			END
		

		declare @xml xml = (
			select 
				  @file_path as file_path
				, @orig_string as orig_string
				, @replace_string as replace_string
				, isnull(@backup_file_nm,'') as backup_file_nm
				, 'file_task' as primary_task
				, 'replace_content' as sub_task
				,'MDDT_AUTH_CALLER_#x$^71' as caller_auth
			for xml path('root')
		)

	    
		exec EDIS.isp_run_task @xml
    
	END

	GO

	--{INSTALL_STEP}Create Proc usp_delete_loc_files{/INSTALL_STEP}

	CREATE PROC EDIS.usp_delete_loc_files
		 @folder_path nvarchar(1000)
		,@file_crit nvarchar(1000) = ''
		,@file_list_tbl  nvarchar(128) = ''

		WITH ENCRYPTION
	AS
	BEGIN
		SET NOCOUNT ON;
	--	-- Copyright Notice

		declare @file_list_usr nvarchar(max)

		if object_id('tempdb..'+@file_list_tbl) is not null
			begin
				declare @sql_file_list nvarchar(max) = 'select @file_list_usr = isnull(@file_list_usr+'';'','''')+file_nm from '+@file_list_tbl
				exec sp_executesql @sql_file_list, N'@file_list_usr nvarchar(max) out', @file_list_usr = @file_list_usr out
		
			end

		if @file_list_usr is null set @file_list_usr = ''

		declare @xml xml = (
			select @folder_path as folder_path, @file_crit as file_crit
				, @file_list_usr as 'file_list_usr'
				, 'file_task' as primary_task, 'delete_files' as sub_task
				,'MDDT_AUTH_CALLER_#x$^71' as caller_auth
			for xml path('root')
		)

	    
		exec EDIS.isp_run_task @xml
    
	END

	GO
	--{INSTALL_STEP}Create Proc usp_watch_for_file{/INSTALL_STEP}

	CREATE PROC EDIS.usp_watch_for_file
		 @folder_path nvarchar(1000)
		,@file_crit nvarchar(1000) = ''
		,@max_timeout int = 2100000000
		WITH ENCRYPTION
	AS
	BEGIN
		SET NOCOUNT ON;
		-- Copyright Notice

		declare @xml xml = (
			select @folder_path as folder_path
				, @file_crit as file_crit
				, 'file_task' as primary_task, 'watch_for_file' as sub_task
				, isnull(@max_timeout,2100000000) as max_timeout
				,'MDDT_AUTH_CALLER_#x$^71' as caller_auth
			for xml path('root')
		)

	    
		exec EDIS.isp_run_task @xml
    
	END

	GO

	--{INSTALL_STEP}Create Proc usp_create_loc_dir{/INSTALL_STEP}

	CREATE procedure EDIS.usp_create_loc_dir
		 @folder_path nvarchar(1000)
		--WITH Encryption
	AS

	EXTERNAL NAME [SQLETL_EDIS].[EDIS.cFileTasks].[create_loc_dir]

	GO

	ADD SIGNATURE TO EDIS.usp_create_loc_dir BY CERTIFICATE SQLETL_EDIS_ProxyCert
	WITH PASSWORD = '{PROXY_CERTIFICATE_PASSWORD}'

	GO

	--{INSTALL_STEP}Create Proc usp_delete_loc_dir{/INSTALL_STEP}

	CREATE procedure EDIS.usp_delete_loc_dir
		 @folder_path nvarchar(1000)
		--WITH Encryption
	AS

	EXTERNAL NAME [SQLETL_EDIS].[EDIS.cFileTasks].[delete_loc_dir]

	GO

	ADD SIGNATURE TO EDIS.usp_delete_loc_dir BY CERTIFICATE SQLETL_EDIS_ProxyCert
	WITH PASSWORD = '{PROXY_CERTIFICATE_PASSWORD}'

	GO

	--{INSTALL_STEP}Create Proc usp_ftp_create_dir{/INSTALL_STEP}

	CREATE PROCEDURE EDIS.usp_ftp_create_dir
		 @ftp_id nvarchar(250)
		,@ftp_srvr nvarchar(1000)
		,@ftp_dir nvarchar(4000)
		,@folder_nm nvarchar(250)
		,@use_ssh bit = 0
		,@use_ssl bit = 0
		,@use_passive bit = 1
		,@port_nbr int = 0
		WITH ENCRYPTION
	AS
	BEGIN    
		SET NOCOUNT ON;
		-- Copyright Notice

		IF NOT EXISTS(SELECT 1 FROM EDIS.lkup_service_id where service_id = @ftp_id)
			BEGIN
				RAISERROR('param @ftp_id with value [%s] does not exist. Please see task EDIS.usp_config_ftp_id to create an FTP ID', 16,16,@ftp_id) with nowait;
				return 16;
			END

		if EDIS.fn_check_perm(@ftp_id) = 0
			begin
				DECLARE @lock_msg VARCHAR(MAX) = 
				'Service ID ['+@ftp_id+'] has been locked by an administrator. '+CHAR(13)+CHAR(10)
				SET @lock_msg += 'To use this Service ID, you will need an administrator to run the SQL Command below '
				SET @lock_msg += 'with the @usr_id parameter set as a global group or database role that you are a member of. '+CHAR(13)+CHAR(10)
				SET @lock_msg += 'You can also set the @usr_id parameter as your individual ID as well ['+SUSER_NAME()+']:'+CHAR(13)+CHAR(10)+CHAR(13)+CHAR(10)
				SET @lock_msg += 'EXEC SSISDB.EDIS.usp_config_svc_id_perm @svc_id = '''+@ftp_id+''''+CHAR(13)+CHAR(10)
				SET @lock_msg += '	,@usr_id = ''DOMAIN\YOUR_GLOBAL_GROUP OR DATABASE ROLE OR YOUR USER ID'''+CHAR(13)+CHAR(10)
				SET @lock_msg += '	,@action = ''INSERT'''


				RAISERROR(@lock_msg,16,16) WITH NOWAIT

				--DECLARE @access_msg VARCHAR(8000) = 'ID [%s] has been locked by an administrator. Please contact them to obtain access.'
				--RAISERROR(@access_msg,16,16,@ftp_id) WITH NOWAIT
				RETURN 16
			end
    
		select @use_ssl = isnull(@use_ssl,0), @use_passive = isnull(@use_passive,1), @use_ssh = isnull(@use_ssh,0)

		declare @ftp_uid nvarchar(4000), @ftp_pwd nvarchar(4000)

		declare @config xml = EDIS.ifn_get_svc_config(@ftp_id)

		set @ftp_uid = @config.value('(/EDIS_SVC_CONFIG/service_user_id)[1]','nvarchar(250)')
		set @ftp_pwd = @config.value('(/EDIS_SVC_CONFIG/service_password)[1]','nvarchar(250)')

		declare @xml xml = (
			select 
				 @ftp_srvr as ftp_srvr
				,@ftp_id as ftp_id
				,@ftp_dir as ftp_dir
				,@folder_nm as folder_nm
				,@ftp_uid as ftp_uid
				,@ftp_pwd as ftp_pwd
				,@@servername as mssql_inst
				,'ftp_task' as primary_task
				,'create_dir' as sub_task
				,@use_ssh as use_ssh
				,@use_ssl as use_ssl
				,@use_passive as use_passive
				,isnull(@port_nbr,0) as ftp_port_nbr
				,'MDDT_AUTH_CALLER_#x$^71' as caller_auth
			for xml path ('root')

		)
    
		exec EDIS.isp_run_task @xml
    
	END

	GO

	--{INSTALL_STEP}Create Proc usp_ftp_delete_files{/INSTALL_STEP}

	CREATE PROCEDURE EDIS.usp_ftp_delete_files
		 @ftp_id nvarchar(250)
		,@ftp_srvr nvarchar(1000)
		,@ftp_dir nvarchar(4000)
		,@file_crit nvarchar(1000) = ''
		,@file_list_tbl  nvarchar(128) = ''
		,@use_ssh bit = 0
		,@use_ssl bit = 0
		,@use_passive bit = 1
		,@port_nbr int = 0
		WITH ENCRYPTION

	AS
	BEGIN
		SET NOCOUNT ON;
		-- Copyright Notice
		
		IF NOT EXISTS(SELECT 1 FROM EDIS.lkup_service_id where service_id = @ftp_id)
			BEGIN
				RAISERROR('param @ftp_id with value [%s] does not exist. Please see task EDIS.usp_config_ftp_id to create an FTP ID', 16,16,@ftp_id) with nowait;
				return 16;
			END

		if EDIS.fn_check_perm(@ftp_id) = 0
			begin
				DECLARE @lock_msg VARCHAR(MAX) = 
				'Service ID ['+@ftp_id+'] has been locked by an administrator. '+CHAR(13)+CHAR(10)
				SET @lock_msg += 'To use this Service ID, you will need an administrator to run the SQL Command below '
				SET @lock_msg += 'with the @usr_id parameter set as a global group or database role that you are a member of. '+CHAR(13)+CHAR(10)
				SET @lock_msg += 'You can also set the @usr_id parameter as your individual ID as well ['+SUSER_NAME()+']:'+CHAR(13)+CHAR(10)+CHAR(13)+CHAR(10)
				SET @lock_msg += 'EXEC SSISDB.EDIS.usp_config_svc_id_perm @svc_id = '''+@ftp_id+''''+CHAR(13)+CHAR(10)
				SET @lock_msg += '	,@usr_id = ''DOMAIN\YOUR_GLOBAL_GROUP OR DATABASE ROLE OR YOUR USER ID'''+CHAR(13)+CHAR(10)
				SET @lock_msg += '	,@action = ''INSERT'''


				RAISERROR(@lock_msg,16,16) WITH NOWAIT

				--DECLARE @access_msg VARCHAR(8000) = 'ID [%s] has been locked by an administrator. Please contact them to obtain access.'
				--RAISERROR(@access_msg,16,16,@ftp_id) WITH NOWAIT
				RETURN 16
			end

		-- update defaults if shell proc forces them to null
		select @file_crit = isnull(@file_crit,''),@use_ssl = isnull(@use_ssl,0), @use_passive = isnull(@use_passive,1), @use_ssh = isnull(@use_ssh,0)

		declare @ftp_uid nvarchar(4000), @ftp_pwd nvarchar(4000)

		declare @config xml = EDIS.ifn_get_svc_config(@ftp_id)

		set @ftp_uid = @config.value('(/EDIS_SVC_CONFIG/service_user_id)[1]','nvarchar(250)')
		set @ftp_pwd = @config.value('(/EDIS_SVC_CONFIG/service_password)[1]','nvarchar(250)')
    
		declare @file_list_usr nvarchar(max)

		if object_id('tempdb..'+@file_list_tbl) is not null
			begin
				declare @sql_file_list nvarchar(max) = 'select @file_list_usr = isnull(@file_list_usr+'';'','''')+file_nm from '+@file_list_tbl
				exec sp_executesql @sql_file_list, N'@file_list_usr nvarchar(max) out', @file_list_usr = @file_list_usr out
			end

		if @file_list_usr is null set @file_list_usr = ''

		declare @xml xml = (
			select 
				 @ftp_srvr as ftp_srvr
				,@ftp_id as ftp_id
				,@ftp_dir as ftp_dir
				,@file_crit as file_crit
				,@file_list_usr as file_list_usr
				,@ftp_uid as ftp_uid
				,@ftp_pwd as ftp_pwd
				,@@servername as mssql_inst
				,'ftp_task' as primary_task
				,'delete_files' as sub_task
				,@use_ssh as use_ssh
				,@use_ssl as use_ssl
				,@use_passive as use_passive
				,isnull(@port_nbr,0) as ftp_port_nbr
				,'MDDT_AUTH_CALLER_#x$^71' as caller_auth
			for xml path ('root')

		)
   
		exec EDIS.isp_run_task @xml
 

	END
	
	GO

	--{INSTALL_STEP}Create Proc usp_ftp_download_files{/INSTALL_STEP}

	CREATE PROCEDURE EDIS.usp_ftp_download_files
		 @ftp_id nvarchar(250)
		,@ftp_srvr nvarchar(1000)
		,@ftp_dir nvarchar(4000)
		,@local_dir nvarchar(1000)
		,@file_crit nvarchar(1000) = ''
		,@file_list_tbl  nvarchar(128) = ''
		,@use_ssh bit = 0
		,@use_ssl bit = 0
		,@use_passive bit = 1
		,@port_nbr int = 0
		WITH ENCRYPTION
	AS
	BEGIN
		SET NOCOUNT ON;
		-- Copyright Notice

		IF NOT EXISTS(SELECT 1 FROM EDIS.lkup_service_id where service_id = @ftp_id)
			BEGIN
				RAISERROR('param @ftp_id with value [%s] does not exist. Please see task EDIS.usp_config_ftp_id to create an FTP ID', 16,16,@ftp_id) with nowait;
				return 16;
			END

		if EDIS.fn_check_perm(@ftp_id) = 0
			begin
				DECLARE @lock_msg VARCHAR(MAX) = 
				'Service ID ['+@ftp_id+'] has been locked by an administrator. '+CHAR(13)+CHAR(10)
				SET @lock_msg += 'To use this Service ID, you will need an administrator to run the SQL Command below '
				SET @lock_msg += 'with the @usr_id parameter set as a global group or database role that you are a member of. '+CHAR(13)+CHAR(10)
				SET @lock_msg += 'You can also set the @usr_id parameter as your individual ID as well ['+SUSER_NAME()+']:'+CHAR(13)+CHAR(10)+CHAR(13)+CHAR(10)
				SET @lock_msg += 'EXEC SSISDB.EDIS.usp_config_svc_id_perm @svc_id = '''+@ftp_id+''''+CHAR(13)+CHAR(10)
				SET @lock_msg += '	,@usr_id = ''DOMAIN\YOUR_GLOBAL_GROUP OR DATABASE ROLE OR YOUR USER ID'''+CHAR(13)+CHAR(10)
				SET @lock_msg += '	,@action = ''INSERT'''


				RAISERROR(@lock_msg,16,16) WITH NOWAIT
				--DECLARE @access_msg VARCHAR(8000) = 'ID [%s] has been locked by an administrator. Please contact them to obtain access.'
				--RAISERROR(@access_msg,16,16,@ftp_id) WITH NOWAIT
				RETURN 16
			end

		-- update defaults if shell proc forces them to null
		select @file_crit = isnull(@file_crit,''), @use_ssl = isnull(@use_ssl,0), @use_passive = isnull(@use_passive,1), @use_ssh = isnull(@use_ssh,0)

		declare @ftp_uid nvarchar(4000), @ftp_pwd nvarchar(4000)
    
		declare @config xml = EDIS.ifn_get_svc_config(@ftp_id)

		set @ftp_uid = @config.value('(/EDIS_SVC_CONFIG/service_user_id)[1]','nvarchar(250)')
		set @ftp_pwd = @config.value('(/EDIS_SVC_CONFIG/service_password)[1]','nvarchar(250)')

		declare @file_list_usr nvarchar(max)

		if object_id('tempdb..'+@file_list_tbl) is not null
			begin
				declare @sql_file_list nvarchar(max) = 'select @file_list_usr = isnull(@file_list_usr+'';'','''')+file_nm from '+@file_list_tbl
				exec sp_executesql @sql_file_list, N'@file_list_usr nvarchar(max) out', @file_list_usr = @file_list_usr out
			
			end

		if @file_list_usr is null set @file_list_usr = ''

		declare @xml xml = (
			select 
				 @ftp_srvr as ftp_srvr
				,@ftp_id as ftp_id
				,@ftp_dir as ftp_dir
				,@file_crit as file_crit
				,@file_list_usr as file_list_usr
				,@ftp_uid as ftp_uid
				,@ftp_pwd as ftp_pwd
				,@local_dir as local_dir
				,@@servername as mssql_inst
				,'ftp_task' as primary_task
				,'download_files' as sub_task
				,@use_ssh as use_ssh
				,@use_ssl as use_ssl
				,@use_passive as use_passive
				,isnull(@port_nbr,0) as ftp_port_nbr
				,'MDDT_AUTH_CALLER_#x$^71' as caller_auth
			for xml path ('root')

		)

   
		exec EDIS.isp_run_task @xml

	END

	GO

	--{INSTALL_STEP}Create Proc usp_config_ftp_id{/INSTALL_STEP}

	create proc EDIS.usp_config_ftp_id
		 @ftp_id nvarchar(250)
		,@uid nvarchar(4000) = null
		,@pwd nvarchar(4000) = null

		WITH EXECUTE AS OWNER, ENCRYPTION
	as
	begin
		SET NOCOUNT ON;
		-- Copyright Notice

		set nocount on;

		declare @msg varchar(max)
		declare @crlf char(2) = char(13)+char(10);

		open symmetric key [SQLETL_EDIS_SKEY]
			decryption by certificate [SQLETL_EDIS_CERT]

			DECLARE @config varbinary(max) = ENCRYPTBYKEY(KEY_GUID('SQLETL_EDIS_SKEY'),CAST(CAST((SELECT 
						    'FTP_CONN' AS service_type
							,@uid as service_user_id
							,@pwd as service_password
						FOR XML PATH ('EDIS_SVC_CONFIG')
					) AS XML) as Nvarchar(max)))
			;

		close symmetric key [SQLETL_EDIS_SKEY];

		if not exists(select 1 from EDIS.lkup_service_id where upper(service_id) = upper(@ftp_id))
			begin

				INSERT EDIS.lkup_service_id (service_id, last_upd_ts, service_type, service_config)

				SELECT @ftp_id as service_id, getdate() as last_upd_ts
					,'FTP_CONN' as service_type
					,@config

				set @msg = concat('FTP Service ID [',upper(@ftp_id),'] added successfully!')
			end
		else
			begin

				UPDATE EDIS.lkup_service_id
					set service_type = 'FTP_CONN', last_upd_ts = getdate()
					,service_config = @config
				WHERE service_id = @ftp_id

				set @msg = concat('FTP Service ID [',upper(@ftp_id),'] updated successfully!')
			end

		
		print @msg

	end

	GO

	--{INSTALL_STEP}Create Proc usp_config_web_svc_id{/INSTALL_STEP}

	create proc EDIS.usp_config_web_svc_id
		 @svc_id nvarchar(250)
		,@uid nvarchar(4000) = null
		,@pwd nvarchar(4000) = null

		WITH EXECUTE AS OWNER, ENCRYPTION
	as
	begin
		SET NOCOUNT ON;
		-- Copyright Notice

		set nocount on;

		declare @msg varchar(max)
		declare @crlf char(2) = char(13)+char(10);

		open symmetric key [SQLETL_EDIS_SKEY]
			decryption by certificate [SQLETL_EDIS_CERT]

			DECLARE @config varbinary(max) = ENCRYPTBYKEY(KEY_GUID('SQLETL_EDIS_SKEY'),CAST(CAST((SELECT 
						    'WEB_SERVICE' AS service_type
							,@uid as service_user_id
							,@pwd as service_password
						FOR XML PATH ('EDIS_SVC_CONFIG')
					) AS XML) as Nvarchar(max)))
			;

		close symmetric key [SQLETL_EDIS_SKEY];

		if not exists(select 1 from EDIS.lkup_service_id where upper(service_id) = upper(@svc_id))
			begin

				INSERT EDIS.lkup_service_id (service_id, last_upd_ts, service_type, service_config)

				SELECT @svc_id as service_id, getdate() as last_upd_ts
					,'WEB_SERVICE' as service_type
					,@config

				set @msg = concat('Web Service ID [',upper(@svc_id),'] added successfully!')
			end
		else
			begin

				UPDATE EDIS.lkup_service_id
					set service_type = 'WEB_SERVICE', last_upd_ts = getdate()
					,service_config = @config
				WHERE service_id = @svc_id

				set @msg = concat('Web Service ID [',upper(@svc_id),'] updated successfully!')
			end

		
		print @msg

	end

	GO

	--{INSTALL_STEP}Create Proc usp_bigquery_update_svc_id{/INSTALL_STEP}

	CREATE proc EDIS.usp_config_bigquery_id
		 @bq_svc_id nvarchar (250)
		,@project_nm nvarchar(128)
		,@project_id nvarchar(128)
		,@creds_file_path nvarchar(1000)
		WITH EXECUTE AS OWNER, ENCRYPTION
	as
	set nocount on;
	-- Copyright Notice

	-- ---------------------------------------------------------------------------------
	-- grab creds

	if EDIS.ufn_does_file_exist(@creds_file_path) = 0
		BEGIN
			RAISERROR('File [%s] does not exist',16,16,@creds_file_path) with Nowait;
			return 16;
		END


	DECLARE @client_secrets NVARCHAR(MAX) = EDIS.ifn_read_file_to_str(@creds_file_path)

	DECLARE @msg varchar(max)

	-- -----------------------------------------------------------------------------------------
	-- Encrypt/Load

	declare @config xml = 
		(
			select 
				   @project_nm as project_nm
				 , @project_id as project_id
				 , @client_secrets as client_secrets
				for xml path ('EDIS_SVC_CONFIG')
		)

		--print cast(@config as nvarchar(max))

		declare @config_enc varbinary(max)

		open symmetric key [SQLETL_EDIS_SKEY]
			decryption by certificate [SQLETL_EDIS_CERT]
				select @config_enc = ENCRYPTBYKEY(KEY_GUID('SQLETL_EDIS_SKEY'),cast(@config as nvarchar(max)))
		close symmetric key [SQLETL_EDIS_SKEY]
		;

		if exists(select 1 FROM EDIS.lkup_service_id where service_id = @bq_svc_id)
			BEGIN

				UPDATE EDIS.lkup_service_id
					set service_config = @config_enc
						,last_upd_ts = getdate()
						,service_type = 'BIGQUERY_CONN'
				WHERE service_id = @bq_svc_id
				;

				set @msg = concat('BigQuery Service ID [',upper(@bq_svc_id),'] updated successfully!')

			END
		ELSE
			BEGIN

				INSERT EDIS.lkup_service_id (service_id, last_upd_ts, service_type, service_config)
				VALUES (@bq_svc_id, getdate(), 'BIGQUERY_CONN', @config_enc)

				set @msg = concat('BigQuery Service ID [',upper(@bq_svc_id),'] added successfully!')
			END

		print @msg

	GO

	--{INSTALL_STEP}Create Proc usp_ftp_upload_files{/INSTALL_STEP}

	CREATE PROCEDURE EDIS.usp_ftp_upload_files
		 @ftp_id nvarchar(250)
		,@ftp_srvr nvarchar(1000)
		,@ftp_dir nvarchar(4000)
		,@local_dir nvarchar(1000)
		,@file_crit nvarchar(1000) = ''
		,@file_list_tbl  nvarchar(128) = ''
		,@archive_flag bit = 0
		,@archive_folder nvarchar(1000) = 'archive'
		,@use_binary bit = 0
		,@use_ssh bit = 0
		,@use_ssl bit = 0
		,@use_passive bit = 1
		,@port_nbr int = 0
		WITH ENCRYPTION

	AS
	BEGIN
		SET NOCOUNT ON;
		-- Copyright Notice

		IF NOT EXISTS(SELECT 1 FROM EDIS.lkup_service_id where service_id = @ftp_id)
			BEGIN
				RAISERROR('param @ftp_id with value [%s] does not exist. Please see task EDIS.usp_config_ftp_id to create an FTP ID', 16,16,@ftp_id) with nowait;
				return 16;
			END

		if EDIS.fn_check_perm(@ftp_id) = 0
			begin
				DECLARE @lock_msg VARCHAR(MAX) = 
				'Service ID ['+@ftp_id+'] has been locked by an administrator. '+CHAR(13)+CHAR(10)
				SET @lock_msg += 'To use this Service ID, you will need an administrator to run the SQL Command below '
				SET @lock_msg += 'with the @usr_id parameter set as a global group or database role that you are a member of. '+CHAR(13)+CHAR(10)
				SET @lock_msg += 'You can also set the @usr_id parameter as your individual ID as well ['+SUSER_NAME()+']:'+CHAR(13)+CHAR(10)+CHAR(13)+CHAR(10)
				SET @lock_msg += 'EXEC SSISDB.EDIS.usp_config_svc_id_perm @svc_id = '''+@ftp_id+''''+CHAR(13)+CHAR(10)
				SET @lock_msg += '	,@usr_id = ''DOMAIN\YOUR_GLOBAL_GROUP OR DATABASE ROLE OR YOUR USER ID'''+CHAR(13)+CHAR(10)
				SET @lock_msg += '	,@action = ''INSERT'''


				RAISERROR(@lock_msg,16,16) WITH NOWAIT
				--DECLARE @access_msg VARCHAR(8000) = 'ID [%s] has been locked by an administrator. Please contact them to obtain access.'
				--RAISERROR(@access_msg,16,16,@ftp_id) WITH NOWAIT
				RETURN 16
			end

		-- update defaults if shell proc forces them to null
		select @file_crit = isnull(@file_crit,''), @archive_flag = isnull(@archive_flag,0), @archive_folder = isnull(@archive_folder,'archive')
			,@use_binary = isnull(@use_binary,0)
			,@use_ssl = isnull(@use_ssl,0), @use_passive = isnull(@use_passive,1)
			, @use_ssh = isnull(@use_ssh,0)

		declare @ftp_uid nvarchar(4000), @ftp_pwd nvarchar(4000)
	
		declare @config xml = EDIS.ifn_get_svc_config(@ftp_id)

		set @ftp_uid = @config.value('(/EDIS_SVC_CONFIG/service_user_id)[1]','nvarchar(250)')
		set @ftp_pwd = @config.value('(/EDIS_SVC_CONFIG/service_password)[1]','nvarchar(250)')
    
		declare @file_list_usr nvarchar(max)

		if object_id('tempdb..'+@file_list_tbl) is not null
			begin
				declare @sql_file_list nvarchar(max) = 'select @file_list_usr = isnull(@file_list_usr+'';'','''')+file_nm from '+@file_list_tbl
				exec sp_executesql @sql_file_list, N'@file_list_usr nvarchar(max) out', @file_list_usr = @file_list_usr out
			
			end

		if @file_list_usr is null set @file_list_usr = ''

		declare @xml xml = (
			select 
				 @ftp_srvr as ftp_srvr
				,@ftp_id as ftp_id
				,@ftp_dir as ftp_dir
				,@file_crit as file_crit
				,@file_list_usr as file_list_usr
				,@ftp_uid as ftp_uid
				,@ftp_pwd as ftp_pwd
				,@local_dir as local_dir
				,@archive_flag as archive_flag
				,@archive_folder as archive_folder
				,@@servername as mssql_inst
				,@use_binary as use_binary
				,'ftp_task' as primary_task
				,'upload_files' as sub_task
				,@use_ssh as use_ssh
				,@use_ssl as use_ssl
				,@use_passive as use_passive
				,isnull(@port_nbr,0) as ftp_port_nbr
				,'MDDT_AUTH_CALLER_#x$^71' as caller_auth
			for xml path ('root')

		)

		exec EDIS.isp_run_task @xml
  
	END

	GO

	--{INSTALL_STEP}Create Proc usp_get_ftp_file_list{/INSTALL_STEP}

	CREATE PROC EDIS.usp_get_ftp_file_list
		 @ftp_id nvarchar(1000)
		,@ftp_srvr nvarchar(1000)
		,@ftp_dir nvarchar(1000)
		,@file_crit nvarchar(1000) = '*'
		,@tmp_tbl_nm nvarchar(128)
		,@show_details bit = 0
		,@use_ssh bit = 0
		,@use_ssl bit = 0
		,@use_passive bit = 1
		,@port_nbr int = 0

		WITH ENCRYPTION
	AS
	BEGIN
		SET NOCOUNT ON;
		-- Copyright Notice

		IF NOT EXISTS(SELECT 1 FROM EDIS.lkup_service_id where service_id = @ftp_id)
			BEGIN
				RAISERROR('param @ftp_id with value [%s] does not exist. Please see task EDIS.usp_config_ftp_id to create an FTP ID', 16,16,@ftp_id) with nowait;
				return 16;
			END

		if EDIS.fn_check_perm(@ftp_id) = 0
			begin
				DECLARE @lock_msg VARCHAR(MAX) = 
				'Service ID ['+@ftp_id+'] has been locked by an administrator. '+CHAR(13)+CHAR(10)
				SET @lock_msg += 'To use this Service ID, you will need an administrator to run the SQL Command below '
				SET @lock_msg += 'with the @usr_id parameter set as a global group or database role that you are a member of. '+CHAR(13)+CHAR(10)
				SET @lock_msg += 'You can also set the @usr_id parameter as your individual ID as well ['+SUSER_NAME()+']:'+CHAR(13)+CHAR(10)+CHAR(13)+CHAR(10)
				SET @lock_msg += 'EXEC SSISDB.EDIS.usp_config_svc_id_perm @svc_id = '''+@ftp_id+''''+CHAR(13)+CHAR(10)
				SET @lock_msg += '	,@usr_id = ''DOMAIN\YOUR_GLOBAL_GROUP OR DATABASE ROLE OR YOUR USER ID'''+CHAR(13)+CHAR(10)
				SET @lock_msg += '	,@action = ''INSERT'''


				RAISERROR(@lock_msg,16,16) WITH NOWAIT

				--DECLARE @access_msg VARCHAR(8000) = 'ID [%s] has been locked by an administrator. Please contact them to obtain access.'
				--RAISERROR(@access_msg,16,16,@ftp_id) WITH NOWAIT
				RETURN 16
			end

		-- update defaults if shell proc forces them to null
		select @file_crit = isnull(@file_crit,'*'), @show_details = isnull(@show_details,0)
			,@use_ssl = isnull(@use_ssl,0), @use_passive = isnull(@use_passive,1)
			, @use_ssh = isnull(@use_ssh,0)

		declare @err_msg varchar(1000)	

		if not exists(select 1 from SSISDB.EDIS.lkup_service_id where service_id = @ftp_id)

			begin
				set @err_msg = concat(
					'FTP ID [',@ftp_id,'] was not found in reference table SSISDB.EDIS.lkup_service_id.'
					,' Process will not finish'
				)
				raiserror(@err_msg,16,16) with nowait
				return 16
			end 

		if left(@tmp_tbl_nm,2) <> '##'
			begin
				set @err_msg = 'This proc requires a global temp table as the tmp table name'
				raiserror(@err_msg,16,16) with nowait
				return 16
			end

		if object_id('tempdb..'+@tmp_tbl_nm) is not null
			begin
				exec('drop table ['+@tmp_tbl_nm+']')
			end

		if @show_details = 1
			begin
				exec('create table ['+@tmp_tbl_nm+'] 
					(
						file_nm nvarchar(1000)
						,file_size_kb float
						,file_last_mod_ts datetime
					)
				')
			end
		else
			begin
				 exec('create table ['+@tmp_tbl_nm+'] (file_nm nvarchar(1000))')
			end

		declare @ftp_uid nvarchar(4000), @ftp_pwd nvarchar(4000)

		declare @config xml = EDIS.ifn_get_svc_config(@ftp_id)

		set @ftp_uid = @config.value('(/EDIS_SVC_CONFIG/service_user_id)[1]','nvarchar(250)')
		set @ftp_pwd = @config.value('(/EDIS_SVC_CONFIG/service_password)[1]','nvarchar(250)')

		declare @xml xml = (
			select @ftp_srvr as ftp_srvr
				,@ftp_id as ftp_id
				,@ftp_dir as ftp_dir
				,@file_crit as file_crit
				,@ftp_uid as ftp_uid
				,@ftp_pwd as ftp_pwd
				,@show_details as show_details
				,@@servername as mssql_inst
				,@tmp_tbl_nm as tmp_tbl_nm
				,'ftp_task' as primary_task
				,'get_file_list' as sub_task
				,@use_ssh as use_ssh
				,@use_ssl as use_ssl
				,@use_passive as use_passive
				,isnull(@port_nbr,0) as ftp_port_nbr
				,'MDDT_AUTH_CALLER_#x$^71' as caller_auth
			for xml path ('root')

		)

		exec EDIS.isp_run_task @xml
    
	END

	GO

	--{INSTALL_STEP}Create Proc usp_get_loc_file_list{/INSTALL_STEP}

	CREATE PROC EDIS.usp_get_loc_file_list
		 @folder_path nvarchar(1000)
		,@file_crit nvarchar(1000) = '*'
		,@show_details bit = 0
		,@tmp_tbl_nm nvarchar(128)

		WITH ENCRYPTION
	AS
	BEGIN
		SET NOCOUNT ON;
		-- Copyright Notice 
    
		-- update defaults if shell proc forces them to null
		select @file_crit = isnull(@file_crit,'*'), @show_details = isnull(@show_details,0)

		if left(@tmp_tbl_nm,2) <> '##'
			begin
				declare @err_msg varchar(1000) = 'This proc requires a global temp table as the tmp table name'
				raiserror(@err_msg,16,16) with nowait
				return 16
			end
    
		if object_id('tempdb..'+@tmp_tbl_nm) is not null
			begin
				exec('drop table ['+@tmp_tbl_nm+']')
			end

		if @show_details = 1
			begin
				exec('create table ['+@tmp_tbl_nm+'] 
					(
						 file_nm nvarchar(1000)
						,full_nm nvarchar(4000)
						,file_ext nvarchar(250)
						,crt_ts datetime
						,last_axs_ts datetime
						,is_read_only bit
						,file_size_kb float
					)
				')
			end
		else
			begin
				 exec('create table ['+@tmp_tbl_nm+'] (file_nm nvarchar(1000))')
			end
    

    
		declare @xml xml = ( 
			select @folder_path as folder_path, @file_crit as file_crit, @show_details as show_details, @tmp_tbl_nm as tmp_tbl_nm
				,@@SERVERNAME as mssql_inst, 'file_task' as primary_task, 'get_file_list' as sub_task
				,'MDDT_AUTH_CALLER_#x$^71' as caller_auth		
				for xml path('root')
		)
	  
		exec EDIS.isp_run_task @xml
   
	END

	GO

	--{INSTALL_STEP}Create Proc usp_excel_get_sheet_list{/INSTALL_STEP}

	CREATE PROC EDIS.usp_excel_get_sheet_list
		 @file_path nvarchar(1000) 
		,@output_tbl_nm nvarchar(128)
		WITH ENCRYPTION
	AS
	BEGIN
		SET NOCOUNT ON;
		-- Copyright Notice 

		declare @err_msg varchar(1000)
    
		if EDIS.ufn_does_file_exist(@file_path) = 0 
			BEGIN
				set @err_msg = concat('File Path [',@file_path,'] does not exist.')
				RAISERROR(@err_msg, 16,16) with nowait;
				return 16
			END


		if left(@output_tbl_nm,2) <> '##'
			begin
				set @err_msg = 'This proc requires a global temp table for parameter @output_tbl_nm'
				raiserror(@err_msg,16,16) with nowait
				return 16
			end
    
		if object_id('tempdb..'+@output_tbl_nm) is not null exec('drop table ['+@output_tbl_nm+']')
	
		exec('create table ['+@output_tbl_nm+'] (sheet_nm nvarchar(128))')

		declare @xml xml = ( 
			select @file_path as file_path
				, @output_tbl_nm as output_tbl_nm
				,'excel_task' as primary_task
				, 'get_sheet_list' as sub_task
				,'MDDT_AUTH_CALLER_#x$^71' as caller_auth	
			for xml path('root')
		)
	  
		exec EDIS.isp_run_task @xml
   
	END

	GO

	--{INSTALL_STEP}Create Proc usp_excel_add_worksheet{/INSTALL_STEP}

	CREATE PROC EDIS.usp_excel_add_worksheet
		 @file_path nvarchar(1000) 
		,@sheet_nm nvarchar(50)
		WITH ENCRYPTION
	AS
	BEGIN
		SET NOCOUNT ON;
		-- Copyright Notice 

		declare @err_msg varchar(1000)
    
		if EDIS.ufn_does_file_exist(@file_path) = 0 
			BEGIN
				set @err_msg = concat('File Path [',@file_path,'] does not exist.')
				RAISERROR(@err_msg, 16,16) with nowait;
				return 16
			END

		declare @xml xml = ( 
			select @file_path as file_path
				, @sheet_nm as sheet_nm
				,'excel_task' as primary_task
				, 'add_worksheet' as sub_task
				,'MDDT_AUTH_CALLER_#x$^71' as caller_auth	
			for xml path('root')
		)
	  
		exec EDIS.isp_run_task @xml
   
	END

	GO

	--{INSTALL_STEP}Create Proc usp_excel_clear_worksheet{/INSTALL_STEP}

	CREATE PROC EDIS.usp_excel_clear_worksheet
		 @file_path nvarchar(1000) 
		,@sheet_nm nvarchar(50)
		WITH ENCRYPTION
	AS
	BEGIN
		SET NOCOUNT ON;
		-- Copyright Notice 

		declare @err_msg varchar(1000)
    
		if EDIS.ufn_does_file_exist(@file_path) = 0 
			BEGIN
				set @err_msg = concat('File Path [',@file_path,'] does not exist.')
				RAISERROR(@err_msg, 16,16) with nowait;
				return 16
			END

		declare @xml xml = ( 
			select @file_path as file_path
				, @sheet_nm as sheet_nm
				,'excel_task' as primary_task
				, 'clear_worksheet' as sub_task
				,'MDDT_AUTH_CALLER_#x$^71' as caller_auth	
			for xml path('root')
		)
	  
		exec EDIS.isp_run_task @xml
   
	END

	GO

	--{INSTALL_STEP}Create Proc usp_excel_clear_worksheet{/INSTALL_STEP}

	CREATE PROC EDIS.usp_excel_rename_worksheet
		 @file_path nvarchar(1000) 
		,@sheet_nm nvarchar(50)
		,@new_sheet_nm nvarchar(50)
		WITH ENCRYPTION
	AS
	BEGIN
		SET NOCOUNT ON;
		-- Copyright Notice 

		declare @err_msg varchar(1000)
    
		if EDIS.ufn_does_file_exist(@file_path) = 0 
			BEGIN
				set @err_msg = concat('File Path [',@file_path,'] does not exist.')
				RAISERROR(@err_msg, 16,16) with nowait;
				return 16
			END

		declare @xml xml = ( 
			select @file_path as file_path
				, @sheet_nm as sheet_nm
				, @new_sheet_nm as new_sheet_nm
				, 'excel_task' as primary_task
				, 'rename_worksheet' as sub_task
				,'MDDT_AUTH_CALLER_#x$^71' as caller_auth	
			for xml path('root')
		)
	  
		exec EDIS.isp_run_task @xml
   
	END

	GO

	CREATE proc EDIS.usp_excel_import_data

		  @file_path nvarchar(1000)
		 ,@sheet_nm nvarchar(50)
		 ,@include_headers bit = 1
		 ,@dest_tbl_nm nvarchar(1000)
		 ,@crt_dest_tbl bit = 0
		 ,@load_on_ordinal bit = 0
		 --,@src_row_sample_scan_cnt int = 1000
		 ,@import_all_as_text bit = 0
		 ,@batch_size int = 10000
		 ,@header_rows_to_skip int = 0
		 ,@include_row_id bit = 0

	with encryption 
	as
		set nocount on;
		-- Copyright Notice 

		declare @err_msg varchar(1000)
    
		if EDIS.ufn_does_file_exist(@file_path) = 0 
			BEGIN
				set @err_msg = concat('File Path [',@file_path,'] does not exist.')
				RAISERROR(@err_msg, 16,16) with nowait;
				return 16
			END

		-- XLSB....use data transfer:
		IF lower(right(@file_path,4)) = 'xlsb'
			BEGIN
				
				DECLARE @src_qry nvarchar(max) = 'SELECT * FROM ['+@sheet_nm+'$]'

				EXEC SSISDB.EDIS.usp_run_data_transfer
					 @src_sys = 'EXCEL'
					,@dest_sys = @@servername
					,@src_qry = @src_qry
					,@dest_tbl = @dest_tbl_nm
					,@crt_dest_tbl = @crt_dest_tbl
					,@file_path = @file_path
					,@include_headers = @include_headers
					
				;

				RETURN

			END

		-- this is removed as a user param since it was confusing to people
		declare @src_row_sample_scan_cnt int = @batch_size

		declare @tgt_db nvarchar(255)
		declare @tgt_schema nvarchar(255)
		declare @tgt_tbl nvarchar(255)


		-- Are we creating the destination table?
		if isnull(@crt_dest_tbl,0) = 1
			BEGIN

				declare @ph_col varchar(250) = (select concat('####________________________',replace(newid(),'-','_')))

				if left(@dest_tbl_nm,2) = '##'
					begin
						set @tgt_db = 'tempdb'
						set @tgt_schema = 'dbo'
						set @tgt_tbl = @dest_tbl_nm	
						if OBJECT_ID('tempdb..'+@dest_tbl_nm) is not null exec('drop table ['+@dest_tbl_nm+']');
						exec('create table ['+@dest_tbl_nm+'] ('+@ph_col+' bit)')
					end
				else
					begin
						set @tgt_db = parsename(@dest_tbl_nm,3)
						set @tgt_schema = parsename(@dest_tbl_nm,2)
						set @tgt_tbl = parsename(@dest_tbl_nm,1)
						declare @full_path nvarchar(1000) = concat('[',@tgt_db,'].[',@tgt_schema,'].[',@tgt_tbl,']')

						if DB_ID(@tgt_db) is null
							BEGIN
								raiserror('If the destination table is not a temporary table, it must be fully qualified with the database_name.schema.table_name',16,16) with nowait;
								return 16
							END
						if object_id(@full_path) is not null
							BEGIN
								raiserror('Permanent table %s already exists. You can only create permanent tables that don''t already exist.',16,16, @full_path) with nowait;
								return 16
							END
					end
			END
		else
			BEGIN
				-- validate target exists
				set @tgt_db = parsename(@dest_tbl_nm,3)
				set @tgt_schema = parsename(@dest_tbl_nm,2)
				set @tgt_tbl = parsename(@dest_tbl_nm,1)
				declare @full_path1 nvarchar(1000) = concat('[',@tgt_db,'].[',@tgt_schema,'].[',@tgt_tbl,']')

				if object_id(@full_path1) is null
					BEGIN
						raiserror('Permanent table %s does not exist. Please fully qualify the destination table in [DB Name].[Schema Name].[Table Name] format',16,16, @full_path1) with nowait;
						return 16
					END

			END

	

		DECLARE @xml XML = (
			SELECT 
			   
			   @file_path as file_path
			  ,@sheet_nm as sheet_nm
			  ,@tgt_db as tgt_db
			  ,@tgt_schema as tgt_schema
			  ,@tgt_tbl as tgt_tbl
			  ,isnull(@crt_dest_tbl,0) as crt_dest_tbl
			  ,isnull(@load_on_ordinal,0) as load_on_ordinal
			  ,isnull(@include_headers,1) as include_headers
			  ,isnull(@src_row_sample_scan_cnt,1000) as src_row_sample_scan_cnt
			  ,isnull(@import_all_as_text,0) as import_all_as_text
			  ,isnull(@batch_size,10000) as batch_size
			  ,isnull(@header_rows_to_skip,0) as header_rows_to_skip
			  ,isnull(@include_row_id,0) as include_row_id
			  , 'excel_task' as primary_task
			  , 'import_data' as sub_task
			  , 'MDDT_AUTH_CALLER_#x$^71' as caller_auth
			for xml path('root')
		)

		declare @ret_cd int;
		exec @ret_cd = EDIS.isp_run_task @xml


	GO


	--{INSTALL_STEP}Create Proc usp_excel_export_data{/INSTALL_STEP}

	CREATE PROCEDURE EDIS.usp_excel_export_data
		 @file_path nvarchar(1000)
		,@sheet_nm nvarchar(128) = 'Sheet1'
		,@src_qry nvarchar(max)
		,@bold_headers bit = 0
		,@autofit_cols bit = 0
		,@use_autofilter bit = 0
		--,@table_nm nvarchar(128) = ''
		--,@table_style nvarchar(128) = 'TableStyleMedium3'
		,@include_headers bit = 1
		WITH ENCRYPTION
	AS
		SET NOCOUNT ON;
		-- Copyright Notice 

		-- validate source query
		declare @check_err_msg varchar(max) = EDIS.ifn_validate_qry(@src_qry);

		if @check_err_msg is not null
			BEGIN
				raiserror(@check_err_msg, 16,16) with nowait;
				return 16
			END

		declare @err_msg varchar(max)
		declare @crlf char(2) = char(13)+char(10);

		---- Check: Excel 03 does not support tables
		--if isnull(@table_nm,'') <> '' and right(@file_path,4) = '.xls'
		--	BEGIN
		--		set @err_msg = 'Excel 2003 (.xls) does not support table style formats. Please specify .xlsx or .xlsm for your extension to use table styles'
		--		raiserror(@err_msg,16,16) with nowait;
		--		return 16
		--	END

		-- Check if the file format is valid
		declare @ext char(4) = right(@file_path,4)
		if @ext not in ('xlsx','xlsm','.xls')
			BEGIN
				set @err_msg = 'The file extension format [%s] is not supported. Supported file exensions are .xlsx, .xlsm, and .xls'
				raiserror(@err_msg,16,16, @ext) with nowait;
				return 16
			END

		---- Validate the table style
		--if @table_nm <> '' 
		--	BEGIN
		--		if @table_style not in ('TableStyleMedium1','TableStyleMedium2','TableStyleMedium3')
		--			BEGIN
		--				set @err_msg = 'The table style [%s] is not supported. Supported table styles are as follows: '+@crlf
		--				set @err_msg += 'TableStyleMedium1'+@crlf
		--				set @err_msg += 'TableStyleMedium2'+@crlf
		--				set @err_msg += 'TableStyleMedium3'+@crlf
		--				raiserror(@err_msg,16,16,@table_style) with nowait;
		--				return 16
		--			END
		--	END

		declare @xml xml = (
			select 
				  @file_path as file_path
				 ,isnull(@sheet_nm,'Sheet1') as sheet_nm
				 ,@src_qry as src_qry
				 ,isnull(@bold_headers,0) as bold_headers
				 ,isnull(@autofit_cols,1) as autofit_cols
				 ,isnull(@use_autofilter,0) as use_autofilter
				 --,isnull(@table_nm,'') as table_nm
				 --,isnull(@table_style,'TableStyleMedium3') as table_style
				 ,isnull(@include_headers,1) as include_headers
				 ,'excel_task' as primary_task
				 ,'export_data' as sub_task
				 ,'MDDT_AUTH_CALLER_#x$^71' as caller_auth
			for xml path ('root')
		)
				
		declare @exec_id nvarchar(255)
		declare @ret_cd int;
		exec @ret_cd = EDIS.isp_run_task @xml, @exec_id = @exec_id out;

		-- issue warning if no rows were moved
		declare @row_cnt int = (select rows_tsfr from EDIS.etl_audit with (nolock) where exec_id = @exec_id)

		if @row_cnt = 0
			BEGIN
				print '** EDIS WARNING NOTIFICATION ** - > NO ROWS EXPORTED'
			END

		return @ret_cd;

	GO

	--{INSTALL_STEP}Create Proc usp_get_scalar{/INSTALL_STEP}

	CREATE PROC EDIS.usp_get_scalar 
		 @srvr_nm nvarchar(1000)
		,@sql_qry nvarchar(max)
		,@res nvarchar(max) out

		WITH ENCRYPTION
	AS
	BEGIN
		SET NOCOUNT ON;
		-- Copyright Notice

		if EDIS.fn_check_perm(@srvr_nm) = 0
			begin
				DECLARE @lock_msg VARCHAR(MAX) = 
				'Service ID ['+@srvr_nm+'] has been locked by an administrator. '+CHAR(13)+CHAR(10)
				SET @lock_msg += 'To use this Service ID, you will need an administrator to run the SQL Command below '
				SET @lock_msg += 'with the @usr_id parameter set as a global group or database role that you are a member of. '+CHAR(13)+CHAR(10)
				SET @lock_msg += 'You can also set the @usr_id parameter as your individual ID as well ['+SUSER_NAME()+']:'+CHAR(13)+CHAR(10)+CHAR(13)+CHAR(10)
				SET @lock_msg += 'EXEC SSISDB.EDIS.usp_config_svc_id_perm @svc_id = '''+@srvr_nm+''''+CHAR(13)+CHAR(10)
				SET @lock_msg += '	,@usr_id = ''DOMAIN\YOUR_GLOBAL_GROUP OR DATABASE ROLE OR YOUR USER ID'''+CHAR(13)+CHAR(10)
				SET @lock_msg += '	,@action = ''INSERT'''


				RAISERROR(@lock_msg,16,16) WITH NOWAIT
				
				--DECLARE @access_msg VARCHAR(8000) = 'ID [%s] has been locked by an administrator. Please contact them to obtain access.'
				--RAISERROR(@access_msg,16,16,@srvr_nm) WITH NOWAIT
				RETURN 16
			end

		declare @err_msg varchar(8000)

		if len(@sql_qry) > 18000
			begin
				set @err_msg = 'Source Query cannot exceed 18,000 characters. Consider breaking up your source query into smaller chunks'
				raiserror(@err_msg,16,16) with nowait
				return 16
			end
        

		if not exists(select 1 from EDIS.lkup_service_id where service_id = @srvr_nm)
			begin
				set @err_msg = concat('Server name [',@srvr_nm,'] was not found in reference table EDIS.lkup_service_id')
				raiserror(@err_msg,16,16) with nowait
				return 16
			end

		declare @proxy_id nvarchar(255) = '';
		declare @cn_str nvarchar(4000), @cn_provider nvarchar(1000), @cn_sub_provider nvarchar(1000)

		declare @config xml = EDIS.ifn_get_svc_config(@srvr_nm)

		set @cn_str = @config.value('(/EDIS_SVC_CONFIG/cn_str)[1]','nvarchar(4000)')
		set @cn_provider = @config.value('(/EDIS_SVC_CONFIG/server_provider)[1]','nvarchar(250)')
		set @cn_sub_provider = isnull(@config.value('(/EDIS_SVC_CONFIG/server_sub_provider)[1]','nvarchar(250)'),'')
		set @proxy_id = isnull(@config.value('(/EDIS_SVC_CONFIG/proxy_id)[1]','nvarchar(255)'),'')

		IF ISNULL(@proxy_id,'') <> '' --and @proxy_exec_in_progress = 0
			BEGIN

				

				DECLARE @proxy_check_err_msg NVARCHAR(MAX)
				DECLARE @proxy_check_res bit

				--EXEC EDIS.isp_check_proxy_id @proxy_id, @srvr_nm, @res_msg = @proxy_check_err_msg out;

				--if @proxy_check_err_msg <> 'PROXY_VALID' 
				--	BEGIN
				--		raiserror(@proxy_check_err_msg, 16,16) with nowait;
				--		return 16
				--	END

				

				EXEC EDIS.isp_get_sys_info @info_ind = 'CHECK_PROXY'
					,@info_arg_1 = @proxy_id
					,@res_msg = @proxy_check_err_msg OUT
					,@res = @proxy_check_res OUT
				;
		
				IF @proxy_check_res = 0
					BEGIN
						RAISERROR(@proxy_check_err_msg,16,16) WITH NOWAIT
						RETURN 16
					END
				;

			END

		declare @tmp_tbl nvarchar(128) = concat('##',replace(newid(),'-','_'))
		exec('create table ['+@tmp_tbl+'] (res nvarchar(max))') 

		declare @xml xml = (
			select @cn_str as cn_str
				, @srvr_nm as src_sys_nm
				, @cn_provider as cn_provider
				, @cn_sub_provider as cn_sub_provider
				, @sql_qry as sql_qry
				, @tmp_tbl as tmp_tbl_nm
				, 'sql_cmd_task' as primary_task
				, 'get_scalar' as sub_task
				, @@SERVERNAME as mssql_inst
				,'MDDT_AUTH_CALLER_#x$^71' as caller_auth
				,isnull(@proxy_id,'') as proxy_id
			for xml path ('root')
		)
    
		exec EDIS.isp_run_task @xml  

		declare @sql nvarchar(1000) = concat('select @res = res from [',@tmp_tbl,']')

		exec sp_executesql @sql, N'@res nvarchar(max) out', @res = @res out

		exec('drop table ['+@tmp_tbl+']')

	END    

	GO

	--{INSTALL_STEP}Create Proc usp_rename_loc_file{/INSTALL_STEP}

	CREATE PROC EDIS.usp_rename_loc_file
		 @curr_file_path nvarchar(1000)
		,@new_file_path nvarchar(1000)

		WITH ENCRYPTION
	AS
	BEGIN
		SET NOCOUNT ON;
		-- Copyright Notice
    
		declare @xml xml = (
			select 
				 @curr_file_path as curr_file_path
				, @new_file_path as new_file_path, 'file_task' as primary_task
				, 'rename_file' as sub_task
				,'MDDT_AUTH_CALLER_#x$^71' as caller_auth		
			for xml path('root')
		)

	   
		exec EDIS.isp_run_task @xml
    
	END

	GO

	--{INSTALL_STEP}Create Proc usp_move_loc_file{/INSTALL_STEP}

	CREATE PROC EDIS.usp_move_loc_file
		 @src_path nvarchar(1000)
		,@tgt_dir nvarchar(1000)
		,@new_file_nm nvarchar(1000) = ''
		,@force bit = 0
		WITH ENCRYPTION
	AS
	BEGIN
		SET NOCOUNT ON;
		-- Copyright Notice
    
		declare @xml xml = (
			select 
				 @src_path as src_path
				, @tgt_dir as dest_dir
				, isnull(@force,0) as [force]
				, isnull(@new_file_nm,'') as new_file_nm
				, 'file_task' as primary_task
				, 'move_file' as sub_task
				, 'MDDT_AUTH_CALLER_#x$^71' as caller_auth		
			for xml path('root')
		)

	   
		exec EDIS.isp_run_task @xml
    
	END

	GO

	--{INSTALL_STEP}Create Proc usp_copy_loc_file{/INSTALL_STEP}

	CREATE PROC EDIS.usp_copy_loc_file
		 @src_file_path nvarchar(1000)
		,@tgt_folder_path nvarchar(1000)

		WITH ENCRYPTION
	AS
	BEGIN
	
		SET NOCOUNT ON;
		-- Copyright Notice

		declare @xml xml = (
			select 
				  @src_file_path as file_path
				, @tgt_folder_path as folder_path
				, 'file_task' as primary_task
				, 'copy_file' as sub_task
				, 'MDDT_AUTH_CALLER_#x$^71' as caller_auth
			for xml path('root')

		)

		exec EDIS.isp_run_task @xml

	END

	GO

	--{INSTALL_STEP}Create Proc usp_update_loc_file_attribute{/INSTALL_STEP}

	CREATE PROC EDIS.usp_update_loc_file_attribute
		 @file_path nvarchar(1000)
		,@attribute_name nvarchar(1000)

		WITH ENCRYPTION
	AS
	BEGIN
	
		SET NOCOUNT ON;
		-- Copyright Notice

		if lower(@attribute_name) not in ('hidden','readonly')
			BEGIN
				raiserror('This proc currently supports "hidden" and "readonly" as attribute names',16,16) with nowait;
				return 16;
			END

		declare @xml xml = (
			select 
				  @file_path as file_path
				, @attribute_name as attribute_name 
				, 'file_task' as primary_task
				, 'update_file_attribute' as sub_task
				, 'MDDT_AUTH_CALLER_#x$^71' as caller_auth
			for xml path('root')

		)

		exec EDIS.isp_run_task @xml

	END

	GO

	--{INSTALL_STEP}Create Proc usp_run_process_task{/INSTALL_STEP}

	CREATE PROC EDIS.usp_run_process_task
			 @process_nm nvarchar(1000)
			,@args nvarchar(max) = ''
			,@output_tbl_nm nvarchar(250) = ''
		
			WITH ENCRYPTION
		AS
		BEGIN
			SET NOCOUNT ON;
			-- Copyright Notice

			-- Are we doing an output??
			if isnull(@output_tbl_nm,'') <> ''
				BEGIN

					-- Is it a global temp table?
					IF left(@output_tbl_nm,2) = '##'
						BEGIN
							-- If exists, drop it;
							IF object_id('tempdb..'+@output_tbl_nm) IS NOT NULL exec('DROP TABLE '+@output_tbl_nm);

							exec('CREATE TABLE '+@output_tbl_nm+' (output_res varchar(max))')

						END
					ELSE
						BEGIN
							RAISERROR('Only Global Temporary Tables are allowed for the @output_tbl_nm variable e.g. ##myOutputResTbl', 16,16) with nowait;
							RETURN 16;
						END

				END


			declare @xml xml = (
				select @process_nm as process_nm
					,isnull(@args,'') as args
					,isnull(@output_tbl_nm,'') as output_tbl
					, @@SERVERNAME as mssql_inst
					, 'process_task' as primary_task
					, 'MDDT_AUTH_CALLER_#x$^71' as caller_auth
				for xml path('root')

			)

			declare @ret_cd int;
			exec @ret_cd = EDIS.isp_run_task @xml

			return @ret_cd

		END

	GO

	--{INSTALL_STEP}Create Proc usp_run_powershell_script{/INSTALL_STEP}

	CREATE PROC EDIS.usp_run_powershell_script
			 @script nvarchar(max)
			,@output_tbl_nm nvarchar(250) = ''
		
			WITH ENCRYPTION
		AS
		BEGIN
			SET NOCOUNT ON;
			-- Copyright Notice

			-- Are we doing an output??
			if isnull(@output_tbl_nm,'') <> ''
				BEGIN

					-- Is it a global temp table?
					IF left(@output_tbl_nm,2) = '##'
						BEGIN
							-- If exists, drop it;
							IF object_id('tempdb..'+@output_tbl_nm) IS NOT NULL exec('DROP TABLE '+@output_tbl_nm);

							exec('CREATE TABLE '+@output_tbl_nm+' (output_res varchar(max))')

						END
					ELSE
						BEGIN
							RAISERROR('Only Global Temporary Tables are allowed for the @output_tbl_nm variable e.g. ##myOutputResTbl', 16,16) with nowait;
							RETURN 16;
						END

				END


			declare @xml xml = (
				select @script as script
					,isnull(@output_tbl_nm,'') as output_tbl_nm
					, @@SERVERNAME as mssql_inst
					, 'powershell_task' as primary_task
					, 'MDDT_AUTH_CALLER_#x$^71' as caller_auth
				for xml path('root')

			)

			declare @ret_cd int
			exec @ret_cd = EDIS.isp_run_task @xml

			return @ret_cd

		END

	GO

	--{INSTALL_STEP}Create Proc usp_run_data_transfer{/INSTALL_STEP}

	CREATE PROCEDURE EDIS.[usp_run_data_transfer]

		 @src_sys nvarchar(50) = @@servername
		,@dest_sys nvarchar(50) = @@servername
		,@src_qry nvarchar(max) = ''
		,@dest_tbl nvarchar(250) = ''
		,@crt_dest_tbl bit = 0

		--fast load options
		,@batch_size int = 10000
		,@keep_ident bit = 0
		,@keep_nulls bit = 0
		,@is_key_ordered bit = 0

		-- flat file
		,@file_path nvarchar(1000) = ''
		,@append_to_existing_file bit = 0
		,@include_headers bit = 1 
		,@header_rows_to_skip int = 0
		,@data_rows_to_skip int = 0
		,@text_qual nvarchar(100) = null
		,@col_delim nvarchar(100) = N'{Tab}' 
		,@row_term nvarchar(100) = N'{CR}{LF}' 
		,@fixed_width_row_len int = 0
		,@fixed_width_intervals nvarchar(1000) = ''
		,@ragged_right_intervals nvarchar(1000) = ''
		,@is_unicode bit = 0
		,@add_ghost_col bit = 0 
		,@include_row_id_col bit = 0
		,@max_col_width int = 255 -- max is 4k
		,@load_on_ordinal bit = 0
		,@src_pre_sql_cmd nvarchar(max) = ''
		--,@proxy_id nvarchar(255) = ''
		,@use_32_bit_runtime bit = 0

		-- dev
		--,@save_pkg_file_path nvarchar(1000) = null

		WITH ENCRYPTION

	AS
	BEGIN
    
		-- Copyright Notice

		SET NOCOUNT ON;

		DECLARE @err_msg varchar(max)

		DECLARE @save_pkg_file_path nvarchar(1000) = ''

		DECLARE @access_msg VARCHAR(8000)
		declare @crlf char(2) = char(13)+char(10)
		DECLARE @lock_msg VARCHAR(MAX);
		
		if EDIS.fn_check_perm(@src_sys) = 0
			begin
				set @lock_msg =  'Service ID ['+@src_sys+'] has been locked by an administrator. '+CHAR(13)+CHAR(10)
				SET @lock_msg += 'To use this Service ID, you will need an administrator to run the SQL Command below '
				SET @lock_msg += 'with the @usr_id parameter set as a global group or database role that you are a member of. '+CHAR(13)+CHAR(10)
				SET @lock_msg += 'You can also set the @usr_id parameter as your individual ID as well ['+SUSER_NAME()+']:'+CHAR(13)+CHAR(10)+CHAR(13)+CHAR(10)
				SET @lock_msg += 'EXEC SSISDB.EDIS.usp_config_svc_id_perm @svc_id = '''+@src_sys+''''+CHAR(13)+CHAR(10)
				SET @lock_msg += '	,@usr_id = ''DOMAIN\YOUR_GLOBAL_GROUP OR DATABASE ROLE OR YOUR USER ID'''+CHAR(13)+CHAR(10)
				SET @lock_msg += '	,@action = ''INSERT'''


				RAISERROR(@lock_msg,16,16) WITH NOWAIT
				--set @access_msg = 'ID [%s] has been locked by an administrator. Please contact them to obtain access.'
				--RAISERROR(@access_msg,16,16,@src_sys) WITH NOWAIT
				RETURN 16
			end

		if EDIS.fn_check_perm(@dest_sys) = 0
			begin
				set @lock_msg =  'Service ID ['+@dest_sys+'] has been locked by an administrator. '+CHAR(13)+CHAR(10)
				SET @lock_msg += 'To use this Service ID, you will need an administrator to run the SQL Command below '
				SET @lock_msg += 'with the @usr_id parameter set as a global group or database role that you are a member of. '+CHAR(13)+CHAR(10)
				SET @lock_msg += 'You can also set the @usr_id parameter as your individual ID as well ['+SUSER_NAME()+']:'+CHAR(13)+CHAR(10)+CHAR(13)+CHAR(10)
				SET @lock_msg += 'EXEC SSISDB.EDIS.usp_config_svc_id_perm @svc_id = '''+@dest_sys+''''+CHAR(13)+CHAR(10)
				SET @lock_msg += '	,@usr_id = ''DOMAIN\YOUR_GLOBAL_GROUP OR DATABASE ROLE OR YOUR USER ID'''+CHAR(13)+CHAR(10)
				SET @lock_msg += '	,@action = ''INSERT'''


				RAISERROR(@lock_msg,16,16) WITH NOWAIT
				--set @access_msg = 'ID [%s] has been locked by an administrator. Please contact them to obtain access.'
				--RAISERROR(@access_msg,16,16,@dest_sys) WITH NOWAIT
				RETURN 16
			END
        
		-- If the Source is @@servername, check the source query
		if @src_sys = @@servername
			BEGIN
				
				declare @check_err_msg varchar(max) = EDIS.ifn_validate_qry(@src_qry);

				if @check_err_msg is not null
					BEGIN
						raiserror(@check_err_msg, 16,16) with nowait;
						return 16
					END

			END

		-- check source file path
		IF upper(@src_sys) IN ('ACCESS','EXCEL','FLATFILE','RAW') 
			BEGIN
				IF EDIS.ufn_does_file_exist(@file_path) = 0
					BEGIN
						set @err_msg = 'Source file path ['+isnull(@file_path,0)+'] does not exist'
						RAISERROR(@err_msg,16,16) with nowait;
						RETURN 16;
					END
			END
		;

		-- Get Source and dest configurations
		declare @src_config xml 
		declare @dest_config xml;

		if upper(@src_sys) NOT IN ('ACCESS','EXCEL','FLATFILE','RAW')
			BEGIN
				if not exists(select 1 from EDIS.lkup_service_id where service_id = @src_sys)
					begin
						set @err_msg = 'Source server ['+@src_sys+'] was not found in base table SSISDB.EDIS.lkup_service_id'
						raiserror(@err_msg,16,16) with nowait
						return 16
					end

				set @src_config = EDIS.ifn_get_svc_config(@src_sys)
			END

		if upper(@dest_sys) NOT IN ('ACCESS','EXCEL','FLATFILE','RAW')
			BEGIN
				
				if not exists(select 1 from EDIS.lkup_service_id where service_id = @dest_sys)
					begin
						set @err_msg = 'Destination server ['+@dest_sys+'] was not found in base table SSISDB.EDIS.lkup_service_id'
						raiserror(@err_msg,16,16) with nowait
						return 16
					end

				set @dest_config = EDIS.ifn_get_svc_config(@dest_sys)
			END

		-- ==============================================================================================================
		-- If using Proxy, check it:

		declare @proxy_id nvarchar(255) = '';

		DECLARE @src_proxy_id nvarchar(255) = '', @dest_proxy_id nvarchar(255) = '';

		set @src_proxy_id = isnull(@src_config.value('(/EDIS_SVC_CONFIG/proxy_id)[1]','nvarchar(250)'),'')
		set @dest_proxy_id = isnull(@dest_config.value('(/EDIS_SVC_CONFIG/proxy_id)[1]','nvarchar(250)'),'')

		declare @service_id_assc_proxy nvarchar(255)

		-- If we have 2 proxies, throw an error
		if isnull(@src_proxy_id,'') <> '' and isnull(@dest_proxy_id,'') <> ''
			AND @src_proxy_id <> @dest_proxy_id
			BEGIN
				RAISERROR('Source System [%s] and Destination System [%s] both login on behalf of a different windows account. Data Transfers only support logging in under 1 windows ID', 16,16,@src_sys, @dest_sys) with nowait;
				return 16
			END
		else if isnull(@src_proxy_id,'') <> ''
			BEGIN
				set @proxy_id = @src_proxy_id
				set @service_id_assc_proxy = @src_sys
			END
		else if isnull(@dest_proxy_id,'') <> ''
			BEGIN
				set @proxy_id = @dest_proxy_id
				set @service_id_assc_proxy = @dest_sys
			END


		--set @proxy_id = isnull(@src_config.value('(/EDIS_SVC_CONFIG/proxy_id)[1]','nvarchar(250)'),'')

		IF ISNULL(@proxy_id,'') <> '' --and @proxy_exec_in_progress = 0
		BEGIN
			DECLARE @proxy_check_err_msg NVARCHAR(MAX)
			DECLARE @proxy_check_res bit

			--EXEC EDIS.isp_check_proxy_id @proxy_id, @service_id_assc_proxy, @res_msg = @proxy_check_err_msg out;
			----print @proxy_check_err_msg
			--IF @proxy_check_err_msg <> 'PROXY_VALID' 
			--	BEGIN
			--		raiserror(@proxy_check_err_msg, 16,16) with nowait;
			--		return 16
			--	END

			EXEC EDIS.isp_get_sys_info @info_ind = 'CHECK_PROXY'
				,@info_arg_1 = @proxy_id
				,@res_msg = @proxy_check_err_msg OUT
				,@res = @proxy_check_res OUT
			;
		
			IF @proxy_check_res = 0
				BEGIN
					RAISERROR(@proxy_check_err_msg,16,16) WITH NOWAIT
					RETURN 16
				END
			;

		END


		-- ==============================================================================================================
		-- for excel/access, check driver

		DECLARE @AceEngineVersion NVARCHAR(1000)

		IF UPPER(@src_sys) IN ('ACCESS','EXCEL') OR upper(@dest_sys) IN ('ACCESS','EXCEL') 
			BEGIN
				
				-- for MDB/xls, it uses jet
				if upper(right(@file_path,3)) in ('XLS','MDB')
					BEGIN
						set @use_32_bit_runtime = 1
						set @AceEngineVersion = '12' -- this is meaningless..just a placeholder
					END
				ELSE
					BEGIN
						declare @ace_version_composite varchar(250) = EDIS.ifn_get_ms_ace_version();
						IF @ace_version_composite is null
							BEGIN
								Raiserror('In order to connect to MS Access/Excel, the Microsoft ACE Driver needs to be installed',16,16) with nowait;
								return 16;
							END

						set @AceEngineVersion = left(@ace_version_composite,2)

						if right(@ace_version_composite,2) = '32'
							BEGIN
								set @use_32_bit_runtime = 1
							END
						ELSE
							BEGIN
								set @use_32_bit_runtime = 0
							END

					END
				END

		-- Update defaults if users created shell proc that override with nulls
		select 
			 @src_sys = isnull(@src_sys,@@servername)
			,@dest_sys = isnull(@dest_sys,@@servername)
			,@src_qry = isnull(@src_qry,'')
			,@dest_tbl = isnull(@dest_tbl,'')
			,@crt_dest_tbl = isnull(@crt_dest_tbl,0)
			,@batch_size = isnull(@batch_size,10000)
			,@keep_ident = isnull(@keep_ident,0)
			,@keep_nulls = isnull(@keep_nulls,0)
			,@is_key_ordered = isnull(@is_key_ordered,0)
			,@file_path = isnull(@file_path,'')
			,@append_to_existing_file = isnull(@append_to_existing_file,0)
			,@include_headers = isnull(@include_headers,1)
			,@header_rows_to_skip = isnull(@header_rows_to_skip,0)
			,@data_rows_to_skip = isnull(@data_rows_to_skip,0)
			,@col_delim = isnull(@col_delim,N'{Tab}')
			,@row_term = isnull(@row_term,N'{CR}{LF}')
			,@add_ghost_col = isnull(@add_ghost_col,0)
			,@include_row_id_col = isnull(@include_row_id_col,0)
			,@max_col_width = isnull(@max_col_width,255)
			,@load_on_ordinal = isnull(@load_on_ordinal,0)
			,@use_32_bit_runtime = isnull(@use_32_bit_runtime,0)
			--,@save_pkg_file_path = isnull(@save_pkg_file_path,'')
			,@fixed_width_row_len = isnull(@fixed_width_row_len,0)
			,@fixed_width_intervals = isnull(@fixed_width_intervals,'')
			,@ragged_right_intervals = isnull(@ragged_right_intervals,'')

		declare 
			 @src_server_platform			nvarchar(30)
			,@src_server_provider			nvarchar(30)
			,@src_server_sub_provider		nvarchar(30)
			,@src_cn_str					varchar(8000)
			,@dest_server_platform			nvarchar(30)
			,@dest_server_provider			nvarchar(30)
			,@dest_server_sub_provider		nvarchar(30)
			,@dest_cn_str					varchar(8000)
		;

		-- validate target table if destination is the server and not creating on the fly
		if @dest_sys = @@SERVERNAME and @crt_dest_tbl = 0
			begin
				if object_id(@dest_tbl) is null and left(@dest_tbl,2) <> '##'
					begin
						set @err_msg = concat('Note: Destination table ',@dest_tbl,' does not exist. Ensure tables are fully qualified as database_name.schema_name.table_name')
						raiserror(@err_msg,16,16) with nowait
						return 16
					end
			end

		-- get source config params
		if upper(@src_sys) not in ('FLATFILE','EXCEL','ACCESS','RAW')
			begin
				
				set @src_server_platform		= upper(@src_config.value('(/EDIS_SVC_CONFIG/server_platform)[1]','nvarchar(250)'))
				set @src_server_provider		= upper(@src_config.value('(/EDIS_SVC_CONFIG/server_provider)[1]','nvarchar(250)'))
				set @src_server_sub_provider	= upper(@src_config.value('(/EDIS_SVC_CONFIG/server_sub_provider)[1]','nvarchar(250)'))
				set @src_cn_str					= @src_config.value('(/EDIS_SVC_CONFIG/cn_str)[1]','nvarchar(4000)')
			
			end


		else
			begin
				set @src_server_platform = upper(@src_sys)
				if upper(@src_sys) in ('EXCEL','ACCESS') set @src_server_provider = 'OLEDB'
				if upper(@src_sys) in('FLATFILE','RAW') begin
					set @src_server_provider = upper(@src_sys)
					set @src_cn_str = @file_path
				end
			end

		if upper(@dest_sys) not in ('FLATFILE','EXCEL','ACCESS','RAW')
			begin
				
				set @dest_server_platform		= upper(@dest_config.value('(/EDIS_SVC_CONFIG/server_platform)[1]','nvarchar(250)'))
				set @dest_server_provider		= upper(@dest_config.value('(/EDIS_SVC_CONFIG/server_provider)[1]','nvarchar(250)'))
				set @dest_server_sub_provider	= upper(@dest_config.value('(/EDIS_SVC_CONFIG/server_sub_provider)[1]','nvarchar(250)'))
				set @dest_cn_str				= @dest_config.value('(/EDIS_SVC_CONFIG/cn_str)[1]','nvarchar(4000)')
			

			end
		ELSE
			BEGIN
				IF UPPER(@dest_sys) = 'EXCEL'
					BEGIN
						SET @dest_server_platform = 'EXCEL'
						SET @dest_server_provider = 'EXCEL'
					END	
				ELSE IF UPPER(@dest_sys) = 'ACCESS' 
					BEGIN
						SET @dest_server_platform = 'ACCESS'
						set @dest_server_provider = 'OLEDB'
					END
                ELSE IF UPPER(@dest_sys) IN ('RAW','FLATFILE')
					BEGIN
						set @dest_server_provider = upper(@dest_sys)
						SET @dest_cn_str = @file_path
						SET @dest_server_platform = upper(@dest_sys)
					END
			END
			--end

		-- Excel as destionation...if no sheet specified, set to sheet1
		if (upper(@dest_sys) = 'EXCEL' and isnull(@dest_tbl,'') = '') 
			set @dest_tbl = 'Sheet1'
		;

		-- =======================================================================================================================================
		-- create dest temp table?

		declare @ph_col varchar(250) = (select concat('####________________________',replace(newid(),'-','_')))

		-- is the destination a global temp on the server and does not exist yet? if so, set the create destination to true
		if (@dest_sys = @@servername AND left(@dest_tbl,2) = '##' and object_id('tempdb..'+@dest_tbl) is null)
			set @crt_dest_tbl = 1
		;

		declare @dest_tbl_db nvarchar(255)
		if left(@dest_tbl,2) = '##'
			set @dest_tbl_db = 'tempdb'
		else
			set @dest_tbl_db = parsename(@dest_tbl,3)

		declare @db_nm_perm nvarchar(255)

		if @crt_dest_tbl is null set @crt_dest_tbl = 0;

		-- creating the destination table on the host?
		if (@crt_dest_tbl = 1 AND upper(@dest_sys) = upper(@@SERVERNAME))
			
			begin
				---- validate that they are sending the results to this server
				--if upper(@dest_sys) <> upper(@@SERVERNAME)
				--	begin
				--		set @err_msg = 'You cannot generate the destination table unless the destination is this host MS SQL Server ('+@@SERVERNAME+').'
				--		raiserror(@err_msg,16,16) with nowait
				--		return 16
				--	end

				-- Validate that if the table is a perm table (no global), that it does not aleady exist
				if left(@dest_tbl,2) <> '##'
					begin
						
						-- does the object ID already exist?
						if object_id(@dest_tbl) is not null
							
							begin
								set @err_msg = 'Note: Permanent table '+@dest_tbl+' already exists. You can only generate permanent tables if they don''t already exist.';
								raiserror(@err_msg,16,16) with nowait
								return 16
							end

						-- Did they 3 part qualify the object?
						set @db_nm_perm = parsename(@dest_tbl,3)
						declare @schema_nm_perm nvarchar(256) = parsename(@dest_tbl,2)
						declare @tbl_nm_perm nvarchar(256) = parsename(@dest_tbl,1)

						-- did we not get the parts?
						if @db_nm_perm is null or @schema_nm_perm is null or @tbl_nm_perm is null
							begin
								raiserror('Error attempting to create destination permanent table. In order to create a permanent destination table, the table must be 3-part fully qualified i.e. [db_nm].[schema_nm].[table_nm]',16,16) with nowait
								return 16
							end

						if db_id(@db_nm_perm) is null
							begin
								raiserror('Error attempting to create destination permanent table. Database [%s] does not exist on server [%s]',16,16,@db_nm_perm,@@servername) with nowait
								return 16
							end

						-- update to escape the dest tbl
						set @dest_tbl = concat('[',@db_nm_perm,'].[',@schema_nm_perm,'].[',@tbl_nm_perm,']')

					end

				if left(@dest_tbl,2) = '##'
					begin
						if OBJECT_ID('tempdb..'+@dest_tbl) is not null exec('drop table ['+@dest_tbl+']');
						exec('create table ['+@dest_tbl+'] ('+@ph_col+' bit)')
					end
				else
					begin
						exec('create table '+@dest_tbl+' ('+@ph_col+' bit)')
					end

				-- do we want an identity row?
				if @include_row_id_col = 1
					begin
						if left(@dest_tbl,2) = '##'
							begin
								exec('alter table ['+@dest_tbl+'] add row_id int identity(1,1)')
							end
						else
							begin
								exec('alter table '+@dest_tbl+' add row_id int identity(1,1)')
							end
					end

			end

		-- ==============================================================================================
		-- Load in Paramaters to xml stream

		declare @xml xml = 
		(
			select 

				  @src_sys as src_sys_nm
				, @src_qry as src_qry
				, @src_server_provider as src_server_provider
				, @src_server_sub_provider as src_server_sub_provider
				, @src_server_platform as src_platform
				, @src_cn_str as src_cn_str

				, @dest_sys as dest_sys_nm
				, @dest_server_provider as dest_server_provider
				, @dest_server_sub_provider as dest_server_sub_provider
				, @dest_server_platform as dest_platform
				, @dest_cn_str as dest_cn_str


				, @dest_tbl as dest_tbl
				, @batch_size as load_batch_size
				, @crt_dest_tbl as crt_dest_tbl
				, @file_path as file_path
				, @append_to_existing_file as append_to_existing_file
				, @col_delim as col_delim
				, @row_term as row_term
				, @text_qual as text_qual
				, @header_rows_to_skip as header_rows_to_skip
				, @data_rows_to_skip as data_rows_to_skip
				, @include_headers as include_headers
				, @add_ghost_col as include_ghost_col
				, @max_col_width as max_col_width
				, @load_on_ordinal as load_on_ordinal
				, isnull(@fixed_width_row_len,0) as fixed_width_row_len
				, isnull(@fixed_width_intervals,'') as fixed_width_intervals
				, isnull(@ragged_right_intervals,'') as ragged_right_intervals
				, isnull(@is_unicode,0) as is_unicode
				, @is_key_ordered as is_key_ordered
				, @keep_ident as keep_ident
				, @keep_nulls as [keep_nulls]
				, @save_pkg_file_path as pkg_file_path
				, isnull(@include_row_id_col,0) as include_row_id_col
				, @ph_col as col_place_holder
				, @@SERVERNAME as mssql_inst
				, isnull(@src_pre_sql_cmd,'') as src_pre_sql_cmd
				, @use_32_bit_runtime as use_32_bit_runtime
				, ISNULL(@AceEngineVersion,'') AS ace_engine_version
				, @dest_tbl_db as dest_tbl_db
				, 'data_transfer_task' as primary_task
				, 'MDDT_AUTH_CALLER_#x$^71' as caller_auth
				, isnull(@proxy_id,'') as proxy_id
			for xml path('root')

		)

		declare @ret_cd int;
		exec @ret_cd = EDIS.isp_run_task @xml

		return @ret_cd -- usp_run_data_transfer

	END 

	GO

	--{INSTALL_STEP}Create Proc usp_unzip_files{/INSTALL_STEP}

	CREATE PROC EDIS.[usp_unzip_files]
		 @zip_file_path NVARCHAR(1000)
		,@folder_path nvarchar(1000)

		WITH ENCRYPTION
	AS
	BEGIN
		SET NOCOUNT ON;
		-- copyright notice
		
		DECLARE @xml XML = (
			SELECT 
			  @folder_path AS folder_path
			, @zip_file_path AS zip_file_path
			, 'zip_task' as primary_task
			, 'unzip_files' as sub_task
			, 'MDDT_AUTH_CALLER_#x$^71' as caller_auth
			for xml path('root')
		)

		exec EDIS.isp_run_task @xml
    
	END

	GO

	--{INSTALL_STEP}Create Proc usp_zip_files{/INSTALL_STEP}

	CREATE PROC EDIS.[usp_zip_files]
		 @folder_path nvarchar(1000)
		,@zip_file_path NVARCHAR(1000)
		,@include_sub_folders BIT = 1
		,@append_to_existing_file bit = 0

		WITH ENCRYPTION
	AS
	BEGIN
		SET NOCOUNT ON;
		-- copyright notice
        
		DECLARE @xml XML = (
			SELECT 
			  @folder_path AS folder_path
			, @zip_file_path AS zip_file_path
			, isnull(@include_sub_folders,1) AS include_sub_folders
			, isnull(@append_to_existing_file,0) as append_to_existing_file
			, 'zip_task' as primary_task
			, 'zip_files' as sub_task
			, 'MDDT_AUTH_CALLER_#x$^71' as caller_auth
			for xml path('root')
		)

		exec EDIS.isp_run_task @xml
   
	END

	GO

	--{INSTALL_STEP}Create Proc usp_flatfile_export_data{/INSTALL_STEP}

	CREATE PROC EDIS.usp_flatfile_export_data
		 @src_svc_id varchar(50) = @@servername
		,@file_path varchar(1000)
		,@src_qry nvarchar(max)
		,@include_headers bit = 1
		,@col_delim nvarchar(30) = '{TAB}'
		,@row_term nvarchar(30) = '{CR}{LF}'
		,@text_qual nvarchar(10) = ''
		,@append_to_existing_file bit = 0
		--,@encoding nvarchar(30) = 'default'
		WITH ENCRYPTION
	AS
		SET NOCOUNT ON;
		-- copyright notice

		-- short hand data transfer
		EXEC SSISDB.EDIS.usp_run_data_transfer
			 @src_sys = @src_svc_id
			,@dest_sys = 'FLATFILE'
			,@file_path = @file_path
			,@src_qry = @src_qry
			,@include_headers = @include_headers
			,@col_delim = @col_delim
			,@row_term = @row_term
			,@text_qual = @text_qual
			,@append_to_existing_file = @append_to_existing_file
		;

		--declare @crlf char(2) = char(13)+char(10);

		---- validate server id
		--if not exists(select 1 from EDIS.lkup_service_id where service_id = @src_svc_id)
		--	BEGIN
		--		RAISERROR('Parameter @src_svc_id with value [%s] does not exist. Please see procedure EDIS.usp_config_db_conn to create a server connection.',16,16,@src_svc_id) with nowait;
		--		return 16
		--	END
		--;

		--if EDIS.fn_check_perm(@src_svc_id) = 0
		--	begin
		--		RAISERROR('ID [%s] has been locked by an administrator. Please contact them to obtain access.',16,16,@src_svc_id) WITH NOWAIT
		--		RETURN 16
		--	end
		--;

		------ ---------------------------------------------------------------------------------
		------ Encoding
		----if @encoding is not null 
		----	begin
		----		if lower(@encoding) <> 'default' 
		----			begin
		----				if lower(@encoding) not in ('utf7','utf8','utf32','unicode','bigendianunicode','ascii')
		----					BEGIN
		----						declare @encoding_err_msg varchar(max) = concat(
		----							'Parameter @encoding has invalid value. Valid values are:',@crlf
		----							,'utf7',@crlf
		----							,'utf8',@crlf
		----							,'utf32',@crlf
		----							,'unicode',@crlf
		----							,'bigendianunicode',@crlf
		----							,'ascii',@crlf
		----							,'default',@crlf
		----						)
		----						;
		----						raiserror(@encoding_err_msg,16,16) with nowait; 
		----						return 16
		----					END
		----			end

		----	end
			
		--Declare @svc_config xml = SSISDB.EDIS.ifn_get_svc_config(@src_svc_id);

		--Declare @src_platform nvarchar(255) = upper(@svc_config.value('(/EDIS_SVC_CONFIG/server_platform)[1]','nvarchar(250)'))
		--declare @src_server_provider nvarchar(255) = upper(@svc_config.value('(/EDIS_SVC_CONFIG/server_provider)[1]','nvarchar(250)'))
		--DECLARE @src_server_sub_provider nvarchar(255)	= upper(@svc_config.value('(/EDIS_SVC_CONFIG/server_sub_provider)[1]','nvarchar(250)'))
		--DECLARE @cn_str	nvarchar(4000) = @svc_config.value('(/EDIS_SVC_CONFIG/cn_str)[1]','nvarchar(4000)')
			
		--DECLARE @provider nvarchar(255)
		--if @src_server_provider = 'ado.net'
		--	set @provider = @src_server_sub_provider
		--else
		--	set @provider = @src_server_provider
		--;

		---- Switch for host Server to use MSSQL NC
		--if @src_svc_id = @@servername
		--	BEGIN
		--		set @cn_str = 'Server = '+@@servername+'; Integrated Security = True';
		--		set @provider = 'mssql'
		--	END

		--DECLARE @xml XML = (
		--	SELECT 
		--		 isnull(@src_svc_id,@@servername) as server_id
		--		,@cn_str as cn_str
		--		,@provider as src_provider
		--		,@file_path as file_path
		--		,@src_qry as src_qry
		--		,isnull(@include_headers,1) as include_headers
		--		,isnull(@col_delim ,'{TAB}') as col_delim
		--		,isnull(@row_term,'{CR}{LF}') as row_term
		--		,isnull(@text_qual,'') as text_qual
		--		,isnull(@append_to_existing_file,0) as append_to_existing_file
		--		,isnull(@encoding,'default') as encoding_str

		--		, 'flatfile_task' as primary_task
		--		, 'export_data' as sub_task
		--		, 'MDDT_AUTH_CALLER_#x$^71' as caller_auth
		--	for xml path('root')
		--)

		--exec EDIS.isp_run_task @xml

	GO


	--{INSTALL_STEP}Create Proc usp_run_web_request{/INSTALL_STEP}

	CREATE PROC EDIS.[usp_run_web_request]
		 @url nvarchar(4000)
		,@output_tbl_nm nvarchar(250) = ''
		,@encoding varchar(100) = 'utf16'
		,@content_type varchar(250) = ''
		,@accept varchar(250) = ''
		,@timeout int = 0
        ,@svc_id nvarchar(250) = ''
		,@header_tmp_tbl nvarchar(250) = '' 
		,@token_auth_url nvarchar(4000) = ''
		,@tls_version varchar(5) = ''
		,@method varchar(250) = 'GET'
		,@proxy_svc_id nvarchar(250) = ''
		,@proxy_url nvarchar(4000) = ''
		,@proxy_port int = -1
		,@res nvarchar(max) = null out
		WITH ENCRYPTION
	AS
	BEGIN
		SET NOCOUNT ON;
		-- copyright notice


		declare @was_tls_specified bit = 0;
		if isnull(@tls_version,'') <> ''
			set @was_tls_specified = 1

		-- TLS Version check: if user supplied value
		if @was_tls_specified = 1 
			BEGIN
				if ltrim(rtrim(@tls_version)) not in ('1.1','1.2')
					BEGIN
						RAISERROR('TLS Version values supported are 1.1 and 1.2. To use the default TLS version, do not specify this parameter',16,16) with nowait;
						return 16
					END
			END



		-- Is it a global temp table?
		declare @was_tbl_specified bit = 0
		if isnull(@output_tbl_nm,'') <> ''
			set @was_tbl_specified = 1
		;


		-- the output table is now optional...if no output table is specified, we will create a generic gtt, load the results, kick it to the output var, and drop it
		if @was_tbl_specified = 0
			BEGIN
				declare @gtt nvarchar(250) = concat('##',replace(newid(),'-','_'))
				exec('CREATE TABLE '+@gtt+' (output_res varchar(max))')
				set @output_tbl_nm = @gtt;
			END
		ELSE
			BEGIN
				IF left(@output_tbl_nm,2) <> '##'
					BEGIN
						declare @crlf char(2) = char(13)+char(10);
						
						declare @err_msg varchar(max) = concat(
							 'Parameter @output_tbl_nm only accepts global temporary tables i.e. ##myOutputTbl.',@crlf
							,'Note: The @output_tbl_nm parameter is optional. The results of the web request will also output to variable @res', @crlf
							,'To capture the results in the output variable, use this template:',@crlf,@crlf
							,'---------------',@crlf
							,'DECLARE @web_call_res NVARCHAR(MAX);',@crlf
							,'EXEC SSISDB.EDIS.usp_run_web_request @url = ''http://www.YOUR_WEBSERVICE.COM'', @res = @web_call_res OUT',@crlf
							,'PRINT @web_call_res'
						)

						RAISERROR(@err_msg, 16,16) with nowait;
						RETURN 16;
					END
				ELSE
					BEGIN
						IF object_id('tempdb..'+@output_tbl_nm) IS NOT NULL exec('DROP TABLE '+@output_tbl_nm);
						exec('CREATE TABLE '+@output_tbl_nm+' (output_res varchar(max))')
					END

				
			END

		-- is the headers temp table a temp table??
		IF left(@header_tmp_tbl,1) <> '#' and isnull(len(@header_tmp_tbl),0) > 0
			begin
				RAISERROR('Headers require a temp table to supply the values e.g. #myHeaders or ##headers_list', 16,16) with nowait;
				RETURN 16;
			end

		declare @headers as EDIS.web_request_headers

		-- Assume the first two columns in the headers temp table are the header name and value and load them
		IF object_id('tempdb..'+@header_tmp_tbl) IS NOT NULL
			BEGIN
				declare @cols varchar(500)
				select @cols = isnull(@cols+', ','')+'['+c.name+']'
				from tempdb.sys.columns as c
				where c.object_id = object_id('tempdb..'+@header_tmp_tbl)
					and column_id between 1 and 2
				order by column_id
				declare @sql varchar(max) = concat('SELECT ',@cols,' FROM [',@header_tmp_tbl,']')

				insert @headers
				exec(@sql)
			END

        DECLARE @svc_uid nvarchar(1000) = '', @svc_pwd nvarchar(1000) = '';

		if isnull(@svc_id,'') <> ''
			BEGIN
				declare @config xml = EDIS.ifn_get_svc_config(@svc_id);

				set @svc_uid = @config.value('(/EDIS_SVC_CONFIG/service_user_id)[1]','nvarchar(250)')
				set @svc_pwd = @config.value('(/EDIS_SVC_CONFIG/service_password)[1]','nvarchar(250)')
			END

		DECLARE @proxy_svc_uid nvarchar(1000) = '', @proxy_svc_pwd nvarchar(1000) = '';

		if isnull(@proxy_svc_id,'') <> ''
			BEGIN
				declare @config1 xml = EDIS.ifn_get_svc_config(@proxy_svc_id);

				set @proxy_svc_uid = @config1.value('(/EDIS_SVC_CONFIG/service_user_id)[1]','nvarchar(250)')
				set @proxy_svc_pwd = @config1.value('(/EDIS_SVC_CONFIG/service_password)[1]','nvarchar(250)')
			END
        
		DECLARE @xml XML = (
			SELECT 
			  @url as [url]
			, isnull(@token_auth_url,'') as token_auth_url
			, @output_tbl_nm as output_tbl_nm
			, isnull(@encoding,'utf16') as [encoding]
			, isnull(@timeout,0) as [timeout]
			, isnull(@svc_id,'') as svc_id
            , isnull(@svc_uid,'') as svc_uid
			, isnull(@svc_pwd,'') as svc_pwd
			, isnull(@method,'GET') as method
			, isnull(@tls_version,'') as tls_version
			--, (SELECT * FROM @headers FOR XML PATH('header_arg'), type) AS web_request_header
			, @@servername as mssql_inst
			, 'web_task' as primary_task
			, 'web_req' as sub_task
			, 'MDDT_AUTH_CALLER_#x$^71' as caller_auth
			, isnull(@proxy_svc_uid,'') as proxy_svc_uid
			, isnull(@proxy_svc_pwd,'') as proxy_svc_pwd
			, isnull(@proxy_url,'') as proxy_url
			, isnull(@proxy_port,-1) as proxy_port
			, isnull(@accept,'') as accept
			, isnull(@content_type,'') as content_type
			for xml path('root')
		)

		-- Add Headers if applicable
		if EXISTS(SELECT * FROM @headers)
			BEGIN
				declare @curr_header_nm nvarchar(255), @curr_header_val nvarchar(4000);

				declare cs cursor local fast_forward for select header_name , header_val from @headers
				open cs
				fetch next from cs into @curr_header_nm, @curr_header_val
				while @@FETCH_STATUS = 0
					BEGIN
						declare @header_combo nvarchar(max) = concat(@curr_header_nm,'{|~}', @curr_header_val)

						set @xml.modify('insert <web_request_header>{sql:variable("@header_combo")}</web_request_header> into (/root)[1]')
						fetch next from cs into @curr_header_nm, @curr_header_val
					END
				close cs
				deallocate cs
			END
		;

		declare @ret_cd int;
		exec @ret_cd = EDIS.isp_run_task @xml

		if @ret_cd <> 0
			return @ret_cd

		-- Output to res var
		declare @sql2 nvarchar(max) = N'SET @res = (select * from ['+@output_tbl_nm+'])'
		declare @params nvarchar(50) = N'@res nvarchar(max) out'
		exec sp_executesql @sql2, @params, @res = @res out;
		
		-- if no table was specified, we used a staging table...kill it
		if @was_tbl_specified = 0
			BEGIN
				exec('drop table ['+@output_tbl_nm+']');
			END
		
		return @ret_cd -- usp_run_web_request
   
	END

	GO

	--{INSTALL_STEP}Create Proc usp_run_soap_request{/INSTALL_STEP}

	CREATE PROC EDIS.[usp_run_soap_request]
		 @svc_id nvarchar(250) = ''
		,@url nvarchar(4000)
		,@soap_envelope nvarchar(max)
		,@timeout int = 0
		,@output_tbl_nm nvarchar(250)
		,@encoding varchar(100) = 'utf16'
		,@content_type nvarchar(250) = 'text/xml;charset=UTF-16'
		WITH ENCRYPTION
	AS
	BEGIN
		SET NOCOUNT ON;
		-- copyright notice


		-- Is it a global temp table?
		IF left(@output_tbl_nm,2) = '##'
			BEGIN
				-- If exists, drop it;
				IF object_id('tempdb..'+@output_tbl_nm) IS NOT NULL exec('DROP TABLE '+@output_tbl_nm);

				exec('CREATE TABLE '+@output_tbl_nm+' (output_res varchar(max))')

			END
		ELSE
			BEGIN
				RAISERROR('Only Global Temporary Tables are allowed for the @output_tbl_nm variable e.g. ##myOutputResTbl', 16,16) with nowait;
				RETURN 16;
			END
        
		DECLARE @svc_uid nvarchar(1000) = '', @svc_pwd nvarchar(1000) = '';

		if isnull(@svc_id,'') <> ''
			BEGIN
				
				declare @config xml = EDIS.ifn_get_svc_config(@svc_id);

				set @svc_uid = @config.value('(/EDIS_SVC_CONFIG/service_user_id)[1]','nvarchar(250)')
				set @svc_pwd = @config.value('(/EDIS_SVC_CONFIG/service_password)[1]','nvarchar(250)')

			END


		DECLARE @xml XML = (
			SELECT 
			 @url as [url]
			, @output_tbl_nm as output_tbl_nm
			, isnull(@encoding,'utf16') as [encoding]
			, @@servername as mssql_inst
			, isnull(@timeout,0) as [timeout]
			, isnull(@svc_id,'') as svc_id
			, isnull(@svc_uid,'') as svc_uid
			, isnull(@svc_pwd,'') as svc_pwd
			, @soap_envelope as soap_envelope
			, isnull(@content_type,'text/xml;charset=UTF-16') as content_type
			, 'web_task' as primary_task
			, 'soap_req' as sub_task
			, 'MDDT_AUTH_CALLER_#x$^71' as caller_auth
			for xml path('root')
		)

		exec EDIS.isp_run_task @xml
   
	END

	GO

	CREATE proc edis.usp_config_sharepoint_id
		 @svc_id nvarchar(250)
		,@user_id nvarchar(1000)
		,@password nvarchar(1000)
		,@is_sharepoint_online bit

		with encryption
	as
		set nocount on;

		declare @config xml = 
		(
			select @user_id as 'user_id'
				,@password as 'password'
				,@is_sharepoint_online as is_sharepoint_online
				for xml path ('EDIS_SVC_CONFIG')
		)

		--print cast(@config as nvarchar(max))

		declare @config_enc varbinary(max)

		open symmetric key [SQLETL_EDIS_SKEY]
			decryption by certificate [SQLETL_EDIS_CERT]
				select @config_enc = ENCRYPTBYKEY(KEY_GUID('SQLETL_EDIS_SKEY'),cast(@config as nvarchar(max)))
		close symmetric key [SQLETL_EDIS_SKEY]
		;


		if exists(select 1 from EDIS.lkup_service_id where service_id = @svc_id)
			BEGIN
				Update edis.lkup_service_id
					set service_config = @config_enc, last_upd_ts = getdate(), service_type = 'SHAREPOINT_CONN'
				where service_id = @svc_id

				Print 'SharePoint Service ID Updated!'
			END
		ELSE
			BEGIN
				INSERT edis.lkup_service_id (service_id, last_upd_ts, service_type, service_config)
				values (@svc_id, getdate(), 'SHAREPOINT_CONN', @config_enc)

				Print 'SharePoint Service ID Added!'
			END
	
	GO

	--{INSTALL_STEP}Create Proc usp_sharepoint_list_read{/INSTALL_STEP}

	CREATE PROC EDIS.[usp_sharepoint_list_read]
		  @url nvarchar(4000)
		 ,@svc_id nvarchar(250) 
		 ,@list_nm nvarchar(250)
		 ,@output_tbl_nm nvarchar(250)
		 ,@show_hidden_fields bit = 0
		-- ,@batch_size int = 20

		WITH ENCRYPTION
	AS
	BEGIN
		SET NOCOUNT ON;
		-- copyright notice

		-- Is it a global temp table?
		IF left(@output_tbl_nm,2) = '##'
			BEGIN
				-- If exists, drop it;
				IF object_id('tempdb..'+@output_tbl_nm) IS NOT NULL exec('DROP TABLE '+@output_tbl_nm);

				exec('CREATE TABLE '+@output_tbl_nm+' (output_res varchar(max))')

			END
		ELSE
			BEGIN
				RAISERROR('Only Global Temporary Tables are allowed for the @output_tbl_nm variable e.g. ##myOutputResTbl', 16,16) with nowait;
				RETURN 16;
			END
            
        DECLARE @svc_uid nvarchar(1000) = '', @svc_pwd nvarchar(1000) = '';
		declare @is_sharepoint_online bit;

		declare @svc_config xml = EDIS.ifn_get_svc_config(@svc_id)

		set @svc_uid = @svc_config.value('(/EDIS_SVC_CONFIG/user_id)[1]','nvarchar(250)')
		set @svc_pwd = @svc_config.value('(/EDIS_SVC_CONFIG/password)[1]','nvarchar(250)')
		set @is_sharepoint_online = @svc_config.value('(/EDIS_SVC_CONFIG/is_sharepoint_online)[1]','bit')
        
		DECLARE @xml XML = (
			SELECT 
			  @url as sharepoint_url
			, @list_nm as sharepoint_list_nm
			, @output_tbl_nm as output_tbl_nm
			, iif(isnull(@is_sharepoint_online,0) = 1,'online','onprem') as sharepoint_version
            , isnull(@svc_uid,'') as svc_uid
			, isnull(@svc_pwd,'') as svc_pwd
			, @svc_id as svc_id
			, isnull(@show_hidden_fields,0) as show_hidden_fields
			--, isnull(@batch_size,20) as batch_size
			, 'sharepoint_task' as primary_task
			, 'read_sharepoint_list' as sub_task
			, 'MDDT_AUTH_CALLER_#x$^71' as caller_auth
			for xml path('root')
		)

		declare @ret_cd int
		exec @ret_cd = EDIS.isp_run_task @xml
   
	END

	GO

	CREATE PROC EDIS.[usp_sharepoint_get_list_collection]
		  @url nvarchar(4000)
		 ,@svc_id nvarchar(250) 
		 ,@output_tbl_nm nvarchar(250)

		WITH ENCRYPTION
	AS
	BEGIN
		SET NOCOUNT ON;
		-- copyright notice

		-- Is it a global temp table?
		IF left(@output_tbl_nm,2) = '##'
			BEGIN
				-- If exists, drop it;
				IF object_id('tempdb..'+@output_tbl_nm) IS NOT NULL exec('DROP TABLE '+@output_tbl_nm);

				exec('CREATE TABLE '+@output_tbl_nm+' (list_nm varchar(max))')

			END
		ELSE
			BEGIN
				RAISERROR('Only Global Temporary Tables are allowed for the @output_tbl_nm variable e.g. ##myOutputResTbl', 16,16) with nowait;
				RETURN 16;
			END
            
        DECLARE @svc_uid nvarchar(1000) = '', @svc_pwd nvarchar(1000) = '';
		declare @is_sharepoint_online bit;

		declare @svc_config xml = EDIS.ifn_get_svc_config(@svc_id)

		set @svc_uid = @svc_config.value('(/EDIS_SVC_CONFIG/user_id)[1]','nvarchar(250)')
		set @svc_pwd = @svc_config.value('(/EDIS_SVC_CONFIG/password)[1]','nvarchar(250)')
		set @is_sharepoint_online = @svc_config.value('(/EDIS_SVC_CONFIG/is_sharepoint_online)[1]','bit')
        
		DECLARE @xml XML = (
			SELECT 
			  @url as sharepoint_url
			, @output_tbl_nm as output_tbl_nm
			, iif(isnull(@is_sharepoint_online,0) = 1,'online','onprem') as sharepoint_version
            , isnull(@svc_uid,'') as svc_uid
			, isnull(@svc_pwd,'') as svc_pwd
			, @svc_id as svc_id
			, 'sharepoint_task' as primary_task
			, 'get_sharepoint_list_coll' as sub_task
			, 'MDDT_AUTH_CALLER_#x$^71' as caller_auth
			for xml path('root')
		)

		exec EDIS.isp_run_task @xml
   
	END

	GO

	--{INSTALL_STEP}Create Proc usp_sharepoint_list_get_metadata{/INSTALL_STEP}

	CREATE PROC EDIS.[usp_sharepoint_list_get_metadata]
		  @url nvarchar(4000)
		 ,@svc_id nvarchar(250) 
		 ,@list_nm nvarchar(250)
		 ,@output_tbl_nm nvarchar(250)

		WITH ENCRYPTION
	AS
	BEGIN
		SET NOCOUNT ON;
		-- copyright notice

		-- Is it a global temp table?
		IF left(@output_tbl_nm,2) = '##'
			BEGIN
				-- If exists, drop it;
				IF object_id('tempdb..'+@output_tbl_nm) IS NOT NULL exec('DROP TABLE '+@output_tbl_nm);

				exec(
					'
						CREATE TABLE '+@output_tbl_nm+' 
						(
							  display_name varchar(250), internal_name varchar(250), data_type varchar(250), is_hidden bit, default_value varchar(4000), is_required bit
							, field_description varchar(4000)
							, field_formula varchar(4000)
							, field_class_type varchar(30)
							, validation_formula varchar(4000)
							, validation_message varchar(4000)
						)
					'
				)

			END
		ELSE
			BEGIN
				RAISERROR('Only Global Temporary Tables are allowed for the @output_tbl_nm variable e.g. ##myOutputResTbl', 16,16) with nowait;
				RETURN 16;
			END
            
        DECLARE @svc_uid nvarchar(1000) = '', @svc_pwd nvarchar(1000) = '';
		declare @is_sharepoint_online bit;

		declare @svc_config xml = EDIS.ifn_get_svc_config(@svc_id)

		set @svc_uid = @svc_config.value('(/EDIS_SVC_CONFIG/user_id)[1]','nvarchar(250)')
		set @svc_pwd = @svc_config.value('(/EDIS_SVC_CONFIG/password)[1]','nvarchar(250)')
		set @is_sharepoint_online = @svc_config.value('(/EDIS_SVC_CONFIG/is_sharepoint_online)[1]','bit')
        
		DECLARE @xml XML = (
			SELECT 
			  @url as sharepoint_url
			, @list_nm as sharepoint_list_nm
			, @output_tbl_nm as output_tbl_nm
			, iif(isnull(@is_sharepoint_online,0) = 1,'online','onprem') as sharepoint_version
            , isnull(@svc_uid,'') as svc_uid
			, isnull(@svc_pwd,'') as svc_pwd
			, @svc_id as svc_id
			, 'sharepoint_task' as primary_task
			, 'get_sharepoint_list_metadata' as sub_task
			, 'MDDT_AUTH_CALLER_#x$^71' as caller_auth
			for xml path('root')
		)

		exec EDIS.isp_run_task @xml
   
	END

	GO

	--{INSTALL_STEP}Create Proc usp_sharepoint_library_upload_files{/INSTALL_STEP}

	CREATE PROC EDIS.[usp_sharepoint_library_upload_files]
		  @url nvarchar(4000)
		 ,@svc_id nvarchar(250) 
		 ,@doc_lib_nm nvarchar(250)
		 ,@doc_lib_sub_folder nvarchar(1000) = ''
		 ,@file_crit nvarchar(250) = '*'
		 ,@local_folder_path nvarchar(1000)

		WITH ENCRYPTION
	AS
	BEGIN
		SET NOCOUNT ON;
		-- copyright notice

            
        DECLARE @svc_uid nvarchar(1000) = '', @svc_pwd nvarchar(1000) = '';
		declare @is_sharepoint_online bit;

		declare @svc_config xml = EDIS.ifn_get_svc_config(@svc_id)

		set @svc_uid = @svc_config.value('(/EDIS_SVC_CONFIG/user_id)[1]','nvarchar(250)')
		set @svc_pwd = @svc_config.value('(/EDIS_SVC_CONFIG/password)[1]','nvarchar(250)')
		set @is_sharepoint_online = @svc_config.value('(/EDIS_SVC_CONFIG/is_sharepoint_online)[1]','bit')
        
		DECLARE @xml XML = (
			SELECT 
			  @url as sharepoint_url
			, @doc_lib_nm as sharepoint_doc_lib_nm
			, isnull(@doc_lib_sub_folder,'') as sharepoint_doc_lib_sub_folder
			, @local_folder_path as local_folder_path
			, ISNULL(@file_crit,'*') as file_crit
			, iif(isnull(@is_sharepoint_online,0) = 1,'online','onprem') as sharepoint_version
            , isnull(@svc_uid,'') as svc_uid
			, isnull(@svc_pwd,'') as svc_pwd
			, @svc_id as svc_id
			, 'sharepoint_task' as primary_task
			, 'upload_files_to_sharepoint' as sub_task
			, 'MDDT_AUTH_CALLER_#x$^71' as caller_auth
			for xml path('root')
		)

		exec EDIS.isp_run_task @xml
   
	END

	GO

	--{INSTALL_STEP}Create Proc usp_sharepoint_library_download_files{/INSTALL_STEP}

	CREATE PROC EDIS.[usp_sharepoint_library_download_files]
		  @url nvarchar(4000)
		 ,@svc_id nvarchar(250) 
		 ,@doc_lib_nm nvarchar(250)
		 ,@doc_lib_sub_folder nvarchar(1000) = ''
		 ,@file_crit nvarchar(250) = '*'
		 ,@local_folder_path nvarchar(1000)

		WITH ENCRYPTION
	AS
	BEGIN
		SET NOCOUNT ON;
		-- copyright notice

            
        DECLARE @svc_uid nvarchar(1000) = '', @svc_pwd nvarchar(1000) = '';
		declare @is_sharepoint_online bit;

		declare @svc_config xml = EDIS.ifn_get_svc_config(@svc_id)

		set @svc_uid = @svc_config.value('(/EDIS_SVC_CONFIG/user_id)[1]','nvarchar(250)')
		set @svc_pwd = @svc_config.value('(/EDIS_SVC_CONFIG/password)[1]','nvarchar(250)')
		set @is_sharepoint_online = @svc_config.value('(/EDIS_SVC_CONFIG/is_sharepoint_online)[1]','bit')
        
		DECLARE @xml XML = (
			SELECT 
			  @url as sharepoint_url
			, @doc_lib_nm as sharepoint_doc_lib_nm
			, isnull(@doc_lib_sub_folder,'') as sharepoint_doc_lib_sub_folder
			, @local_folder_path as local_folder_path
			, ISNULL(@file_crit,'*') as file_crit
			, iif(isnull(@is_sharepoint_online,0) = 1,'online','onprem') as sharepoint_version
            , isnull(@svc_uid,'') as svc_uid
			, isnull(@svc_pwd,'') as svc_pwd
			, @svc_id as svc_id
			, 'sharepoint_task' as primary_task
			, 'download_files_from_sharepoint' as sub_task
			, 'MDDT_AUTH_CALLER_#x$^71' as caller_auth
			for xml path('root')
		)

		exec EDIS.isp_run_task @xml
   
	END

	GO

	--{INSTALL_STEP}Create Proc usp_sharepoint_library_get_file_list{/INSTALL_STEP}

	CREATE PROC EDIS.[usp_sharepoint_library_get_file_list]
		  @url nvarchar(4000)
		 ,@svc_id nvarchar(250) 
		 ,@doc_lib_nm nvarchar(250)
		 ,@file_crit nvarchar(250) = '*'
		 ,@output_tbl_nm nvarchar(250)

		WITH ENCRYPTION
	AS
	BEGIN
		SET NOCOUNT ON;
		-- copyright notice

		-- Is it a global temp table?
		IF left(@output_tbl_nm,2) = '##'
			BEGIN
				-- If exists, drop it;
				IF object_id('tempdb..'+@output_tbl_nm) IS NOT NULL exec('DROP TABLE '+@output_tbl_nm);

				exec(
					'
						CREATE TABLE '+@output_tbl_nm+' (file_nm nvarchar(4000), file_path nvarchar(4000), file_size_kb bigint, crt_ts datetime2, last_mod_ts datetime2)
					'
				)

			END
		ELSE
			BEGIN
				RAISERROR('Only Global Temporary Tables are allowed for the @output_tbl_nm variable e.g. ##myOutputResTbl', 16,16) with nowait;
				RETURN 16;
			END
            
         DECLARE @svc_uid nvarchar(1000) = '', @svc_pwd nvarchar(1000) = '';
		declare @is_sharepoint_online bit;

		declare @svc_config xml = EDIS.ifn_get_svc_config(@svc_id)

		set @svc_uid = @svc_config.value('(/EDIS_SVC_CONFIG/user_id)[1]','nvarchar(250)')
		set @svc_pwd = @svc_config.value('(/EDIS_SVC_CONFIG/password)[1]','nvarchar(250)')
		set @is_sharepoint_online = @svc_config.value('(/EDIS_SVC_CONFIG/is_sharepoint_online)[1]','bit')
        
		DECLARE @xml XML = (
			SELECT 
			  @url as sharepoint_url
			, @doc_lib_nm as sharepoint_doc_lib_nm
			, @output_tbl_nm as output_tbl_nm
			, ISNULL(@file_crit,'*') as file_crit
			, iif(isnull(@is_sharepoint_online,0) = 1,'online','onprem') as sharepoint_version
            , isnull(@svc_uid,'') as svc_uid
			, isnull(@svc_pwd,'') as svc_pwd
			, @svc_id as svc_id
			, 'sharepoint_task' as primary_task
			, 'get_sharepoint_doc_lib_file_list' as sub_task
			, 'MDDT_AUTH_CALLER_#x$^71' as caller_auth
			for xml path('root')
		)

		exec EDIS.isp_run_task @xml
   
	END

	GO

	--{INSTALL_STEP}Create Proc usp_sharepoint_list_write{/INSTALL_STEP}

	CREATE PROC EDIS.[usp_sharepoint_list_write]
		  @url nvarchar(4000)
		 ,@svc_id nvarchar(250) 
		 ,@list_nm nvarchar(250)
		 ,@src_qry nvarchar(max)
		 ,@batch_size int = 20

		WITH ENCRYPTION
	AS
	BEGIN
		SET NOCOUNT ON;
		-- copyright notice
            
        DECLARE @svc_uid nvarchar(1000) = '', @svc_pwd nvarchar(1000) = '';
		declare @is_sharepoint_online bit;

		declare @svc_config xml = EDIS.ifn_get_svc_config(@svc_id)

		set @svc_uid = @svc_config.value('(/EDIS_SVC_CONFIG/user_id)[1]','nvarchar(250)')
		set @svc_pwd = @svc_config.value('(/EDIS_SVC_CONFIG/password)[1]','nvarchar(250)')
		set @is_sharepoint_online = @svc_config.value('(/EDIS_SVC_CONFIG/is_sharepoint_online)[1]','bit')
        
		DECLARE @xml XML = (
			SELECT 
			  @url as sharepoint_url
			, @list_nm as sharepoint_list_nm
			, @src_qry as src_qry
			, isnull(@batch_size,20) as batch_size
			, iif(isnull(@is_sharepoint_online,0) = 1,'online','onprem') as sharepoint_version
            , isnull(@svc_uid,'') as svc_uid
			, isnull(@svc_pwd,'') as svc_pwd
			, @svc_id as svc_id
			, 'sharepoint_task' as primary_task
			, 'write_to_sharepoint_list' as sub_task
			, 'MDDT_AUTH_CALLER_#x$^71' as caller_auth
			for xml path('root')
		)

		exec EDIS.isp_run_task @xml
   
	END

	GO

	--{INSTALL_STEP}Create Proc usp_sharepoint_list_purge{/INSTALL_STEP}

	CREATE PROC EDIS.[usp_sharepoint_list_purge]
		  @url nvarchar(4000)
		 ,@svc_id nvarchar(250) 
		 ,@list_nm nvarchar(250)
		 ,@batch_size int = 20

		WITH ENCRYPTION
	AS
	BEGIN
		SET NOCOUNT ON;
		-- copyright notice
            
         DECLARE @svc_uid nvarchar(1000) = '', @svc_pwd nvarchar(1000) = '';
		declare @is_sharepoint_online bit;

		declare @svc_config xml = EDIS.ifn_get_svc_config(@svc_id)

		set @svc_uid = @svc_config.value('(/EDIS_SVC_CONFIG/user_id)[1]','nvarchar(250)')
		set @svc_pwd = @svc_config.value('(/EDIS_SVC_CONFIG/password)[1]','nvarchar(250)')
		set @is_sharepoint_online = @svc_config.value('(/EDIS_SVC_CONFIG/is_sharepoint_online)[1]','bit')
        
		DECLARE @xml XML = (
			SELECT 
			  @url as sharepoint_url
			, @list_nm as sharepoint_list_nm
			, isnull(@batch_size,20) as batch_size
			, iif(isnull(@is_sharepoint_online,0) = 1,'online','onprem') as sharepoint_version
            , isnull(@svc_uid,'') as svc_uid
			, isnull(@svc_pwd,'') as svc_pwd
			, @svc_id as svc_id
			, 'sharepoint_task' as primary_task
			, 'purge_sharepoint_list' as sub_task
			, 'MDDT_AUTH_CALLER_#x$^71' as caller_auth
			for xml path('root')
		)

		exec EDIS.isp_run_task @xml
   
	END

	GO

	--{INSTALL_STEP}Create Proc usp_bigquery_import_data{/INSTALL_STEP}

	CREATE proc EDIS.usp_bigquery_import_data

	 @bq_svc_id nvarchar(250)
	,@dest_svc_id nvarchar(255) = @@servername
	,@src_qry nvarchar(max)
	,@dest_tbl_nm nvarchar(1000)
	,@crt_dest_tbl bit = 0
	,@load_on_ordinal bit = 0
	,@max_col_width int = 255
	,@bq_fetch_size int = 1000
	,@batch_size int = 10000

	with encryption 
	as
		set nocount on;
		-- copyright notice

		if @dest_svc_id is null set @dest_svc_id = @@servername

		IF NOT EXISTS(SELECT 1 FROM EDIS.lkup_service_id WHERE service_id = @bq_svc_id)
			BEGIN
				RAISERROR('BigQuery Service ID [%s] was not found. Please check that you are referencing the correct service ID',16,16,@bq_svc_id) with NOWAIT;
				RETURN 16;
			END

		if EDIS.fn_check_perm(@bq_svc_id) = 0
			begin
				DECLARE @lock_msg VARCHAR(MAX) = 
				'Service ID ['+@bq_svc_id+'] has been locked by an administrator. '+CHAR(13)+CHAR(10)
				SET @lock_msg += 'To use this Service ID, you will need an administrator to run the SQL Command below '
				SET @lock_msg += 'with the @usr_id parameter set as a global group or database role that you are a member of. '+CHAR(13)+CHAR(10)
				SET @lock_msg += 'You can also set the @usr_id parameter as your individual ID as well ['+SUSER_NAME()+']:'+CHAR(13)+CHAR(10)+CHAR(13)+CHAR(10)
				SET @lock_msg += 'EXEC SSISDB.EDIS.usp_config_svc_id_perm @svc_id = '''+@bq_svc_id+''''+CHAR(13)+CHAR(10)
				SET @lock_msg += '	,@usr_id = ''DOMAIN\YOUR_GLOBAL_GROUP OR DATABASE ROLE OR YOUR USER ID'''+CHAR(13)+CHAR(10)
				SET @lock_msg += '	,@action = ''INSERT'''


				RAISERROR(@lock_msg,16,16) WITH NOWAIT
				--RAISERROR('BigQuery Service ID [%s] has been locked by an administrator. Please contact them to obtain access.',16,16,@bq_svc_id) WITH NOWAIT
				RETURN 16
			end

		declare @tgt_db nvarchar(255)
		declare @tgt_schema nvarchar(255)
		declare @tgt_tbl nvarchar(255)

	
		if not EXISTS(SELECT * FROM SSISDB.EDIS.lkup_service_id where service_id = @dest_svc_id)
			BEGIN
				RAISERROR('Destination Service ID [%s] does not exist', 16,16,@dest_svc_id) with nowait;
				return 16
			END

		declare @dest_cn_str nvarchar(4000), @dest_platform nvarchar(255)

		declare @dest_config xml = EDIS.ifn_get_svc_config(@dest_svc_id)

		set @dest_cn_str = @dest_config.value('(/EDIS_SVC_CONFIG/cn_str)[1]','nvarchar(4000)')
		set @dest_platform = @dest_config.value('(/EDIS_SVC_CONFIG/server_platform)[1]','nvarchar(255)')

		if @dest_platform <> 'MSSQL'
			BEGIN
				RAISERROR('BigQuery Import task currently only supports Microsoft SQL Server destinations',16,16) with nowait;
			END


		declare @proxy_id nvarchar(255) = '';

		set @proxy_id = isnull(@dest_config.value('(/EDIS_SVC_CONFIG/proxy_id)[1]','nvarchar(250)'),'')

		IF ISNULL(@proxy_id,'') <> '' --and @proxy_exec_in_progress = 0
		BEGIN
			DECLARE @proxy_check_err_msg NVARCHAR(MAX)
			DECLARE @proxy_check_res bit

			
			--EXEC EDIS.isp_check_proxy_id @proxy_id, @dest_svc_id, @res_msg = @proxy_check_err_msg out;

			--IF @proxy_check_err_msg <> 'PROXY_VALID' 
			--	BEGIN
			--		raiserror(@proxy_check_err_msg, 16,16) with nowait;
			--		return 16
			--	END


			EXEC EDIS.isp_get_sys_info @info_ind = 'CHECK_PROXY'
				,@info_arg_1 = @proxy_id
				,@res_msg = @proxy_check_err_msg OUT
				,@res = @proxy_check_res OUT
			;
		
			IF @proxy_check_res = 0
				BEGIN
					RAISERROR(@proxy_check_err_msg,16,16) WITH NOWAIT
					RETURN 16
				END
			;

		END


		-- Are we creating the destination table? (only validate if the target is the host)
		if isnull(@crt_dest_tbl,0) = 1 and @dest_svc_id = @@servername
			BEGIN

				declare @ph_col varchar(250) = (select concat('####________________________',replace(newid(),'-','_')))

				if left(@dest_tbl_nm,2) = '##' 
					begin
						set @tgt_db = 'tempdb'
						set @tgt_schema = 'dbo'
						set @tgt_tbl = @dest_tbl_nm	
						if OBJECT_ID('tempdb..'+@dest_tbl_nm) is not null exec('drop table ['+@dest_tbl_nm+']');
						exec('create table ['+@dest_tbl_nm+'] ('+@ph_col+' bit)')
					end
				else
					begin
						set @tgt_db = parsename(@dest_tbl_nm,3)
						set @tgt_schema = parsename(@dest_tbl_nm,2)
						set @tgt_tbl = parsename(@dest_tbl_nm,1)
						declare @full_path nvarchar(1000) = concat('[',@tgt_db,'].[',@tgt_schema,'].[',@tgt_tbl,']')

						if DB_ID(@tgt_db) is null
							BEGIN
								raiserror('If the destination table is not a temporary table, it must be fully qualified with the database_name.schema.table_name',16,16) with nowait;
								return 16
							END
						if object_id(@full_path) is not null
							BEGIN
								raiserror('Permanent table %s already exists. You can only create permanent tables that don''t already exist.',16,16, @full_path) with nowait;
								return 16
							END
						--exec('create table '+@dest_tbl_nm+' ('+@ph_col+' bit)')
					end
			END
		
		ELSE
			BEGIN
				-- validate target exists
				set @tgt_db = parsename(@dest_tbl_nm,3)
				set @tgt_schema = parsename(@dest_tbl_nm,2)
				set @tgt_tbl = parsename(@dest_tbl_nm,1)
				declare @full_path1 nvarchar(1000) = concat('[',@tgt_db,'].[',@tgt_schema,'].[',@tgt_tbl,']')

				-- validate target if Host SQL Server
				if object_id(@full_path1) is null and @dest_svc_id = @@servername
					BEGIN
						raiserror('Permanent table %s does not exist. Please fully qualify the destination table in [DB Name].[Schema Name].[Table Name] format',16,16, @full_path1) with nowait;
						return 16
					END

			END

		
		declare @project_nm nvarchar(250)
		declare @project_id nvarchar(250)
		declare @client_secrets nvarchar(max)

		declare @svc_config xml = EDIS.ifn_get_svc_config(@bq_svc_id)

		set @project_nm = @svc_config.value('(/EDIS_SVC_CONFIG/project_nm)[1]','nvarchar(250)')
		set @project_id = @svc_config.value('(/EDIS_SVC_CONFIG/project_nm)[1]','nvarchar(250)')
		set @client_secrets = @svc_config.value('(/EDIS_SVC_CONFIG/client_secrets)[1]','nvarchar(max)')

		DECLARE @xml XML = (
			SELECT 
			   @bq_svc_id as bq_svc_id
			  ,@project_nm as project_nm
			  ,@project_id as project_id
			  ,@client_secrets as client_secrets
			  ,isnull(@bq_fetch_size,1000) as bq_fetch_size
			  ,isnull(@batch_size,10000) as batch_size
			  ,isnull(@crt_dest_tbl,0) as crt_dest_tbl
			  ,isnull(@load_on_ordinal,0) as load_on_ordinal
			  ,@src_qry as src_qry
			  ,@tgt_db as tgt_db
			  ,@tgt_schema as tgt_schema
			  ,@tgt_tbl as tgt_tbl
			  ,@dest_cn_str as dest_cn_str
			  ,isnull(@proxy_id,'') as proxy_id
			  ,isnull(@max_col_width,255) as max_col_width
			  , 'bigquery_task' as primary_task
			  , 'import_data' as sub_task
			  , 'MDDT_AUTH_CALLER_#x$^71' as caller_auth
			for xml path('root')
		)

		exec EDIS.isp_run_task @xml


	GO

	--{INSTALL_STEP}Create Proc usp_bigquery_export_data{/INSTALL_STEP}

	create proc EDIS.usp_bigquery_export_data
		 @bq_svc_id nvarchar(255)
		,@src_svc_id nvarchar(255) = @@servername
		,@src_qry nvarchar(max)
		,@dataset_nm nvarchar(1000)
		,@dest_tbl_nm nvarchar(1000)
		--,@crt_dest_tbl bit = 0
		,@truncate_existing bit = 0
		,@drop_existing bit = 0
		--,@overwrite_existing bit = 0
		,@merge_dest_tbl bit = 0
		,@dest_tbl_key_cols nvarchar(max) = ''
		,@work_dir nvarchar(1000)
		with encryption
	as
	BEGIN

		set nocount on;
		-- copyright notice

		IF NOT EXISTS(SELECT 1 FROM EDIS.lkup_service_id WHERE service_id = @bq_svc_id)
			BEGIN
				RAISERROR('BigQuery Service ID [%s] was not found. Please check that you are referencing the correct service ID',16,16,@bq_svc_id) with NOWAIT;
				RETURN 16;
			END

		if EDIS.fn_check_perm(@bq_svc_id) = 0
			begin
				DECLARE @lock_msg VARCHAR(MAX) = 
				'Service ID ['+@bq_svc_id+'] has been locked by an administrator. '+CHAR(13)+CHAR(10)
				SET @lock_msg += 'To use this Service ID, you will need an administrator to run the SQL Command below '
				SET @lock_msg += 'with the @usr_id parameter set as a global group or database role that you are a member of. '+CHAR(13)+CHAR(10)
				SET @lock_msg += 'You can also set the @usr_id parameter as your individual ID as well ['+SUSER_NAME()+']:'+CHAR(13)+CHAR(10)+CHAR(13)+CHAR(10)
				SET @lock_msg += 'EXEC SSISDB.EDIS.usp_config_svc_id_perm @svc_id = '''+@bq_svc_id+''''+CHAR(13)+CHAR(10)
				SET @lock_msg += '	,@usr_id = ''DOMAIN\YOUR_GLOBAL_GROUP OR DATABASE ROLE OR YOUR USER ID'''+CHAR(13)+CHAR(10)
				SET @lock_msg += '	,@action = ''INSERT'''


				RAISERROR(@lock_msg,16,16) WITH NOWAIT
				--RAISERROR('BigQuery Service ID [%s] has been locked by an administrator. Please contact them to obtain access.',16,16,@bq_svc_id) WITH NOWAIT
				RETURN 16
			end

		DECLARE @src_platform varchar(250), @src_cn_provider varchar(250), @src_cn_sub_provider varchar(250), @src_cn_str varchar(4000);

		-- validate source query syntax if host server
		if @src_svc_id = @@servername
			BEGIN

				declare @check_err_msg varchar(max) = EDIS.ifn_validate_qry(@src_qry);

				IF @check_err_msg is not null
					BEGIN
						raiserror(@check_err_msg, 16,16) with nowait;
						return 16
					END

			END
		
		declare @proxy_id nvarchar(255);



		-- get connection info
		IF NOT EXISTS(SELECT 1 FROM SSISDB.EDIS.lkup_service_id where service_id = @src_svc_id)
			BEGIN
				declare @missing_src_err_msg varchar(max) = 'Source system ['+@src_svc_id+'] does not exist';
				raiserror(@missing_src_err_msg, 16,16) with nowait;
				return 16
			END
		ELSE
			BEGIN
				declare @src_svc_config xml = EDIS.ifn_get_svc_config(@src_svc_id)

				set @src_cn_provider = upper(@src_svc_config.value('(/EDIS_SVC_CONFIG/server_provider)[1]','nvarchar(250)'))
				set @src_cn_sub_provider = upper(@src_svc_config.value('(/EDIS_SVC_CONFIG/server_sub_provider)[1]','nvarchar(250)'))
				set @src_platform = upper(@src_svc_config.value('(/EDIS_SVC_CONFIG/server_platform)[1]','nvarchar(250)'))
				set @src_cn_str = @src_svc_config.value('(/EDIS_SVC_CONFIG/cn_str)[1]','nvarchar(4000)')

				set @proxy_id = isnull(@src_svc_config.value('(/EDIS_SVC_CONFIG/proxy_id)[1]','nvarchar(250)'),'')

				IF ISNULL(@proxy_id,'') <> '' 
					BEGIN
						DECLARE @proxy_check_err_msg NVARCHAR(MAX)
						DECLARE @proxy_check_res bit

						
						--EXEC EDIS.isp_check_proxy_id @proxy_id, @src_svc_id, @res_msg = @proxy_check_err_msg out;

						--if @proxy_check_err_msg <> 'PROXY_VALID' 
						--	BEGIN
						--		raiserror(@proxy_check_err_msg, 16,16) with nowait;
						--		return 16
						--	END


						EXEC EDIS.isp_get_sys_info @info_ind = 'CHECK_PROXY'
							,@info_arg_1 = @proxy_id
							,@res_msg = @proxy_check_err_msg OUT
							,@res = @proxy_check_res OUT
						;
		
						IF @proxy_check_res = 0
							BEGIN
								RAISERROR(@proxy_check_err_msg,16,16) WITH NOWAIT
								RETURN 16
							END
						;

					END

			END



		declare @project_nm nvarchar(250)
		declare @project_id nvarchar(250)
		declare @client_secrets nvarchar(max)

		declare @bq_svc_config xml = EDIS.ifn_get_svc_config(@bq_svc_id)

		set @project_nm = @bq_svc_config.value('(/EDIS_SVC_CONFIG/project_nm)[1]','nvarchar(250)')
		set @project_id = @bq_svc_config.value('(/EDIS_SVC_CONFIG/project_nm)[1]','nvarchar(250)')
		set @client_secrets = @bq_svc_config.value('(/EDIS_SVC_CONFIG/client_secrets)[1]','nvarchar(max)')

		DECLARE @xml XML = (
			SELECT 
			   @bq_svc_id as bq_svc_id
			  ,@project_nm as project_nm
			  ,@project_id as project_id
			  ,@client_secrets as client_secrets
			  --,isnull(@crt_dest_tbl,0) as crt_dest_tbl
			  ,isnull(@truncate_existing,0) as truncate_existing
			  ,isnull(@drop_existing,0) as drop_existing
			 -- ,isnull(@overwrite_existing,0) as overwrite_existing
			  ,isnull(@merge_dest_tbl,0) as merge_dest_tbl
			  ,isnull(@dest_tbl_key_cols,'') as dest_tbl_key_cols 
			  ,@src_qry as src_qry
			  ,@dataset_nm as dataset_nm
			  ,@dest_tbl_nm as dest_tbl_nm
			  ,@work_dir as work_dir
			  ,@src_svc_id as src_sys_nm
			  ,@src_platform as src_platform
			  ,@src_cn_provider as src_cn_provider
			  ,@src_cn_sub_provider as src_cn_sub_provider
			  ,@src_cn_str as src_cn_str
			  ,isnull(@proxy_id,'') as proxy_id
			  , 'bigquery_task' as primary_task
			  , 'export_data' as sub_task
			  , 'MDDT_AUTH_CALLER_#x$^71' as caller_auth
			for xml path('root')
		)

		exec EDIS.isp_run_task @xml
	END

	GO

	--{INSTALL_STEP}Create Proc usp_bigquery_crt_tbl_from_qry{/INSTALL_STEP}

	create proc EDIS.usp_bigquery_crt_tbl_from_qry
		 @bq_svc_id nvarchar(255)
		,@src_qry nvarchar(max)
		,@dataset_nm nvarchar(1000)
		,@dest_tbl_nm nvarchar(1000)
		,@drop_existing bit = 0
		with encryption
	as
	BEGIN

		set nocount on;
		-- copyright notice

		IF NOT EXISTS(SELECT 1 FROM EDIS.lkup_service_id WHERE service_id = @bq_svc_id)
			BEGIN
				RAISERROR('BigQuery Service ID [%s] was not found. Please check that you are referencing the correct service ID',16,16,@bq_svc_id) with NOWAIT;
				RETURN 16;
			END

		if EDIS.fn_check_perm(@bq_svc_id) = 0
			begin

				DECLARE @lock_msg VARCHAR(MAX) = 
				'Service ID ['+@bq_svc_id+'] has been locked by an administrator. '+CHAR(13)+CHAR(10)
				SET @lock_msg += 'To use this Service ID, you will need an administrator to run the SQL Command below '
				SET @lock_msg += 'with the @usr_id parameter set as a global group or database role that you are a member of. '+CHAR(13)+CHAR(10)
				SET @lock_msg += 'You can also set the @usr_id parameter as your individual ID as well ['+SUSER_NAME()+']:'+CHAR(13)+CHAR(10)+CHAR(13)+CHAR(10)
				SET @lock_msg += 'EXEC SSISDB.EDIS.usp_config_svc_id_perm @svc_id = '''+@bq_svc_id+''''+CHAR(13)+CHAR(10)
				SET @lock_msg += '	,@usr_id = ''DOMAIN\YOUR_GLOBAL_GROUP OR DATABASE ROLE OR YOUR USER ID'''+CHAR(13)+CHAR(10)
				SET @lock_msg += '	,@action = ''INSERT'''


				RAISERROR(@lock_msg,16,16) WITH NOWAIT
				--RAISERROR('BigQuery Service ID [%s] has been locked by an administrator. Please contact them to obtain access.',16,16,@bq_svc_id) WITH NOWAIT
				RETURN 16
			end

		declare @project_nm nvarchar(250)
		declare @project_id nvarchar(250)
		declare @client_secrets nvarchar(max)

		declare @svc_config xml = EDIS.ifn_get_svc_config(@bq_svc_id)

		set @project_nm = @svc_config.value('(/EDIS_SVC_CONFIG/project_nm)[1]','nvarchar(250)')
		set @project_id = @svc_config.value('(/EDIS_SVC_CONFIG/project_nm)[1]','nvarchar(250)')
		set @client_secrets = @svc_config.value('(/EDIS_SVC_CONFIG/client_secrets)[1]','nvarchar(max)')

		DECLARE @xml XML = (
			SELECT 
			   @bq_svc_id as bq_svc_id
			  ,@project_nm as project_nm
			  ,@project_id as project_id
			  ,@client_secrets as client_secrets
			  ,isnull(@drop_existing,0) as drop_existing
			  ,@src_qry as src_qry
			  ,@dataset_nm as dataset_nm
			  ,@dest_tbl_nm as dest_tbl_nm
			  , 'bigquery_task' as primary_task
			  , 'crt_tbl_from_qry' as sub_task
			  , 'MDDT_AUTH_CALLER_#x$^71' as caller_auth
			for xml path('root')
		)

		exec EDIS.isp_run_task @xml
	END

	GO

	--{INSTALL_STEP}Create Proc usp_bigquery_crt_tbl_from_qry{/INSTALL_STEP}

	create proc EDIS.usp_bigquery_append_data
		 @bq_svc_id nvarchar(255)
		,@src_qry nvarchar(max)
		,@dataset_nm nvarchar(1000)
		,@dest_tbl_nm nvarchar(1000)
		with encryption
	as
	BEGIN

		set nocount on;
		-- copyright notice

		IF NOT EXISTS(SELECT 1 FROM EDIS.lkup_service_id WHERE service_id = @bq_svc_id)
			BEGIN
				RAISERROR('BigQuery Service ID [%s] was not found. Please check that you are referencing the correct service ID',16,16,@bq_svc_id) with NOWAIT;
				RETURN 16;
			END

		if EDIS.fn_check_perm(@bq_svc_id) = 0
			begin
				DECLARE @lock_msg VARCHAR(MAX) = 
				'Service ID ['+@bq_svc_id+'] has been locked by an administrator. '+CHAR(13)+CHAR(10)
				SET @lock_msg += 'To use this Service ID, you will need an administrator to run the SQL Command below '
				SET @lock_msg += 'with the @usr_id parameter set as a global group or database role that you are a member of. '+CHAR(13)+CHAR(10)
				SET @lock_msg += 'You can also set the @usr_id parameter as your individual ID as well ['+SUSER_NAME()+']:'+CHAR(13)+CHAR(10)+CHAR(13)+CHAR(10)
				SET @lock_msg += 'EXEC SSISDB.EDIS.usp_config_svc_id_perm @svc_id = '''+@bq_svc_id+''''+CHAR(13)+CHAR(10)
				SET @lock_msg += '	,@usr_id = ''DOMAIN\YOUR_GLOBAL_GROUP OR DATABASE ROLE OR YOUR USER ID'''+CHAR(13)+CHAR(10)
				SET @lock_msg += '	,@action = ''INSERT'''
				RAISERROR(@lock_msg, 16,16) WITH NOWAIT
				--RAISERROR('BigQuery Service ID [%s] has been locked by an administrator. Please contact them to obtain access.',16,16,@bq_svc_id) WITH NOWAIT
				RETURN 16
			end

		declare @project_nm nvarchar(250)
		declare @project_id nvarchar(250)
		declare @client_secrets nvarchar(max)

		declare @svc_config xml = EDIS.ifn_get_svc_config(@bq_svc_id)

		set @project_nm = @svc_config.value('(/EDIS_SVC_CONFIG/project_nm)[1]','nvarchar(250)')
		set @project_id = @svc_config.value('(/EDIS_SVC_CONFIG/project_nm)[1]','nvarchar(250)')
		set @client_secrets = @svc_config.value('(/EDIS_SVC_CONFIG/client_secrets)[1]','nvarchar(max)')

		DECLARE @xml XML = (
			SELECT 
			   @bq_svc_id as bq_svc_id
			  ,@project_nm as project_nm
			  ,@project_id as project_id
			  ,@client_secrets as client_secrets
			  ,@src_qry as src_qry
			  ,@dataset_nm as dataset_nm
			  ,@dest_tbl_nm as dest_tbl_nm
			  , 'bigquery_task' as primary_task
			  , 'append_data' as sub_task
			  , 'MDDT_AUTH_CALLER_#x$^71' as caller_auth
			for xml path('root')
		)

		exec EDIS.isp_run_task @xml
	END

	GO

	--{INSTALL_STEP}Create Proc usp_bigquery_drop_tbl{/INSTALL_STEP}

	create proc EDIS.usp_bigquery_drop_tbl
		 @bq_svc_id nvarchar(255)
		,@dataset_nm nvarchar(1000)
		,@tbl_nm nvarchar(1000)
		,@fail_if_missing bit = 0
		with encryption
	as
	BEGIN

		set nocount on;
		-- copyright notice

		IF NOT EXISTS(SELECT 1 FROM EDIS.lkup_service_id WHERE service_id = @bq_svc_id)
			BEGIN
				RAISERROR('BigQuery Service ID [%s] was not found. Please check that you are referencing the correct service ID',16,16,@bq_svc_id) with NOWAIT;
				RETURN 16;
			END

		if EDIS.fn_check_perm(@bq_svc_id) = 0
			begin
				DECLARE @lock_msg VARCHAR(MAX) = 
				'Service ID ['+@bq_svc_id+'] has been locked by an administrator. '+CHAR(13)+CHAR(10)
				SET @lock_msg += 'To use this Service ID, you will need an administrator to run the SQL Command below '
				SET @lock_msg += 'with the @usr_id parameter set as a global group or database role that you are a member of. '+CHAR(13)+CHAR(10)
				SET @lock_msg += 'You can also set the @usr_id parameter as your individual ID as well ['+SUSER_NAME()+']:'+CHAR(13)+CHAR(10)+CHAR(13)+CHAR(10)
				SET @lock_msg += 'EXEC SSISDB.EDIS.usp_config_svc_id_perm @svc_id = '''+@bq_svc_id+''''+CHAR(13)+CHAR(10)
				SET @lock_msg += '	,@usr_id = ''DOMAIN\YOUR_GLOBAL_GROUP OR DATABASE ROLE OR YOUR USER ID'''+CHAR(13)+CHAR(10)
				SET @lock_msg += '	,@action = ''INSERT'''
				RAISERROR(@lock_msg, 16, 16) with NOWAIT
				--RAISERROR('BigQuery Service ID [%s] has been locked by an administrator. Please contact them to obtain access.',16,16,@bq_svc_id) WITH NOWAIT
				RETURN 16
			end

		declare @project_nm nvarchar(250)
		declare @project_id nvarchar(250)
		declare @client_secrets nvarchar(max)

		declare @svc_config xml = EDIS.ifn_get_svc_config(@bq_svc_id)

		set @project_nm = @svc_config.value('(/EDIS_SVC_CONFIG/project_nm)[1]','nvarchar(250)')
		set @project_id = @svc_config.value('(/EDIS_SVC_CONFIG/project_nm)[1]','nvarchar(250)')
		set @client_secrets = @svc_config.value('(/EDIS_SVC_CONFIG/client_secrets)[1]','nvarchar(max)')

		DECLARE @xml XML = (
			SELECT 
			   @bq_svc_id as svc_id
			  ,@project_nm as project_nm
			  ,@project_id as project_id
			  ,@client_secrets as client_secrets
			  ,@dataset_nm as dataset_nm
			  ,@tbl_nm as dest_tbl_nm
			  ,isnull(@fail_if_missing,0) as fail_if_missing
			  , 'bigquery_task' as primary_task
			  , 'drop_table' as sub_task
			  , 'MDDT_AUTH_CALLER_#x$^71' as caller_auth
			for xml path('root')
		)

		exec EDIS.isp_run_task @xml
	END

	GO

	--{INSTALL_STEP}Create Proc usp_bigquery_run_sql_cmd{/INSTALL_STEP}

	create proc EDIS.usp_bigquery_run_sql_cmd
		 @bq_svc_id nvarchar(255)
		,@dataset_nm nvarchar(1000)
		,@sql_cmd nvarchar(max)
		with encryption
	as
	BEGIN

		set nocount on;
		-- copyright notice

		IF NOT EXISTS(SELECT 1 FROM EDIS.lkup_service_id WHERE service_id = @bq_svc_id)
			BEGIN
				RAISERROR('BigQuery Service ID [%s] was not found. Please check that you are referencing the correct service ID',16,16,@bq_svc_id) with NOWAIT;
				RETURN 16;
			END

		if EDIS.fn_check_perm(@bq_svc_id) = 0
			begin
				DECLARE @lock_msg VARCHAR(MAX) = 
				'Service ID ['+@bq_svc_id+'] has been locked by an administrator. '+CHAR(13)+CHAR(10)
				SET @lock_msg += 'To use this Service ID, you will need an administrator to run the SQL Command below '
				SET @lock_msg += 'with the @usr_id parameter set as a global group or database role that you are a member of. '+CHAR(13)+CHAR(10)
				SET @lock_msg += 'You can also set the @usr_id parameter as your individual ID as well ['+SUSER_NAME()+']:'+CHAR(13)+CHAR(10)+CHAR(13)+CHAR(10)
				SET @lock_msg += 'EXEC SSISDB.EDIS.usp_config_svc_id_perm @svc_id = '''+@bq_svc_id+''''+CHAR(13)+CHAR(10)
				SET @lock_msg += '	,@usr_id = ''DOMAIN\YOUR_GLOBAL_GROUP OR DATABASE ROLE OR YOUR USER ID'''+CHAR(13)+CHAR(10)
				SET @lock_msg += '	,@action = ''INSERT'''
				RAISERROR(@lock_msg, 16, 16) with NOWAIT
				--RAISERROR('BigQuery Service ID [%s] has been locked by an administrator. Please contact them to obtain access.',16,16,@bq_svc_id) WITH NOWAIT
				RETURN 16
			end

		declare @project_nm nvarchar(250)
		declare @project_id nvarchar(250)
		declare @client_secrets nvarchar(max)

		declare @svc_config xml = EDIS.ifn_get_svc_config(@bq_svc_id)

		set @project_nm = @svc_config.value('(/EDIS_SVC_CONFIG/project_nm)[1]','nvarchar(250)')
		set @project_id = @svc_config.value('(/EDIS_SVC_CONFIG/project_nm)[1]','nvarchar(250)')
		set @client_secrets = @svc_config.value('(/EDIS_SVC_CONFIG/client_secrets)[1]','nvarchar(max)')

		DECLARE @xml XML = (
			SELECT 
			   @bq_svc_id as svc_id
			  ,@project_nm as project_nm
			  ,@project_id as project_id
			  ,@client_secrets as client_secrets
			  ,@dataset_nm as dataset_nm
			  ,@sql_cmd as sql_cmd
			  , 'bigquery_task' as primary_task
			  , 'sql_cmd' as sub_task
			  , 'MDDT_AUTH_CALLER_#x$^71' as caller_auth
			for xml path('root')
		)

		exec EDIS.isp_run_task @xml
	END
	GO

	--{INSTALL_STEP}Create Proc usp_run_sql_cmd{/INSTALL_STEP}

	CREATE PROC EDIS.usp_run_sql_cmd 
		 @srvr_nm nvarchar(1000)
		,@sql_cmd nvarchar(max)
		,@file_path nvarchar(1000) = null
		,@use_32_bit_runtime bit = 0
		WITH ENCRYPTION
	AS
	BEGIN
		SET NOCOUNT ON;
		-- copyright notice
		
		declare @access_msg varchar(8000), @server_platform nvarchar(250)

		if EDIS.fn_check_perm(@srvr_nm) = 0
			begin
				DECLARE @lock_msg VARCHAR(MAX) = 
				'Service ID ['+@srvr_nm+'] has been locked by an administrator. '+CHAR(13)+CHAR(10)
				SET @lock_msg += 'To use this Service ID, you will need an administrator to run the SQL Command below '
				SET @lock_msg += 'with the @usr_id parameter set as a global group or database role that you are a member of. '+CHAR(13)+CHAR(10)
				SET @lock_msg += 'You can also set the @usr_id parameter as your individual ID as well ['+SUSER_NAME()+']:'+CHAR(13)+CHAR(10)+CHAR(13)+CHAR(10)
				SET @lock_msg += 'EXEC SSISDB.EDIS.usp_config_svc_id_perm @svc_id = '''+@srvr_nm+''''+CHAR(13)+CHAR(10)
				SET @lock_msg += '	,@usr_id = ''DOMAIN\YOUR_GLOBAL_GROUP OR DATABASE ROLE OR YOUR USER ID'''+CHAR(13)+CHAR(10)
				SET @lock_msg += '	,@action = ''INSERT'''
				RAISERROR(@lock_msg, 16, 16) with NOWAIT
				--set @access_msg = 'ID [%s] has been locked by an administrator. Please contact them to obtain access.'
				--RAISERROR(@access_msg,16,16,@srvr_nm) WITH NOWAIT
				RETURN 16
			end

		declare @err_msg varchar(8000)

		-- if excel/access make sure file path is supplied
		if upper(@srvr_nm) in ('EXCEL','ACCESS') 
			BEGIN
				set @server_platform = upper(@srvr_nm)
				if isnull(ltrim(rtrim(@file_path)),'') = ''
					BEGIN
						set @err_msg = concat('the @file_path parameter is required to run a sql cmd against [',@srvr_nm,']')
						RAISERROR(@err_msg, 16,16) with nowait;
						return 16
					END
				else if EDIS.ufn_does_file_exist(@file_path) = 0 
					BEGIN
						set @err_msg = concat('File Path [',@file_path,'] does not exist.')
						RAISERROR(@err_msg, 16,16) with nowait;
						return 16
					END
			END
		ELSE if not exists(select 1 from EDIS.lkup_service_id where service_id = @srvr_nm)
			begin
				set @err_msg = concat(
					'Server name [',@srvr_nm,'] was not found in reference table EDIS.lkup_service_id')
				raiserror(@err_msg,16,16) with nowait
				return 16
			end

		
		declare @proxy_id nvarchar(255) = '';
		declare @cn_str nvarchar(4000), @cn_provider varchar(250), @cn_sub_provider varchar(1000), @ace_version nvarchar(250)
		
		if upper(@srvr_nm) not in ('EXCEL','ACCESS')
			BEGIN

				declare @svc_config xml = EDIS.ifn_get_svc_config(@srvr_nm)

				set @cn_provider = @svc_config.value('(/EDIS_SVC_CONFIG/server_provider)[1]','nvarchar(250)')
				set @cn_sub_provider = @svc_config.value('(/EDIS_SVC_CONFIG/server_sub_provider)[1]','nvarchar(250)')
				--set @platform = @svc_config.value('(/EDIS_SVC_CONFIG/server_platform)[1]','nvarchar(250)')
				set @cn_str = @svc_config.value('(/EDIS_SVC_CONFIG/cn_str)[1]','nvarchar(4000)')

				

				set @proxy_id = isnull(@svc_config.value('(/EDIS_SVC_CONFIG/proxy_id)[1]','nvarchar(250)'),'')

				IF ISNULL(@proxy_id,'') <> '' --and @proxy_exec_in_progress = 0
				BEGIN
					DECLARE @proxy_check_err_msg NVARCHAR(MAX)
					DECLARE @proxy_check_res bit

					
					--EXEC EDIS.isp_check_proxy_id @proxy_id, @srvr_nm, @res_msg = @proxy_check_err_msg out;

					--if @proxy_check_err_msg <> 'PROXY_VALID' 
					--	BEGIN
					--		raiserror(@proxy_check_err_msg, 16,16) with nowait;
					--		return 16
					--	END


					EXEC EDIS.isp_get_sys_info @info_ind = 'CHECK_PROXY'
						,@info_arg_1 = @proxy_id
						,@res_msg = @proxy_check_err_msg OUT
						,@res = @proxy_check_res OUT
					;
		
					IF @proxy_check_res = 0
						BEGIN
							RAISERROR(@proxy_check_err_msg,16,16) WITH NOWAIT
							RETURN 16
						END
					;

				END

			END
		ELSE
			BEGIN
				set @cn_provider = 'OLEDB';

				-- for MDB/xls, it uses jet
				if upper(right(@file_path,3)) in ('XLS','MDB')
					BEGIN
						set @use_32_bit_runtime = 1
						set @ace_version = '12' -- this is meaningless..just a placeholder
					END
				ELSE
					BEGIN
						declare @ace_version_composite varchar(250) = EDIS.ifn_get_ms_ace_version();
						IF @ace_version_composite is null
							BEGIN
								Raiserror('In order to connect to MS Access/Excel, the Microsoft ACE Driver needs to be installed',16,16) with nowait;
								return 16;
							END

						set @ace_version = left(@ace_version_composite,2)

						if left(@ace_version_composite,2) = '32'
							BEGIN
								set @use_32_bit_runtime = 1
							END
						ELSE
							BEGIN
								set @use_32_bit_runtime = 0
							END

					END

			END

		 declare @xml xml = (
			select 
				 isnull(@cn_str,'') as cn_str
				,@srvr_nm as src_sys_nm
				,@sql_cmd as sql_cmd
				,@cn_provider as cn_provider
				,isnull(@cn_sub_provider,'') as cn_sub_provider
				,'sql_cmd_task' as primary_task
				,'run_sql_cmd' as sub_task
				,'MDDT_AUTH_CALLER_#x$^71' as caller_auth
				,isnull(@ace_version,'') as ace_engine_version
				,isnull(@file_path,'') as file_path
				,isnull(@server_platform,'') as server_platform
				,isnull(@use_32_bit_runtime,0) as use_32_bit_runtime
				,isnull(@proxy_id,'') as proxy_id
			for xml path ('root')
		)

		declare @ret_cd int
		exec @ret_cd = EDIS.isp_run_task @xml  

		return @ret_cd

	END    

	GO

	--{INSTALL_STEP}Create Proc usp_config_db_conn{/INSTALL_STEP}

	create proc EDIS.usp_config_db_conn
		 @server_id nvarchar(250)
		,@server_platform nvarchar(250)
		,@server_provider nvarchar(10)
		,@use_ado_net bit = 0
		,@cn_str nvarchar(4000) 
		WITH EXECUTE AS OWNER, ENCRYPTION
	as
	begin
		SET NOCOUNT ON;
		-- Copyright Notice 

		set nocount on;

		if upper(@server_provider) not in ('OLEDB','ODBC')
			BEGIN
				raiserror('Server provider must be OLEDB or ODBC', 16,16) with nowait;
				return 16;
			END

		declare @msg varchar(max) 

		open symmetric key [SQLETL_EDIS_SKEY]
					decryption by certificate [SQLETL_EDIS_CERT]

		declare @config varbinary(max) = 
			ENCRYPTBYKEY(KEY_GUID('SQLETL_EDIS_SKEY'),CAST(CAST((SELECT 
						    'DB_CONN' AS service_type
							,@server_platform as server_platform
							,CASE WHEN
								isnull(@use_ado_net,0) = 1 THEN 'ADO.NET' ELSE @server_provider END as server_provider
							,CASE WHEN isnull(@use_ado_net,0) = 1 THEN @server_provider ELSE '' end as server_sub_provider
							,@cn_str as cn_str
						FOR XML PATH ('EDIS_SVC_CONFIG')
					) AS XML) as Nvarchar(max)))

		close symmetric key [SQLETL_EDIS_SKEY];

		IF NOT EXISTS(SELECT 1 FROM EDIS.lkup_service_id where service_id = @server_id)
			BEGIN
				INSERT EDIS.lkup_service_id (service_id, last_upd_ts, service_type, service_config)
				VALUES (@server_id, getdate(), 'DB_CONN', @config)

				set @msg = 'Server ID ['+@server_id+'] added'

			END
		ELSE
			BEGIN
				UPDATE EDIS.lkup_service_id
					set last_upd_ts = getdate(), service_type = 'DB_CONN', service_config = @config
				WHERE service_id = @server_id

				set @msg = 'Server ID ['+@server_id+'] updated'

			END

		if (charindex(' ',@cn_str) > 0 and @server_provider = 'ODBC')
			BEGIN
				PRINT 'WARNING: ODBC Connection strings with spaces often fail to connect due to the specific ODBC driver not being able to interpret whitespace.'
				PRINT 'EDIS suggests that you rerun this procedure and remove the white space from the connection string unless you are certain your connection string whitespace is valid.'
			END

		-- validate connections that have passwords
		if (charindex('password', @cn_str) > 0 or charindex('pwd', @cn_str) > 0)
			BEGIN
				print 'validating connection'
				DECLARE @err_msg nvarchar(max) = null
				EXEC EDIS.isp_validate_db_conn
					@cn_str, @server_provider, @err_msg = @err_msg out
				;

				if @err_msg is not null
					BEGIN
						DECLARE @user_msg nvarchar(max) = 'There was an error attempting to validate the connection for ['+@server_id+'].'+char(13)+char(10)
						set @user_msg += 'Error Message: '+char(13)+char(10)+@err_msg
						RAISERROR(@user_msg, 16, 16) with nowait;
						return 16;
					END
				print 'validation complete. Connected Successfully'
			END

		print @msg
	
	end

	GO

	--{INSTALL_STEP}Create proc usp_config_email_acct{/INSTALL_STEP}

	Create proc EDIS.usp_config_email_acct
		  @svc_id nvarchar(255)
		 ,@smtp_host nvarchar(1000)
		 ,@port int 
		 ,@user_id nvarchar(1000) = ''
		 ,@pwd nvarchar(1000) = ''
		 ,@sender_email_address nvarchar(500)
		 ,@sender_email_display_nm nvarchar(500) = ''
		 ,@use_ssl bit = 0
		WITH EXECUTE AS OWNER, ENCRYPTION
	as
	begin
		SET NOCOUNT ON;
		-- Copyright Notice 

		set nocount on;

		declare @msg varchar(max) 

		open symmetric key [SQLETL_EDIS_SKEY]
					decryption by certificate [SQLETL_EDIS_CERT]

		declare @config varbinary(max) = 
			ENCRYPTBYKEY(KEY_GUID('SQLETL_EDIS_SKEY'),CAST(CAST((SELECT 
						    'EMAIL_ACCT' AS service_type
							,@smtp_host as smtp_host
							,@port as port
							,@user_id as svc_uid
							,@pwd as svc_pwd
							,@use_ssl as use_ssl
							,@sender_email_address as sender_email_address
							,@sender_email_display_nm as sender_email_display_nm
						FOR XML PATH ('EDIS_SVC_CONFIG')
					) AS XML) as Nvarchar(max)))

		close symmetric key [SQLETL_EDIS_SKEY];

		IF NOT EXISTS(SELECT 1 FROM EDIS.lkup_service_id where service_id = @svc_id)
			BEGIN
				INSERT EDIS.lkup_service_id (service_id, last_upd_ts, service_type, service_config)
				VALUES (@svc_id, getdate(), 'EMAIL_ACCT', @config)

				set @msg = 'Email Service ID ['+@svc_id+'] added'

			END
		ELSE
			BEGIN
				UPDATE EDIS.lkup_service_id
					set last_upd_ts = getdate(), service_type = 'EMAIL_ACCT', service_config = @config
				WHERE service_id = @svc_id

				set @msg = 'Email Service ID ['+@svc_id+'] updated'

			END


		print @msg
	
	end

	GO

	--{INSTALL_STEP}Create proc isp_get_cn_template{/INSTALL_STEP}

	CREATE PROC EDIS.isp_get_cn_template
		 @service_id nvarchar(255)
		,@statement nvarchar(max) = null out

		WITH ENCRYPTION
		as
			SET NOCOUNT ON;
			-- Copyright Notice 


			declare @config xml = SSISDB.EDIS.ifn_get_svc_config(@service_id);

			declare @cn_str nvarchar(4000) = @config.value('(/EDIS_SVC_CONFIG/cn_str)[1]','nvarchar(4000)')
			declare @platform nvarchar(250) = @config.value('(/EDIS_SVC_CONFIG/server_platform)[1]','nvarchar(250)')
			declare @provider nvarchar(10) = @config.value('(/EDIS_SVC_CONFIG/server_provider)[1]','nvarchar(250)')
			declare @sub_provider nvarchar(10) = @config.value('(/EDIS_SVC_CONFIG/server_sub_provider)[1]','nvarchar(250)')
			declare @proxy_id nvarchar(255) = isnull(@config.value('(/EDIS_SVC_CONFIG/proxy_id)[1]','nvarchar(250)'),'')

			declare @use_ado_net bit = 0;
			if @provider = 'ADO.NET' set @use_ado_net = 1;

			if @use_ado_net = 1 set @provider = @sub_provider;

			declare @props as table (prop_nm nvarchar(255), prop_val nvarchar(max));
			insert @props
			exec SSISDB.edis.isp_get_cn_props @service_id;

			--select * from @props

			DECLARE @cn_provider nvarchar(255) = (SELECT prop_val FROM @props WHERE prop_nm = 'Provider');


			if (@proxy_id <> '' OR @cn_provider in ('SQLOLEDB'))
				BEGIN
					--select * from @props;

					declare @instance nvarchar(255)  = (SELECT prop_val from @props where prop_nm = 'Data Source')
					declare @default_db nvarchar(255)  = isnull((SELECT prop_val from @props where prop_nm = 'Initial Catalog'),'master')
					declare @use_integrated_security bit = 0
					IF EXISTS(SELECT 1 FROM @props where prop_val = 'SSPI')
						set @use_integrated_security = 1
					;

					declare @sql_auth_user_id nvarchar(255)
					declare @sql_auth_password nvarchar(255)
					declare @windows_auth_user_id nvarchar(255)

					if @use_integrated_security = 1
						BEGIN
							SET @windows_auth_user_id = (
								SELECT c.credential_identity
								FROM MSDB.dbo.sysproxies as p
									INNER JOIN master.sys.credentials as c
										on p.credential_id = c.credential_id
								WHERE p.name = @proxy_id
							)

							set @statement = concat(
								'/* ',char(13)+char(10)
								,'	For security reasons, EDIS does not store the password to a Windows account.',char(13)+char(10)
								,'	Please contact the owner of the Windows account to update the password in the template below.',char(13)+char(10)
								,'*/',char(13)+char(10)+char(13)+char(10)
									,'EXEC SSISDB.EDIS.usp_config_db_conn_mssql @server_id = ''',@service_id,'''',char(13)+char(10)
										,'	,@server_instance = ''',@instance,'''',char(13)+char(10)
										,'	,@default_db = ''',@default_db,'''',char(13)+char(10)
										,'	,@use_integrated_security = 1',char(13)+char(10)
										,'	,@windows_auth_user_id = ''',@windows_auth_user_id,'''',char(13)+char(10)
										,'	,@windows_auth_password = ''XXXXXXXXXXXXXXXXXXXXX''',char(13)+char(10)
					)

						END
					ELSE
						BEGIN
							set @sql_auth_user_id = (SELECT prop_val from @props where prop_nm = 'User ID')
							set @sql_auth_password = (SELECT prop_val from @props where prop_nm = 'Password')

							set @statement = concat(
									'EXEC SSISDB.EDIS.usp_config_db_conn_mssql @server_id = ''',@service_id,'''',char(13)+char(10)
										,'	,@server_instance = ''',@instance,'''',char(13)+char(10)
										,'	,@default_db = ''',@default_db,'''',char(13)+char(10)
										,'	,@use_integrated_security = 0',char(13)+char(10)
										,'	,@sql_auth_user_id = ''',@sql_auth_user_id,'''',char(13)+char(10)
										,'	,@sql_auth_password = ''',@sql_auth_password,'''',char(13)+char(10)
							);

						END

			

			
				END
			ELSE
				BEGIN
					set @statement = concat(
						'EXEC SSISDB.EDIS.usp_config_db_conn @server_id = ''',@service_id,'''',char(13)+char(10)
						,'	,@server_platform = ''',@platform,'''',char(13)+char(10)
						,'	,@server_provider = ''',@provider,'''',char(13)+char(10)
						,'	,@use_ado_net = ',@use_ado_net,'',char(13)+char(10)
						,'	,@cn_str = ''',@cn_str,'''',char(13)+char(10)
					)
				END
			
				

			print @statement

	GO

	--{INSTALL_STEP}Create proc usp_config_ews_acct{/INSTALL_STEP}

	Create proc EDIS.usp_config_ews_acct
		  @svc_id nvarchar(255)
		 ,@user_id nvarchar(1000)
		 ,@domain nvarchar(1000) = ''
		 ,@password nvarchar(1000)
		 ,@email_acct nvarchar(1000) 
		 ,@exchange_version nvarchar(15) 
		 ,@office_365_url nvarchar(500) = ''
		WITH EXECUTE AS OWNER, ENCRYPTION
	as
	begin
		SET NOCOUNT ON;
		-- Copyright Notice 

		set nocount on;

		declare @msg varchar(max) 

		-- validate exchange version
		if lower(@exchange_version) not in ('2007_sp1','2010','2010_sp1','2010_sp2','2013','2013_sp1')
			BEGIN
				set @msg = concat(
						'Parameter @exchange_version only accepts the following values:'
						,char(13)+char(10),'2007_sp1'
						,char(13)+char(10),'2010'
						,char(13)+char(10),'2010_sp1'
						,char(13)+char(10),'2010_sp2'
						,char(13)+char(10),'2013'
						,char(13)+char(10),'2013_sp1'
						,char(13)+char(10),'For accounts using Office 365, use value "2013" for the exchange version'
				)
				raiserror(@msg,16,16) with nowait;
				return 16;

			END


		open symmetric key [SQLETL_EDIS_SKEY]
					decryption by certificate [SQLETL_EDIS_CERT]

		declare @config varbinary(max) = 
			ENCRYPTBYKEY(KEY_GUID('SQLETL_EDIS_SKEY'),CAST(CAST((SELECT 
						    'EWS_ACCT' AS service_type
							,@user_id as svc_uid
							,@password as svc_pwd
							,@domain as domain
							,@email_acct as email_acct
							,@exchange_version as exchange_version
							,@office_365_url as office_365_url
						FOR XML PATH ('EDIS_SVC_CONFIG')
					) AS XML) as Nvarchar(max)))

		close symmetric key [SQLETL_EDIS_SKEY];

		IF NOT EXISTS(SELECT 1 FROM EDIS.lkup_service_id where service_id = @svc_id)
			BEGIN
				INSERT EDIS.lkup_service_id (service_id, last_upd_ts, service_type, service_config)
				VALUES (@svc_id, getdate(), 'EWS_ACCT', @config)

				set @msg = 'Exchange Web Services (EWS) Service ID ['+@svc_id+'] added'

			END
		ELSE
			BEGIN
				UPDATE EDIS.lkup_service_id
					set last_upd_ts = getdate(), service_type = 'EWS_ACCT', service_config = @config
				WHERE service_id = @svc_id

				set @msg = 'Exchange Web Services (EWS) Service ID ['+@svc_id+'] updated'

			END


		print @msg
	
	end

	GO

	--{INSTALL_STEP}Create proc usp_email_create_folder{/INSTALL_STEP}

	CREATE proc EDIS.usp_email_create_folder
		 @svc_id nvarchar(250)
		,@folder_nm nvarchar(250)
		,@parent_folder_path nvarchar(250)
		with encryption
	as
		set nocount on;
		-- Copyright Notice 

		if not exists(Select 1 from EDIS.lkup_service_id where service_id = @svc_id)
			BEGIN
				RAISERROR('Parameter @svc_id with value [%s] does not exist. Please use procedure EDIS.usp_config_ews_acct to create an EWS service ID', 16,16, @svc_id) with nowait;
				return 16;
			END

		-- is the service ID EWS?
		if not exists(Select 1 from EDIS.lkup_service_id where service_id = @svc_id and service_type = 'EWS_ACCT')
			BEGIN
				RAISERROR('Service ID [%s] must be an Exchange Web Service (EWS) account for this procedure to work. Please use procedure EDIS.usp_config_ews_acct to create an EWS service ID', 16,16, @svc_id) with nowait;
				return 16;
			END

		declare 
			  @svc_uid nvarchar(1000)
			, @svc_pwd nvarchar(1000)
			, @domain nvarchar(1000)
			, @email_acct nvarchar(1000)
			, @office_365_url nvarchar(1000)
			, @exchange_version nvarchar(1000)
		;

		declare @svc_config xml = EDIS.ifn_get_svc_config(@svc_id);

		set @svc_uid = @svc_config.value('(/EDIS_SVC_CONFIG/svc_uid)[1]','nvarchar(1000)')
		set @svc_pwd = @svc_config.value('(/EDIS_SVC_CONFIG/svc_pwd)[1]','nvarchar(1000)')
		set @domain = @svc_config.value('(/EDIS_SVC_CONFIG/domain)[1]','nvarchar(1000)')
		set @email_acct = @svc_config.value('(/EDIS_SVC_CONFIG/email_acct)[1]','nvarchar(1000)')
		set @exchange_version = @svc_config.value('(/EDIS_SVC_CONFIG/exchange_version)[1]','nvarchar(1000)')
		set @office_365_url = @svc_config.value('(/EDIS_SVC_CONFIG/office_365_url)[1]','nvarchar(1000)')

		DECLARE @xml XML = (
			SELECT 
			    @svc_uid as svc_uid
			   ,@svc_pwd as svc_pwd
			   ,@domain as domain
			   ,@email_acct as email_acct
			   ,@office_365_url as office_365_url
			   ,@exchange_version as exchange_version
			   ,@folder_nm as folder_nm
			   ,@parent_folder_path as parent_folder_path
			  , 'ews_task' as primary_task
			  , 'create_folder' as sub_task
			  , 'MDDT_AUTH_CALLER_#x$^71' as caller_auth
			for xml path('root')
		)

		exec EDIS.isp_run_task @xml
			

	GO

	--{INSTALL_STEP}Create proc usp_email_delete_folder{/INSTALL_STEP}

	CREATE proc EDIS.usp_email_delete_folder
		 @svc_id nvarchar(250)
		,@folder_nm nvarchar(250)
		,@parent_folder_path nvarchar(250)
		with encryption
	as
		set nocount on;
		-- Copyright Notice 

		if not exists(Select 1 from EDIS.lkup_service_id where service_id = @svc_id)
			BEGIN
				RAISERROR('Parameter @svc_id with value [%s] does not exist. Please use procedure EDIS.usp_config_ews_acct to create an EWS service ID', 16,16, @svc_id) with nowait;
				return 16;
			END

		-- is the service ID EWS?
		if not exists(Select 1 from EDIS.lkup_service_id where service_id = @svc_id and service_type = 'EWS_ACCT')
			BEGIN
				RAISERROR('Service ID [%s] must be an Exchange Web Service (EWS) account for this procedure to work. Please use procedure EDIS.usp_config_ews_acct to create an EWS service ID', 16,16, @svc_id) with nowait;
				return 16;
			END

		declare 
			  @svc_uid nvarchar(1000)
			, @svc_pwd nvarchar(1000)
			, @domain nvarchar(1000)
			, @email_acct nvarchar(1000)
			, @office_365_url nvarchar(1000)
			, @exchange_version nvarchar(1000)
		;

		declare @svc_config xml = EDIS.ifn_get_svc_config(@svc_id);

		set @svc_uid = @svc_config.value('(/EDIS_SVC_CONFIG/svc_uid)[1]','nvarchar(1000)')
		set @svc_pwd = @svc_config.value('(/EDIS_SVC_CONFIG/svc_pwd)[1]','nvarchar(1000)')
		set @domain = @svc_config.value('(/EDIS_SVC_CONFIG/domain)[1]','nvarchar(1000)')
		set @email_acct = @svc_config.value('(/EDIS_SVC_CONFIG/email_acct)[1]','nvarchar(1000)')
		set @exchange_version = @svc_config.value('(/EDIS_SVC_CONFIG/exchange_version)[1]','nvarchar(1000)')
		set @office_365_url = @svc_config.value('(/EDIS_SVC_CONFIG/office_365_url)[1]','nvarchar(1000)')

		DECLARE @xml XML = (
			SELECT 
			    @svc_uid as svc_uid
			   ,@svc_pwd as svc_pwd
			   ,@domain as domain
			   ,@email_acct as email_acct
			   ,@office_365_url as office_365_url
			   ,@exchange_version as exchange_version
			   ,@folder_nm as folder_nm
			   ,@parent_folder_path as parent_folder_path
			  , 'ews_task' as primary_task
			  , 'delete_folder' as sub_task
			  , 'MDDT_AUTH_CALLER_#x$^71' as caller_auth
			for xml path('root')
		)

		exec EDIS.isp_run_task @xml
			

	GO

	--{INSTALL_STEP}Create proc usp_email_create_cal_appt{/INSTALL_STEP}

	CREATE proc EDIS.usp_email_create_cal_appt
		 @svc_id nvarchar(250)
		,@subject nvarchar(250)
		,@start_ts datetime
		,@end_ts datetime
		,@location nvarchar(250) = null
		,@body nvarchar(max) = null
		,@category nvarchar(250) = null
		,@invite_list nvarchar(max) = null
		with encryption
	as
		set nocount on;
		-- Copyright Notice 

		if not exists(Select 1 from EDIS.lkup_service_id where service_id = @svc_id)
			BEGIN
				RAISERROR('Parameter @svc_id with value [%s] does not exist. Please use procedure EDIS.usp_config_ews_acct to create an EWS service ID', 16,16, @svc_id) with nowait;
				return 16;
			END

		-- is the service ID EWS?
		if not exists(Select 1 from EDIS.lkup_service_id where service_id = @svc_id and service_type = 'EWS_ACCT')
			BEGIN
				RAISERROR('Service ID [%s] must be an Exchange Web Service (EWS) account for this procedure to work. Please use procedure EDIS.usp_config_ews_acct to create an EWS service ID', 16,16, @svc_id) with nowait;
				return 16;
			END

		declare 
			  @svc_uid nvarchar(1000)
			, @svc_pwd nvarchar(1000)
			, @domain nvarchar(1000)
			, @email_acct nvarchar(1000)
			, @office_365_url nvarchar(1000)
			, @exchange_version nvarchar(1000)
		;

		declare @svc_config xml = EDIS.ifn_get_svc_config(@svc_id);

		set @svc_uid = @svc_config.value('(/EDIS_SVC_CONFIG/svc_uid)[1]','nvarchar(1000)')
		set @svc_pwd = @svc_config.value('(/EDIS_SVC_CONFIG/svc_pwd)[1]','nvarchar(1000)')
		set @domain = @svc_config.value('(/EDIS_SVC_CONFIG/domain)[1]','nvarchar(1000)')
		set @email_acct = @svc_config.value('(/EDIS_SVC_CONFIG/email_acct)[1]','nvarchar(1000)')
		set @exchange_version = @svc_config.value('(/EDIS_SVC_CONFIG/exchange_version)[1]','nvarchar(1000)')
		set @office_365_url = @svc_config.value('(/EDIS_SVC_CONFIG/office_365_url)[1]','nvarchar(1000)')

		DECLARE @xml XML = (
			SELECT 
			    @svc_uid as svc_uid
			   ,@svc_pwd as svc_pwd
			   ,@domain as domain
			   ,@email_acct as email_acct
			   ,@office_365_url as office_365_url
			   ,@exchange_version as exchange_version
			   ,@subject as 'subject'
			   ,@body as body
			   ,@start_ts as start_ts
			   ,@end_ts as end_ts
			   ,@location as 'location'
			   ,@category as category
			   ,@invite_list as invite_list
			  , 'ews_task' as primary_task
			  , 'create_calendar_appt' as sub_task
			  , 'MDDT_AUTH_CALLER_#x$^71' as caller_auth
			for xml path('root')
		)

		exec EDIS.isp_run_task @xml
			

	GO

	--{INSTALL_STEP}Create proc usp_email_move_messages{/INSTALL_STEP}

	CREATE proc EDIS.usp_email_move_messages
		 @svc_id nvarchar(250)
		,@src_folder_path nvarchar(250)
		,@tgt_folder_path nvarchar(250)
		,@msg_id_list nvarchar(max)
		with encryption
	as
		set nocount on;
		-- Copyright Notice 

		if not exists(Select 1 from EDIS.lkup_service_id where service_id = @svc_id)
			BEGIN
				RAISERROR('Parameter @svc_id with value [%s] does not exist. Please use procedure EDIS.usp_config_ews_acct to create an EWS service ID', 16,16, @svc_id) with nowait;
				return 16;
			END

		-- is the service ID EWS?
		if not exists(Select 1 from EDIS.lkup_service_id where service_id = @svc_id and service_type = 'EWS_ACCT')
			BEGIN
				RAISERROR('Service ID [%s] must be an Exchange Web Service (EWS) account for this procedure to work. Please use procedure EDIS.usp_config_ews_acct to create an EWS service ID', 16,16, @svc_id) with nowait;
				return 16;
			END

		declare 
			  @svc_uid nvarchar(1000)
			, @svc_pwd nvarchar(1000)
			, @domain nvarchar(1000)
			, @email_acct nvarchar(1000)
			, @office_365_url nvarchar(1000)
			, @exchange_version nvarchar(1000)
		;

		declare @svc_config xml = EDIS.ifn_get_svc_config(@svc_id);

		set @svc_uid = @svc_config.value('(/EDIS_SVC_CONFIG/svc_uid)[1]','nvarchar(1000)')
		set @svc_pwd = @svc_config.value('(/EDIS_SVC_CONFIG/svc_pwd)[1]','nvarchar(1000)')
		set @domain = @svc_config.value('(/EDIS_SVC_CONFIG/domain)[1]','nvarchar(1000)')
		set @email_acct = @svc_config.value('(/EDIS_SVC_CONFIG/email_acct)[1]','nvarchar(1000)')
		set @exchange_version = @svc_config.value('(/EDIS_SVC_CONFIG/exchange_version)[1]','nvarchar(1000)')
		set @office_365_url = @svc_config.value('(/EDIS_SVC_CONFIG/office_365_url)[1]','nvarchar(1000)')

		DECLARE @xml XML = (
			SELECT 
			    @svc_uid as svc_uid
			   ,@svc_pwd as svc_pwd
			   ,@domain as domain
			   ,@email_acct as email_acct
			   ,@office_365_url as office_365_url
			   ,@exchange_version as exchange_version
			   ,@src_folder_path as src_folder_path
			   ,@tgt_folder_path as tgt_folder_path
			   ,@msg_id_list as msg_id_list
			  , 'ews_task' as primary_task
			  , 'move_messages' as sub_task
			  , 'MDDT_AUTH_CALLER_#x$^71' as caller_auth
			for xml path('root')
		)

		exec EDIS.isp_run_task @xml
			

	GO

	--{INSTALL_STEP}Create proc usp_email_delete_messages{/INSTALL_STEP}

	CREATE proc EDIS.usp_email_delete_messages
		 @svc_id nvarchar(250)
		--,@folder_path nvarchar(250)
		,@msg_id_list nvarchar(max)
		with encryption
	as
		set nocount on;
		-- Copyright Notice 

		if not exists(Select 1 from EDIS.lkup_service_id where service_id = @svc_id)
			BEGIN
				RAISERROR('Parameter @svc_id with value [%s] does not exist. Please use procedure EDIS.usp_config_ews_acct to create an EWS service ID', 16,16, @svc_id) with nowait;
				return 16;
			END

		-- is the service ID EWS?
		if not exists(Select 1 from EDIS.lkup_service_id where service_id = @svc_id and service_type = 'EWS_ACCT')
			BEGIN
				RAISERROR('Service ID [%s] must be an Exchange Web Service (EWS) account for this procedure to work. Please use procedure EDIS.usp_config_ews_acct to create an EWS service ID', 16,16, @svc_id) with nowait;
				return 16;
			END

		declare 
			  @svc_uid nvarchar(1000)
			, @svc_pwd nvarchar(1000)
			, @domain nvarchar(1000)
			, @email_acct nvarchar(1000)
			, @office_365_url nvarchar(1000)
			, @exchange_version nvarchar(1000)
		;

		declare @svc_config xml = EDIS.ifn_get_svc_config(@svc_id);

		set @svc_uid = @svc_config.value('(/EDIS_SVC_CONFIG/svc_uid)[1]','nvarchar(1000)')
		set @svc_pwd = @svc_config.value('(/EDIS_SVC_CONFIG/svc_pwd)[1]','nvarchar(1000)')
		set @domain = @svc_config.value('(/EDIS_SVC_CONFIG/domain)[1]','nvarchar(1000)')
		set @email_acct = @svc_config.value('(/EDIS_SVC_CONFIG/email_acct)[1]','nvarchar(1000)')
		set @exchange_version = @svc_config.value('(/EDIS_SVC_CONFIG/exchange_version)[1]','nvarchar(1000)')
		set @office_365_url = @svc_config.value('(/EDIS_SVC_CONFIG/office_365_url)[1]','nvarchar(1000)')

		DECLARE @xml XML = (
			SELECT 
			    @svc_uid as svc_uid
			   ,@svc_pwd as svc_pwd
			   ,@domain as domain
			   ,@email_acct as email_acct
			   ,@office_365_url as office_365_url
			   ,@exchange_version as exchange_version
			  -- ,@folder_path as src_folder_path
			   ,@msg_id_list as msg_id_list
			  , 'ews_task' as primary_task
			  , 'delete_messages' as sub_task
			  , 'MDDT_AUTH_CALLER_#x$^71' as caller_auth
			for xml path('root')
		)

		exec EDIS.isp_run_task @xml
			

	GO

	--{INSTALL_STEP}Create proc usp_email_import_messages{/INSTALL_STEP}

	CREATE proc EDIS.[usp_email_import_messages]
		 @svc_id nvarchar(250)
		,@folder_path nvarchar(250)
		,@dest_tbl_nm nvarchar(1000)
		,@subject_filter nvarchar(1000) = null
		,@start_dt date = null
		,@end_dt date = null
		,@include_attachment_content bit = 0
		,@attachment_name_filter nvarchar(1000) = null
		,@body_format nvarchar(250) = 'text'
			WITH ENCRYPTION
	as
		set nocount on;
		-- Copyright Notice 

		if upper(isnull(@body_format,'')) not in ('HTML','TEXT')
			BEGIN
				Raiserror('Parameter @body_format must be either "HTML" or "TEXT"', 16,16) with nowait; 
				return 16;
			END

		if not exists(Select 1 from EDIS.lkup_service_id where service_id = @svc_id)
			BEGIN
				RAISERROR('Parameter @svc_id with value [%s] does not exist. Please use procedure EDIS.usp_config_ews_acct to create an EWS service ID', 16,16, @svc_id) with nowait;
				return 16;
			END

		-- is the service ID EWS?
		if not exists(Select 1 from EDIS.lkup_service_id where service_id = @svc_id and service_type = 'EWS_ACCT')
			BEGIN
				RAISERROR('Service ID [%s] must be an Exchange Web Service (EWS) account for this procedure to work. Please use procedure EDIS.usp_config_ews_acct to create an EWS service ID', 16,16, @svc_id) with nowait;
				return 16;
			END

		
		-- OUTPUT TABLE...If temp table, drop/recreate; if perm, only create if not exist

		declare @tgt_db nvarchar(255)
		declare @tgt_schema nvarchar(255)
		declare @tgt_tbl nvarchar(255)
		declare @full_path nvarchar(2000)


		if left(@dest_tbl_nm,2) = '##' 
			begin
				set @tgt_db = 'tempdb'
				set @tgt_schema = 'dbo'
				set @tgt_tbl = @dest_tbl_nm	
				set @full_path = 'tempdb.dbo.'+@dest_tbl_nm;
				print @full_path
				if OBJECT_ID('tempdb..'+@dest_tbl_nm) is not null 
					begin
						exec('drop table '+@full_path+'');
						print 'dropped temp table'
					end
			end
		else
			begin
				set @tgt_db = parsename(@dest_tbl_nm,3)
				set @tgt_schema = parsename(@dest_tbl_nm,2)
				set @tgt_tbl = parsename(@dest_tbl_nm,1)
				set @full_path = concat('[',@tgt_db,'].[',@tgt_schema,'].[',@tgt_tbl,']')

				if DB_ID(@tgt_db) is null
					BEGIN
						raiserror('If the destination table is not a temporary table, it must be fully qualified with the database_name.schema.table_name',16,16) with nowait;
						return 16
					END
				if object_id(@full_path) is not null 
					BEGIN
						raiserror('Permanent table %s already exists. You can only create permanent tables that don''t already exist.',16,16, @full_path) with nowait;
						return 16
					END
			end
		
		-- Create the table
		--print @full_path
		exec('
					create table '+@full_path+'
					(
						email_id varchar(512), folder_path varchar(4000), date_sent datetime2, date_received datetime2, subject nvarchar(500), body nvarchar(max)
						,to_recipients nvarchar(max), cc_recipients nvarchar(max), has_attachments bit
						,attachments nvarchar(max), attachment_cnt int
						,is_reply bit, is_forward bit, importance nvarchar(10)
					
					)
				
				
				')
		
		-- ---------------------------------------------------------------------------------------------------------------------

		declare 
			  @svc_uid nvarchar(1000)
			, @svc_pwd nvarchar(1000)
			, @domain nvarchar(1000)
			, @email_acct nvarchar(1000)
			, @office_365_url nvarchar(1000)
			, @exchange_version nvarchar(1000)
		;

		declare @svc_config xml = EDIS.ifn_get_svc_config(@svc_id);

		set @svc_uid = @svc_config.value('(/EDIS_SVC_CONFIG/svc_uid)[1]','nvarchar(1000)')
		set @svc_pwd = @svc_config.value('(/EDIS_SVC_CONFIG/svc_pwd)[1]','nvarchar(1000)')
		set @domain = @svc_config.value('(/EDIS_SVC_CONFIG/domain)[1]','nvarchar(1000)')
		set @email_acct = @svc_config.value('(/EDIS_SVC_CONFIG/email_acct)[1]','nvarchar(1000)')
		set @exchange_version = @svc_config.value('(/EDIS_SVC_CONFIG/exchange_version)[1]','nvarchar(1000)')
		set @office_365_url = @svc_config.value('(/EDIS_SVC_CONFIG/office_365_url)[1]','nvarchar(1000)')

		DECLARE @xml XML = (
			SELECT 
			    @svc_uid as svc_uid
			   ,@svc_pwd as svc_pwd
			   ,@domain as domain
			   ,@email_acct as email_acct
			   ,@office_365_url as office_365_url
			   ,@exchange_version as exchange_version
			   ,@folder_path as folder_path
			   ,@subject_filter as subject_filter
			   ,@start_dt as msg_start_dt
			   ,@end_dt as msg_end_dt
			   ,@include_attachment_content as include_attachment_content
			   ,@attachment_name_filter as attachment_name_filter
			   ,@body_format as body_format
			   ,@tgt_db as target_db
			   ,@tgt_schema as target_schema
			   ,@tgt_tbl as target_tbl

			  , 'ews_task' as primary_task
			  , 'import_messages' as sub_task
			  , 'MDDT_AUTH_CALLER_#x$^71' as caller_auth
			for xml path('root')
		)

		exec EDIS.isp_run_task @xml


	GO

	--{INSTALL_STEP}Create proc usp_email_save_attachment_to_file{/INSTALL_STEP}

	CREATE proc [EDIS].[usp_email_save_attachment_to_file]
		 @email_id varchar(512)
		,@src_tbl nvarchar(1000)
		,@folder_path nvarchar(255)
			WITH ENCRYPTION
	as
		set nocount on;
		-- Copyright Notice 

		DECLARE @contents xml;

			declare @sql nvarchar(max) = N'SET @contents = (select cast(attachments as xml) from '+@src_tbl+' WHERE email_id = @email_id)';
			declare @params nvarchar(max) = N'@contents xml out, @email_id varchar(512)';

			exec sp_executesql @sql, @params, @contents = @contents out, @email_id = @email_id;

			if @contents is null
				BEGIN
					RAISERROR('No attachments found for the supplied email id', 16,16) with nowait;
					return 16
				END
			
			if object_id('tempdb..#att') is not null drop table #att;

			select att.c.value('@ATTACHMENT_NAME', 'nvarchar(1000)') as attach_nm
				,att.c.value('@ATTACHMENT_CONTENT', 'varbinary(max)') as attach_content
			into #att
			from @contents.nodes('ATTACHMENTS/ATTACHMENT') as att(c)
			;

			declare @tot_recs int = @@rowcount;

			declare @curr_attach_nm nvarchar(1000), @curr_attach_content varbinary(max)
				,@full_attach_path nvarchar(1000);
		
			if right(@folder_path,1) <> '\' set @folder_path += '\'
			declare cs cursor local fast_forward for select attach_nm, attach_content
			from #att
			open cs
			fetch next from cs into @curr_attach_nm, @curr_attach_content
			while @@FETCH_STATUS = 0
				BEGIN
					set @full_attach_path = @folder_path + @curr_attach_nm
					exec SSISDB.edis.usp_convert_varbinary_to_file @bin_data = @curr_attach_content
						,@output_file_path = @full_attach_path
					;

					fetch next from cs into @curr_attach_nm, @curr_attach_content;
					
				END
			close cs
			deallocate cs

			drop table #att;

	GO


	--{INSTALL_STEP}Create proc usp_send_email{/INSTALL_STEP}

	CREATE proc EDIS.[usp_send_email]
		 @svc_id nvarchar(250)
		,@to nvarchar(max) = ''
		,@cc nvarchar(max) = ''
		,@bcc nvarchar(max) = ''
		,@subject nvarchar(500)
		,@body nvarchar(max)
		,@body_format varchar(4) = 'HTML'
		,@is_high_pri bit = 0
		,@file_attachment_path nvarchar(max) = ''
		,@qry nvarchar(max) = ''
		,@qry_attachment_path nvarchar(max) = ''
		,@col_delim nvarchar(255) = ''
		,@compress_qry_attachment bit = 0
		,@from nvarchar(1000) = ''
		,@from_display_nm nvarchar(1000) = ''
			WITH ENCRYPTION
	as
		set nocount on;
		-- Copyright Notice 

		if upper(isnull(@body_format,'')) not in ('HTML','TEXT')
			BEGIN
				Raiserror('Parameter @body_format must be either "HTML" or "TEXT"', 16,16) with nowait; 
				return 16;
			END


		if isnull(@to,'') = '' AND isnull(@cc,'') = '' and isnull(@bcc,'') = ''
			BEGIN
				RAISERROR('Atleast one recipient email address must be present to send an email. Parameters @to, @cc, and @bcc are all null', 16,16) with nowait;
				return 16;
			END

		if not exists(Select 1 from EDIS.lkup_service_id where service_id = @svc_id)
			BEGIN
				RAISERROR('Parameter @svc_id with value [%s] does not exist. Please use procedure EDIS.usp_config_email_acct to create an email service ID', 16,16, @svc_id) with nowait;
				return 16;
			END

		if not exists(Select 1 from EDIS.lkup_service_id where service_id = @svc_id and service_type = 'EMAIL_ACCT')
			BEGIN
				RAISERROR('Parameter @svc_id with value [%s] is not an email account. Please use procedure EDIS.usp_config_email_acct to create an email service ID', 16,16, @svc_id) with nowait;
				return 16;
			END

		-- check attachment existence
		if isnull(@file_attachment_path,'') <> ''
			BEGIN
				declare @files as table (file_nm nvarchar(4000));

				insert @files
				select *
				from EDIS.ufn_split_string(@file_attachment_path,';')
				;

				declare cs cursor local fast_forward for select file_nm from @files;
				declare @curr_file nvarchar(4000)
				open cs
				fetch next from cs into @curr_file
				while @@FETCH_STATUS = 0
					BEGIN
						IF EDIS.ufn_does_file_exist(@curr_file) = 0
							BEGIN
								close cs
								deallocate cs

								raiserror('Parameter @file_attachment_path contained a file [%s] that does not exist', 16,16, @curr_file) with nowait;
								return 16
							END

						fetch next from cs into @curr_file
					END
				close cs
				deallocate cs

			END

		-- ---------------------------------------------------------------------------------------------------------------------

		declare 
			  @user_id nvarchar(1000)
			, @pwd nvarchar(1000)
			, @smtp_host nvarchar(1000)
			, @port int
			, @use_ssl bit
			, @default_from_adrs nvarchar(1000)
			, @default_from_display_nm nvarchar(1000)
		;

		declare @svc_config xml = EDIS.ifn_get_svc_config(@svc_id);

		set @user_id = @svc_config.value('(/EDIS_SVC_CONFIG/svc_uid)[1]','nvarchar(1000)')
		set @pwd = @svc_config.value('(/EDIS_SVC_CONFIG/svc_pwd)[1]','nvarchar(1000)')
		set @smtp_host = @svc_config.value('(/EDIS_SVC_CONFIG/smtp_host)[1]','nvarchar(1000)')
		set @port = @svc_config.value('(/EDIS_SVC_CONFIG/port)[1]','int')
		set @use_ssl = @svc_config.value('(/EDIS_SVC_CONFIG/use_ssl)[1]','bit')
		set @default_from_adrs = @svc_config.value('(/EDIS_SVC_CONFIG/sender_email_address)[1]','nvarchar(1000)')
		set @default_from_display_nm = @svc_config.value('(/EDIS_SVC_CONFIG/sender_email_display_nm)[1]','nvarchar(1000)')

		if isnull(@from,'') = '' 
			BEGIN
				set @from = @default_from_adrs;
				set @from_display_nm = @default_from_display_nm;
			END

		--print @from

		DECLARE @xml XML = (
			SELECT 
			   @to as [to]
			  ,@cc as cc
			  ,@bcc as bcc
			  ,@subject as [subject]
			  ,@body as body
			  ,isnull(@body_format,'HTML') as body_format
			  ,@svc_id as svc_id
			  ,isnull(@is_high_pri,0) as is_high_pri
			  ,@file_attachment_path as file_attachment_path
			  ,isnull(@qry,'') as qry
			  ,isnull(@qry_attachment_path,'') as qry_attachment_path
			  ,isnull(@compress_qry_attachment,0) as compress_qry_attachment
			  ,isnull(@col_delim,'') as col_delim
			  ,@from as [from]
			  ,@from_display_nm as from_display_nm
			  ,@user_id as svc_uid
			  ,@pwd as svc_pwd
			  ,@smtp_host as smtp_host
			  ,@port as port
			  ,@use_ssl as use_ssl
			  , 'email_task' as primary_task
			  , 'send_email' as sub_task
			  , 'MDDT_AUTH_CALLER_#x$^71' as caller_auth
			for xml path('root')
		)

		exec EDIS.isp_run_task @xml


	GO

	--{INSTALL_STEP}Create proc isp_setup_proxy_id{/INSTALL_STEP}

	CREATE PROC EDIS.isp_setup_proxy_id 
		  @login_nm  nvarchar(1000)
		, @login_pwd  nvarchar(1000)
		, @proxy_id  nvarchar(1000)
		WITH ENCRYPTION
	AS	
		BEGIN
			EXEC MSDB.dbo.isp_SQLETL_EDIS_setup_proxy_id
				@login_nm, @login_pwd, @proxy_id
			;
		END

	GO

	--{INSTALL_STEP}Sign Proc isp_setup_proxy_id{/INSTALL_STEP}

	ADD SIGNATURE TO EDIS.isp_setup_proxy_id BY CERTIFICATE SQLETL_EDIS_ProxyCert
	WITH PASSWORD = '{PROXY_CERTIFICATE_PASSWORD}'

	GO

	--{INSTALL_STEP}Create proc usp_config_db_conn_mssql{/INSTALL_STEP}

	CREATE PROC EDIS.usp_config_db_conn_mssql
		 @server_id NVARCHAR(255)
		,@server_instance NVARCHAR(255)
		,@default_db NVARCHAR(255) = 'master'
		,@use_integrated_security BIT 
		,@sql_auth_user_id NVARCHAR(255) = ''
		,@sql_auth_password NVARCHAR(1000) = ''
		,@windows_auth_user_id NVARCHAR(255) = ''
		,@windows_auth_password NVARCHAR(1000) = ''
		WITH ENCRYPTION
	AS
		SET NOCOUNT ON;


		Declare @msg varchar(max)

		DECLARE @cn_str NVARCHAR(MAX) = 
			'Provider = SQLOLEDB; Data Source = '+@server_instance+'; Initial Catalog = '+ISNULL(@default_db,'master')+'; '
		

		DECLARE @proxy_id NVARCHAR(255) = ''

		IF @use_integrated_security = 1
			BEGIN
				SET @cn_str += 'Integrated Security = SSPI;'

				IF ISNULL(@windows_auth_user_id,'') <> ''
					BEGIN
						SET @proxy_id = 'SQLETL_EDIS_PROXY_'+REPLACE(@windows_auth_user_id,'\','_')

						DECLARE @ret_cd int
						EXEC @ret_cd = EDIS.isp_setup_proxy_id @login_nm = @windows_auth_user_id 
							, @login_pwd = @windows_auth_password  
							, @proxy_id = @proxy_id

						if @ret_cd <> 0 
							BEGIN
								declare @ret_err_msg varchar(8000) = Error_Message()
								raiserror(@ret_err_msg, 16,16) with nowait;
								return 16
							END

					END
			END
		ELSE
			BEGIN
				SET @cn_str += 'User Id = '+@sql_auth_user_id+'; Password = '+@sql_auth_password+';'
			END

		
		DECLARE @args XML = (
			SELECT
				 'DB_CONN' as service_type
				,@cn_str AS cn_str
				,'OLEDB' AS server_provider
				,'MSSQL' AS server_platform
				,@use_integrated_security AS use_integrated_security
				,@proxy_id AS proxy_id
			FOR XML PATH ('EDIS_SVC_CONFIG')

		)

		-- Encrypt Credentials

		DECLARE @args_enc VARBINARY(MAX)

		open symmetric key [SQLETL_EDIS_SKEY]
			decryption by certificate [SQLETL_EDIS_CERT]
		set @args_enc = ENCRYPTBYKEY(KEY_GUID('SQLETL_EDIS_SKEY'),CAST(@args AS NVARCHAR(MAX)))
		close symmetric key [SQLETL_EDIS_SKEY]

		IF NOT EXISTS(SELECT 1 FROM edis.lkup_service_id WHERE service_id = @server_id)
			BEGIN
				INSERT edis.lkup_service_id (service_id, last_upd_ts, service_type, service_config)
				SELECT @server_id, GETDATE(), 'DB_CONN', @args_enc

				set @msg = 'SQL Connection ['+@server_id+'] added'
			END
		ELSE
			BEGIN
				UPDATE edis.lkup_service_id
					SET service_config = @args_enc, last_upd_ts = GETDATE(), service_type = 'DB_CONN'
				WHERE service_id = @server_id
				set @msg = 'SQL Connection ['+@server_id+'] updated'
			END

		if @use_integrated_security = 0 
			BEGIN
				DECLARE @err_msg nvarchar(max) = null
				print 'validating connection'
				EXEC EDIS.isp_validate_db_conn
					@cn_str, 'oledb', @err_msg = @err_msg out
				;

				if @err_msg is not null
					BEGIN
						DECLARE @user_msg nvarchar(max) = 'There was an error attempting to validate the connection for ['+@server_id+'].'+char(13)+char(10)
						set @user_msg += 'Error Message: '+char(13)+char(10)+@err_msg
						RAISERROR(@user_msg, 16, 16) with nowait;
						return 16;
					END
				print 'Validation Complete. Connected Successfully'
			END
		
		print @msg

	GO

	--{INSTALL_STEP}Create proc usp_config_db_conn_msolap{/INSTALL_STEP}

	CREATE PROC EDIS.usp_config_db_conn_msolap
		 @server_id NVARCHAR(255)
		,@server_instance NVARCHAR(255)
		,@default_cube NVARCHAR(255) 
		,@use_integrated_security BIT 
		,@sql_auth_user_id NVARCHAR(255) = ''
		,@sql_auth_password NVARCHAR(1000) = ''
		,@windows_auth_user_id NVARCHAR(255) = ''
		,@windows_auth_password NVARCHAR(1000) = ''
		WITH ENCRYPTION
	AS
		SET NOCOUNT ON;


		Declare @msg varchar(max)

		DECLARE @cn_str NVARCHAR(MAX) = 
			'Provider = MSOLAP; Data Source = '+@server_instance+'; Initial Catalog = '+@default_cube+'; '
		

		DECLARE @proxy_id NVARCHAR(255) = ''

		IF @use_integrated_security = 1
			BEGIN
				SET @cn_str += 'Integrated Security = SSPI;'

				IF ISNULL(@windows_auth_user_id,'') <> ''
					BEGIN
						SET @proxy_id = 'SQLETL_EDIS_PROXY_'+REPLACE(@windows_auth_user_id,'\','_')

						DECLARE @ret_cd int
						EXEC @ret_cd = EDIS.isp_setup_proxy_id @login_nm = @windows_auth_user_id 
							, @login_pwd = @windows_auth_password  
							, @proxy_id = @proxy_id

						if @ret_cd <> 0 
							BEGIN
								declare @ret_err_msg varchar(8000) = Error_Message()
								raiserror(@ret_err_msg, 16,16) with nowait;
								return 16
							END

					END
			END
		ELSE
			BEGIN
				SET @cn_str += 'User Id = '+@sql_auth_user_id+'; Password = '+@sql_auth_password+';'
			END

		
		DECLARE @args XML = (
			SELECT
				 'DB_CONN' as service_type
				, @cn_str AS cn_str
				,'ADO.NET' AS server_provider -- SSAS needs to use ado.net connection or it has issues querying the data
				,'OLEDB' AS server_sub_provider
				,'MSOLAP' AS server_platform
				,@use_integrated_security AS use_integrated_security
				,@proxy_id AS proxy_id
			FOR XML PATH ('EDIS_SVC_CONFIG')

		)

		-- Encrypt Credentials

		DECLARE @args_enc VARBINARY(MAX)

		open symmetric key [SQLETL_EDIS_SKEY]
			decryption by certificate [SQLETL_EDIS_CERT]
		set @args_enc = ENCRYPTBYKEY(KEY_GUID('SQLETL_EDIS_SKEY'),CAST(@args AS NVARCHAR(MAX)))
		close symmetric key [SQLETL_EDIS_SKEY]

		IF NOT EXISTS(SELECT 1 FROM edis.lkup_service_id WHERE service_id = @server_id)
			BEGIN
				INSERT edis.lkup_service_id (service_id, last_upd_ts, service_type, service_config)
				SELECT @server_id, GETDATE(), 'DB_CONN', @args_enc

				set @msg = 'SSAS Connection ['+@server_id+'] added'
			END
		ELSE
			BEGIN
				UPDATE edis.lkup_service_id
					SET service_config = @args_enc, last_upd_ts = GETDATE(), service_type = 'DB_CONN'
				WHERE service_id = @server_id
				set @msg = 'SSAS Connection ['+@server_id+'] updated'
			END

		if @use_integrated_security = 0 
			BEGIN
				DECLARE @err_msg nvarchar(max) = null
				EXEC EDIS.isp_validate_db_conn
					@cn_str, 'oledb', @err_msg = @err_msg out
				;

				if @err_msg is not null
					BEGIN
						DECLARE @user_msg nvarchar(max) = 'There was an error attempting to validate the connection for ['+@server_id+'].'+char(13)+char(10)
						set @user_msg += 'Error Message: '+char(13)+char(10)+@err_msg
						RAISERROR(@user_msg, 16, 16) with nowait;
						return 16;
					END
			END
		
		print @msg

	GO

	-- ====================================================================================================================================
	-- Convert Old Server ID accounts

	--{INSTALL_STEP}Convert old server IDs to service IDs{/INSTALL_STEP}

	IF EXISTS(SELECT 1 FROM SYS.TABLES WHERE NAME = 'lkup_server_id' and schema_Name(schema_id) = 'EDIS')
		BEGIN
			
			BEGIN TRY
				
				BEGIN TRAN

					IF OBJECT_ID('tempdb..#edis') IS NOT NULL DROP TABLE #edis;

					SELECT CAST(s.server_id AS NVARCHAR(250)) AS service_id
						,CAST('DB_CONN' AS NVARCHAR(250)) AS service_type
						,CAST((SELECT 
								'DB_CONN' AS service_type
								,server_provider 
								,ISNULL(server_sub_provider,'') AS server_sub_provider
								,server_platform
								,CONVERT(NVARCHAR(MAX), DECRYPTBYKEYAUTOCERT(CERT_ID('SQLETL_EDIS_CERT'),NULL, cn_str)) AS cn_str
							FROM SSISDB.edis.lkup_server_id
							WHERE server_id = s.server_id
							FOR XML PATH ('EDIS_SVC_CONFIG')
						) AS XML) AS config_xml
						,CAST(NULL AS VARBINARY(MAX)) AS service_config
					INTO #edis
					FROM SSISDB.edis.lkup_server_id AS s
					;

					open symmetric key [SQLETL_EDIS_SKEY]
						decryption by certificate [SQLETL_EDIS_CERT]

					UPDATE #EDIS
						set service_config = ENCRYPTBYKEY(KEY_GUID('SQLETL_EDIS_SKEY'),CAST(config_xml AS NVARCHAR(MAX)))

					close symmetric key [SQLETL_EDIS_SKEY]

					INSERT SSISDB.EDIS.lkup_service_id (service_id, last_upd_ts, service_type, service_config)
					SELECT tmp.service_id, getdate(), tmp.service_type, tmp.service_config
					FROM #edis as tmp
						left join SSISDB.EDIS.lkup_service_id as tgt
							on tmp.service_id = tgt.service_id
					WHERE tgt.service_id is null
					;

					DROP TABLE SSISDB.edis.lkup_server_id;

					DROP TABLE #edis

				COMMIT TRAN;

			END TRY
			BEGIN CATCH
				ROLLBACK TRAN;
				RAISERROR('Error converting EDIS legacy server IDs to service IDs', 16, 16) with nowait;
			END CATCH

		END
	GO

	--{INSTALL_STEP}Install Proc usp_merge{/INSTALL_STEP}
	
CREATE PROCEDURE EDIS.[usp_merge]
        @target NVARCHAR(1000)
       ,@source NVARCHAR(1000)
       ,@delete_no_match BIT = 0
       ,@allow_identity_insert bit = 0
       ,@target_sub_qry NVARCHAR(MAX) = ''
       ,@target_key_cols nvarchar(max) = ''
       ,@print_merge_statement bit = 0
	   ,@rows_affected int = null out
	   ,@rows_inserted int = null out
	   ,@rows_updated int = null out
	   ,@rows_deleted int = null out
	   WITH ENCRYPTION
AS
BEGIN

       SET NOCOUNT ON;
       SET XACT_ABORT ON;

	   declare @step nvarchar(250)

       BEGIN TRY
			declare @start_ts datetime2 = getdate();


              DECLARE 
                      @sql NVARCHAR(MAX)
                     ,@params NVARCHAR(MAX)
                     ,@db_exists bit
                     ,@schema_exists BIT
                     ,@tbl_exists BIT
                     ,@msg VARCHAR(MAX)
                     ,@crlf CHAR(2) = CHAR(13)+CHAR(10)


              -------------------------------------------------------
              -- Parse schemas, dbs, and tables

              DECLARE 
                      @tgt_db             VARCHAR(255)
                     ,@tgt_schema  VARCHAR(255)
                     ,@tgt_tbl            VARCHAR(255)
                     ,@src_db             VARCHAR(255)
                     ,@src_schema  VARCHAR(255)
                     ,@src_tbl            VARCHAR(255)
                     ,@tgt_object_id INT
                     ,@src_object_id INT
                     ,@tgt_full_path VARCHAR(1000)
                     ,@src_full_path VARCHAR(1000)
                     ,@base_object_nm VARCHAR(1000)
              ;

              -- Did the user provide a target sub query to speed up the load?
              DECLARE @using_target_sub_qry BIT = 0
              IF ISNULL(LTRIM(RTRIM(@target_sub_qry)),'') <> '' SET @using_target_sub_qry = 1


              -- Validate Target Subquery Syntax
              IF @using_target_sub_qry = 1
                     BEGIN
              
                           IF exists(select 1 from sys.dm_exec_describe_first_result_set(@target_sub_qry, NULL, 0) where error_message is not NULL)
                                  BEGIN
                                  
                                         DECLARE @tgt_sub_qry_err_msg VARCHAR(MAX) = CONCAT(
                                                'The source query provided by parameter @target_sub_qry has a syntax issue. Below is the error statement',@crlf
                                                ,'Error Message',@crlf
                                                ,'-------------',@crlf,@crlf
                                                ,(select top 1 error_message 
                                                FROM sys.dm_exec_describe_first_result_set(@target_sub_qry, NULL, 0) where error_message is not NULL)
                                         )

                                         --set @sql_err_msg = (select top 1 error_message from #qry_meta)
                                         raiserror(@tgt_sub_qry_err_msg, 16,16) with nowait;
                                         return 16

                                  END


                     END

			set @step = 'ended syntax validation for subquery'
              -- ==========================================================================================================================
              -- Evaluate Target
              
              -- temp table handler
              IF LEFT(PARSENAME(@target,1),1) = '#'
                     BEGIN
                           SET @tgt_db = 'tempdb'
                           SET @tgt_schema = 'dbo'
                           SET @tgt_tbl = PARSENAME(@target,1)

                           SET @tgt_full_path = CONCAT('[',@tgt_db,'].[',@tgt_schema,'].[',@tgt_tbl,']')
                           SET @tgt_object_id = OBJECT_ID(@tgt_full_path,'U');

                           IF @tgt_object_id IS NULL
                                  BEGIN
                                         RAISERROR('Target temporary table [%s] does not exist!', 16, 16, @tgt_tbl) WITH NOWAIT;
                                         RETURN 16
                                  END

                     END
              ELSE
                     BEGIN

                           -- target db
                           SET @tgt_db = PARSENAME(@target,3)
                           IF DB_ID(@tgt_db) IS NULL
                                  BEGIN
                                         RAISERROR('Target Database [%s] does not exist! For non-temporary tables, parameter @target must be a fully qualified path i.e. [database].[schema].[table].', 16, 16, @tgt_db) WITH NOWAIT;
                                         RETURN 16
                                  END

                           -- target schema
                           IF CHARINDEX('..',@target) > 0
                                  BEGIN
                                         SET @tgt_schema = 'dbo'
                                  END
                           ELSE
                                  BEGIN
                                         SET @tgt_schema = PARSENAME(@target,2)

                                         SET @sql = N'SELECT @schema_exists = isnull((SELECT 1 FROM ['+@tgt_db+'].sys.schemas where name = @tgt_schema),0)'
                                         SET @params = N'@schema_exists bit out, @tgt_schema varchar(255)'
                                         EXEC sp_executesql @sql, @params, @schema_exists = @schema_exists OUT, @tgt_schema = @tgt_schema

                                         IF @schema_exists = 0
                                                BEGIN
                                                       RAISERROR('Target Schema [%s] does not exist!', 16, 16, @tgt_schema) WITH NOWAIT;
                                                       RETURN 16
                                                END
                                  END

                           -- target table
                           SET @tgt_tbl = PARSENAME(@target,1)
                     
                           SET @sql = 
                                  N'
                                         SELECT @tbl_exists = isnull((
                                                       SELECT 1 
                                                       FROM ['+@tgt_db+'].sys.tables as T
                                                              INNER JOIN ['+@tgt_db+'].sys.schemas as sc
                                                                     ON t.schema_id = sc.schema_id
                                                       WHERE t.name = @tgt_tbl AND sc.name = @tgt_schema)
                                         ,0)'
                           SET @params = N'@tbl_exists bit out, @tgt_tbl varchar(255), @tgt_schema varchar(255)'
                           EXEC sp_executesql @sql, @params, @tbl_exists = @tbl_exists OUT, @tgt_tbl = @tgt_tbl, @tgt_schema = @tgt_schema

                           IF @tbl_exists = 0
                                  BEGIN
                                         -- Is this a synonym?
                                         SET @base_object_nm = NULL
                                         SET @sql = N'
                                                SELECT @base_object_nm = 
                                                       (
                                                              SELECT S.base_object_name FROM ['+@tgt_db+'].sys.synonyms AS S
                                                                     INNER JOIN ['+@tgt_db+'].sys.schemas as sc
                                                                           ON s.schema_id = sc.schema_id
                                                              WHERE S.name = @tgt_tbl AND sc.name = @tgt_schema)'
                                         SET @params = N'@base_object_nm varchar(1000) out, @tgt_tbl varchar(255), @tgt_schema varchar(255)'
                                         EXEC sp_executesql @sql, @params, @base_object_nm = @base_object_nm OUT, @tgt_tbl = @tgt_tbl, @tgt_schema = @tgt_schema;

                                         IF @base_object_nm IS NOT NULL
                                                BEGIN
                                                       SET @tgt_schema = PARSENAME(@base_object_nm,2)
                                                       SET @tgt_tbl = PARSENAME(@base_object_nm,1)

                                                       -- if synonym is cross database
                                                       IF PARSENAME(@base_object_nm,3) IS NOT NULL
                                                              SET @tgt_db = PARSENAME(@base_object_nm,3)

                                                END
                                         ELSE
                                                BEGIN
                                                       RAISERROR('Target Table [%s] does not exist!', 16, 16, @tgt_tbl) WITH NOWAIT;
                                                       RETURN 16
                                                END
                                  END

                           SET @tgt_full_path = CONCAT('[',@tgt_db,'].[',@tgt_schema,'].[',@tgt_tbl,']')
                           SET @tgt_object_id = OBJECT_ID(@tgt_full_path,'U');
                     END


				set @step = 'ended evaluating target table'
              -- ==========================================================================================================================
              -- Evaluate Source
               
       
              SET @schema_exists = NULL;
              SET @tbl_exists = NULL;

              -- temp table handler
              IF LEFT(PARSENAME(@source,1),1) = '#'
                     BEGIN
                           SET @src_db = 'tempdb'
                           SET @src_schema = 'dbo'
                           SET @src_tbl = PARSENAME(@source,1)

                           SET @src_full_path = CONCAT('[',@src_db,'].[',@src_schema,'].[',@src_tbl,']')
                           SET @src_object_id = OBJECT_ID(@src_full_path,'U');

                           IF @src_object_id IS NULL
                                  BEGIN
                                         RAISERROR('Source temporary table [%s] does not exist!', 16, 16, @src_tbl) WITH NOWAIT;
                                         RETURN 16
                                  END
                     END
              ELSE
                     BEGIN
                     
                           -- db
                           SET @src_db = PARSENAME(@source,3)
                           IF DB_ID(@src_db) IS NULL
                                  BEGIN
                                         RAISERROR('Source Database [%s] does not exist! For non-temporary tables, parameter @source must be a fully qualified path i.e. [database].[schema].[table].', 16, 16, @src_db) WITH NOWAIT;
                                         RETURN 16
                                  END

                           -- schema
                           IF CHARINDEX('..',@source) > 0
                                  BEGIN
                                         SET @src_schema = 'dbo'
                                  END
                           ELSE
                                  BEGIN
                                         SET @src_schema = PARSENAME(@source,2)

                                         SET @sql = N'SELECT @schema_exists = isnull((SELECT 1 FROM ['+@src_db+'].sys.schemas where name = @src_schema),0)'
                                         SET @params = N'@schema_exists bit out, @src_schema varchar(255)'
                                         EXEC sp_executesql @sql, @params, @schema_exists = @schema_exists OUT, @src_schema = @src_schema

                                         IF @schema_exists = 0
                                                BEGIN
                                                       RAISERROR('Source Schema [%s] does not exist!', 16, 16, @src_schema) WITH NOWAIT;
                                                       RETURN 16
                                                END
                                  END

                           -- table
                           SET @src_tbl = PARSENAME(@source,1)
                           --PRINT @src_schema
                           --PRINT @src_tbl
                           SET @sql = 
                                                N'
                                                       SELECT @tbl_exists = isnull((
                                                                     SELECT 1 
                                                                     FROM ['+@src_db+'].sys.tables as T
                                                                           INNER JOIN ['+@src_db+'].sys.schemas as sc
                                                                                  ON t.schema_id = sc.schema_id
                                                                     WHERE  t.name = @src_tbl AND sc.name = @src_schema)
                                                       ,0)'
                           --PRINT @sql
                           SET @params = N'@tbl_exists bit out, @src_tbl varchar(255), @src_schema varchar(255)'
                           EXEC sp_executesql @sql, @params, @tbl_exists = @tbl_exists OUT, @src_tbl = @src_tbl, @src_schema = @src_schema

                           IF @tbl_exists = 0
                                  BEGIN
                                         -- Is this a synonym?
                                         SET @base_object_nm = NULL
                                         SET @sql = N'
                                                SELECT @base_object_nm = 
                                                       (
                                                              SELECT S.base_object_name FROM ['+@src_db+'].sys.synonyms AS S
                                                                     INNER JOIN ['+@src_db+'].sys.schemas as sc
                                                                           ON s.schema_id = sc.schema_id
                                                              WHERE S.name = @src_tbl AND sc.name = @src_schema)
                                                '
                                         SET @params = N'@base_object_nm varchar(1000) out, @src_tbl varchar(255), @src_schema varchar(255)'
                                         EXEC sp_executesql @sql, @params, @base_object_nm = @base_object_nm OUT, @src_tbl = @src_tbl, @src_schema = @src_schema;

                                         IF @base_object_nm IS NOT NULL
                                                BEGIN
                                                       SET @src_schema = PARSENAME(@base_object_nm,2)
                                                       SET @src_tbl = PARSENAME(@base_object_nm,1)

                                                       -- if synonym is cross database
                                                       IF PARSENAME(@base_object_nm,3) IS NOT NULL
                                                              SET @src_db = PARSENAME(@base_object_nm,3)

                                                END
                                         ELSE
                                                BEGIN
                                                       RAISERROR('Source Table [%s] does not exist!', 16, 16, @src_tbl) WITH NOWAIT;
                                                       RETURN 16
                                                END
                                  END

                           SET @src_full_path = CONCAT('[',@src_db,'].[',@src_schema,'].[',@src_tbl,']')
                           SET @src_object_id = OBJECT_ID(@src_full_path,'U');
                     END

				set @step = 'ended evaluating source table'

              -- ======================================================================
              -- Load Table Catalog

              declare @tbl_cat as table (col_nm varchar(250), ord_pos smallint, is_pk bit, pk_ord_pos smallint, exists_in_src bit, is_identity bit
				,is_nullable bit)
				;

              set @sql = 
                     '
                           select c.name, c.column_id
                                  ,case when ic.index_column_id is not null then 1 else 0 end as is_pk
                                  ,ic.key_ordinal as pk_ord_pos
                                  ,case when src.name is not null then 1 else 0 end as exists_in_src
                                  ,c.is_identity
								  ,c.is_nullable
                           from ['+@tgt_db+'].sys.columns as c with (nolock)
                                  left join ['+@tgt_db+'].sys.indexes as i with (nolock)
                                         on c.object_id = i.object_id and i.is_primary_key = 1 
                                  left join ['+@tgt_db+'].sys.index_columns as ic with (nolock)
                                         on i.object_id = ic.object_id and i.index_id = ic.index_id and c.column_id = ic.column_id
                                  left join (
                                                select name from ['+@src_db+'].sys.columns with (nolock) where object_id = '+cast(@src_object_id as varchar(50))+'
                                         ) as src
                                                on c.name = src.name
                           where c.object_id = '+cast(@tgt_object_id as varchar(50))+'
                     '
              ;

              --print @sql

              insert @tbl_cat (col_nm, ord_pos, is_pk, pk_ord_pos, exists_in_src, is_identity, is_nullable)
              exec(@sql);

			  set @step = 'table catalog loaded'

			   declare @src_cols_no_match as table (col_nm nvarchar(255));

			  set @sql = 
				'
					SELECT src.name
                    from ['+@src_db+'].sys.columns as src with (nolock)
						LEFT JOIN ['+@tgt_db+'].sys.columns as tgt with (nolock)
							on src.name = tgt.name and tgt.object_id = '+cast(@tgt_object_id as varchar(50))+'
					WHERE 1=1
						and src.object_id = '+cast(@src_object_id as varchar(50))+'
						and tgt.name is null
                        
				'
			  ;

			  insert @src_cols_no_match
			  exec(@sql)

			  declare @src_cols_no_match_list nvarchar(max)

			  select @src_cols_no_match_list = isnull(@src_cols_no_match_list,'') + col_nm + char(13)+char(10)
			  from @src_cols_no_match
			  ;
              
			  set @step = 'source columns with no target listed'


              -- did they supply a key list
              if isnull(@target_key_cols,'') <> '' 
                     BEGIN
                           declare @key_cols as table (col_nm nvarchar(255))
                           insert @key_cols
                           select *
                           from SSISDB.EDIS.ufn_split_string(@target_key_cols,',')
                           ;

                           delete @key_cols where isnull(ltrim(rtrim(col_nm)),'') = '';


                           update cat
                                  set 
                                          cat.is_pk = 1
                                         ,cat.pk_ord_pos = cat.ord_pos
                           from @tbl_cat as cat
                                  inner join @key_cols as k
                                         on cat.col_nm = k.col_nm
                           ;

                           -- validate we did not include columns that are not in the target
                           declare @non_matched_key_cols as table (col_nm nvarchar(255))
                           insert @non_matched_key_cols
                           select k.col_nm
                           from @key_cols as k
                                  left join @tbl_cat as t
                                         on k.col_nm = t.col_nm
                           where t.col_nm is null

                           if @@ROWCOUNT > 0
                                  BEGIN

                                         declare @no_match_key_cols_list nvarchar(max);

                                         select @no_match_key_cols_list = isnull(@no_match_key_cols_list,'') + col_nm + char(13)+char(10)
                                         from @non_matched_key_cols
                                         ;
                     

                                         set @msg = 'Parameter @target_key_cols contained the following column name(s) that are not present in the target table' + char(13)+char(10)
                                                +replicate('-',(select max(len(col_nm)) from @non_matched_key_cols))+char(13)+char(10)
                                                + @no_match_key_cols_list

                                         Raiserror(@msg, 16,16) with nowait;
                                         return 16;
                                  END

                     END

				set @step = 'target key columns asserted'
              -- ---------------------------------------------------------------------------------------
              -- Check that a primary key exists in the target

              if not exists(select 1 from @tbl_cat where is_pk = 1)
                     begin
                           set @msg = 
                                   'Error: Target Table '+@tgt_full_path+' does not contain a primary key.'+@crlf
                                  +'usp_merge requires a primary key on the target table to ensure target and source are joined correctly.'
                           raiserror(@msg,16,1) with nowait;

                           return 16;
                     END


              -- -----------------------------------------------------------------------------------------------------------------------------
              -- End Param validation

              declare 
              
                      @join_txt nvarchar(max)
                     ,@matched_txt nvarchar(max)
                     ,@unmatched_insert_txt varchar(max)
                     ,@unmatched_values_txt varchar(max)
                     ,@last_upd_ts nvarchar(30)
                     ,@existing_ci_nm nvarchar(250)
              ;

              /*
                     Merge/Upsert statements have 3 basic parts:
                     1 - The target and source table specification with join
                     2 - the matched clause (update part)
                     3 - The unmatched clause (insert part)

                     The proc below assembles a merge statement concatenating these three parts together      and then executes said merge statement


              */

              -- -------------------------------------------------------------------------------------------------
              -- Check if the target has a last_upd_ts column

              --DECLARE @tgt_has_last_upd_ts BIT 

              --if exists(select 1 from @tbl_cat where col_nm = 'last_upd_ts') 
              --     begin
              --            set @tgt_has_last_upd_ts = 1
              --     end
              --ELSE
              --     BEGIN
              --            SET @tgt_has_last_upd_ts = 0
              --     END
              --;
              -- ===================================================================================================================
              -- ===================================================================================================================
              -- [2] Build Out Merge SQL Text
                     -- consists of 3 parts
                           -- - i. Join Text
                           -- - ii. Match Text
                           -- - iii. Not Matched Text
       
              -- this spacer helps for formatting the merge text getting assembled
              declare @spacer varchar(50) = @crlf+'                                      ';

              -- ===================================================================================================================
              -- [2i]. Join Text 

              select @join_txt = isnull(@join_txt,'')
                     -- add in a break in the text to make it more readable
                     +case when ROW_NUMBER() over(order by pk_ord_pos) % 3 = 0 then @spacer else '' end
                     +' and tgt.['+col_nm+'] = src.['+col_nm+']' 
              from @tbl_cat
              where is_pk = 1
              ;

              -- trim off the first "and "
              set @join_txt = right(@join_txt,len(@join_txt) - 5);

			  set @step = 'join predicate built'

              -- ===================================================================================================================
              -- [2ii]. Matched Text

              select @matched_txt = 
                       isnull(@matched_txt,'') 
                     -- add line breaker every three recs for merge text format
                     + case when ROW_NUMBER() over(order by t.ord_pos) % 3 = 0 then @spacer else '' end
                     +', tgt.['+t.col_nm+'] = src.['+t.col_nm+']'
              from @tbl_cat as t
              where t.is_pk <> 1 and  exists_in_src = 1 and t.is_identity = 0 -- do not allow updating an identity column
              order by t.ord_pos
              ;

              -- trim off the leading spaces & breaker
              set @matched_txt = right(@matched_txt,len(@matched_txt) -2);
       
              -- if a last_upd_ts column exists, tack it on the end of the update
              --if @tgt_has_last_upd_ts = 1 begin
              
              --     -- if we don't have any columns other than the last upd ts (all columns in source are PK's)
              --     IF @matched_txt      IS NULL
              --            SET @matched_txt = 'tgt.[last_upd_ts] = @now'
              --     ELSE
              --            SET @matched_txt = @matched_txt + ', tgt.[last_upd_ts] = @now';
              --END

			  set @step = 'matched clause built'

              -- ===================================================================================================================
              -- [2iii]. Not Matched Text
       
              select @unmatched_insert_txt = 
                     isnull(@unmatched_insert_txt,'')
                     -- add line breaker every three recs for merge text format
                     + case when ROW_NUMBER() over(order by t.ord_pos) % 6 = 0 then @spacer else '' end
                     + ', ['+t.col_nm+']'
              from @tbl_cat as t
              where exists_in_src = 1 
                     and is_identity = 0
              order by t.ord_pos
              ;

              -- if we are allowing identity insert
              if isnull(@allow_identity_insert,0) = 1
                     BEGIN
                           select @unmatched_insert_txt = 
                                  isnull(@unmatched_insert_txt,'')
                                  -- add line breaker every three recs for merge text format
                                  + case when ROW_NUMBER() over(order by t.ord_pos) % 6 = 0 then @spacer else '' end
                                  + ', ['+t.col_nm+']'
                           from @tbl_cat as t
                           where exists_in_src = 1 
                                  and is_identity = 1
                           order by t.ord_pos
                     END


              -- trim off the leading spaces & breaker
              set @unmatched_insert_txt = right(@unmatched_insert_txt,len(@unmatched_insert_txt) - 2);

              set @unmatched_values_txt = replace(@unmatched_insert_txt, '[','src.[');

              -- add last_upd_ts if exists
              --if @tgt_has_last_upd_ts = 1 
              --     begin  
              --            SET @unmatched_insert_txt = @unmatched_insert_txt + ', [last_upd_ts]';
              --            SET @unmatched_values_txt = @unmatched_values_txt + ', @now';
              --     END

			  set @step = 'unmatched clause built'
       
              -- ====================================================================================================================
              -- [3] Optimize the temp table to prepare for Upsert

              -- If the source is a not a temp table, we will create/drop the index afer the merge is complete

              DECLARE @is_index_temp BIT = IIF(@src_db <> 'tempdb',1,0)


              -- Determine index type needed
              DECLARE @index_type VARCHAR(30) = 'NONCLUSTERED'

              -- how many rows are we dealing with?
       
              -- declare @source_tbl nvarchar(250) = '##dfs_facts_dly_delv_stats', @index_type varchar(30)
              IF OBJECT_ID('tempdb..#src_rows') IS NOT NULL DROP TABLE #src_rows;

              CREATE TABLE #src_rows (nm NVARCHAR(250), row_cnt BIGINT, reserved VARCHAR(250), data VARCHAR(250), index_size VARCHAR(250), unused VARCHAR(250));

              INSERT #src_rows 
              EXEC('['+@src_db+']..sp_spaceused ''['+@src_schema+'].['+@src_tbl+']''')
       

              -- if the source has more than a million rows, lets check to see if we can impliment a clustered index
              IF (SELECT row_cnt FROM #src_rows) > 1000000
                     BEGIN
                           DECLARE @src_has_cli BIT = 0

                           SET @sql = N'SELECT @src_has_cli = isnull((SELECT 1 FROM ['+@src_db+'].sys.indexes where object_id = @src_object_id
                                                                                                       and type_desc = ''CLUSTERED''),0)'
                           SET @params = N'@src_has_cli bit out, @src_object_id int';

                           EXEC sp_executesql @sql, @params, @src_has_cli = @src_has_cli OUT, @src_object_id = @src_object_id;

                           IF @src_has_cli = 0
                                  SET @index_type = 'CLUSTERED'
                     END

              DROP TABLE #src_rows;

			  set @step = 'temporary index type determined'

              -- index create statement
              DECLARE @index_nm VARCHAR(50) = cast(newid() as varchar(50))
			  	
              set @sql = 
                     '
                           CREATE UNIQUE '+@index_type+' INDEX ['+@index_nm+'] ON '
							+ case when @src_db = 'tempdb' then '['+@src_tbl+']' else '['+@src_schema+'].['+@src_tbl+']'  end
                                  +' ('+stuff((select ', ['+col_nm+']' from @tbl_cat where is_pk = 1 order by pk_ord_pos for xml path ('')),1,2,'')+')';
              ;
       
              IF @src_db <> 'tempdb'
                     BEGIN
        
                           SET @sql = '
                                  USE ['+@src_db+'];
                                  '+@sql
              END

              
       
              -- add covering clause for nonclustered
              IF @index_type = 'NONCLUSTERED'
                     BEGIN
                           declare @cover_clause varchar(max) = '('+stuff(
                                  (
                                         select ', ['+t.col_nm+']'
                                         from @tbl_cat as t
                                         where 1=1
                                                --and t.col_nm <> 'last_upd_ts'
                                                and t.is_pk <> 1
                                                and exists_in_src = 1
                                         order by t.ord_pos 
                                  for xml path ('')),1,2,'')+')'
                     
                           ;


							IF ISNULL(@cover_clause,'') <> ''
							BEGIN
								set @sql = @sql + ' INCLUDE '+@cover_clause;
							END


                           --set @sql = @sql + ' INCLUDE '+@cover_clause;

                     END
                     
              begin try
				
    
                     exec(@sql);
					
					set @step = 'temporary index created'

              END TRY
              BEGIN CATCH

                     DECLARE @index_crt_err_msg VARCHAR(MAX) = ERROR_MESSAGE();

					 if charindex('The CREATE UNIQUE INDEX statement terminated because a duplicate key', @index_crt_err_msg) > 0
						begin

							declare @dups_sql varchar(max)
							declare @tmp_key_cnt int

							declare @tmp_on_clause varchar(max), @gtt varchar(250), @tmp_keys varchar(max);

							set @tmp_keys = stuff((select ', ['+col_nm+']' from @tbl_cat where is_pk = 1 order by pk_ord_pos for xml path ('')),1,2,'')
							set @tmp_key_cnt = (select count(*) from @tbl_cat where is_pk = 1)

							set @tmp_on_clause = 'on '+stuff((select 'and tmp.['+col_nm+'] = dups.['+col_nm+'] ' from @tbl_cat where is_pk = 1 order by pk_ord_pos for xml path ('')),1,3,'')

							set @gtt = '##'+cast(replace(newid(),'-','_') as varchar(250));

							-- isolate dups to global temp
							set @dups_sql = 
								'
									select tmp.*
									into ['+@gtt+']
									from '
										+case
											when @src_db = 'tempdb' then @src_tbl
											else @src_full_path
										end+' as tmp
										inner join (
											select '+@tmp_keys+'
											from '
												+case
													when @src_db = 'tempdb' then @src_tbl
													else @src_full_path
												end+'
											group by '+@tmp_keys+'
											having count(*) >=2
										) as dups
											'+@tmp_on_clause
							;

							exec(@dups_sql);

							declare @dup_recs int = @@rowcount;

							set @step = 'duplicates counted'

							-- to force sort
							--EXEC('create clustered index c on ['+@gtt+'] ('+@tmp_keys+')')

							declare @gtt2 nvarchar(255) = concat('##',newid())

							declare @dups_sql_sample nvarchar(max) = 'select top 2 * INTO ['+@gtt2+'] from ['+@gtt+'] ORDER BY '+@tmp_keys;
							exec(@dups_sql_sample)

							set @dups_sql_sample = 'SELECT * FROM ['+@gtt2+']'

							set @step = 'top 2 duplicates isolated'

							-- get the dup rows printout
							--declare @dup_rows nvarchar(max) = SSISDB.edis.ifn_format_qry_as_text(@dups_sql_sample)
							-- dont show this..too long

							declare @dups_non_key_cols_sample_txt nvarchar(max) = ''

							declare @found_dup_non_key_recs bit = 0

							declare @curr_col nvarchar(255); 
							declare @examples_found_cnt int = 0;
							declare cs_looper cursor local fast_forward
								for
									select col_nm
									from @tbl_cat
									where exists_in_src = 1
										and is_pk = 0
								open cs_looper
								fetch next from cs_looper into @curr_col;
								while @@fetch_status = 0
									begin
										declare @sql_dups_non_key nvarchar(max) = 
											N'
												IF EXISTS(
													SELECT '+@tmp_keys+'
													FROM ['+@gtt2+']
													GROUP BY  '+@tmp_keys+'
													HAVING COUNT(DISTINCT ISNULL('+@curr_col+','''')) >=2
												)
													SET @has_dup = 1
												else
													SET @has_dup = 0
											'
										;
									  declare @col_has_dup bit = 0;
									  exec sp_executesql @sql_dups_non_key, N'@has_dup bit out', @has_dup = @col_has_dup out;

									  --print @col_has_dup;

									  if @col_has_dup = 1
										begin
											declare @dup_non_key_cols_msg nvarchar(max) = NULL;
											set @sql_dups_non_key = 
												'
													SELECT @dup_non_key_cols_msg = 
														isnull(@dup_non_key_cols_msg+'', '','''') 
															+
																CASE 
																	WHEN '+@curr_col+' IS NULL THEN ''NULL''
																	ELSE cast('+@curr_col+' as nvarchar(max))
																END
													FROM ['+@gtt2+']
												'
											;
											exec sp_executesql @sql_dups_non_key, N'@dup_non_key_cols_msg nvarchar(max) out', @dup_non_key_cols_msg = @dup_non_key_cols_msg out;

											set @dups_non_key_cols_sample_txt += 'Non-Key Column ['+@curr_col+'] Conflicting Values: ('+ @dup_non_key_cols_msg + ')'+ char(13)+char(10)

											set @found_dup_non_key_recs = 1
											set @examples_found_cnt +=1

											-- dont show more than 3 examples since the print statement is limited
											if @examples_found_cnt >=3 break;

											

										END

										

										fetch next from cs_looper into @curr_col;
									end
								;
								close cs_looper
								deallocate cs_looper
							
							;

							declare @gtt3 nvarchar(255) = concat('##',newid());

							set @sql = 
								'SELECT DISTINCT '+@tmp_keys+'
								into ['+@gtt3+']
								FROM ['+@gtt2+']
							'
							;

							exec(@sql);

							declare @tmp_key_vals nvarchar(max) --= SSISDB.edis.ifn_format_qry_as_text(@prim_key_cols_sql);

							-- if one col, no need to concat
							if (select count(col_nm) from @tbl_cat where is_pk = 1) = 1
								begin
									set @sql = N'set @tmp_key_vals = (SELECT CAST('+@tmp_keys+' as nvarchar(max)) FROM ['+@gtt3+'])';
								end
                            else
								begin
									set @sql = N'set @tmp_key_vals = (SELECT CONCAT('+replace(@tmp_keys,',',', '', '',')+') FROM ['+@gtt3+'])';
								end
							--print @sql

							
				
							exec sp_executesql @sql, N'@tmp_key_vals nvarchar(max) out', @tmp_key_vals = @tmp_key_vals out;

							exec('DROP TABLE ['+@gtt+']');
							exec('DROP TABLE ['+@gtt2+']');
							exec('DROP TABLE ['+@gtt3+']');

							declare @dups_msg nvarchar(max);

							if @found_dup_non_key_recs = 1
								begin
									
									set @step = 'creating duplicates message on non key recs'

									set @dups_msg =  
										 'Duplicate Rows Detected'+char(13)+char(10)
										 +'Below is an example where source table '
											+case when left(@src_tbl,1) = '#' then @src_tbl else @src_full_path end+' had 2 rows with the same key columns and different non-key values.'+char(13)+char(10)
										 +'Please address before re-submitting.'+char(13)+char(10)+char(13)+char(10)
										 +'-------------------------------------'+char(13)+char(10)
										 +'Primary Key Column Name(s): ('+@tmp_keys+')'+char(13)+char(10)
										 +'Primary Key Value(s) duplicated: ('+@tmp_key_vals+')'+char(13)+char(10)+char(13)+char(10)
										 +'Sample Non-Key Column Value(s) That Differ'+char(13)+char(10)
										 +'---------------------------------'+char(13)+char(10)
										 +@dups_non_key_cols_sample_txt
								end
                            else
								begin

									set @step = 'creating duplicates message on same key cols'

									set @dups_msg = 'Duplicate Rows Detected'+char(13)+char(10)
										+'Below is an example where source table '
											+case when left(@src_tbl,1) = '#' then @src_tbl else @src_full_path end+' had 2 rows with the same key columns.'+char(13)+char(10)
										+'Please address before re-submitting.'+char(13)+char(10)
										+'-------------------------------------'+char(13)+char(10)
										+'Primary Key Column Name(s): ('+@tmp_keys+')'+char(13)+char(10)
										+'Primary Key Value(s) duplicated: ('+@tmp_key_vals+')'+char(13)+char(10)
										+'Suggested Fix: Use the keyword DISTINCT to collapse the duplicate rows in your source table'
								end
							
							raiserror(@dups_msg,16,16) with nowait;
							return 16;

						end
                    else
						begin
							
							set @step = 'unknown dups error message'

							 set @msg = concat('Error attempting to create unique index on table '+@src_full_path+' during the usp_merge task',@crlf
									,'Error Message: ',@index_crt_err_msg)
							 raiserror(@msg,16,16);
							 RETURN 16
						END
              END CATCH



              -- =====================================================================================================================
              -- [4] Assemble Merge command

              -- If the target does not have any rows, we will do a straight insert
              -- if it has rows, we run a merge

              IF OBJECT_ID('tempdb..#tgt_rows') IS NOT NULL DROP TABLE #tgt_rows;

              CREATE TABLE #tgt_rows (nm NVARCHAR(250), row_cnt BIGINT, reserved VARCHAR(250), data VARCHAR(250), index_size VARCHAR(250), unused VARCHAR(250));

              INSERT #tgt_rows 
              EXEC('['+@tgt_db+']..sp_spaceused ''['+@tgt_schema+'].['+@tgt_tbl+']''')

              -- does target have rows?
              DECLARE @is_target_empty BIT = 0
              IF (SELECT row_cnt FROM #tgt_rows) = 0
                     SET @is_target_empty = 1
              ;


              -- if source is tempdb...no need to reference it
              DECLARE @merge_source_tbl VARCHAR(1000);
              IF @src_db = 'tempdb'
                     SET @merge_source_tbl = '['+@src_tbl+']'
              ELSE
                     SET @merge_source_tbl = '['+@src_db+'].['+@src_schema+'].['+@src_tbl+']'
              ;

				-- tracks rows inserted/updated/deleted
			  IF OBJECT_ID('tempdb..#res_set') IS NOT NULL DROP TABLE #res_set;
			  create table #res_set (act nvarchar(10));

			  declare @using_merge bit = 1

			    -- If the target is empty, do a straight insert
              IF @is_target_empty = 1 OR @delete_no_match = 1
                     BEGIN
						set @using_merge = 0
                           SET @sql = CONCAT(
                                  '
								   USE ['+@tgt_db+'];

								   ',

								   IIF(@allow_identity_insert = 1, ' SET IDENTITY_INSERT ['+@tgt_schema+'].['+@tgt_tbl+'] ON; ',''),'

								   ',

								   -- if we are using the @delete_no_match, then truncate the table for efficiency
								   IIF(@delete_no_match = 1,
										  'TRUNCATE TABLE ['+@tgt_db+'].['+@tgt_schema+'].['+@tgt_tbl+']'
										  ,''
								   ),
								   '
                                         
                                         
								   INSERT ['+@tgt_db+'].['+@tgt_schema+'].['+@tgt_tbl+'] WITH (TABLOCK) 
								   (
										  '+@unmatched_insert_txt+'
								   )
								   SELECT '+@unmatched_values_txt+'
								   FROM '+@merge_source_tbl+' AS SRC
									'
                           )

                     END
              ELSE
                     BEGIN
                           set @sql = concat(
						'
						  USE ['+@tgt_db+'];',

						  IIF(@allow_identity_insert = 1, ' SET IDENTITY_INSERT ['+@tgt_schema+'].['+@tgt_tbl+'] ON; ',''),'

						  ',
						  CASE WHEN @using_target_sub_qry = 1 
								 THEN ';WITH TGT AS ('+@target_sub_qry+') MERGE TGT'
								 WHEN @tgt_db = 'tempdb' then 'MERGE ['+@tgt_tbl+'] WITH (TABLOCK) AS TGT '
								 ELSE 'MERGE ['+@tgt_db+'].['+@tgt_schema+'].['+@tgt_tbl+'] WITH (TABLOCK) AS TGT '
						  END,
								 '
								 USING '+@merge_source_tbl+' AS SRC WITH (TABLOCK)
									   ON '+@join_txt+'
								 WHEN MATCHED THEN UPDATE 
									   SET  
													 '+@matched_txt+'
								 WHEN NOT MATCHED BY TARGET THEN
									   INSERT (
													 '+@unmatched_insert_txt+')
									   VALUES (
													 '+@unmatched_values_txt+')
								OUTPUT $action into #res_set
						  ;

						'
                           
                           )
                     END

       
              ;

              -- run it
              BEGIN TRY
                     --print @sql

                     if @print_merge_statement = 1
                           print @sql;

                     -- need to wrap in explicit transaction since multiple dml statements now in use(truncate/insert)
                     BEGIN TRANSACTION
						   set @step = 'running merge command'
                           EXEC(@sql);

						   set @rows_affected = @@rowcount;

						   set @step = 'merge commmand executed'

							IF @using_merge = 1
								BEGIN
									set @rows_inserted = (SELECT COUNT(*) FROM #res_set WHERE act = 'INSERT');
									set @rows_updated = (SELECT COUNT(*) FROM #res_set WHERE act = 'UPDATE');
									set @rows_deleted = (SELECT COUNT(*) FROM #res_set WHERE act = 'DELETE');
								END
							ELSE
								BEGIN
									set @rows_inserted = @rows_affected
								END

						   set @step = 'rows modified assigned'

						   DROP TABLE #res_set;
						  
						   
						   declare @end_ts datetime2 = getdate();

						   -- log it
						   insert SSISDB.edis.etl_audit (exec_id, task_action, task_start_ts, task_end_ts, task_duration, task_run_outcome
								,usr_login_id, src_sys, dest_sys, rows_tsfr
								)
							values (newid(), 'USP_MERGE', @start_ts, @end_ts, datediff(second,@start_ts, @end_ts), 'SUCCESS'
								,suser_name(), @src_full_path, @tgt_full_path, @rows_affected
							)

							set @step = 'merge logged to audit'
                           
                     COMMIT TRANSACTION

                     -- Drop the index if temporary
                     IF @is_index_temp = 1
                           BEGIN
								SET @sql = 'USE ['+@src_db+']; DROP INDEX ['+@index_nm+'] ON ['+@src_schema+'].['+@src_tbl+']'
								EXEC(@sql)
                           END

					IF @src_cols_no_match_list IS NOT NULL
						BEGIN
							declare @src_cols_msg nvarchar(Max) =
								CONCAT(
								 'EDIS WARNING:'
								 ,char(13)+char(10)
								 ,'The following source columns were not merged to the target table'
								 ,char(13)+char(10)
								 ,'due to the source column not having a corresponding column in the target with the same name:'
								 ,char(13)+char(10)
								 ,'----------------------'
								 ,char(13)+char(10)
								 ,@src_cols_no_match_list
							)
							print @src_cols_msg
						END

              END TRY
              BEGIN CATCH
                     
                     IF @@TRANCOUNT > 0 
                           ROLLBACK TRANSACTION
                     ;

					 set @step = 'merge commmand failed: Transaction rolled back'

                     DECLARE @truncation_msg_cols VARCHAR(MAX), @truncation_msg_cols_found BIT = 0

                     DECLARE @sys_err_msg VARCHAR(4000) = ERROR_MESSAGE();

                     -- Truncation error handler
                     DECLARE @arithmetic_overflow_err VARCHAR(250) = 'Arithmetic overflow error for data type';
                     DECLARE @arithmetic_overflow_err2 VARCHAR(250) = 'Arithmetic overflow error converting expression to data type'
                     DECLARE @string_truncate_err VARCHAR(250) = 'String or binary data would be truncated.'


                     IF 
                              CHARINDEX(@arithmetic_overflow_err, @sys_err_msg)     > 0 
                           OR CHARINDEX(@arithmetic_overflow_err2, @sys_err_msg)    > 0 
                           OR CHARINDEX(@string_truncate_err, @sys_err_msg)         > 0 

                           BEGIN

							    set @step = 'beginning truncation error analysis'

                                IF OBJECT_ID('tempdb..#offending_columns') IS NOT NULL DROP TABLE #offending_columns;

								CREATE TABLE #offending_columns (col_nm VARCHAR(255), src_typ varchar(250), dest_typ varchar(250), is_nullable bit);

								DECLARE @truncation_sql NVARCHAR(MAX) = 
									N'
										INSERT #offending_columns (col_nm, src_typ, dest_typ, is_nullable)
										SELECT tgt_col.name AS col_nm
											,CASE
												WHEN TYPE_NAME(src_col.user_type_id) IN (''varchar'',''char'',''nvarchar'',''nchar'',''binary'',''varbinary'')
													THEN CONCAT(TYPE_NAME(src_col.user_type_id),''('',src_col.max_length,'')'')
												WHEN TYPE_NAME(src_col.user_type_id) IN (''decimal'',''numeric'') 
													THEN CONCAT(TYPE_NAME(src_col.user_type_id),''('',src_col.precision,'','',src_col.scale,'')'')
												WHEN TYPE_NAME(src_col.user_type_id) IN (''tinyint'',''smallint'',''int'',''bigint'')
													THEN TYPE_NAME(src_col.user_type_id)
											END as src_typ
											,CASE
												WHEN TYPE_NAME(tgt_col.user_type_id) IN (''varchar'',''char'',''nvarchar'',''nchar'',''binary'',''varbinary'')
													THEN CONCAT(TYPE_NAME(tgt_col.user_type_id),''('',tgt_col.max_length,'')'')
												WHEN TYPE_NAME(tgt_col.user_type_id) IN (''decimal'',''numeric'') 
													THEN CONCAT(TYPE_NAME(tgt_col.user_type_id),''('',tgt_col.precision,'','',tgt_col.scale,'')'')
												WHEN TYPE_NAME(tgt_col.user_type_id) IN (''tinyint'',''smallint'',''int'',''bigint'')
													THEN TYPE_NAME(tgt_col.user_type_id)
											END as dest_typ
											,tgt_col.is_nullable
										FROM ['+@tgt_db+'].sys.tables AS tgt_tbl
											INNER JOIN ['+@tgt_db+'].sys.columns AS tgt_col
												ON tgt_col.object_id = tgt_tbl.object_id
											INNER JOIN ['+@src_db+'].sys.columns AS src_col
												ON tgt_col.name = src_col.name
											INNER JOIN ['+@src_db+'].sys.tables AS src_tbl 
												ON src_col.object_id = src_tbl.object_id
										WHERE tgt_tbl.object_id = @tgt_object_id
											AND src_tbl.object_id = @src_object_id
											AND TYPE_NAME(tgt_col.user_type_id) IN (''varchar'',''char'',''nvarchar'',''nchar'',''binary'',''varbinary''
												,''tinyint'',''smallint'',''int'',''bigint'',''decimal'',''numeric''
											)
											AND tgt_col.max_length < src_col.max_length
									'
								DECLARE @truncation_sql_params NVARCHAR(MAX) = N'@tgt_object_id int, @src_object_id int';

								EXEC sp_executesql @truncation_sql, @truncation_sql_params, @tgt_object_id, @src_object_id;

								set @step = 'truncation sql ran'

								IF EXISTS(SELECT * FROM #offending_columns)
									begin
										
										declare @trun_msg_sql nvarchar(max) 
											= 
										'
											SELECT 
												 col_nm as [Column]
												,src_typ as [Source Type]
												,dest_typ as [Target Type] 
												,[Suggested Target Table DDL Alter Statement] = 
													CONCAT(''ALTER TABLE '+case when @tgt_db = 'tempdb' then @tgt_tbl else @tgt_full_path end
														+' ALTER COLUMN ['',col_nm,''] '',src_typ
														,case when is_nullable = 1 then '' NOT NULL'' ELSE '' NULL'' END)
											FROM #offending_columns
										
										'
										--print @trun_msg_sql
										set @truncation_msg_cols = SSISDB.EDIS.ifn_format_qry_as_text(@trun_msg_sql);
									
										
										drop TABLE #offending_columns;

										SET @msg = 'Column Truncation error has been detected. '
										SET @msg += 'This occurs when a column in the source table is longer than the column in the destination table. '+@crlf;
										SET @msg += 'Below is a list of column(s) that that have a longer width in the source. '+@crlf+@crlf;
										SET @msg = @msg + @truncation_msg_cols

										set @step = 'column truncation error message created'

										raiserror(@msg,16,16) with nowait;
										return 16;
									END

								;



                           END
					else
						begin
							-- general error
							set @msg = 'usp_merge failed with the following information:'
							SET @msg = @msg + 'error message -> '+ @sys_err_msg+@crlf;
							set @msg = @msg + 'error line -> '+ CAST(ERROR_LINE() AS VARCHAR(5))+@crlf;
							raiserror(@msg,16,16) with nowait;
							return 16;
						END

              END CATCH

              
       END TRY
       BEGIN CATCH
              DECLARE @merge_err_msg VARCHAR(MAX) = ERROR_MESSAGE();
              DECLARE @err_line INT = ERROR_LINE();

			  set @merge_err_msg += char(13)+char(10)+ 'Merge Step: '+@step


			  declare @end_ts2 datetime2 = getdate()

			  -- log it
				insert SSISDB.edis.etl_audit (exec_id, task_action, task_start_ts, task_end_ts, task_duration, task_run_outcome
					,usr_login_id, src_sys, dest_sys, err_msg
					)
				values (newid(), 'USP_MERGE', @start_ts, @end_ts2, datediff(second,@start_ts, @end_ts2), 'FAILURE'
					,suser_name(), @src_full_path, @tgt_full_path, @merge_err_msg
				)

              SET @merge_err_msg = CONCAT('usp_merge error: ',@merge_err_msg , CHAR(13)+CHAR(10) , 'Error Line ',@err_line);
              RAISERROR(@merge_err_msg,16,16) WITH NOWAIT;
              RETURN 16
       END CATCH

	   return 0 -- usp_merge

END


	GO



	--{INSTALL_STEP}Deactivate old svc id table{/INSTALL_STEP}

	IF EXISTS(SELECT 1 FROM SYS.TABLES WHERE NAME = 'lkup_svc_id' and schema_Name(schema_id) = 'EDIS')
		BEGIN
			-- if no data, kill it
			IF NOT EXiSTS(SELECT * FROM EDIS.lkup_svc_id)
				BEGIN
					EXEC SSISDB..sp_executesql N'DROP TABLE EDIS.lkup_svc_id'
				END
			ELSE
				BEGIN
					EXEC SP_RENAME 'EDIS.lkup_svc_id', 'lkup_svc_id_inactive'
				END
			
		END

	-- ====================================================================================================================================
	-- Load in Servername Connection

	--{INSTALL_STEP}Load default MSSQL Connection{/INSTALL_STEP}

	 IF NOT EXISTS(SELECT 1 FROM SSISDB.EDIS.lkup_service_id WHERE service_id = @@servername) 
			BEGIN

				EXEC EDIS.usp_config_db_conn_mssql
					 @server_id = @@servername
					,@server_instance = @@servername
					,@use_integrated_security = 1

			END
            


	GO

	-- Add diagnostic procs
	--{INSTALL_STEP}proc isp_turn_on_logging{/INSTALL_STEP}

	CREATE PROC EDIS.isp_turn_on_logging
		with encryption
		as
			set nocount on;
			declare @bin varbinary(128);
			set @bin = cast('edis_logging_verbose' as varbinary(128))
			set context_info @bin;
	GO

	-- =====================================================================================================================================
	-- Views:

	--{INSTALL_STEP}Create View v_lkup_server_id{/INSTALL_STEP}

	create view EDIS.v_lkup_service_id
		with encryption
	as
	SELECT service_id, service_type, last_upd_ts
	  FROM [SSISDB].EDIS.[lkup_service_id] with (nolock)
	  where EDIS.fn_check_perm(service_id) = 1

	GO

	--{INSTALL_STEP}Create View v_etl_audit{/INSTALL_STEP}

	CREATE VIEW EDIS.v_etl_audit
	as
		SELECT 
			 exec_id
			,task_action
			,task_start_ts
			,task_end_ts
			,task_duration
			,task_run_outcome
			,usr_login_id
			,src_sys
			,dest_sys
			,src_qry
			,dest_tbl
			,rows_tsfr
			,err_msg
			,svc_id
			,sys_hb_ts
			,info_msgs
		FROM edis.etl_audit with (nolock)

	GO


	-- =====================================================================================================================================
	-- Database Role

	--{INSTALL_STEP}Create database role{/INSTALL_STEP}

	IF NOT EXISTS(SELECT * FROM SYS.database_principals WHERE type_desc = 'DATABASE_ROLE' AND NAME = 'EDIS_Role')
		BEGIN
			CREATE ROLE [EDIS_Role] AUTHORIZATION [DBO]
		END
    ;

	GO

	--{INSTALL_STEP}Grant execute rights to EDIS procs{/INSTALL_STEP}

	if object_id('tempdb..#obs') is not null drop table #obs;
	create table #obs (ob_nm varchar(250));

	insert #obs values 
		 ('usp_rename_loc_file')
		,('usp_create_loc_dir')
		,('usp_delete_loc_dir')
		,('usp_delete_loc_files')
		,('usp_copy_loc_file')
		,('usp_copy_loc_file')
		,('usp_watch_for_file')
		,('usp_update_loc_file_attribute')
		,('usp_get_loc_file_list')
		,('usp_get_ftp_file_list')
		,('usp_ftp_upload_files')
		,('usp_ftp_download_files')
		,('usp_ftp_delete_files')
		,('usp_ftp_create_dir')
		,('usp_run_sql_cmd')
		,('usp_get_scalar')
		,('usp_run_data_transfer')
		,('isp_log_info')
		,('usp_zip_files')
		,('ufn_does_file_exist')
		,('usp_unzip_files')
		,('usp_run_process_task')
		,('usp_run_web_request')
		,('usp_run_soap_request')
		,('usp_sharepoint_list_read')
		,('usp_sharepoint_list_write')
		,('usp_sharepoint_list_purge')
		,('usp_sharepoint_list_get_metadata')
		,('usp_sharepoint_library_upload_files')
		,('usp_sharepoint_library_download_files')
		,('usp_sharepoint_library_get_file_list')
		,('usp_sharepoint_get_list_collection')
		,('usp_excel_get_sheet_list')
		,('usp_excel_rename_worksheet')
		,('usp_excel_clear_worksheet')
		,('usp_excel_add_worksheet')
		,('usp_excel_export_data')
		,('usp_excel_import_data')
		,('usp_bigquery_import_data')
		,('usp_bigquery_export_data')
		,('usp_bigquery_drop_tbl')
		,('usp_bigquery_crt_tbl_from_qry')
		,('usp_bigquery_append_data') 
		,('usp_bigquery_run_sql_cmd')
		,('usp_merge')
		,('isp_log_task')
		,('v_lkup_service_id')
		,('v_etl_audit')
		,('fn_check_perm')
		,('usp_run_powershell_script')
		,('ifn_validate_qry')
		,('usp_convert_varbinary_to_file')
		,('ufn_convert_file_to_varbinary')
		,('ufn_split_string')
		,('usp_send_email')
		,('ufn_get_files')
		,('usp_move_loc_file')
		,('ufn_read_file_line')
		,('usp_replace_file_content')
		,('usp_email_import_messages')
		,('usp_email_save_attachment_to_file')
		,('usp_flatfile_export_data')
		,('usp_email_create_folder')
		,('usp_email_delete_folder')
		,('usp_email_create_cal_appt')
		,('usp_email_move_messages')
		,('usp_email_delete_messages')
		,('ufn_concat_list')
	;

	-- -------------------------------------------------------------------
	-- Add Permissions

	-- Types
	GRANT EXECUTE ON TYPE::[EDIS].[web_request_headers] TO [EDIS_Role];

	-- Objects

	if object_id('tempdb..#perms') is not null drop table #perms;

	select distinct ob.name, OBJECT_SCHEMA_NAME(ob.object_id) as schema_nm, isnull(obs.type, ob.type) as type
	into #perms
	from #obs as tmp
		inner join sys.objects as ob
			on ob.name COLLATE SQL_Latin1_General_CP1_CI_AS = tmp.ob_nm
		left join sys.synonyms as sn
			on ob.object_id = sn.object_id
		left join sys.objects as obS
			on object_id(sn.base_object_name) = obs.object_id
	WHERE OBJECT_SCHEMA_NAME(ob.object_id) IN ('EDIS')
	
	declare csp cursor local fast_forward for select name, schema_nm, type
	from #perms

	declare @nm nvarchar(250), @schema_nm nvarchar(250), @type nvarchar(10)
	open csp
	fetch next from csp into @nm, @schema_nm, @type
	while @@FETCH_STATUS = 0
		BEGIN
			
			declare @perm_grant_sql nvarchar(max) = 
				N'GRANT '+case when @type in('FT', 'V') then 'SELECT' ELSE 'EXECUTE' END + ' ON ['+@schema_nm+'].['+@nm+'] TO [EDIS_Role]'
			;

			--print @perm_grant_sql
			exec sp_executesql @perm_grant_sql
				

			fetch next from csp into @nm, @schema_nm, @type
		END
	close csp
	deallocate csp

	

	GO

	-- Grant Insert/Delete/SELECT on params
	GRANT SELECT, INSERT, DELETE ON EDIS.util_task_params to [EDIS_Role];

	GO

	--{INSTALL_STEP}Set Package Exec permissions{/INSTALL_STEP}

    -- Data Transfer Folder/Project/Package

    -- folder
    declare @folder_id int = (select folder_id from catalog.folders where name = 'SQLETL.COM')
    declare @db_role_id int = (select principal_id from sys.database_principals where name = 'EDIS_Role')

    EXEC [SSISDB].[catalog].[grant_permission] @object_type=1, @object_id = @folder_id, @principal_id = @db_role_id, @permission_type=1
    EXEC [SSISDB].[catalog].[grant_permission] @object_type=1, @object_id = @folder_id, @principal_id = @db_role_id, @permission_type=103
    EXEC [SSISDB].[catalog].[grant_permission] @object_type=1, @object_id = @folder_id, @principal_id = @db_role_id, @permission_type=101
	
	---- project
    declare @project_id int = (select p.project_id 
	    from catalog.projects as p
		    inner join catalog.folders as f
			    on p.folder_id = f.folder_id
	    where p.folder_id = @folder_id and p.name = 'EDIS'
    )

	if @project_id is not null
		begin

			EXEC [SSISDB].[catalog].[grant_permission] @object_type=2, @object_id = @project_id, @principal_id = @db_role_id, @permission_type=1
			EXEC [SSISDB].[catalog].[grant_permission] @object_type=2, @object_id = @project_id, @principal_id = @db_role_id, @permission_type=3

		end

	GO

	-- ENABLE MS TRIGGER
	
	IF EXiSTS(select * from SSISDB.sys.triggers where name = 'ddl_cleanup_object_permissions')
		BEGIN
			IF EXISTS (SELECT is_disabled from SSISDB.sys.triggers where name = 'ddl_cleanup_object_permissions' and is_disabled = 1)
				BEGIN
					EXEC SSISDB..sp_executesql N'ENABLE TRIGGER ddl_cleanup_object_permissions ON DATABASE'
					--print 'trigger enabled'
				END
		END

	GO

	-- Add Server Trigger for db owner change on ssisdb

	IF EXISTS(select * from sys.server_triggers where name = 'EDIS_DB_OWNER_CHANGE_TRIG')
		BEGIN
			EXEC master..sp_executesql N'DROP TRIGGER EDIS_DB_OWNER_CHANGE_TRIG ON ALL SERVER'
		END

	GO
	declare @trig_def nvarchar(max) = 
		'
	CREATE TRIGGER EDIS_DB_OWNER_CHANGE_TRIG
	ON ALL SERVER
	with EXECUTE as '''+(SELECT NAME from sys.server_principals where sid = 0x01)+'''
	FOR ALTER_AUTHORIZATION_DATABASE
	AS

	BEGIN
		declare @data xml = eventdata();
		declare @db nvarchar(255) = @data.value(''(/EVENT_INSTANCE/DatabaseName)[1]'', ''nvarchar(255)'');
		declare @object_type nvarchar(255) = @data.value(''(/EVENT_INSTANCE/ObjectType)[1]'', ''nvarchar(255)'')
		declare @owner_nm nvarchar(255) = @data.value(''(/EVENT_INSTANCE/OwnerName)[1]'', ''nvarchar(255)'')

		declare @sa nvarchar(255) = (select name from sys.server_principals where sid = 0x01)

		if @db = ''SSISDB'' and @object_type = ''DATABASE'' and @owner_nm <> @sa
			BEGIN
				declare @err_msg nvarchar(max) = 
					''EDIS NOTIFICATION: Error changing database owner for database [SSISDB]. In order for EDIS to function correctly, the SSISDB database owner needs to be ''+@sa+''.''+char(13)+char(10)+
					''This change was prevented by server trigger [EDIS_DB_OWNER_CHANGE_TRIG]. If you disable this trigger and change the database owner for database [SSISDB], ''+
					''EDIS will not function correctly.''
				RAISERROR(@err_msg,16,16) with nowait;
				rollback transaction
			END

	END
	
		'
	EXEC master..sp_executesql @trig_def;
	GO
	exec master..sp_executesql N'ENABLE TRIGGER [EDIS_DB_OWNER_CHANGE_TRIG] ON ALL SERVER'
